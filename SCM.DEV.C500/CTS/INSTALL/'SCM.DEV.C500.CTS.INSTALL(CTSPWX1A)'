         TITLE 'SA-AGENT ICHPWX01 EXIT FOR RACF ONLINE INTERCEPTOR'     00010000
*                                                                       00010100
*********************************************************************** 00010200
****                                                               **** 00010300
****   SA-AGENT VERSION 4.0.XX                                     **** 00010400
****                                                               **** 00010500
****   (C) COPYRIGHT 1999-2000 BMC SOFTWARE INC.                   **** 00010600
****                                                               **** 00010700
*********************************************************************** 00010800
*                                                                       00020000
*********************************************************************** 00030000
*                                                                     * 00040000
* MODULE NAME : CTSPWX1A                                              * 00050000
*                                                                     * 00060000
* DESCRIPTION : SA-AGENT ICHPWX01 EXIT ROUTINE                        * 00070000
*                                                                     * 00080000
* FUNCTION:                                                           * 00090000
*                                                                     * 00100000
*    ICHPWX01 IS RACF NEW PASSWORD EXIT WHICH SA-AGENT USES FOR       * 00110000
*    PASSWORD SYNCRONIZTION SUPPORT.                                  * 00120000
*    THE EXIT INTERCEPTS PASSWORD CHANGES THAT WERE GENERATED BY      * 00130000
*    THE RACF COMMANDS 'ALTUSER' AND 'PASSWORD' AND NOTIFIES OF THE   * 00140000
*    EVENT TO SA-AGENT ONLINE INTERCEPTOR SERVER VIA CROSS MEMORY     * 00150000
*    SERVICES.                                                        * 00160000
*                                                                     * 00170000
* ATTRIBUTES  : THE EXIT MODULE SHOULD BE LINK-EDITED WITH RMODE ANY  * 00180000
*               AND AMODE 31 , REUSABLE AND REENTRABLE .              * 00190000
*                                                                     * 00200000
* ENVIRONMENT : THE EXIT RECEIVES CONTROL IN PROBLEM STATE AND PSW    * 00210000
*               KEY 8 WHEN INVOKED BY 'ALTUSER' AND 'PASSWORD'        * 00220000
*               COMMANDS.                                             * 00230000
*               WHEN INVOKED BY RACINIT , IT RECEIVES CONTROL IN      * 00240000
*               SUPERVISOR STATE, PSW KEY 0.                          * 00250000
*                                                                     * 00260000
* RESTRICTIONS : NONE                                                 * 00270000
*                                                                     * 00280000
* REGISTER USAGE :  R0  - TEMPORARY WORK REGISTER                     * 00340000
*                   R1  - TEMPORARY WORK REGISTER                     * 00350000
*                   R2  - TEMPORARY WORK REGISTER                     * 00360000
*                   R3  -> NEW PASSWORD                               * 00370000
*                   R4  -> USERID                                     * 00380000
*                   R5  -  LENGTH REGISTER                            * 00390000
*                   R6  -  NOT USED                                   * 00400000
*                   R7  -  NOT USED                                   * 00410000
*                   R8  -> EVT                                        * 00420000
*                   R9  -> RQC                                        * 00430000
*                   R10 -> NOT USED                                   * 00440000
*                   R11 -> PARAMETER LIST                             * 00450000
*                   R12 -> PROGRAM BASE                               * 00460000
*                   R13 -> DYNAMIC WORK AREA (SVAE AREA)              * 00470000
*                   R14 -  RETURN ADDRESS                             * 00480000
*                   R15 -  RETURN CODE                                * 00490000
*                                                                     * 00500000
* INPUT :                                                             * 00510000
*                                                                     * 00520000
*    REGISTER 1 POINTS TO A RACF PASSWORD EXIT PARAMETER LIST WHICH   * 00530000
*    IS MAPPED BY THE PWXPL CONTROL BLOCK (ICHPWXP MARCO)             * 00540000
*                                                                     * 00550000
* OUTPUT:                                                             * 00560000
*                                                                     * 00570000
*    THIS EXIT ALWAYS RETURNS A RETURN CODE OF 0 .                    * 00580000
*                                                                     * 00590000
* ICHPWX01 RETURN CODES ARE :                                         * 00600000
*                                                                     * 00610000
*    0 - AUTHORIZED THE NEW PASSWORD. CONTINUE WITH PROCESSING        * 00620000
*    4 - THE NEW PASSWORD REQUEST IS NOT ACCEPTED AND IS TO BE FAILED * 00630000
*    8 - THE INTERVAL VALUE CHANGE IS NOT ACCEPTED AND IS TOP BE      * 00640000
*        FAILED .                                                     * 00650000
*   12 - THE NEW PASSWORD REQUEST IS NOT ACCEPTED AND IS TO BE FAILED * 00660000
*        THIS IS THE SAME AS RETURN CODE 4, BUT THE ERROR MESSAGES    * 00670000
*        THAT ARE ISSUED BY 'ALTUSER' AND 'PASSWORD' COMMNADS         * 00680000
*        WILL BE  SUPPRESSED                                          * 00690000
*   16 - THE INTERVAL VALUE CHANGE IS NOT ACCEPTED AND IS TO BE       * 00700000
*        FAILED .                                                     * 00710000
*        THIS IS THE SAME AS RETURN CODE 8, BUT THE ERROR MESSAGES    * 00720000
*        THAT ARE ISSUED BY 'ALTUSER' AND 'PASSWORD' COMMNADS         * 00730000
*        WILL BE  SUPPRESSED                                          * 00740000
*                                                                     * 00750000
* CHANGE ACTIVITY :                                                   * 00760000
*                                                                     * 00770000
*    24/10/94 DC CREATED                                              * 00780000
*    19/07/95 DC CHANGE RMODE TO ANY                                  * 00790000
*    25/02/98 DC LONG RQC SUPPORT                                     * 00791000
*    25/02/99 GS INTERCEPT ALTUSER COMMANDS                           * 00792000
*    03/07/00 YB INDICATE CALLED BY ALTUSER                           * 00793000
*    18/01/06 EM WS2555 NOTIFY WHEN PASSWORD IS NOT INTERCEPTED       * 00800000
*                                                                     * 00801000
*********************************************************************** 00810000
*                                                                       00820000
****************************************************************        00830000
*        CONFIGURATIONS DEFINITION                             *        00840000
****************************************************************        00850000
*                                                                       00860000
****************************************************************        00890000
*        REGISTER EQUATES                                      *        00900000
****************************************************************        00910000
*                                                                       00920000
R0       EQU   0                                                        00930000
R1       EQU   1                                                        00940000
R2       EQU   2                                                        00950000
R3       EQU   3                                                        00960000
R4       EQU   4                                                        00970000
R5       EQU   5                                                        00980000
R6       EQU   6                                                        00990000
R7       EQU   7                                                        01000000
R8       EQU   8                                                        01010000
R9       EQU   9                                                        01020000
R10      EQU   10                                                       01030000
R11      EQU   11                                                       01040000
R12      EQU   12                                                       01050000
R13      EQU   13                                                       01060000
R14      EQU   14                                                       01070000
R15      EQU   15                                                       01080000
*                                                                       01090000
CTSPWX1A CSECT ,                                                        01100000
CTSPWX1A AMODE 31                                                       01110000
CTSPWX1A RMODE ANY                                                      01120000
*                                                                       01130000
****************************************************************        01140000
*        PROLOG CODE                                           *        01150000
****************************************************************        01160000
*                                                                       01170000
         SAVE  (14,12),,CTSPWX1A-&SYSDATE-&SYSTIME                      01180000
         LR    R12,R15                 R12 -> PROGRAM BASE              01190000
         USING CTSPWX1A,R12            PROGRAM ADDRESSABILITY           01200000
         CTSLEVEL ,                                                     01210000
         LR    R11,R1                  R11 -> PARAMETERS LIST           01220000
         USING PWXPL,R11               PARAMETER LIST ADDRESSABILITY    01230000
*                                                                       01240000
****************************************************************        01250000
*        VERIFY CALLERS, NEWPW AND USERID                               01260000
****************************************************************        01270000
*                                                                       01280000
*        IGNORE IF CALLER = RACINIT                                     01290000
* DO NOT IGNORE IF CALLER = ALTUSER                                     01300000
*                                                                       01310000
         ICM   R1,15,PWXCALLR          WAS CALLER PASSED ?              01320000
         BZ    NOCALLER                NO, ISSUE WARNING MESSAGE        01330000
         CLI   0(R1),PWXRINIT          CALLED BY RACINIT ?              01340000
         BE    RETURN                  YES, THEN IGNORE THE CALL        01350000
         XR    R6,R6                   ZERO R6                WS2372    01350100
         CLI   0(R1),PWXALTUS          CALLED BY ALTUSER ?    WS2372    01350200
         BNE   NOTALU                  NO - SKIP THIS         WS2372    01350300
         LA    R6,1                    INDICATE ALTUSER       WS2372    01350400
NOTALU   DS    0H                                             WS2372    01351000
*        CLI   0(R1),PWXALTUS          CALLED BY ALTUSER ?              01360000
*        BE    RETURN                  YES, THEN IGNORE THE CALL        01370000
*                                                                       01380000
*        IGNORE IF NO USERID                                            01390000
*                                                                       01400000
         ICM   R3,15,PWXUSRID          WAS A NEW USER PASSED ?          01410000
         BZ    NOUID                   NO, ISSUE WARNING MESSAGE        01420000
         CLI   0(R3),0                 WAS NEW USER PASSED ?            01430000
         BE    NOUID                   NO, ISSUE WARNING MESSAGE        01440000
*                                                                       01450000
*        IGNORE IF NO NEW PASSWORD                                      01460000
*                                                                       01470000
         ICM   R4,15,PWXNEWPW          WAS NEW PASSWORD PASSED ?        01480000
         BZ    RETURN                  NO, IGNORE THE CALL              01490000
         CLI   0(R4),0                 WAS NEW PASSWORD PASSED ?        01500000
         BE    RETURN                  NO, IGNORE THE CALL              01510000
*                                                                       01520000
*        PASSED FILTERING                                               01530000
*                                                                       01540000
         B     START                                                    01550000
*                                                                       01560000
****************************************************************        01570000
*        PARAMETERS ERROR                                      *        01580000
****************************************************************        01590000
*                                                                       01600000
NOCALLER DS    0H                                                       01610000
         WTO   'CTSPWX1A: PARAMETERS ERROR - NO CALLER'                 01620000
         B     RETURN                                                   01630000
NOUID    DS    0H                                                       01640000
         WTO   'CTSPWX1A: PARAMETERS ERROR - NO USERID'                 01650000
         B     RETURN                                                   01660000
*                                                                       01670000
****************************************************************        01680000
*        OBTAIN WORKAREA                                       *        01690000
****************************************************************        01700000
*                                                                       01710000
START    DS    0H                                                       01720000
         GETMAIN RC,LV=WORKLEN                                          01730000
         LTR   R15,R15                                                  01740000
         BZ    CHAINSA                                                  01750000
         WTO   'CTSPWX1A: GETMAIN FAILED ERROR'                         01760000
         B     RETURN                                                   01770000
CHAINSA  DS    0H                                                       01780000
         ST    R1,8(R13)               CHAIN                            01790000
         ST    R13,4(R1)               SAVE AREAS                       01800000
         LR    R13,R1                  ESTABLISH WORK AREA              01810000
         USING WORKAREA,R13               ADDRESSABILITY                01820000
*                                                                       01830000
****************************************************************        01840000
*        CREATE RECOVERY ENVIRONMENT                           *        01850000
****************************************************************        01860000
*                                                                       01870000
         XC    ABNDCODE,ABNDCODE       CLEAR ABEND CODE                 01880000
         MVC   WRKESTAE,LSTESTAE                                        01890000
         ESTAE ABNDEXIT,PARAM=WORKAREA,TERM=YES,MF=(E,WRKESTAE)         01900000
*                                                                       01910000
****************************************************************        01920000
*        BUILD RQC AND EVT                                     *        01930000
****************************************************************        01940000
*                                                              *        01950000
* 'RQC' IS THE 'REQUEST CONTROL BLOCK' WHICH IS USED BY THE PC *        01960000
* ROUTINES TO PASS INFORMATION TO THE SA-AGENT ONLINE          *        01970000
* INTERCEPTOR .                                                *        01980000
*                                                              *        01990000
* 'EVT' IS THE 'EVENT CONTROL BLOCK' WHICH IS IMBEDED IN THE   *        02000000
* REQUEST BLOCK FOR 'NOTIFY REQUESTS' . IT DESCRIBES THE       *        02010000
* EVENT THAT OCCURED INCLUDING THE ENTITY (USER, GROUP ETC...) *        02020000
* AND THE EVENT ACTION TYPE (ADD, DELETED, MODIFY, PASSWORD    *        02030000
* CHANGED, ETC...) .                                           *        02040000
*                                                              *        02050000
* THE FOLLOWING CODE FORMATS THESE CONTROL BLOCKS AND FILL THEM*        02060000
* WITH THE RELEVANT INFO SO THEY CAN BE PASSED ON TO THE PC    *        02070000
* ROUTINES AND BE TRANSFERED TO THE ONLINE INTERCEPTOR SERVER. *        02080000
*                                                              *        02090000
****************************************************************        02100000
*                                                                       02110000
*        INITIALIZE RQC                                                 02120000
*                                                                       02130000
*PS0244  XC    RQCAREA,RQCAREA         CLEAR LOCAL RQC AREA             02140100
         LA    R0,RQCAREA              CLEAR THE AREA           PS0244  02140200
         LA    R1,RQCLEN               SET LENGTH               PS0244  02140300
         XR    R15,R15                 PADD WITH X'00'          PS0244  02140400
         MVCL  R0,R14                  CLEAR                    PS0244  02141000
         LA    R9,RQCAREA              R9 -> LOACL RQC AREA             02150000
         USING RQC,R9                  MAP IT                           02160000
*PS0244  MVI   RQCTYPE,RQCTNOT         REQUEST TYPE IS 'NOTIFY'         02170000
         MVI   RQCTYPE,RQCTNOTX        REQUEST TYPE IS 'NOTIFY' PS0244  02171000
*                                                                       02180000
*        INITIALIZE EVT                                                 02190000
*                                                                       02200000
         LA    R8,RQCEVT               R8 -> EVT                        02210000
         USING EVT,R8                  MAP EVENT BLOCK                  02220000
         MVC   EVTEVT,=CL4'EVT '       SETUP EYE CATCHER                02230000
         MVC   EVTFLAG,=A(EVTFULL)     EVT IS LOADED WITH DATA          02240000
         MVI   EVTTYPE,EVTTUSER        EVENT TYPE = USER                02250000
         MVI   EVTACT,EVTAPSWD         ACTION = PASSWORD CHANGE         02260000
         TIME  BIN                                                      02270000
         ST    R0,EVTTIME              EVENT TIME STAMP                 02280000
         ST    R1,EVTDATE              EVENT TIME STAMP                 02290000
*                                                                       02300000
*        COPY ORIGINATOR USERID                                         02310000
*                                                                       02320000
         L     R1,PSATOLD-PSA          R1 -> CURRENT TCB                02330000
         ICM   R1,15,TCBSENV-TCB(R1)   R1 -> TASK ACEE                  02340000
         BNZ   COPYOUID                HAVE IT, COPY UID                02350000
         L     R1,PSAAOLD-PSA          R1 -> CURRENT ASCB               02360000
         L     R1,ASCBASXB-ASCB(R1)    R1 -> ASXB                       02370000
         ICM   R1,15,ASXBSENV-ASXB(R1) R1 -> ADDRESS SPACE ACEE         02380000
         BZ    SKIPOUID                NONE, NO ACEE FOUND              02390000
COPYOUID DS    0H                                                       02400000
         MVC   EVTOUID,ACEEUSRI-ACEE(R1) COPY USERID FROM ACEE          02410000
SKIPOUID DS    0H                                                       02420000
*                                                                       02430000
*        COPY ORIGINATOR JOBNAME                                        02440000
*                                                                       02450000
         L     R1,PSAAOLD-PSA          R1 -> ASCB                       02460000
         ICM   R15,15,ASCBJBNI-ASCB(R1) JOBNAME EXISTS ?                02470000
         BNZ   COPYOJBN                YES, THEN COPY IT                02480000
         ICM   R15,15,ASCBJBNS-ASCB(R1) STCNAME EXISTS ?                02490000
         BZ    SKIPOJBN                NO, NOTHING CAN BE COPIED        02500000
COPYOJBN DS    0H                                                       02510000
         MVC   EVTOJBN,0(R15)          COPY JOBNAME/STCNAME             02520000
SKIPOJBN DS    0H                                                       02530000
*                                                                       02540000
*        COPY ORIGINATOR PROGNAME (JOBSTEP TCB, OLDEST RB)              02550000
*                                                                       02560000
         L     R1,PSATOLD-PSA          R1 -> CURRENT TCB                02570000
         ICM   R15,15,TCBJSTCB-TCB(R1) R15 -> JOBSTEP TCB               02580000
         BZ    PROGRB                  NO, SAY WITH CURRENT TCB         02590000
         LR    R1,R15                  R1 -> JOB STEP TCB               02600000
PROGRB   DS    0H                                                       02610000
         L     R15,TCBRBP-TCB(,R1)     R15 -> NEWEST RB FOR TCB         02620000
         USING RBBASIC,R15             MAP RB                           02630000
LOOPPROG DS    0H                                                       02640000
         XR    R14,R14                 CLEAR TO BE SURE                 02650000
         ICM   R14,7,RBLINKB           R14 -> PREVIOUS RB IN CHAIN      02660000
         BZ    SKIPPROG                NO, DEAD END                     02670000
         CR    R1,R14                  IS RB THE OLDEST ?               02680000
         BE    COPYPROG                YES, COPY PROGNAME               02690000
         LR    R15,R14                 KEEP LOOKING FOR OLDEST RB       02700000
         B     LOOPPROG                                                 02710000
COPYPROG DS    0H                                                       02720000
         XR    R1,R1                   CLEAR R1                         02730000
         ICM   R1,7,RBCDE1             R1  -> CDE                       02740000
         MVC   EVTOPROG,CDNAME-CDENTRY(R1) COPY PROGNAME FROM CDE       02750000
         LTR   R6,R6                  IS ALTUSER IND. TURNED ON WS2372  02751000
         BZ    SKIPALU                NO - SKIP IT              WS2372  02752000
         MVC   EVTOPROG,=C'ALTUSER '  YES - MOVE INDICATION     WS2372  02753000
SKIPALU  DS    0H                                               WS2372  02754000
SKIPPROG DS    0H                                                       02760000
         DROP  R15                                                      02770000
*                                                                       02780000
*        COPY USERID                                                    02790000
*                                                                       02800000
         MVC   EVTUSER,=CL8' '         INSURE BLANK PADDING             02810000
         XR    R5,R5                   PREPARE FOR 'IC'                 02820000
         IC    R5,0(R3)                R5 = LENGTH OF USER ID           02830000
         BCTR  R5,0                    ADJUST USERID LENGTH FOR 'EX'    02840000
         MVC   EVTUSER(*-*),1(R3)      DUMMY CODE FOR 'EX'              02850000
         EX    R5,*-6                  COPY THE USERID TO EVT           02860000
*                                                                       02870000
*        COPY NEW PASSWORD                                              02880000
*                                                                       02890000
         MVC   EVTGROUP,=CL8' '        INSURE BLANK PADDING             02900000
         XR    R5,R5                   PREPARE FOR 'IC'                 02910000
         IC    R5,0(R4)                R5 = NEW PASSWORD LENGTH         02920000
         BCTR  R5,0                    ADJUST FOR 'EX'                  02930000
         MVC   EVTGROUP(*-*),1(R4)     DUMMY CODE FOR 'EX'              02940000
         EX    R5,*-6                  COPY PASSWORD                    02950000
* WS2555 DROP  R8                                                       02960000
*                                                                       02970000
****************************************************************        02980000
*        NOTIFY SA-AGENT INTERCEPTOR SERVER VIA PC ROUTINE              02990000
****************************************************************        03000000
*                                                                       03010000
         CALL  CTSAPCC,(FUJIFLAG,SSNAME,JOBNAME,(R9),PCCWORK),         X03020000
               MF=(E,CALLAREA)                                          03030000
         LTR   R15,R15                 SUCCESS  ?                       03040000
         BZ    CLEANUP                 YES, FINISH                      03050000
*                                                                       03051000
         CH    R15,=H'8'               FREE CHAIN EXISTS ?       WS2555 03052000
         BE    NOFRCHN                 NO, FREE CHAIN RUN OUT    WS2555 03053000
*                                                                       03054000
         CH    R15,=H'160'             WAS SEREVER UP ?                 03060000
         BNH   CLEANUP                 NO, THEN FINISH                  03070000
*                                                                       03080000
****************************************************************        03090000
*        NOTIFY ROUTINE INTERNAL ERROR - ISSUE  ERROR MESSAGE           03100000
****************************************************************        03110000
*                                                                       03120000
         CVD   R15,PACKD               CONVERT RC TO EBCDIC             03130000
         UNPK  CHARRC,PACKD            CONVERT RC TO EBCDIC             03140000
         OI    CHARRC+7,X'F0'          CONVERT RC TO EBCDIC             03150000
         MVC   WTOAREA(WTONTFYL),WTONTFY                                03160000
         MVC   WTOAREA+WTONTFYL-4(4),CHARRC+4                           03170000
         WTO   MF=(E,WTOAREA)                                           03180000
         B     CLEANUP                                           WS2555 03181000
*                                                                       03182000
****************************************************************        03183000
*        NOTIFY FREE CHAIN IS EMPTY                              WS2555 03184000
****************************************************************        03185000
*                                                                       03186000
NOFRCHN  DS    0H                                                WS2555 03187000
         MVC   WTOAREA(WTOEVTL),WTOEVT                           WS2555 03188000
         MVC   WTOAREA+23(L'EVTUSER),EVTUSER                     WS2555 03189000
         WTO   MF=(E,WTOAREA)                                    WS2555 03189100
         B     CLEANUP                                           WS2555 03189200
         DROP  R8                                                WS2555 03189300
*                                                                       03190000
****************************************************************        03200000
*        ISSUE ABEND MESSGAE                                   *        03210000
****************************************************************        03220000
*                                                                       03230000
CLEANUP  DS    0H                                                       03240000
         ICM   R2,15,ABNDCODE          R2 -> ABEND CODE WORD            03250000
         BZ    NOABEND                 ZERO, NO ABEND OCCURED           03260000
         MVI   ABNDTYPE,C'U'           ASSUME USER ABNED                03270000
         N     R2,=XL4'00000FFF'       ISOLATE USER ABEND CODE          03280000
         BNZ   ABENDMSG                HAVE IT, ISSUE THE MESSAGE       03290000
         L     R2,ABNDCODE             TRY AGAIN FOR SYSTEM ABNED       03300000
         SRL   R2,12                   ISOLATE SYSTEM ABEND CODE        03310000
         MVI   ABNDTYPE,C'S'           SET SYSTEM ABEND TYPE            03320000
ABENDMSG DS    0H                                                       03330000
         ST    R2,ABNDBIN              SAVE ISOLATED ABEND CODE         03340000
         UNPK  ABNDCHAR(9),ABNDBIN(5)  CONVERT ABEND CODE TO ZONED      03350000
         TR    ABNDCHAR(8),HEX2CHAR    CONEVRT TO CHARACTERS            03360000
         MVC   ABNDCHAR+4(1),ABNDTYPE  SET ABEND TYPE CHARACTER         03370000
         MVC   WTOAREA(WTOABNDL),WTOABND                                03380000
         MVC   WTOAREA+WTOABNDL-4(4),ABNDCHAR+4                         03390000
         WTO   MF=(E,WTOAREA)                                           03400000
NOABEND  DS    0H                                                       03410000
*                                                                       03420000
****************************************************************        03430000
*        CLRER RECOVERY ENVIRONMENT                            *        03440000
****************************************************************        03450000
*                                                                       03460000
         ESTAE 0                                                        03470000
*                                                                       03480000
****************************************************************        03490000
*        RELEASE WORKAREA STORAGE                              *        03500000
****************************************************************        03510000
*                                                                       03520000
         DROP  R13                                                      03530000
         LR    R1,R13                  ADDRESS FOR FREEMAIN             03540000
         L     R13,4(R13)              RESTORE CALLERS SAVE AREA        03550000
         LA    R0,WORKLEN              R0 = WORK AREA LENGTH            03560000
         FREEMAIN RC,LV=(R0),A=(R1)    FREE WORK AREA                   03570000
         LTR   R15,R15                 SUCCESS ?                        03580000
         BZ    RETURN                  YES, CONTINUE                    03590000
         WTO   'CTSPWX1A: FREEMAIN FAILED ERROR'                        03600000
*                                                                       03610000
****************************************************************        03620000
*        TERMINATE TO CALLER                                   *        03630000
****************************************************************        03640000
*                                                                       03650000
RETURN   DS    0H                                                       03660000
         SR    R15,R15                 LOAD RETURN CODE                 03670000
         RETURN (14,12),T,RC=(15)      RESTORE REGISTERS AND RETURN     03680000
*                                                                       03690000
****************************************************************        03700000
*        CONSTANTS                                             *        03710000
****************************************************************        03720000
*                                                                       03730000
         DS    0D                                                       03740000
FUJIFLAG DC    AL1(128)                FIXED FLAG FOR MVS SYSTEM        03750000
SSNAME   DC    CL4'    '                                                03760000
JOBNAME  DC    CL8'CTSAONI'            CROSS MEMEORY JOBNAME            03770000
*                                                                       03780000
LSTESTAE ESTAE MF=L                    LIST FORM FOR ESTAE              03790000
LENESTAE EQU   *-LSTESTAE                                               03800000
*                                                                       03810000
WTONTFY  WTO   'CTSPWX1A: SA-AGENT ONLINE INTERCEPTOR NOTIFY HAS FAILED*03820000
                RC=XXXX',MF=L                                           03830000
WTONTFYL EQU   *-WTONTFY                                                03840000
WTOABND  WTO   'CTSPWX1A: SA-AGENT RACF EXIT ICHPWX01 HAS ABENDED. ABEN*03850000
               D CODE=XXXX',MF=L                                        03860000
WTOABNDL EQU   *-WTOABND                                                03870000
WTOEVT   WTO   'CTSPWX1A: CHNG PWD <USERID> EVENT IS LOST. START AGENT *03871000
               ASAP TO EMPTY QUEUE AND MEMORY.',MF=L             WS2555 03872000
WTOEVTL  EQU   *-WTOEVT                                          WS2555 03873000
*                                                                       03880000
HEX2CHAR DC    256AL1(*-HEX2CHAR)      ZONED TO HEX EBCDIC              03890000
         ORG   HEX2CHAR+X'FA'             CONVERSION                    03900000
         DC    CL6'ABCDEF'                     TABLE                    03910000
         ORG                                                            03920000
         LTORG                                                          03930000
         DROP                                                           03940000
*                                                                       03950000
****************************************************************        03960000
*        ABEND RECOVERY ROUTINE                                *        03970000
****************************************************************        03980000
*                                                                       03990000
ABNDEXIT DS    0H                                                       04000000
         USING ABNDEXIT,R15            ABEND EXIT ADDRESSABILITY        04010000
         L     R12,=A(CTSPWX1A)        RESTORE LMOD BASE REG            04020000
         DROP  R15                                                      04030000
         USING CTSPWX1A,R12            RESTORE ITS ADDRESSABILITY       04040000
         C     R0,=F'12'               SDWA PROVIDED ?                  04050000
         BE    NOSDWA                  NO, CAN NOT RETRY                04060000
         USING SDWA,R1                 MAP SDWA                         04070000
         L     R13,SDWAPARM            RESTORE WORKAREA REGISTER        04080000
         USING WORKAREA,R13            MAP WORKAREA                     04090000
         MVC   ABNDCODE,SDWAABCC       SET ABEND CODE                   04100000
         TM    SDWAERRD,SDWACLUP       RETRY ALLOWED ?                  04110000
         BNZ   NORETRY                 NO, CAN NOT RETRY                04120000
*                                                                       04130000
RETRY    DS    0H                                                       04140000
         ST    R12,SDWASR12            SET BASE REGISTER FOR RETRY      04150000
         ST    R13,SDWASR13            SET WORKAREA REGISTER FOR RETRY  04160000
         SETRP RETREGS=YES,RC=4,RETADDR=CLEANUP,                       X04170000
               FRESDWA=YES,DUMP=YES                                     04180000
         BR    R14                                                      04190000
*                                                                       04200000
NOSDWA   DS    0H                                                       04210000
         LR    R13,R2                   NO SDWA, PARM IN R2             04220000
         ST    R1,ABNDCODE              SAVE ABEND CODE                 04230000
         XR    R1,R1                    CLEAR                           04240000
NORETRY  DS    0H                                                       04250000
         XR    R15,R15                  INDICATE NO RETRY               04260000
         BR    R14                      RETURN TO RTM                   04270000
         LTORG                                                          04280000
         DROP                                                           04290000
*                                                                       04300000
****************************************************************        04310000
*        DYNAMIC WORK AREA DSECT                               *        04320000
****************************************************************        04330000
*                                                                       04340000
WORKAREA DSECT                                                          04350000
SAVEAREA DS    18F                     SAVE AREA TO CALL OTHERS         04360000
CALLAREA CALL  ,(,,,,),MF=L            EXECUTE FORM CALL AREA           04370000
PCCWORK  DS    XL512                   WORK AREA FOR CTSAPCC ROUTINE    04380000
RQCAREA  DS    CL(RQCLEN)              AREA FOR RQC                     04390000
PACKD    DS    D                       RETURN CODE CONVERSION           04400000
CHARRC   DS    CL8                     RETURN CODE CONVERSION           04410000
WTOAREA  DS    XL384                   WTO WORK AREA                    04420000
ABNDCODE DS    XL4                     ABCODE SAVED BY ESTAE ROUTINE    04430000
ABNDBIN  DS    XL5                     ISOLATED ABEND CODE + PAD BYTE   04440000
ABNDTYPE DS    CL1                     ABEND TYPE (S/U)                 04450000
ABNDCHAR DS    CL9                     CHARCTER ABEND CODE FOR MSG      04460000
WRKESTAE DS    CL(LENESTAE)            EXECUTE FORM FOR ESTAE           04470000
RESERVED DS    16X                     RESERVED AREA                    04480000
WORKLEN  EQU   *-WORKAREA                                               04490000
*                                                                       04500000
****************************************************************        04510000
*        SA-AGENT CONTROL BLOCKS                               *        04520000
****************************************************************        04530000
*                                                                       04540000
RQC      DSECT                                                          04550000
         COPY  CTSRQC                  XMS REQUEST ELEMENT              04560000
EVT      DSECT                                                          04570000
         COPY  CTSEVT                  EVENT CONTROL BLOCK              04580000
*                                                                       04590000
****************************************************************        04600000
*        SYSTEM DSECTS                                         *        04610000
****************************************************************        04620000
*                                                                       04630000
         ICHPWXP                                                        04640000
         IHASDWA                                                        04650000
         IHAPSA                                                         04660000
         CVT   DSECT=YES                                                04670000
         IHAASCB                                                        04680000
         IHAASXB                                                        04690000
         IHAACEE                                                        04700000
         IKJTCB                                                         04710000
         IHARB                                                          04720000
         IHACDE                                                         04730000
         END                                                            04740000
