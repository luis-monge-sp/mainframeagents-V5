      MACRO                                                             00010000
.*********************************************************************  00011000
.***                                                              ****  00012000
.***       REQUEST CHAIN HANDLE MACROS                            ****  00012100
.***                                                              ****  00012200
.***       WRITTEN BY: MAURI KANTER (KM)                          ****  00012300
.***                                                              ****  00012400
.***       IOA         RELEASE 4.5.0                              ****  00012500
.***                                                              ****  00012600
.***       LICENCED MATERIAL - NEW DIMENSION SOFTWARE LTD.        ****  00012700
.***                                                              ****  00012800
.*********************************************************************  00012900
.*                                                                   *  00013000
.*  THIS MACRO REPLACES THE OLD MACROS CTORQG,CTORQP,CTORQTG         *  00013100
.*  IT WAS DEVELOPED TO IMPLEMENT A NEW REQUESTS CHAINING ALGORITHM  *  00013200
.*  THAT WILL ALLOW CONCURRENT USERS FOR GET AND PUT ON THE SAME     *  00013300
.*  CHAIN WITHOUT LOCKING IT.                                        *  00013400
.*  SOME NEW OPCODES WERE ALSO ADDED                                 *  00013500
.*                                                                   *  00013600
.*********************************************************************  00013700
.*---------- IOA V 4.5.0 --------------------------------------------*  00013800
.* *CTV   NY 23.01.94 COPY CTOREQ TO IOARQCP                            00013900
.* BO0442 DC 31.01.94 BUG FIX FROM MAURI (LOST RQC)                     00014000
.*-------------------------------------------------------------------*  00014100
&LABEL   CTSAREQ &FUNC,               CTOREQ FUNCTION                  +00014200
               &ANCHOR=,              REQUESTS HEADER (ANCHOR)         +00014300
               &REQADDR=,             REQUEST ADDRESS                  +00014400
               &QTYPE=,               QUEUE TYPE                       +00014500
               &ID=                   ID# OF QUEUE                      00014600
.********************************************************************** 00014700
.*                                                                    * 00014800
.* THIS MACRO IS USED TO HANDLE PUT/GET/ETC REQUESTS TO THE CONTROL-O * 00014900
.* REQUEST CHAINS.                                                    * 00015000
.*                                                                    * 00015100
.*  PARAMETERS                                                        * 00015200
.*  ----------                                                        * 00015300
.*                                                                    * 00015400
.*   1  -       FUNC                                                  * 00015500
.*              POSITIONAL PARAMETER                                  * 00015600
.*              THE DESIRED FUNCTION. VALID VALUES ARE:               * 00015700
.*                                    PUT      (CONNECT)              * 00015800
.*                                    GET      (DISCONNECT)           * 00015900
.*                                    MASSPUT  (MASSIVE PUT)          * 00016000
.*                                    LIST     (WITHOUT DISCONNECTING)* 00016100
.*                                    GETTOP   (IF REQADDR IS TOP)    * 00016200
.*                                    XMHINIT  (SETUP AN AREA AS RQH) * 00016300
.*                                                                    * 00016400
.*   2  -       ANCHOR                                                * 00016500
.*              KEYWORD PARAMETER                                     * 00016600
.*              A-TYPE ADDRESS OR REGISTERS (2)-(12)                  * 00016700
.*              THE ADDRESS OF THE ANCHOR (REQUESTS CHAIN HEADER)     * 00016800
.*                                                                    * 00016900
.*   3  -       REQADDR                                               * 00017000
.*              KEYWORD PARAMETER                                     * 00017100
.*              A-TYPE ADDRESS OR REGISTERS (2)-(12)                  * 00017200
.*              THE ADDRESS OF THE REQUEST                            * 00017300
.*              THIS ADDRESS NORMALLY POINTS TO AN RQC EXCEPT IN THE  * 00017400
.*              CASE OF A MASSPUT OPCODE WHERE THE ADDRESS POINTS     * 00017500
.*              TO ANOTHER ANCHOR (THE ANCHOR OF THE SOURCE CHAIN)    * 00017600
.*                                                                    * 00017700
.*   4  -       QTYPE                                                 * 00017800
.*              KEYWORD PARAMETER                                     * 00017900
.*              A-TYPE ADDRESS OR REGISTERS (2)-(12)                  * 00018000
.*              THE TYPE OF QUEUE (LIFO/FIFO)                         * 00019000
.*              ONLY USED WITH XMHINIT                                * 00020000
.*                                                                    * 00030000
.*   5  -       ID                                                    * 00040000
.*              KEYWORD PARAMETER                                     * 00041000
.*              A-TYPE ADDRESS OR REGISTERS (2)-(12)                  * 00042000
.*              THE ID# FOR THE QUEUE                                 * 00043000
.*              ONLY USED WITH XMHINIT                                * 00044000
.*                                                                    * 00045000
.*  REGISTERS                                                         * 00046000
.*  ----------                                                        * 00047000
.*   REGISTERS 0,1,14,15,11 ARE DESTROYED BY THIS MACRO.              * 00048000
.*                                                                    * 00048100
.********************************************************************** 00048200
.********************************************************************** 00048300
.*       LOGIC CHECKS                                                 * 00048400
.********************************************************************** 00048500
&LABEL   DS    0H                                                       00048600
         PUSH  PRINT                                                    00048700
         PRINT GEN                                                      00048800
         PUSH  USING                                                    00048900
         CTSACHK REQUIRE=(&FUNC,FUNCTION)                               00049000
         CTSACHK VER=(&FUNC,FUNCTION,PUT,GET,LIST,GETTOP,MASSPUT,      +00049100
               XMHINIT)                                                 00049200
         CTSACHK REQUIRE=(&ANCHOR,ANCHOR)                               00049300
         AIF   ('&FUNC' EQ 'XMHINIT').XMHINI                            00049400
         CTSACHK REQUIRE=(&REQADDR,REQADDR)                             00049500
.********************************************************************** 00049600
.*       INITIAL CODE FOR ALL FUNCTIONS                               * 00049700
.********************************************************************** 00049800
.PROC    ANOP                                                           00049900
**********************************************************************  00050000
*                                                                       00060000
         MNOTE 0,'&FUNC FUNCTION '                                      00061000
*                                                                       00061100
* RETURN CODE: (IN R15)                                                 00061200
*    0 - OK                                                             00061300
         AIF   ('&FUNC' EQ 'PUT').SKIP01                                00061400
         AIF   ('&FUNC' EQ 'MASSPUT').SKIP01                            00061500
*    4 - NO ELEMENTS IN CHAIN                                           00061600
.SKIP01  ANOP                                                           00061700
*    8 - ANCHOR IS ZERO OR INVALID                                      00061800
*   12 - INVALID ID WAS DETECTED                                        00061900
         AIF   ('&FUNC' NE 'GETTOP').SKIP03                             00062000
*   16 - ADDRESS DOES NOT MATCH                                         00063000
.SKIP03  ANOP                                                           00064000
*                                                                       00065000
* DESTROYS REGISTERS: R0,R1,R9,R10,R11,R14,R15                          00066000
*                                                                       00067000
**********************************************************************  00068000
.*                                                                      00069000
         AIF   ('&ANCHOR'(1,1) EQ '(').ADDRANC                          00070000
         L     R11,&ANCHOR         R11 -> REQUEST HEADER                00071000
         AGO   .AFTERA                                                  00072000
.ADDRANC ANOP                                                           00073000
         LR    R11,&ANCHOR         R11 -> REQUEST HEADER                00074000
.AFTERA  ANOP                                                           00075000
.*                                                                      00076000
         AIF   ('&REQADDR'(1,1) EQ '(').ADDRREP                         00077000
         L     R15,&REQADDR        R15 -> REQUEST ELEMENT               00078000
         AGO   .AFTERP                                                  00079000
.ADDRREP ANOP                                                           00080000
         LR    R15,&REQADDR        R15 -> REQUEST ELEMENT               00080100
.AFTERP  ANOP                                                           00080200
.*                                                                      00080300
         AIF   ('&FUNC' EQ 'MASSPUT').SKIPUSI                           00080400
         USING RQHSTART,R11        HEADER  ADDRESSABILITY               00080500
         USING RQCSTART,R15        REQUEST ADDRESSABILITY               00080600
.SKIPUSI ANOP                                                           00080700
.********************************************************************** 00080800
.*       PROCESS ACCORDING TO THE FUNCTION                            * 00080900
.********************************************************************** 00081000
         AIF   ('&FUNC' EQ 'PUT').PUT                                   00081100
         AIF   ('&FUNC' EQ 'MASSPUT').MASSPUT                           00081200
         AGO   .GET                                                     00081300
.********************************************************************** 00081400
.*  PUT FUNCTION                                                      * 00081500
.********************************************************************** 00081600
.PUT     ANOP                                                           00081700
         LTR   R11,R11             IS ANCHOR ZERO ?                     00081800
         BZ    ANP0&SYSNDX         YES - ERROR (RC=8)                   00081900
         CLC   =CL4'RQH ',RQHEYE   IS EYECATCHER PRESENT                00082000
         BNE   ANP0&SYSNDX         NO - ERROR (RC=8)                    00082100
         CLI   RQHSTAT,RQHNOTOK    IS CHAIN MARKED AS NOT OK ?          00082200
         BE    ANER&SYSNDX         YES - ERROR (RC=12)                  00082300
*        *------------------------------------------------------------* 00082400
*        SETUP NECESSARY FIELDS ON RQC                                  00082500
*        *------------------------------------------------------------* 00082600
         XC    RQCSTART(4),RQCSTART        NEW REQ IS THE LAST IN CHAIN 00082700
         MVC   RQCID#(L'RQCID#),RQHID#     CHAIN ID                     00082800
*        *------------------------------------------------------------* 00082900
*        INCREMENT # OF PUT OPERATIONS IN RQH                           00083000
*        *------------------------------------------------------------* 00083100
         L     R0,RQHPUTS#                                              00083200
LXLP&SYSNDX EQU   *                                                     00083300
         LR    R10,R0                                                   00083400
         AH    R10,=AL2(1)               +1                             00083500
         CS    R0,R10,RQHPUTS#                                          00083600
         BNZ   LXLP&SYSNDX                                              00083700
*        *------------------------------------------------------------* 00083800
*        LIFO CHAIN                                                     00083900
*        *------------------------------------------------------------* 00084000
         CLI   RQHQTYPE,RQHLIFO    IS IT A LIFO QUEUE ?                 00084100
         BNE   FIFP&SYSNDX         NO, THEN FIFO TREATMENT              00084200
.*                                                                      00084300
         L     R0,RQHTOP                                                00084400
LILP&SYSNDX EQU   *                                                     00084500
         ST    R0,RQCNEXT                                               00084600
         STCK  RQHPUTCK                                                 00084700
         CS    R0,R15,RQHTOP                                            00084800
         BNZ   LILP&SYSNDX                                              00084900
.*                                                                      00085000
         B     UPRV&SYSNDX         GO UPDATE COUNTERS                   00085100
*        *------------------------------------------------------------* 00085200
*        OR FIFO CHAIN                                                  00085300
*        ADJUST TOP/BOTTOM TO NEW VALUE                                 00085400
*        *------------------------------------------------------------* 00085500
FIFP&SYSNDX EQU   *                                                     00085600
         LM    R0,R1,RQHTOP        GET CURRENT TOP AND BOTTOM           00085700
.*                                                                      00085800
LOOP&SYSNDX EQU   *                                                     00085900
         LTR   R14,R0              R14 = CURRENT TOP                    00086000
         BNZ   UPDT&SYSNDX         IF NONZERO, TOP DOES NOT CHANGE      00087000
.*                                                                      00088000
         LR    R14,R15             ELSE IF ZERO, TOP = BOTTOM           00089000
.*                                                                      00090000
UPDT&SYSNDX EQU   *                                                     00100000
         STCK  RQHPUTCK                                                 00101000
         CDS   R0,R14,RQHTOP       SERIALIZED UPDATE OF TOP/BOTTOM      00101100
         BNZ   LOOP&SYSNDX         IF NEEDED, TRY AGAIN                 00101200
*        *------------------------------------------------------------* 00101300
*        FIFO CHAIN                                                     00101400
*        AFTER CHECKING THAT OLD ID# = NEW ID#                          00101500
*        CHAIN OLD LAST TO NEW LAST IF NECESSARY                        00101600
*        *------------------------------------------------------------* 00101700
         LTR   R0,R0               DID A TOP EXIST PREVIOUSLY ?         00101800
         BZ    UPRV&SYSNDX         NO, SKIP                             00101900
.*                                                                      00102000
         CLC   RQCID#,RQCID#-RQCSTART(R1)  IS CHAIN CONSISTENT ?        00103000
         BNE   ANER&SYSNDX                                              00104000
.*                                                                      00105000
         ST    R15,0(R1)           PREVIOUS BOT -> TO NEW BOT RQC       00105100
UPRV&SYSNDX EQU   *                                                     00105200
*        *------------------------------------------------------------* 00105300
*        ADJUST CURRENT NUMBER AND HIGH WATER MARK (HWM)                00105400
*        *------------------------------------------------------------* 00105500
         LM    R0,R1,RQHCURR#      CURRENT COUNTER AND HWM              00105600
LOP2&SYSNDX EQU   *                                                     00105700
         LR    R14,R0              R14  = CURRENT NUMBER OF ENTRIES     00105800
         AH    R14,=AL2(1)               +1                             00105900
.*                                                                      00106000
         L     R15,RQHINIT#                                             00107000
         LTR   R15,R15             IS INITIAL NUMBER 0 ?                00108000
         BNZ   CDS0&SYSNDX         YES, LWM IS NEEDED INSTEAD           00109000
.*                                                                      00110000
         LR    R15,R1              R15 = OLD HWM                        00120000
         CR    R15,R14             IS OLD HWM GOOD ENOUGH ?             00130000
         BH    CDSR&SYSNDX         YES, KEEP OLD VALUE                  00140000
.*                                                                      00150000
         LR    R15,R14             ELSE, SET NEW VALUE                  00160000
         B     CDSR&SYSNDX                                              00170000
.*                                                                      00180000
CDS0&SYSNDX EQU   *                                                     00190000
         LR    R15,R1              R15 = OLD HWM                        00200000
CDSR&SYSNDX EQU   *                                                     00210000
         CDS   R0,R14,RQHCURR#     NEW COUNTER AND HWM                  00220000
         BNZ   LOP2&SYSNDX         IF NEEDED, TRY AGAIN                 00230000
*        *------------------------------------------------------------* 00240000
*        ADJUST COUNTER OF ELEMENTS INSERTED                            00250000
*        *------------------------------------------------------------* 00260000
         L     R0,RQHPUTL#                                              00270000
LZLP&SYSNDX EQU   *                                                     00271000
         LR    R10,R0                                                   00272000
         AH    R10,=AL2(1)               +1                             00273000
         CS    R0,R10,RQHPUTL#                                          00273100
         BNZ   LZLP&SYSNDX                                              00273200
*        *------------------------------------------------------------* 00273300
*        AND EXIT                                                       00273400
*        *------------------------------------------------------------* 00273500
         SLR   R15,R15             PUT ENDED OK                         00273600
         B     ENP&SYSNDX                                               00273700
*        *------------------------------------------------------------* 00273800
*        CHAIN ANCHOR IS ZERO OR INVALID                                00273900
*        *------------------------------------------------------------* 00274000
ANP0&SYSNDX EQU   *                                                     00274100
         LA    R15,8                                                    00274200
         B     ENP&SYSNDX                                               00274300
*        *------------------------------------------------------------* 00274400
*        INVALID ID WAS DETECTED - CHAIN IS IN ERROR                    00274500
*        *------------------------------------------------------------* 00274600
ANER&SYSNDX EQU   *                                                     00274700
         MVI   RQHSTAT,RQHNOTOK    CHAIN MARKED NOT OK                  00274800
         LA    R15,12                                                   00274900
         B     ENP&SYSNDX                                               00275000
*        *------------------------------------------------------------* 00275100
ENP&SYSNDX EQU   *                                                      00275200
         AGO   .MEND                                                    00275300
.********************************************************************** 00275400
.*  MASSPUT FUNCTION                                                  * 00275500
.********************************************************************** 00275600
.MASSPUT ANOP                                                           00275700
         LTR   R11,R11             IS TARGET ANCHOR ZERO ?              00275800
         BZ    MP01&SYSNDX         YES - ERROR (RC=8)                   00275900
         USING RQHSTART,R11        TARGET HEADER ADDRESSABILITY         00276000
         CLC   =CL4'RQH ',RQHEYE   IS EYECATCHER PRESENT ?              00276100
         BNE   MP01&SYSNDX         NO - ERROR (RC=8)                    00276200
         CLI   RQHSTAT,RQHNOTOK    IS CHAIN MARKED AS NOT OK ?          00276300
         BE    MPER&SYSNDX         YES - ERROR (RC=12)                  00276400
         DROP  R11                                                      00276500
*                                                                       00276600
         LTR   R15,R15             IS SOURCE ANCHOR ZERO ?              00276700
         BZ    MP01&SYSNDX         YES - ERROR (RC=8)                   00276800
         USING RQHSTART,R15        SOURCE HEADER ADDRESSABILITY         00276900
         CLC   =CL4'RQH ',RQHEYE   IS EYECATCHER PRESENT ?              00277000
         BNE   MP01&SYSNDX         NO - ERROR (RC=8)                    00278000
         CLI   RQHSTAT,RQHNOTOK    IS CHAIN MARKED AS NOT OK ?          00279000
         BE    MPER&SYSNDX         YES - ERROR (RC=12)                  00280000
.*                                                                      00280100
         CLC   =2F'0',RQHTOP       ARE THERE ENTRIES IN SOURCE CHAIN?   00280200
         BE    MP00&SYSNDX         NO, EXIT WITH RC=0 (NOTHING CHANGE)  00280300
         LR    R9,R15              R9 -> SOURCE ANCHOR                  00280400
         DROP  R15                                                      00280500
.*                                                                      00280600
*        *------------------------------------------------------------* 00280700
*        INCREMENT # OF PUT OPERATIONS IN RQH                           00280800
*        *------------------------------------------------------------* 00280900
         USING RQHSTART,R11        TARGET HEADER ADDRESSABILITY         00281000
         L     R0,RQHPUTS#                                              00281100
LXZP&SYSNDX EQU   *                                                     00281200
         LR    R10,R0                                                   00281300
         AH    R10,=AL2(1)               +1                             00281400
         CS    R0,R10,RQHPUTS#                                          00281500
         BNZ   LXZP&SYSNDX                                              00281600
         DROP  R11                                                      00281700
*        *------------------------------------------------------------* 00281800
*        RESET ANCHOR OF SOURCE CHAIN AND KEEP THE TOP/BOTTOM           00281900
*        *------------------------------------------------------------* 00282000
         USING RQHSTART,R9         SOURCE HEADER ADDRESSABILITY         00282100
         XR    R14,R14                                                  00282200
         XR    R15,R15                                                  00282300
         LM    R0,R1,RQHTOP        CURRENT TOP/BOT                      00282400
MPSA&SYSNDX EQU   *                                                     00282500
         L     R10,RQHCURR#        R10 = CURRENT# OF RQCS               00282600
         STCK  RQHGETCK                                                 00282700
         CDS   R0,R14,RQHTOP       CLEAR TOP/BOT                        00282800
         BNZ   MPSA&SYSNDX         IF NEEDED, TRY AGAIN                 00282900
*                                                                       00283000
.*                                                                      00283100
.*                                                                      00283200
         L     R15,RQHCURR#        R15 = CURRENT NUMBER OF RQC'S        00283300
         LR    R14,R15                                                  00283400
MPC#&SYSNDX EQU   *                                                     00283500
         SR    R14,R10             SUBTRACT AMOUNT AT CDS SWAP          00283600
         CS    R15,R14,RQHCURR#                                         00283700
         BNZ   MPC#&SYSNDX         IF NEEDED, TRY AGAIN                 00283800
*                                                                       00283900
.*                                                                      00284000
.*                                                                      00285000
         L     R15,RQHGETL#        R15 = NUMBER OF GET ELEMENTS         00285100
         LR    R14,R15                                                  00285200
MZZ#&SYSNDX EQU   *                                                     00285300
         AR    R14,R10             ADD AMOUNT AT CDS SWAP               00285400
         CS    R15,R14,RQHGETL#                                         00285500
         BNZ   MZZ#&SYSNDX         IF NEEDED, TRY AGAIN                 00285600
.*                                                                      00285700
         L     R15,RQHGETS#        R15 = NUMBER OF GET OPERATIONS       00285800
         LR    R14,R15             R14 = CURRENT NUMBER OF RQC'S        00285900
MYY#&SYSNDX EQU   *                                                     00286000
         AH    R14,=AL2(1)         SUBTRACT AMOUNT AT CDS SWAP          00286100
         CS    R15,R14,RQHGETS#                                         00286200
         BNZ   MYY#&SYSNDX         IF NEEDED, TRY AGAIN                 00286300
         DROP  R9                                                       00286400
.*                                                                      00286500
         LR    R14,R0              KEEP SOURCE TOP IN R14               00286600
         LR    R15,R1              KEEP SOURCE BOT IN R15               00286700
*        *------------------------------------------------------------* 00286800
*        CHANGE ID OF ENTRIES IN SOURCE CHAIN WITH TARGET CHAIN ID.     00286900
*        *------------------------------------------------------------* 00287000
         XR    R9,R9               R9 = 0 (CLEAR # OF RQCS ADDED)       00287100
         LR    R1,R0               R1 = -> TOP OF SOURCE CHAIN          00287200
.*                                                                      00287300
MPL#&SYSNDX EQU   *                                                     00287400
         USING RQCSTART,R1         ON-HAND RQC ADDRESSABILITY           00287500
         USING RQHSTART,R11        TARGET HEADER ADDRESSABILITY         00287600
.*                                                                      00287700
         MVC   RQCID#(L'RQCID#),RQHID#    SET NEW ID TO                 00287800
.*                                                                      00287900
         LR    R0,R1               KEEP ADDRESS OF LAST ON-HAND RQC     00288000
         LA    R9,1(R9)            ADD 1 TO NUMBER OF ADDED RQCS        00288100
         L     R1,RQCNEXT          POINT TO NEXT RQC                    00288200
         LTR   R1,R1               ARE THERE MORE ENTRIES IN CHAIN ?    00288300
         BZ    MPLX&SYSNDX         NO, EXIT LOOP                        00288400
.*                                                                      00288500
         B     MPL#&SYSNDX         AND LOOP                             00288600
         DROP  R1,R11              DROP ADDRESSABILITY                  00288700
.*                                                                      00288800
MPLX&SYSNDX EQU   *                                                     00288900
*        *------------------------------------------------------------* 00289000
*        LIFO CHAIN                                                     00289100
*        *------------------------------------------------------------* 00289200
         USING RQHSTART,R11        TARGET HEADER ADDRESSABILITY         00289300
.*                                                                      00289400
         CLI   RQHQTYPE,RQHLIFO    IS IT A LIFO QUEUE ?                 00289500
         BNE   MPFP&SYSNDX         NO, THEN FIFO TREATMENT              00289600
.*                                                                      00289700
         LR    R1,R0               ADDREESS OF LAST RQC ON-HAND         00289800
         L     R0,RQHTOP                                                00289900
MPLP&SYSNDX EQU   *                                                     00290000
         ST    R0,RQCNEXT-RQCSTART(R1)  CHAIN SOURCE AFTER TARGET       00290100
         STCK  RQHPUTCK                                                 00290200
         CS    R0,R14,RQHTOP                                            00290300
         BNZ   MPLP&SYSNDX                                              00290400
.*                                                                      00290500
         B     MPRV&SYSNDX         GO UPDATE COUNTERS                   00290600
*        *------------------------------------------------------------* 00290700
*        OR FIFO CHAIN                                                  00290800
*        ADJUST TOP/BOTTOM TO NEW VALUE                                 00290900
*        *------------------------------------------------------------* 00291000
MPFP&SYSNDX EQU   *                                                     00291100
         LR    R10,R14             R10 = TOP OF SOURCE                  00291200
         LM    R0,R1,RQHTOP        GET CURRENT TOP AND BOTTOM           00291300
.*                                                                      00291400
MPLZ&SYSNDX EQU   *                                                     00291500
         LTR   R14,R0              TARGET TOP                           00291600
         BNZ   MPUP&SYSNDX         IF NONZERO, TOP DOES NOT CHANGE      00291700
.*                                                                      00291800
         LR    R14,R10             ELSE ,TOP = TOP OF SOURCE            00291900
.*                                                                      00292000
MPUP&SYSNDX EQU   *                                                     00292100
         STCK  RQHPUTCK                                                 00292200
         CDS   R0,R14,RQHTOP       SERIALIZED UPDATE OF TOP/BOTTOM      00292300
         BNZ   MPLZ&SYSNDX         IF NEEDED, TRY AGAIN                 00292400
*        *------------------------------------------------------------* 00292500
*        FIFO CHAIN                                                     00292600
*        AFTER CHECKING THAT OLD ID# = NEW ID#                          00292700
*        CHAIN OLD LAST TO NEW LAST IF NECESSARY                        00292800
*        *------------------------------------------------------------* 00292900
         LTR   R0,R0               DID A TOP EXIST PREVIOUSLY ?         00293000
         BZ    MPRV&SYSNDX         NO, SKIP                             00293100
.*                                                                      00293200
.*                                 IS CHAIN CONSISTENT ?                00293300
         CLC   RQCID#-RQCSTART(L'RQCID#,R14),RQCID#-RQCSTART(R1)        00293400
         BNE   MPER&SYSNDX                                              00293500
.*                                                                      00293600
         ST    R10,0(R1)            PREVIOUS BOT -> TO SOURCE TOP RQC   00293700
MPRV&SYSNDX EQU   *                                                     00293800
*        *------------------------------------------------------------* 00293900
*        ADJUST CURRENT NUMBER AND HIGH WATER MARK (HWM)                00294000
*        *------------------------------------------------------------* 00294100
         LM    R0,R1,RQHCURR#      CURRENT COUNTER AND HWM              00294200
MPL2&SYSNDX EQU   *                                                     00294300
         LR    R14,R0              R14  = CURRENT NUMBER OF ENTRIES     00294400
         AR    R14,R9                     + ENTRIES IN SOURCE CHAIN     00294500
.*                                                                      00294600
         L     R15,RQHINIT#                                             00294700
         LTR   R15,R15             IS INITIAL NUMBER 0 ?                00294800
         BNZ   MPS0&SYSNDX         YES, LWM IS NEEDED INSTEAD           00294900
.*                                                                      00295000
         LR    R15,R1              R15 = OLD HWM                        00295100
         CR    R15,R14             IS OLD HWM GOOD ENOUGH ?             00295200
         BH    MPSR&SYSNDX         YES, KEEP OLD VALUE                  00295300
.*                                                                      00295400
         LR    R15,R14             ELSE, SET NEW VALUE                  00295500
         B     MPSR&SYSNDX                                              00295600
.*                                                                      00295700
MPS0&SYSNDX EQU   *                                                     00295800
         LR    R15,R1              R15 = OLD HWM                        00295900
MPSR&SYSNDX EQU   *                                                     00296000
         CDS   R0,R14,RQHCURR#     NEW COUNTER AND HWM                  00296100
         BNZ   MPL2&SYSNDX         IF NEEDED, TRY AGAIN                 00296200
*        *------------------------------------------------------------* 00296300
*        ADJUST COUNTER OF ELEMENTS INSERTED                            00296400
*        *------------------------------------------------------------* 00296500
         L     R0,RQHPUTL#                                              00296600
LZLP&SYSNDX EQU   *                                                     00296700
         LR    R10,R0                                                   00296800
         AR    R10,R9                     + ENTRIES IN SOURCE CHAIN     00296900
         CS    R0,R10,RQHPUTL#                                          00297000
         BNZ   LZLP&SYSNDX                                              00297100
*        *------------------------------------------------------------* 00297200
*        AND EXIT                                                       00297300
*        *------------------------------------------------------------* 00297400
MP00&SYSNDX EQU   *                                                     00297500
         SLR   R15,R15             MASSPUT ENDED OK                     00297600
         B     MPP&SYSNDX                                               00297700
*        *------------------------------------------------------------* 00297800
*        CHAIN ANCHOR IS ZERO OR INVALID                                00297900
*        *------------------------------------------------------------* 00298000
MP01&SYSNDX EQU   *                                                     00298100
         LA    R15,8                                                    00298200
         B     MPP&SYSNDX                                               00298300
*        *------------------------------------------------------------* 00298400
*        INVALID ID WAS DETECTED - CHAIN IS IN ERROR                    00298500
*        *------------------------------------------------------------* 00298600
MPER&SYSNDX EQU   *                                                     00298700
         MVI   RQHSTAT,RQHNOTOK    CHAIN MARKED NOT OK                  00298800
         LA    R15,12                                                   00298900
         B     MPP&SYSNDX                                               00299000
*        *------------------------------------------------------------* 00299100
MPP&SYSNDX EQU   *                                                      00299200
         AGO   .MEND                                                    00299300
.********************************************************************** 00299400
.*  GET FUNCTION                                                      * 00299500
.********************************************************************** 00299600
.GET     ANOP                                                           00299700
         LTR   R11,R11             IS ANCHOR ZERO ?                     00299800
         BZ    ANG0&SYSNDX         YES - ERROR (RC=8)                   00299900
         CLC   =CL4'RQH ',RQHEYE   IS EYECATCHER PRESENT                00300000
         BNE   ANG0&SYSNDX         NO - ERROR (RC=8)                    00300100
         CLI   RQHSTAT,RQHNOTOK    IS CHAIN MARKED AS NOT OK ?          00300200
         BE    A2ER&SYSNDX         YES - ERROR (RC=12)                  00300300
*        *------------------------------------------------------------* 00300400
*        CHECK IF FREE ELEMENT EXISTS                                   00300500
*        *------------------------------------------------------------* 00300600
LPGT&SYSNDX EQU   *                                             BO0442  00300700
         LM    R0,R1,RQHTOP        GET CURRENT TOP AND BOTTOM           00300800
LPRD&SYSNDX EQU   *                                                     00300900
         LTR   R0,R0               ANY FREE ELEMENT ?                   00301000
         BZ    NOFR&SYSNDX         NO - ERROR                           00302000
.*                                                                      00302100
         LR    R14,R0              R14 = CURRENT TOP                    00302200
         L     R10,0(R14)                                       BO0442  00302300
         CS    R0,R14,RQHTOP       RQHTOP                       BO0442  00302400
         BNZ   LPGT&SYSNDX                                      BO0442  00302500
.*       ************************************************************** 00302600
         AIF   ('&FUNC' NE 'GETTOP').SKIP05                             00302700
*        *------------------------------------------------------------* 00302800
*        CHECK IF THE ADDRESS OF THE REQUEST MATCHES PASSED ADDRESS     00302900
*        *------------------------------------------------------------* 00303000
         CR    R15,R0              ADDRESS OF REQUEST = TOP ?           00303100
         BNE   NOMT&SYSNDX         NO, SET RC=16                        00303200
.SKIP05  ANOP                                                           00303300
.*       ************************************************************** 00303400
         AIF   ('&FUNC' NE 'LIST').DECHAIN                              00303500
*        *------------------------------------------------------------* 00303600
*        CHECK IF WE NEED TO RETURN THE TOP OF CHAIN OR NEXT ON CHAIN   00303700
*        *------------------------------------------------------------* 00303800
         LTR   R15,R15             WAS AN ADDRESS OF REQUEST PROVIDED ? 00303900
         BZ    TOPL&SYSNDX         YES, TOP WAS REQUESTED               00304000
.*                                                                      00304100
         L     R15,RQCNEXT         GET ADDRESS OF NEXT RQC              00304200
.*                                                                      00304300
         LTR   R15,R15             DOES NEXT RECORD EXIST ?             00304400
         BZ    NOFR&SYSNDX         NO,  RC = 4                          00304500
.*                                                                      00304600
         LR    R0,R15                                                   00304700
         CLC   RQHID#,RQCID#-RQCSTART(R15)  DOES ID# MATCH ?            00304800
         BNE   NOFR&SYSNDX         NO,  RC = 4                          00304900
.*                                                                      00305000
TOPL&SYSNDX EQU   *                                                     00306000
.DECHAIN ANOP                                                           00307000
.*       ************************************************************** 00308000
         AIF   ('&FUNC' EQ 'LIST').NOTDECH                              00309000
*        *------------------------------------------------------------* 00310000
*        DECHAIN THE REQUEST ELEMENT FROM GIVEN CHAIN                   00320000
*        *------------------------------------------------------------* 00330000
         LR    R15,R1              R15 = CURRENT BOT (0 FOR LIFO)       00331000
*BO0442  L     R14,0(R14)          R14 -> NEXT ELEMENT                  00332000
*BO0442  LTR   R14,R14             WAS THIS THE LAST ELEMENT ?          00333000
         LTR   R14,R10             WAS THIS THE LAST ELEMENT ?  BO0442  00334000
         BNZ   MOVA&SYSNDX         NO - JUST MOVE THE ADDRESS           00335000
.*                                                                      00336000
         CLI   RQHQTYPE,RQHLIFO    IS IT A LIFO QUEUE ?                 00337000
         BE    MOVA&SYSNDX         YES - JUST MOVE THE ADDRESS          00338000
.*                                                                      00338100
         CR    R0,R1               TOP EQUALS BOT (ONLY ONE ELEMENT)?   00338200
         BNE   NOFR&SYSNDX         NO - SOMEONE DOESN'T FINISH CHAINING 00338300
.*                                                                      00338400
         SR    R15,R15             YES, ALSO SET BOTTOM = 0             00338500
MOVA&SYSNDX EQU   *                                                     00338600
         STCK  RQHGETCK                                                 00338700
         CDS   R0,R14,RQHTOP       SERIALIZED UPDATE OF TOP/BOTTOM      00338800
         BNZ   LPRD&SYSNDX         IF NEEDED, TRY AGAIN                 00338900
.*                                                                      00339000
         LR    R15,R0              OLD TOP                              00340000
         CLC   RQHID#,RQCID#-RQCSTART(R15)  DOES ID# MATCH ?            00340100
         BE    CHOK&SYSNDX         YES, GO ON                           00340200
.*                                                                      00340300
         MVI   RQHSTAT,RQHNOTOK    CHAIN MARKED NOT OK                  00340400
.*                                                                      00340500
CHOK&SYSNDX EQU   *                                                     00340600
         MVI   RQCID#,RQHIDO       MARK ORPHAN UNTIL PUT IN FREE CHAIN  00340700
*        *------------------------------------------------------------* 00340800
*        UPDATE THE NUMBER OF GET OPERATIONS                            00340900
*        *------------------------------------------------------------* 00341000
         L     R9,RQHGETL#                                              00341100
LZZP&SYSNDX EQU   *                                                     00341200
         LR    R10,R9                                                   00341300
         AH    R10,=AL2(1)               +1                             00341400
         CS    R9,R10,RQHGETL#                                          00341500
         BNZ   LZZP&SYSNDX                                              00341600
*        *------------------------------------------------------------* 00341700
*        UPDATE THE NUMBER OF GET ELEMENTS                              00341800
*        *------------------------------------------------------------* 00341900
         L     R9,RQHGETS#                                              00342000
LYYP&SYSNDX EQU   *                                                     00342100
         LR    R10,R9                                                   00342200
         AH    R10,=AL2(1)               +1                             00342300
         CS    R9,R10,RQHGETS#                                          00342400
         BNZ   LYYP&SYSNDX                                              00342500
.NOTDECH ANOP                                                           00342600
.*       ************************************************************** 00342700
*        *------------------------------------------------------------* 00342800
*        MOVE REQUEST ELEMENT ADDRESS TO CALLER                         00342900
*        *------------------------------------------------------------* 00343000
         AIF   ('&REQADDR'(1,1) EQ '(').ADDRREG                         00343100
         LA    R15,&REQADDR        R15 -> REQUEST ELEMENT               00343200
         ST    R0,0(R15)           REQADDR = ADDRESS OF CHAIN ELEMENT   00343300
         AGO   .AFTERG                                                  00343400
.ADDRREG ANOP                                                           00343500
         LR    &REQADDR,R0                                              00343600
.AFTERG  ANOP                                                           00343700
.*       ************************************************************** 00343800
         AIF   ('&FUNC' EQ 'LIST').AFTERR1                              00343900
*        *------------------------------------------------------------* 00344000
*        ADJUST COUNTER AND LOW WATER MARK                              00344100
*        *------------------------------------------------------------* 00344200
         LM    R0,R1,RQHCURR#      CURRENT COUNTER AND HWM              00344300
LOP3&SYSNDX EQU   *                                                     00344400
         LR    R14,R0              R14  = CURRENT NUMBER OF ENTRIES     00344500
         SH    R14,=AL2(1)               -1                             00344600
.*                                                                      00344700
         L     R15,RQHINIT#                                             00344800
         LTR   R15,R15             IS INITIAL NUMBER 0 ?                00344900
         BZ    CDSX&SYSNDX         YES, HWM IS NEEDED INSTEAD           00345000
.*                                                                      00345100
         LR    R15,R1              R15 = OLD LWM                        00345200
         CR    R15,R14             IS OLD LWM GOOD ENOUGH ?             00345300
         BL    CDS3&SYSNDX         YES, KEEP OLD VALUE                  00345400
.*                                                                      00345500
         LR    R15,R14             ELSE, SET NEW VALUE                  00345600
         B     CDS3&SYSNDX                                              00345700
.*                                                                      00345800
CDSX&SYSNDX EQU   *                                                     00345900
         LR    R15,R1              R15 = OLD LWM                        00346000
CDS3&SYSNDX EQU   *                                                     00346100
         CDS   R0,R14,RQHCURR#     NEW COUNTER AND HWM                  00346200
         BNZ   LOP3&SYSNDX         IF NEEDED, TRY AGAIN                 00346300
.AFTERR1 ANOP                                                           00346400
.*       ************************************************************** 00346500
*        *------------------------------------------------------------* 00346600
*        CHECK IF PROBLEMS HAPPENED                                     00346700
*        *------------------------------------------------------------* 00346800
         CLI   RQHSTAT,RQHNOTOK    IS CHAIN MARKED NOT OK ?             00346900
         BE    A2ER&SYSNDX         YES, SET RC=12                       00347000
*        *------------------------------------------------------------* 00347100
*        EXIT                                                           00347200
*        *------------------------------------------------------------* 00347300
         SLR   R15,R15                                                  00347400
         B     ENG&SYSNDX                                               00347500
*        *------------------------------------------------------------* 00347600
*        NO FREE ELEMENT FOUND                                          00347700
*        *------------------------------------------------------------* 00347800
NOFR&SYSNDX EQU   *                                                     00347900
         LA    R15,4                                                    00348000
         B     ENG&SYSNDX                                               00349000
.*       ************************************************************** 00350000
         AIF   ('&FUNC' NE 'GETTOP').SKIP07                             00350100
*        *------------------------------------------------------------* 00350200
*        ADDRESSES DOES NOT MATCH (TOP AND REQUEST)                     00350300
*        *------------------------------------------------------------* 00350400
NOMT&SYSNDX EQU   *                                                     00350500
         LA    R15,16                                                   00350600
         B     ENG&SYSNDX                                               00350700
.SKIP07  ANOP                                                           00350800
.*       ************************************************************** 00350900
         AIF   ('&FUNC' NE 'LIST').SKIPEOC                              00351000
*        *------------------------------------------------------------* 00351100
*        END OF LISTED CHAIN                                            00351200
*        *------------------------------------------------------------* 00351300
EOFC&SYSNDX EQU   *                                                     00351400
         LA    R15,16                                                   00351500
         B     ENG&SYSNDX                                               00351600
.SKIPEOC ANOP                                                           00351700
.*       ************************************************************** 00351800
*        *------------------------------------------------------------* 00351900
*        CHAIN ANCHOR IS ZERO OR INVALID                                00352000
*        *------------------------------------------------------------* 00353000
ANG0&SYSNDX EQU   *                                                     00353100
         LA    R15,8                                                    00353200
         B     ENG&SYSNDX                                               00353300
*        *------------------------------------------------------------* 00353400
*        INVALID ID WAS DETECTED                                        00353500
*        *------------------------------------------------------------* 00353600
A2ER&SYSNDX EQU   *                                                     00353700
         LA    R15,12                                                   00353800
         MVI   RQHSTAT,RQHNOTOK    CHAIN MARKED NOT OK                  00353900
         B     ENG&SYSNDX                                               00354000
ENG&SYSNDX EQU   *                                                      00354100
         AGO   .MEND                                                    00354200
.********************************************************************** 00354300
.*  XMHINIT FUNCTION                                                  * 00354400
.********************************************************************** 00354500
.XMHINI  ANOP                                                           00354600
*        *------------------------------------------------------------* 00354700
*        CHECK PARAMETERS AND SETUP REGISTERS                           00354800
*        *------------------------------------------------------------* 00354900
         CTSACHK REQUIRE=(&QTYPE,QTYPE)                                 00355000
         CTSACHK REQUIRE=(&ID,ID)                                       00355100
.*                                                                      00355200
         AIF   ('&ANCHOR'(1,1) EQ '(').INIRANC                          00355300
         L     R11,&ANCHOR         R11 -> REQUEST HEADER                00355400
         AGO   .INIERA                                                  00355500
.INIRANC ANOP                                                           00355600
         LR    R11,&ANCHOR         R11 -> REQUEST HEADER                00355700
.INIERA  ANOP                                                           00355800
.*                                                                      00355900
         AIF   ('&QTYPE'(1,1) EQ '(').QNIRANC                           00356000
         L     R14,&QTYPE          R14 -> QUEUE TYPE (LIFO/FIFO)        00356100
         AGO   .QNIERA                                                  00356200
.QNIRANC ANOP                                                           00356300
         LR    R14,&QTYPE          R14 -> QUEUE TYPE (LIFO/FIFO)        00356400
.QNIERA  ANOP                                                           00356500
.*                                                                      00356600
         AIF   ('&ID'(1,1) EQ '(').IDIRANC                              00356700
         L     R15,&ID             R15 -> CHAIN ID#                     00356800
         AGO   .IDIERA                                                  00356900
.IDIRANC ANOP                                                           00357000
         LR    R15,&ID             R15 -> CHAIN ID#                     00357100
.IDIERA  ANOP                                                           00357200
*        *------------------------------------------------------------* 00357300
*        SET HEADER OF CHAIN                                            00357400
*        *------------------------------------------------------------* 00357500
         USING RQHSTART,R11                                             00357600
         XC    RQHSTART(RQHLEN),RQHSTART CLEAR RQH                      00357700
         MVC   RQHEYE,=CL4'RQH '   SET EYECATCHER                       00357800
         MVC   RQHQTYPE,0(R14)     SET QTYPE (FIFO/LIFO)                00357900
         MVC   RQHID#,0(R15)       SET ID FOR CHAIN                     00358000
         SLR   R15,R15             XMHINIT ENDED OK                     00358100
         DROP  R11                                                      00358200
.*--------------------------------------------------------------------* 00358300
.*  END OF MACRO                                                        00358400
.*--------------------------------------------------------------------* 00358500
.MEND    ANOP                                                           00358600
         POP   USING                                                    00358700
         POP   PRINT                                                    00358800
         MEND                                                           00358900
