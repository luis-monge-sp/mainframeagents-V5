CTSALIB TITLE '   LIBRARY ROUTINE'                                      00030000
**********************************************************************  00040000
*                                                                    *  00050000
*                                                                    *  00060000
*                             CTMLIB                                 *  00070000
*                             -------                                *  00080000
*                                                                    *  00090000
*                       WRITTEN BY YNON RAPOPORT                     *  00100000
*                       CORRECTED BY JOSEPH HOLLANDER                *  00110000
*                                                                    *  00120000
*                                                                    *  00130000
*                                                                    *  00140000
*                                                                    *  00150000
*   FUNCTION:  THIS PROGRAM PROVIDES THE FOLLOWING IO SERVICES       *  00160000
*              1) CHECKING A GIVEN LIBRARY EXIST                     *  00170000
*              2) CHECKING A GIVEN MEMBER  EXIST IN LAST USED  LIB   *  00180000
*              3) ALLOCATE DYNAMICALLY A GIVEN LIBRARY               *  00190000
*              4) OPEN A GIVEN MEMBER IN  LAST USED LIBRARY          *  00200000
*              5) CLOSE  LAST OPENED MEMBER                          *  00210000
*              6) GET A RECORD FROM LAST OPENED MEMBER               *  00220000
*              8) PUT A RECORD IN LAST   OPENED MEMBER               *  00230000
*              9) UNALLOCATING A GIVEN DDNAME                        *  00240000
*              10 WRITE INPLACE A RECORD                             *  00250000
*              11 GET USER DATA OF SPECIFIED  MEMBER.                *  00260000
*              12 PUT USER DATA FOR A SPECIFIED MEMBER.              *  00270000
*                                                                    *  00280000
*                                                                    *  00290000
*   INPUT :    1) A REQUEST IN CHAR: INFO,INIT,FIN,DIR,DIRF,            00300009
*                                    ALLOC,UNALLOC
*                                    INITDSN,ENDDSN,BLDLM,           *  00310009
*                                    OPENMEM,CLOSEMEM,OMEMOUT,CMEMOUT*  00320009
*                                    GET,PUT,EMPCLOSE,GETUDATA,      *  00330009
*                                    PUTUDATA,DMEMOUT TERS WITH      *  00340009
*              2) LIB DSNAME  (44 LETPADDING BLANK TO THE               00350015
*                     RIGHT                                             00360000
*              3) MEMBER NAME IN LIBRARY                                00370000
*              4) ADDR OF RECORD (FOR GET/PUT) RECORDS                  00380000
*              5) DDNAME      (8 CHARS)                                 00390000
*              6) PUT OPT     A-ADD R-REPLACE                           00400001
*              7) NUMBER OF ENTRIES TO READ FOR 'DIR' REQUEST           00400001
*              8) AREA SIZE FOR 'DIRF' REQUEST                   MW1161 00400001
*                                                                       00410000
*   RETURN CODES IN R15             EIN KESHER ...                      00420000
*              0 OPERATION OK                                           00430000
*              4 EOF                                                    00440000
*              8 OPEN ERROR                                             00450000
*             12 INVALID PARM (LIKE DDNAME SPECFIED NOT EXIST)          00460000
*             16 MISSING PARM                                           00470000
*             20 REQUEST NOT SUPPORTED OR MISSPELLED                    00480000
*             24 TOO MANT DSNMES AT THE SAME TIME                       00490000
*             28 ERROR OF CTMLIB , CALL CONTROL M  MEN                  00500000
*             32 NO MEMORY AVAILABLE                                    00510001
*             36 UNEXPECTED ERROR FROM DYNAMIC ALLOCATION               00520000
*             40 STAE CATCH                                             00530000
*             44 MEMBER EXISTS WHEN SHOULDNT AND VICE VERCA ON PUT      00540000
*             MORE                                                      00550000
*-------------------------------------------------------------------*   00560000
* PTF07 02/09/85 FREEPOOL MACRO TO PREVENT ACCOMULATION OF STORAGE  *   00570000
*-------------------P-T-F---1-5-A----------------------------PTF15A-*   00580000
*  B229  02.11.86   BUG WITH A PDS OF GREATER THAN 500 MEMBERS      *   00590000
*-------------------P-T-F---1-6------------------------------PTF16--*   00600000
*  W241  XX.XX.87   SUPPORT FOR PANVALET LIBRARIES                  *   00610000
*  B262  25.05.87   TRAPEXIT CODE CONTAINED INCORRECT COMMAND       *   00620000
*  W240  25.05.87   SUPPORT FOR LIBRARIAN LIBRARIES                 *   00630000
*------------------ V 2.0.0 ---------------------------------V200---*   00640000
*  W442  18.05.88   LET PANVALET DO INCLUDES IF NECESSARY.          *   00650000
*------------------ V 2.1.0 ---------------------------------V210---*   00660000
*  B446  26.10.88   CLOSE THE BLDL DCB BEFORE OPEN (ROSCOE DUMP).   *   00670000
*  B504  18.01.89   HANDLE ERROR CODE FROM PANVALET INCLUDE FUNC.   *   00680000
*------------------ M 3.0.0 ----------------------------------------*   00690012
*  WM407 LN 19.11.90   SUPPORT OF CONCATENATION                     *   00700012
*  BXXXX LN 21.11.90   EXCESSIVE STAE 0 MACRO HAVE BEEN DELETED     *   00710012
*  I0358 DB 04.12.90   ADD SUPPORT FOR LIBRARIAN PS FILES           *   00720015
*  I0361 DB 13.12.90   CHANGE PANVALET/LIBRARIAN TO WXTRN           *   00730015
*  B1326 LN 09.01.91   BYPASS GETMAIN/FREEMAIN FOR BUFFER IF BLK=0  *   00740015
*  B1064 LN 09.01.91   DECREASING NUMBER OF BUFFERS                 *   00750015
*  B1335 LN 26.02.91   FREEPOOL FOR BLDL DCB                        *   00760015
*  BM203 YY 01.03.91   NO SPACE IN LIBRARY AFTER STOW               *   00770015
*-------------------M 3.0.0 - AFTER MAP ----------------------------*   00780015
*  I0358 DB 16.04.91   REMOVAL OF SUPPORT FOR LIBRARIAN PS.         *   00790015
*------------------ M 3.0.2 ----------------------------------------*   00800012
* WM1161 EL 05.08.91   SUPPORT FOR ISPF STATISTICS.                 *   00810015
* MW1161 YG 10.10.92   DIRF REQUEST FOR ISPF STATISTICS.            *   00810015
* BM1575 SB 03.09.91   SECOND OPENMEM DOESN'T BEGIN SEARCH FROM     *   00820015
*                      THE FIRST LIBRARY IN CONCATENATION           *   00830015
* BM1585 LN 15.09.91   CORRECTION   OF BM1575                       *   00840016
* BM1665 YY 15.09.91   INVALID ADDRESSABILITY IN TRAPEXIT           *   00841015
* IM0384 YY 07.10.91   DELETE A MEMBER (STOW).                      *   00800200
*------------------ M 3.0.9 ----------------------------------------*   00800012
* BM2022 LN 17.08.92 DON'T PERFORM ENDDSN IF INITDSN DOESN'T SUCCEED*   00840016
* BM2108 LN 14.12.92 LENGTH FOR DIR ENTRY IS INCORRECT              *   00840016
* **SL** SL 08.02.93 FIX BUG IN OBTAIN                              *   00840016
*------------------ M 5.0.0 ----------------------------------------*   00800012
* GEM--- YG 27.06.93 SUPPORT FOR GEM LIBRARIES. ALSO GEM+--, GEM++- *
* WI0378 SL 17.11.93 SUPPORT OPTION CANCEL IN OMEMOUT               *
* BI0543 YG 07.08.94 USE SEPARATE WORKAREA FOR EVERY LIBRARIAN FILE *
* WI0847 LN 28.03.95 POSSIBILITY TO READ/WRITE ABOVE THE LINE       *
* WI0880 LN 24.05.95 SUPPORT LIBRARIAN -INC STATEMENT               *
* II0231 HT 07.06.95 CHANGE CTMLEVEL TO IOALEVEL                    *
* WI0550 YG 21.02.96 LONG MEMBER NAMES IN PANVALET                  *
*-------------------- 5.1.0 ----------------------------------------*   00800012
* BI0967 LN 26.06.96 S0C4 (RC40) FOR NON-FIRST LIBRARY IN AMODE=31  *
* BD3917 LN 26.06.96 EXTRACT DOES NOT WORK IN MVS/XA IN RMODE=ANY   *
*IS10188 AL 06.10.24 MOVE OUR MODULES ABOVE 16M LINE                *
*********************************************************************   00850000
               EJECT                                                    00860000
               MACRO                                                    00870000
               LIBTYPE   &TYPE=                                         00880000
               GBLC      &LIBTYP(30)                                    00890000
               GBLA      &NUMTYP                                        00900000
*                                                                       00910000
***    THE   MACRO   DEFINE  A  DSN  TYPE  IT DEALS  WITH               00920000
*                                                                       00930000
&LIBTYP(&NUMTYP+1)    SETC   '&TYPE'                                    00940000
&NUMTYP        SETA    &NUMTYP+1                                        00950000
               AIF     (&NUMTYP   LT   30).END                          00960000
               MNOTE   12,'TOO MANY TYPES OF LIB'                       00970000
.END           MEND                                                     00980000
               SPACE  5                                                 00990000
               MACRO                                                    01000000
&NAME          LIBACT   &ACT=,&ROUTALL=,&EXCHK=N,&RSET=N       BM1585   01010016
               GBLC      &TYPACT(30),&LIBTYP(30)                        01020000
               GBLA      &NUMACT,&NUMTYP,&MAXLIB                        01030000
               LCLA      &I,&J,&K,&L                                    01040000
               LCLA      &VALUE(30)                                     01050000
               LCLC      &ACT6                                          01060000
*                                                                       01070000
**  THE   MACRO   DEFINES   AN  ACT(OPEN CLOSE)                         01080000
**  AND  WHICH  ROUTINE  DEALS  ACCORDING TO DSN TYPE                   01090000
*                                                                       01100000
               PUSH    PRINT                                            01110000
&TYPACT(&NUMACT+1)   SETC    '&ACT'                                     01120000
         AIF   (K'&ACT GT 6).ACT6                                       01130000
&ACT6    SETC  '&ACT'                                                   01140000
         AGO   .END6                                                    01150000
.ACT6    ANOP                                                           01160000
&ACT6    SETC  '&ACT'(1,6)                                              01170000
.END6    ANOP                                                           01180000
&NUMACT       SETA      &NUMACT+1                                       01190000
               AIF       ('&EXCHK' EQ 'N').CHKADDR                      01200000
               SR     R3,R3                                      WI0847
*    FIND ENTRY DESCRIBES OUR DATA SET                                  01210000
&ACT           L      R2,LIBTABA+4    UPON TABLE OF DSN'S               01220000
               LIBPCHK   5,DDNAME,8,DSCH&SYSNDX                         01230000
               LA     R5,&MAXLIB      MAX NUMBER OF DATASET             01240000
LP&SYSNDX      CLI    0(R2),0         ENTRY IN USE                      01250000
               BE     NE&SYSNDX        NO,TRY NEXT                      01260000
               ICM    R3,7,1(R2)        UPON ENTRY OF DSN        WI0847 01270000
               CLC    DDNAME,LIBDCDDN FOUND AS DDNAME?                  01280000
               BE     FOU&SYSNDX      NOW R3 POINTS THE ENTRY           01290000
NE&SYSNDX      LA     R2,4(R2)        NEXT ENTRY OF DSNAMES             01300000
               BCT    R5,LP&SYSNDX    TRY ANOTHER ENTRY                 01310000
*              WTO    'REQUESTED  DDNAME NOT IN TABLE'                  01320000
               B      INVPARM         RC OF INVLAID PARM                01330000
DSCH&SYSNDX    LIBPCHK   2,DSNAME,44,MISSING                            01340000
               LA     R5,&MAXLIB      MAX NUMBER OF DATASET             01350000
LP&SYSNDX.1    ICM    R3,7,1(R2)        UPON ENTRY OF DSN        WI0847 01270000
               CLC    DDNAME,LIBDCDSN FOUND AS DDNAME?                  01370000
               BE     FOU&SYSNDX      NOW R3 POINTS THE ENTRY           01380000
               LA     R2,4(R2)        NEXT ENTRY OF DSNAMES             01390000
               BCT    R5,LP&SYSNDX.1  TRY ANOTHER ENTRY                 01400000
               B      INVPARM         RC OF INVLAID PARM                01410000
FOU&SYSNDX     EQU    *                                                 01440000
               MVC    DDNAME,LIBODDN MOVE REAL DDNAME           WM407   01450007
               ST     R2,TEADD     ADDR OF DSN IN TS TABLE      WM407   01460005
*              LR     R11,R2                                    WM407   01470005
               AGO   .ALLASK                                            01490000
.CHKADDR       ANOP                                                     01500000
&ACT           EQU   *                                                  01510000
.ALLASK        ANOP                                                  *  01520000
               AIF   ('&RSET' NE 'Y').ROUT                      BM1585  01530016
               BAL   R10,RSETDD                                 BM1585  01580016
.ROUT          AIF   (T'&ROUTALL EQ  'O').SETTAB                        01590000
               B     &ROUTALL        GO HANDLE REQUEST                  01600000
               AGO   .SER                                               01610000
               MEXIT                                                    01620000
.SETTAB        ANOP                                                     01630000
               B     SER&SYSNDX                                         01640000
TB&ACT6        DS    0F                                                 01650015
.LOOPI         ANOP                                                     01660000
&I             SETA  &I+1                                               01670000
               AIF   (&I  GT  N'&SYSLIST).END                           01680000
.LOOPJ         ANOP   LOOP  VERFY KIND OF LIB                           01690000
&J             SETA  &J+1                                               01700000
               AIF   (&J  GT  &NUMTYP).INVLIB                           01710000
               AIF   ('&SYSLIST(&I,1)' EQ '&LIBTYP(&J)').FSUG           01720000
               AGO   .LOOPJ                                             01730000
.INVLIB        ANOP                                                     01740000
               MNOTE  12,'LIB TYPE UNKNOWN'                             01750000
               POP   PRINT                                              01760000
               MEXIT                                                    01770000
.FSUG          ANOP                                                     01780000
               DC    CL4'&SYSLIST(&I,1)',A(&SYSLIST(&I,2))              01790000
&VALUE(&J)     SETA   1                                                 01800000
               AGO   .LOOPI                                             01810000
.END           ANOP                                                     01820000
               DC    X'FF'                                              01830000
.*     CHECK THAT ALL LIB TYPES WHERE LISTED                            01840000
.LOOPK         ANOP                                                     01850000
&K             SETA  &K+1                                               01860000
               AIF   (&K  GT &NUMTYP).CHKNUM    LOOK IF ALL LIBS        01870000
&L             SETA  &L+&VALUE(&K)                                      01880000
               AGO   .LOOPK                                             01890000
.CHKNUM        ANOP                                                     01900000
               AIF   (&L  EQ  &NUMTYP).DS                               01910000
               MNOTE   12,'NOT ALL LIB TYPES WHERE LISTED'              01920000
.DS            ANOP                                                     01930000
               DS    0F          FOR  ALIGNMENT                         01940000
SER&SYSNDX     EQU   *                                                  01950000
               LA    R2,TB&ACT6 ON TABLE                                01960000
LQ&ACT6        CLI   0(R2),X'FF'    CANT BE                             01970000
               BNE   LP&ACT6                                            01980000
               B     CTMLIBER                                           01990007
LP&ACT6        CLC   0(4,R2),LIBDCTYP  CORRECT TYPE                     02000000
               BE    JUMP&SYSNDX                                        02010000
               LA    R2,8(R2)                                           02020000
               B     LQ&ACT6                                            02030000
JUMP&SYSNDX    EQU   *                                                  02040000
               L     R15,4(R2)         TAKE ADDR OF ROUTINE             02050000
               BR    R15               JUMP TO IT                       02060000
               SPACE  3                                                 02070000
               POP   PRINT                                              02080000
               MEXIT                                                    02090000
.SER           ANOP                                                     02100000
SER&SYSNDX     EQU   *                                                  02110000
               POP  PRINT                                               02120000
               MEND                                                     02130000
               SPACE  5                                                 02140000
               MACRO                                                    02150000
&NAME          LIBPCHK   &PARMN,&VAR,&VARLEN,&ERROR                     02160000
*                                                                       02170000
***    THE  MACRO  CHECKS  IF A GIVEN  PARAMETR  GIVEN                  02180000
*                                                                       02190000
               PUSH  PRINT                                              02200000
&NAME          L     R1,PARMADDR                                        02210000
               ICM   R1,B'0111',(4*(&PARMN-1)+1)(R1) VAR  GIVEN?        02220000
               BZ    &ERROR             IF PARM NOT GIVEN               02230000
               MVC   &VAR.(&VARLEN),0(R1)                               02240000
               POP   PRINT                                              02250000
               MEND                                                     02260000
          SPACE  3                                                      02270000
          MACRO                                                         02280000
&NAME     LIBTBGEN                                                      02290000
          GBLC     &TYPACT(30)                                          02300000
          GBLA     &NUMACT                                              02310000
          LCLA     &I                                                   02320000
          PUSH     PRINT                                                02330000
*                                                                       02340000
***   THE  MACRO  GENERATE  THE   ACTS TABLE                            02350000
*                                                                       02360000
          DS       0F                                                   02370000
&NAME     EQU      *                                                    02380000
.LOOP     ANOP                                                          02390000
&I        SETA     &I+1                                                 02400000
          AIF     (&I  GT   &NUMACT).END                                02410000
          DC      CL8'&TYPACT(&I)',A(&TYPACT(&I))                       02420000
          AGO     .LOOP                                                 02430000
.END      ANOP                                                          02440000
          DC      X'FF'                                                 02450000
          POP     PRINT                                                 02460000
          MEND                                                          02470000
          SPACE   5                                                     02480000
          MACRO                                                         02490000
          TRANBYT   &FR=,&FO=,&TO=,&LEN=2                               02500000
          LCLA      &I                                                  02510000
          PUSH    PRINT                                                 02520000
.LOOP    ANOP                                                           02530000
NE&SYSNDX.&I   EQU   *                                                  02540000
&I       SETA     &I+1                                                  02550000
         AIF   (&I  GT   N'&SYSLIST).END                                02560000
         TM    &FR,&SYSLIST(&I,1)                                       02570000
         BNO  NE&SYSNDX.&I                                              02580000
         MVC  &TO.(&LEN),=C'&SYSLIST(&I,2)'                             02590000
         B    &FO                                                       02600000
         AGO  .LOOP                                                     02610000
.END     ANOP                                                           02620000
         POP    PRINT                                                   02630000
         MEND                                                           02640000
         SPACE  5                                                       02650000
         MACRO                                                          02660000
         GIVPARM    &PARMN                                              02670000
         L     R1,PARMADDR                                              02680000
         L     R1,4*(&PARMN-1)(,R1)                                     02690000
         MEND                                                           02700000
**********************************************************************  02710000
         EJECT                                                          02720000
         PRINT GEN                                                      02730000
         IHAPSA ,                                                BD3917
         IKJTCB ,                                                BD3917
TIOT     DSECT                                                          02740002
         IEFTIOT1                                                       02750002
JFCBLIST DSECT                                                          02760000
         IEFJFCBN LIST=YES                                              02770000
         DCBD  DSORG=PS,DEVD=DA                                         02780000
         SPACE 5                                                        02790000
         PRINT GEN                                                      02800000
*        COPY  CTMXMM                                                   02810000
LIBDC    DSECT DESCRIPION OF A SINGLE LIB                               02820007
LIBDCDDN DS    CL8        DDN  CONNECTED WITH LIBRARY                   02830007
LIBDCDSN DS    CL44       LIBRARY NAME                                  02840000
         ORG   LIBDCDSN                                          GEM---
LIBDCLIB DS    CL26       GEM LIBRARY NAME                       GEM---
         DS    CL2                                               GEM---
LIBDCMEM DS    CL16       GEM MEMBER NAME                        GEM---
         ORG   ,                                                 GEM---
LIBDCDCB DS    A          DCB CONNECTED WITH LIBRARY                    02850000
LIBDCTCB DS    A          TCB OF TASK OPENED THAT LIBRARY               02860000
LIBDCJFC DS    A          ADDR OF JFCB CONNECTED WITH LIBRARY           02870000
LIBDCTYP DS    CL4        TYPE OF LIB                                   02880000
LIBDCBLD DS    A          DCB  FOR  BLDL OR LIBRARIAN WORK AREA         02890000
LIBDSORG DS    CL2        DSORG OF LIB                                  02900000
LIBRECFM DS    CL2        RECFM OF LIB                                  02910000
LIBLRECL DS    H          LRECL                                         02920000
LIBBLKSI DS    H          BLOCKSIZE                                     02930000
LIBDCODC DS    A          DCB OUTPUT PROCESS                            02940000
LIBDCBUF DS    A          ADDR OF BUFFER FOR OUTPUT PROCESSING          02950000
LIBDCU#  DS    F          NUMBER OF BYTES USED SO FAR                   02960000
LIBDCTTR DS    F          TTR OF MEMBER                                 02970000
LIBODDN  DS    CL8        REAL DDNAME                           WM407   02980007
LIB#DD   DS    H          CURRENT NUMBER IN CONCATENATION       WM407   02990002
         DS    H          RESERVED (FOR ALIGNMENT)              WM407   03000005
LIBDCLN  EQU   *-LIBDC                                                  03010000
PRJCOM   DS    F          GEM COMMUNICATION AREA                 GEM---
LIBCOM   DS    F          GEM COMMUNICATION AREA                 GEM---
LIBDCGMF DS    X          GEM LIBRARY STATUS FLAGS               GEM---
CATOPEN  EQU   01         GEM PROJECT CATALOG IS OPEN            GEM---
LIBOPEN  EQU   02         GEM LIBRARY IS OPEN                    GEM---
MODFOUND EQU   04         MODULE HAS BEEN FOUND                  GEM---
LBSPARE1 DS    XL3        SPARE                                  GEM---
LBDIRENT DS    300X       GEM DIRECTORY ENTRY                    GEM---
         SPACE  3                                                       03020000
INFOUT   DSECT     DESRIPION  OF A DSN(INFORMATION TO USER)             03030000
INFTYPE  DS    CL4   TYPE OF FILE (PDS,PAN,LIBRARION ETC)               03040000
INFDSORG DS    CL2   DSORG OF FILE                                      03050000
INFRECFM DS    CL2   RECFM OF FILE                                      03060000
INFBLKSI DS    H     BLKSIZE OF FILE                                    03070000
INFLRECL DS    H     LRECL OF FILE                                      03080000
INFDSNAM DS    CL44  DSNAME OF FILE                                     03090000
         SPACE 5                                                        03100000
         SPACE                                                          03110000
         GBLA  &MAXLIB    MAX LIBRARIES OPENED A ONE TIME               03120000
&MAXLIB  SETA  30                                                       03130000
         PRINT GEN                                                      03140000
         TITLE 'CTMLIB MAIN ROUTINE'                                    03150000
CTSALIB  CSECT                                                          03160000
CTSALIB  AMODE 24           MUST BE BELOW THE 16M LINE          IS10188
CTSALIB  RMODE 24           MUST BE BELOW THE 16M LINE          IS10188
         BEGIN *,R12,R11                                                03170005
         CTSEQUR
*                                                                       03180000
*    LEVEL OF THIS MODULE                                               03190000
*                                                                       03200000
         CTSLEVEL                                                       03210005
**********************************************************************  03220000
****                                                              ****  03230000
****       CONTROL-M   RELEASE 2.2.0                              ****  03240005
****                                                              ****  03250000
****       LICENSED MATERIAL - 4TH DIMENSION SOFTWARE LTD.        ****  03260005
****                                                              ****  03270000
**********************************************************************  03280000
         WXTRN  FAIROPN                                         I0361   03300014
         WXTRN  FAIRMOD                                         I0361   03310014
         WXTRN  FAIRCLS                                         I0361   03320014
         WXTRN  FAIRREC                                         I0361   03330014
         WXTRN  POPEN                                           I0361   03340014
         WXTRN  PSRCH                                           I0361   03350014
         WXTRN  PCLOSE                                          I0361   03360014
         WXTRN  PREAD                                           I0361   03370014
         WXTRN  CTMGEM                                           GEM--- 03370014
         NI     FL,255-FL31      ZERO OUT THE FLAG               WI0847
         L      R15,=X'01000000' PUT SOMETHING IN HIGH-ORDER BYT WI0847
         LA     R14,0(R15)       TRY TO NULLIFY IT               WI0847
         CR     R14,R15          IF IT REMAINS                   WI0847
         BNE    MODOK            WE ARE IN AMODE=31              WI0847
         OI     FL,FL31          AMODE=24                        WI0847
MODOK    EQU    *                                                WI0847
*                                                                       03380000
*        SET   NAMES OF ALL KIND OF LIBS                                03390000
*                                                                       03400000
         LIBTYPE   TYPE=PDS        REGULAR PDS                          03410000
         LIBTYPE   TYPE=PAN        PANVALET                   W241      03420000
         LIBTYPE   TYPE=LIB        LIBRARIAN                  W240      03430000
         LIBTYPE   TYPE=GEM        GEM                           GEM---
         ST    R1,PARMADDR         STPRE ADDR OF PARM                   03440000
         SPACE  3                                                       03450000
*                                                                       03460000
*        SOME INITIALIZATIONS                                           03470000
*                                                                       03480000
         MVI   WLIB,0                                           BM1585  03490016
*                                                                       03510000
*        OVERIDE DDNAME WHEN WORKING IN THE SERVER ENVIRONMENT          03520000
*                                                                       03530000
*                                                                       03540000
*        FIND OUT USER REQUEST                                          03550000
*                                                                       03560000
         L     R2,0(R1)            UPON NAME OF REQUEST                 03570000
         LM    R3,R5,=A(ACTTAB,12,ACTTBEND)                             03580000
LOOPCOD  CLC   0(8,R2),0(R3)       REQUEST LOCATED?                     03590000
         BE    GOROUT              YES - GO HANDELE REQUEST             03600000
         BXLE  R3,R4,LOOPCOD       GO CHECK NEXT REQUEST                03610000
         B     INVREQ              UNKNOWN REQUEST                      03620000
         SPACE 3                                                        03630000
*                                                                       03640000
***      JUMP  TO  OUR  ACTION  HANDLE   ROUTINE                        03650000
*                                                                       03660000
GOROUT   EQU   *                                                        03670000
         BAL    R14,AMOD24                                       WI0847
         STAE  TRAPEXIT                                                 03680007
         BAL   R14,AMOD31                                        WI0847
         L     R15,8(R3)                                                03690000
         BR    R15                                                      03700000
         SPACE 3                                                        03710000
RC36     LA    R15,36                                           WM407   03720003
*                                                                       03730000
***      RETURN  TO  CALLER  WITH  RC  IN R15                           03740000
*                                                                       03750000
END      EQU   *                                                        03760000
         ST    R15,KR15                                                 03770000
END1     BAL   R14,AMOD24                                        WI0847 03780015
         STAE  0                                                        03780015
         L     R15,KR15                                                 03790000
ENDNOSTA BAL   R14,AMOD31    SET BACK AMODE=31 IF NEEDED         WI0847 03800000
         BRTRN (15)                                                     03800000
KR15     DS    F                                                        03810000
         TITLE  'CTSALIB : CHECKING IF A GIVEN DSN EXIST'               03820000
         USING  LIBDC,R3                                                03830000
         LIBACT  ACT=LIBCHK,ROUTALL=LOOKEXT,EXCHK=N                     03840000
LOOKEXT  EQU   *                                                        03850000
         LIBPCHK   2,DSNAME,44,MISSING                                  03860000
         BAL   R14,GEMCHECK                                      GEM---
         LTR   R15,R15                                           GEM---
         BZ    END            GEM LIBRARY - NO NEED TO LOCATE    GEM---
         BAL   R14,PVDSNAME   CHECK FOR THE SPECIAL PV FORMAT    WI0550
         LOCATE    LOCLIB                                               03870000
         LTR      R15,R15                                               03880000
         BZ       END                                                   03890000
         LA       R15,4                                                 03900000
         B         END                                                  03910000
         TITLE    'ALLOC  DYNAMICALY A DSN'                             03920000
         LIBACT  ACT=ALLOC,ROUTALL=ALLOCON,EXCHK=N                      03930000
         SPACE    3                                                     03940000
*                                                                       03950000
***      ALLOCATE   DYNAMICALLY  A  USER  REQUSTED  DSNAME              03960000
*                                                                       03970000
ALLOCON  EQU      *                                                     03980000
*        CHECK    USER  GAVE   NAME   OF  FILE                          03990000
         LIBPCHK   2,DSNAME,44,MISSING                                  04000000
         BAL   R14,PVDSNAME   CHECK FOR THE SPECIAL PV FORMAT    WI0550
         SPACE    3                                                     04010000
*                                                                       04020000
***     CHECK   IF  RETURN  DDNAME                                      04030000
*                                                                       04040000
         SR        R5,R5         ASSUME DDNAME RETURNED                 04050000
         LIBPCHK   5,DDNAME,8,MISSING                                   04060000
         BAL   R14,GEMCHECK                                      GEM---
*PRTDBG ' ALLOC DSN=_ DDNAME=_ R15=#',(DSNAME,44,DDNAME,8,?R15)  GEM---
         LTR   R15,R15                                           GEM---
         BNZ   ALLOCON1        NOT A GEM LIBRARY                 GEM---
*           GO INITDSN FOR GEM (FILL A SLOT IN LIB TABLE)        GEM---
         BAL   R14,CKREPEAT                                      GEM---
*PRTDBG ' ALLOC CKREPEAT R15=#',(?R15)                           GEM---
         LTR   R15,R15         FOUND?                            GEM---
         BNZ   END             YES, ERROR                        GEM---
*                                                                GEM---
*        FIND ENTRY IN DSNAME TABLE                              GEM---
*                                                                GEM---
         LA      R5,&MAXLIB    MAX NUMBER OF ENTRIES             GEM---
         L       R2,LIBTABA+4   TABLE OF DSN ENTRIES             GEM---
GEMTSLIB TS      0(R2)                                           GEM---
         BE      GEMFDENT                                        GEM---
         LA      R2,4(R2)                                        GEM---
         BCT     R5,GEMTSLIB                                     GEM---
         B       TOOMANY                                         GEM---
         SPACE   3                                               GEM---
*                                                                GEM---
*    POINT  TO   ENTRY  IN  DSNAMES  TABLE                       GEM---
*                                                                GEM---
GEMFDENT EQU     *                                               GEM---
         SH     R5,=Y(&MAXLIB)                                   GEM---
         LCR    R5,R5         FIND NUM OF ENTRY                  GEM---
         MH     R5,=Y(LIBDCLN+4+DCBLEN+200+DCBLEN1)              GEM---
         A      R5,LIBTABA+8                                     GEM---
         LR     R3,R5                                            GEM---
         STCM  R3,B'0111',1(R2)  KEEP ADDR OF NEW LIBDC WM407    GEM---
         MVC   LIBDCDDN,DDNAME   MOVE DDNAME TO DCB AND LIBDC    GEM---
         MVC   LIBODDN,DDNAME                          WM407     GEM---
         XC    LIB#DD,LIB#DD                           WM407     GEM---
         SPACE   3                                               GEM---
*                                                                GEM---
*   MOVE   OUR  TCB  POINTER  TO  LIBDC                          GEM---
*                                                                GEM---
         L     R1,16                                             GEM---
         L     R1,0(R1)                                          GEM---
         L     R1,0(R1)                                          GEM---
         ST    R1,LIBDCTCB     STORE TCB ADDR                    GEM---
*                                                                GEM---
         MVC   LIBDCTYP,=CL4'GEM'                                GEM---
         MVC   LIBDSORG(2),=C'PO'                                GEM---
         MVC   LIBRECFM(2),=C'FX'                                GEM---
         MVC   LIBLRECL,=H'80'                                   GEM---
         MVC   LIBBLKSI,=H'80'                                   GEM---
         MVC   LIBDCDSN,BLANK                                    GEM---
         MVC   LIBDCDSN,DSNAME                                   GEM+--
         MVI   LIBDCGMF,0          CLEAR FLAG                    GEM---
         SR    R15,R15                                           GEM---
         B     END                                               GEM---
ALLOCON1 DS    0H                                                GEM---
         L         R1,PARMADDR                                          04070000
         LA        R1,0(R1)                                             04080000
         C         R1,=F'1'      RETURNED DDNAME                        04090000
         BE        RETDDN                                               04100000
*        WTO       'NOT   RETURNED  DDNAME'                             04110000
USDDNAM  MVC       ALLDDNAM+6(8),DDNAME                                 04120000
*        XC        ALLRTDDN(2),ALLRTDDN                                 04130000
         LA        R5,1                                                 04140000
         B         H2DAL1                                               04150000
RETDDN   EQU       *                                                    04160000
*        MVC     ALLRTDDN(2),=X'0055' SET  CODE OF RET DDNAME           04170000
*        MVC     ALLDDNAM(2),=X'0000'   NOT  DDNAME                     04180000
         SPACE   3                                                      04190000
*                                                                       04200000
***      MOVE   DSNAME   TO  H2ADL    PARAMETER  AND  CALL  ALLOCATION  04210000
*                                                                       04220000
H2DAL1   MVC   ALLDSNAM+6(44),DSNAME                                    04230000
         MVC   ALLDSNAM+4(2),=Y(44)                                     04240000
         BAL     R10,H2DALA                                             04250000
*WI0550  LTR     R5,R5           RET DDNAME?                            04260000
*WI0550  BNZ     END             NO RETUEN                              04270000
         LTR     R15,R15         ALLOC OK?                              04280000
         BNZ     END                                                    04290000
         L     R1,LIBTABA+4                                      WI0550
         LA    R1,(4*&MAXLIB)(R1)    ON PREFIX TABLE             WI0550
         LA    R0,&MAXLIB     NUMBER OF ENTRIES                  WI0550
PVDDLOOP CLI   0(R1),0        IS IT FREE?                        WI0550
         BNE   PVDDNEXT                                          WI0550
         MVC   0(8,R1),DDNAME MOVE DDNAME                        WI0550
         MVC   8(8,R1),PVPREF MOVE THE PREFIX                    WI0550
         B     RETDD                                             WI0550
PVDDNEXT LA    R1,16(R1)      NEXT ENTRY                         WI0550
         BCT   R0,PVDDLOOP                                       WI0550
         EX    R0,*           SOMETHING'S WRONG HERE             WI0550
RETDD    DS    0H                                                WI0550
         LTR   R5,R5          RET DDNAME?                        WI0550 04260000
         BNZ   END            NO RETURN                          WI0550 04270000
*                                                                       04300000
***   IF  RETURNED  DDNAME  THEN  MOVE  NEW   DDNAME  TO  USER PARM     04310000
*                                                                       04320000
         L       R1,PARMADDR                                            04330000
         L       R1,4*4(R1)      ADDR OF DDNAME PARM                    04340000
*        LH      R5,ALLRTDDN+4   TAKE LENGTH                            04350000
         BCTR    R5,0            FOR EX COMMAND                         04360000
         MVC     0(8,R1),=CL8' '                                        04370000
         B       END                                                    04380000
PVDSNAME DS    0H                                                WI0550
         MVC   TEMPDSN,DSNAME                                    WI0550
         LA    R1,TEMPDSN                                        WI0550
         MVI   PREFL,0        CLEAR PREFIX                       WI0550
         LA    R0,44                                             WI0550
         LA    R15,DSNAME                                        WI0550
ZDSLOOP  DS    0H                                                WI0550
         CLI   0(R1),C'-'     OUR DELIMITER?                     WI0550
         BE    PRGPREF        WE MOVED PREFIX, NOT DSNAME        WI0550
         MVC   0(1,R15),0(1)  MOVE NEXT BYTE                     WI0550
         LA    R15,1(R15)     INCREMENT TARGET PTR               WI0550
ZDSNEXT  LA    R1,1(R1)       INCREMENT SOURCE PTR               WI0550
         BCT   R0,ZDSLOOP                                        WI0550
         BR    R14                                               WI0550
PRGPREF  DS    0H                                                WI0550
         LA    R15,44                                            WI0550
         SR    R15,R0         PREFIX LENGTH                      WI0550
         CH    R15,=H'8'      NO MORE THAN 7 ACCEPTED            WI0550
         BL    STPREF                                            WI0550
         LA    R15,7                                             WI0550
STPREF   STC   R15,PREFL                                         WI0550
         MVC   PREFIX,DSNAME  KEEP PREFIX                        WI0550
         LA    R15,DSNAME     RETURN TO THE BEGINNING            WI0550
         MVC   DSNAME,BLANK                                      WI0550
         B     ZDSNEXT        NOW GO FOR A REAL NAME             WI0550
*OVDDN   MVC     0(*-*,R1),ALLRTDDN+6                                   04390000
         TITLE   'INIT WORKING WITH A DSNAME'                           04400000
         LIBACT  ACT=INITDSN,ROUTALL=INITLIB,EXCHK=N                    04410000
INITLIB  EQU     *                                                      04420000
*                                                                       04430000
***      CHECK  USER   GAVE   DDNAME                                    04440000
*                                                                       04450000
         LIBPCHK  5,DDNAME,8,MISSING                                    04460000
*                                                                GEM---
*        CHECK FOR GEM LIBRARY                                   GEM---
*                                                                GEM---
         BAL   R14,CKREPEAT                                      GEM---
*PRTDBG ' INITLIB LIBDC"_" R15=#',(0(R3),80,?R15)                GEM---
         LTR   R15,R15                                           GEM---
         BZ    NOGEM              NOT FOUND                      GEM---
*  IF FOUND, LIBDC ENTRY IS POINTED TO BY R3                     GEM---
         CLC   LIBDCTYP,=CL4'GEM'                                GEM---
         BNE   NOGEM                                             GEM---
         SR    R15,R15            GEM LIB - INITIALIZED ALREADY  GEM---
         B     END                                               GEM---
NOGEM    DS    0H                                                GEM---
*                                                                       04470000
*        FIND ENTRY IN DSNAME TABLE                                     04480000
*                                                                       04490000
         LA      R5,&MAXLIB    MAX NUMBER OF ENTRIES                    04500000
         L       R2,LIBTABA+4   TABLE OF DSN ENTRIES                    04510000
TSLIB    TS      0(R2)                                                  04520000
         BE      FOUNDENT                                               04530000
         LA      R2,4(R2)                                               04540000
         BCT     R5,TSLIB                                               04550000
         B       TOOMANY                                                04560000
         SPACE   3                                                      04570000
*                                                                       04580000
*    POINT  TO   ENTRY  IN  DSNAMES  TABLE                              04590000
*                                                                       04600000
FOUNDENT EQU     *                                                      04610000
         SH     R5,=Y(&MAXLIB)                                          04620000
         LCR    R5,R5         FIND NUM OF ENTRY                         04630000
         MH     R5,=Y(LIBDCLN+4+DCBLEN+200+DCBLEN1)                     04640000
         A      R5,LIBTABA+8                                            04650000
         LR     R3,R5                                                   04660000
         STCM    R3,B'0111',1(R2)  KEEP ADDR OF NEW LIBDC        WM407  04670007
         EJECT                                                          04680000
*                                                                       04690000
****     EVERY  ENTRY  (POINTED  BY  R3) IS  BUILT:                     04700000
****     LIBDC  FIELDS (DESCIBED  BY  LIBDC  DSECT)                     04710000
****     EX    LIST   FOR  JFCB                                         04720000
****     DCB   FOR  RDJFCB  USE                                         04730000
****     JFCB  FOR  READING  MEMBER  AFTER  MEMBER                      04740000
****     DCB   FOR  BLDL  OF  MEMBERS                                   04750000
****     DCB   FOR  WRITING A MEMBER                                    04760000
*                                                                       04770000
***      MOVE   MODEL   OF  DCB  FOR  READING  MEMBERS                  04780000
*                                                                       04790000
SETADR   EQU    *                                                       04800000
         LA     R4,LIBDCLN(R3)     UPON EXT OF DCB                      04810000
         LA     R6,4(,R4)           ON DCB                              04820000
         LA     R8,DCB              UPON  MODEL                         04830000
         LA     R7,DCBLEN                                               04840000
         LR     R9,R7                                                   04850000
         MVCL   R6,R8                                                   04860000
         LA      R5,4(R4)           R5 POINTS DCB                       04870000
         USING   IHADCB,R5                                              04880000
         ST      R5,LIBDCDCB       STORE DCB IN LIBDC                   04890000
         LA      R1,EODAD                                               04900000
         STCM    R1,B'0111',DCBEODAD+1   STORE EODAD ADDR               04910000
         SPACE   3                                                      04920000
*                                                                       04930000
***     MOVE  JFCB  ADDRESS  TO  DCB  AND  EX  LIST                     04940000
*                                                                       04950000
**    AND OF JFCB                                                       04960000
         LA      R7,DCBLEN(R5)     R7 POINTS AT JFCB                    04970000
         ST      R7,LIBDCJFC                                            04980000
         STCM    R4,B'0111',DCBEXLST+1  STORE ADDR OF EX LIST IN DCB    04990000
         MVI     0(R4),X'87'       SYN ITS A JFCB EXLST                 05000000
         STCM    R7,B'0111',1(R4)  AND SET JFCB ADDR IN EXLST           05010000
**  AND OF DDNAME                                                       05020000
         MVC     LIBDCDDN,DDNAME   MOVE DDNAME TO DCB AND LIBDC         05030000
         MVC     LIBODDN,DDNAME                                 WM407   05040007
         MVC     DCBDDNAM,DDNAME                                        05050005
         XC      LIB#DD,LIB#DD                                  WM407   05060003
         SPACE   3                                                      05070000
*                                                                       05080000
*   MOVE   OUR  TCB  POINTER  TO  LIBDC                                 05090000
*                                                                       05100000
         L       R1,16                                                  05110000
         L       R1,0(R1)                                               05120000
         L       R1,0(R1)                                               05130000
         ST      R1,LIBDCTCB     STORE TCB ADDR                         05140000
         SPACE   3                                                      05150000
*                                                                       05160000
*        AND NOW : DECIDE WHAT KIND OF LIB WE ARE LOOKING AT            05170000
*                                                                       05180000
*  CHECK FOR CONCATENATION                                      WM407   05190002
*                                                               WM407   05200002
*BD3917  EXTRACT TIOTA,FIELDS=TIOT                              WM407   05210002
         L    R1,PSATOLD-PSA       TCB                           BD3917
         L    R1,TCBTIO-TCB(R1)    TIOT                          BD3917
         USING TIOT,R1                                          WM407   05230002
* SEARCH TIOT FOR REQUESTED DDNAME                              WM407   05240002
         SR    R0,R0                                            WM407   05250002
FTIOT    ICM   R0,1,TIOELNGH                                    WM407   05260002
         BE    RC4                                              WM407   05270005
         CLC   TIOEDDNM,DDNAME                                  WM407   05280002
         BE    FNT                                              WM407   05290002
         AR    R1,R0                                            WM407   05300002
         B     FTIOT                                            WM407   05310002
FNT      AR    R1,R0                                            WM407   05330005
         CLI   TIOELNGH,0                                       WM407   05340005
         BE    RDJ                                              WM407   05350005
         CLI   TIOEDDNM,C' '                                    WM407   05360002
         BNE   RDJ                                              WM407   05370002
         DROP  R1                                               WM407   05380002
* CONCATENATED DDCARD                                           WM407   05390002
         MVI   LIB#DD+1,1                                       WM407   05400007
         BAL    R14,AMOD24                                       WI0847
         LA    R0,LIBODDN                                       WM407   05420007
         LA    R1,LIBDCDDN                                      WM407   05430007
         CALL  CTSADAL,((R1),1,(R0),(R7))    FIRST DD-CARD       WM407  05440015
         BAL    R14,AMOD31                                       WI0847
         LTR   R15,R15                                          WM407   05450003
         BNE   RC36                                             WM407   05460003
         B     ARD                                              WM407   05470002
RDJ      RDJFCB  ((5))                                                  05480005
         LTR    R15,R15                                                 05490003
         BNZ   RC4                                              WM407   05500002
ARD      BAL   R10,INITDS                                       WM407   05510003
         B     RC0                                              WM407   05520002
         SPACE 3                                                        05530002
         TITLE   'BLDL FOR SPECIFIC MEMBER EXSISTENCE'                  05540000
         LIBACT   (PDS,PDSBLDL),(PAN,PANBLDL),(LIB,LIBRBLDL),   W240   *05550000
               (GEM,GEMBLDL),                                    GEM---*
               ACT=BLDLM,EXCHK=Y,RSET=Y                  BM1585 W240    05560016
         SPACE 3                                                        05570000
*                                                                       05580000
*    FIND MEMBER FOR PDS                                                05590000
*                                                                       05600000
PDSBLDL  EQU   *                                                        05610000
***   R3  POINTS ENTRY THAT DESCIBES DSN                                05620000
         LIBPCHK 3,BLDLMEM,8,MISSING                                    05630000
         L     R5,LIBDCBLD  POINT TO DCB                                05640000
         BAL   R10,BLDL                                                 05650000
*   PRTDBG ' PDS BLDL DDNAME=_ R15=#',(DDNAME,8,?R15)                   05660000
         LTR   R15,R15                                                  05670000
         BZ    END                                                      05680000
EBLDL    BAL   R10,NEXTDD                                       WM407   05690003
         LTR   R15,R15                                          WM407   05700003
         BE    BLDLM                                            WM407   05710007
RC4      LA    R15,4                                                    05720002
         B     END                                                      05730000
*                                                                GEM---
*    FIND MEMBER FOR GEM                                         GEM---
*                                                                GEM---
GEMBLDL  EQU   *                                                 GEM---
***   R3  POINTS TO THE ENTRY THAT DESCRIBES DSN                 GEM---
         MVC   BLDLMEM,BLANK                                     GEM---
         LIBPCHK 3,BLDLMEM,8,GEMBLD1                             GEM---
GEMBLD1  DS    0H                                                GEM---
         BAL    R14,AMOD24                                       WI0847
         CALL  CTMGEM,        CALL GEM INTERFACE                 GEM---*
               (FINDMEM,      FUNCTION REQUIRED                  GEM---*
               BLDLMEM,       PROJECT DDNAME                     GEM---*
               (3)),VL        DATA SET ENTRY                     GEM---
         BAL    R14,AMOD31                                       WI0847
*PRTDBG ' CALL CTMGEM FINDMEM R15=#',(?R15)                      GEM---
         LTR   R15,R15                                           GEM---
         BZ    END                                               GEM---
         LA    R15,4                                             GEM---
         B     END                                               GEM---
         SPACE 3                                                        05740000
*                                                              WM1161   05750000
*   GET USER DATA FROM DIRECTORY.                              WM1161   05760000
*                                                                       05770015
         TITLE 'BLDL TO GET USER DATA, FOR ISPF STATISTICS'    WM1161   05780015
         LIBACT (PDS,PDSGUDAT),(PAN,PANGUDAT),(LIB,LIBGUDAT),  WM1161  X05790000
               (GEM,GEMGUDAT),                                   GEM---X
               ACT=GETUDATA,EXCHK=YES                          WM1161   05800000
PDSGUDAT EQU   *                                               WM1161   05810000
         LIBPCHK 3,BLDLMEM,8,MISSING   CHECK FOR MEMBER NAME   WM1161   05820000
         LIBPCHK 4,RECA,4,MISSING      CHECK FOR DATA ADDRESS  WM1161   05830000
         L     R5,LIBDCBLD             R5->DCB                 WM1161   05840000
         BAL   R10,BLDL                ISSUE BLDL TO GET DATA  WM1161   05850000
         LTR   R15,R15                 SUCCESS?                WM1161   05860000
         BZ    PDSGUEND                YES: RETURN THE DATA    WM1161   05870000
         LA    R15,4                   NO: SET "NOT FOUND" RC  WM1161   05880002
         B     END                     RETURN TO CALLER        WM1161   05890000
PDSGUEND EQU   *                                               WM1161   05900000
         L     R1,RECA                 R1 ->  DATA ADDRESS     WM1161   05910000
         MVC   0(76,R1),BLDLMEM        MOVE DIR ENTRY TO PARM  WM1161   05920000
         MVC   11(63,R1),13(R1)        REMOVE TWO BYTES        WM1161   05930000
         BAL   R14,AMOD31                                      WI0847
         XR    R15,R15                 SET GOOD RC             WM1161   05940000
         B     END                                             WM1161   05950000
*                                                              WM1161   05960000
PANGUDAT EQU   *                                               WM1161   05970000
         LA    R15,20                  SET "NOT SUPPORTED" RC  WM1161   05980000
         B     END                                             WM1161   05990000
*                                                              WM1161   06000000
LIBGUDAT EQU   *                                               WM1161   06010000
         LA    R15,20                  SET "NOT SUPPORTED" RC  WM1161   06020000
         B     END                                             WM1161   06030000
GEMGUDAT EQU   *                                                 GEM---
         LA    R15,20                  SET "NOT SUPPORTED" RC    GEM---
         B     END                                               GEM---
*                                                              WM1161   06040000
*   PUT USER DATA INTO DIRECTORY.                              WM1161   06050000
*                                                                       06060015
         TITLE 'STOW TO PUT USER DATA, FOR ISPF STATISTICS'    WM1161   06070015
         LIBACT (PDS,PDSPUDAT),(PAN,PANPUDAT),(LIB,LIBPUDAT),  WM1161  X06080000
               (GEM,GEMPUDAT),                                   GEM---X
               ACT=PUTUDATA,EXCHK=YES                          WM1161   06090000
PDSPUDAT EQU   *                                               WM1161   06100000
         LIBPCHK 3,BLDLMEM,8,MISSING   CHECK FOR MEMBER NAME   WM1161   06110000
         LIBPCHK 4,RECA,4,MISSING      CHECK FOR DATA ADDRESS  WM1161   06120000
         L     R5,RECA                 R5 -> DATA ADDRESS      WM1161   06130015
         BAL   R14,AMOD31                                      WI0847
         CLC   BLDLMEM(8),0(R5)        ENSURE NAME INTEGRITY   WM1161   06140015
         BNE   INVPARM                 NO: SAY INVALID PARM    WM1161   06150015
         MVC   BLDLMEM(74),0(R5)       SET THE DIRECTORY ENTRY WM1161   06160017
         BAL   R14,AMOD24                                      WI0847
         L     R5,LIBDCBLD             R5->DCB                 WM1161   06170000
         BAL    R14,AMOD24                                       WI0847
         OPEN  ((5),UPDAT)             OPEN THE LIBRARY        WM1161   06180000
         STOW  (5),BLDLMEM,R           REPLACE DIRECTORY ENTRY WM1161   06190017
         LR    R9,R15                  KEEP RETURN CODE        WM1161   06200000
         CLOSE ((R5))                  CLOSE THE LIBRARY       WM1161   06210000
         BAL    R14,AMOD31                                       WI0847
         LR    R15,R9                  RESTORE RETURN CODE     WM1161   06220015
         B     END                     YES: RETURN TO CALLER   WM1161   06230000
*                                                              WM1161   06240000
PANPUDAT EQU   *                                               WM1161   06250000
         LA    R15,20                  SET "NOT SUPPORTED" RC  WM1161   06260000
         B     END                                             WM1161   06270000
*                                                              WM1161   06280000
LIBPUDAT EQU   *                                               WM1161   06290000
         LA    R15,20                  SET "NOT SUPPORTED" RC  WM1161   06300000
         B     END                                             WM1161   06310000
GEMPUDAT EQU   *                                                 GEM---
         LA    R15,20                  SET "NOT SUPPORTED" RC    GEM---
         B     END                                               GEM---
*                                                                       06320015
*                                                                       06330015
*   LIBRARIAN:  GET INFORMATION ABOUT MODULE (BLDL)             W240    06340000
*                                                               W240    06350000
LIBRBLDL EQU   *                                                W240    06360000
         BAL   R10,LIBRBLD                                      WM407   06370007
         LTR   R15,R15                                          WM407   06380007
         BNE   EBLDL                                            WM407   06390007
         B     END                                              WM407   06400007
LIBRBLD  LIBPCHK 3,BLDLMEM,8,MISSING                            W240    06410007
         L     R5,LIBDCBLD  POINT TO DCB (REMAINS OF PDS)       W240    06420000
         MVC   FAIRMMDN,BLDLMEM      FIX MODULE NAME            W240    06430000
*BI0543  CALL  FAIRMOD,(FAIRWKAR,0,FAIRMMDN,FAIRMOPS),VL        W240    06440000
**       IOATWISH WI0880,TABLE=NO                                WI0880
**       MVC   FAIRMOPS+2(1),IOXXINFC-IOAOZP(R1)                 WI0880
**       DELETE EP=IOAOZP                                        WI0880
         BAL    R14,AMOD24                                       WI0847
         CALL  FAIRMOD,((R5),0,FAIRMMDN,FAIRMOPS),VL             BI0543 06440000
         BAL    R14,AMOD31                                       WI0847
         LTR   R15,R15               NORMAL COMPLETION ?        W240    06450000
         BNZ   LIBRBBAD              IF NOT - SKIP              W240    06460007
         USING MODRES,R1             ESTABLISH ADDRESSABILITY   W240    06470000
         CLI   MODRET,C'0'           FUNCTION COMPLETED OK ?    W240    06480000
*        BE    END                   IF SO - RETURN             W240    06490007
         BER   R10                   IF SO - RETURN             W240    06500007
         DROP  R1                    DROP ADDRESSABILITY        W240    06510000
LIBRBBAD LA    R15,4                 FIX BAD RETURN CODE        W240    06520007
         BR    R10                                              WM407   06530007
*         B     END                   RETURN                     W240   06540003
         SPACE 3                                                        06550000
*                                                                       06560000
*    FIND MEMBER FOR PANVALET                                           06570000
*                                                                       06580000
PANBLDL  EQU   *                                                        06590000
***   R3  POINTS ENTRY THAT DESCIBES DSN                                06600000
         LIBPCHK 3,BLDLMEM,8,MISSING                                    06610000
         L     R5,LIBDCBLD  POINT TO DCB (REMAINS OF PDS JUST IN CASE)  06620000
         XC    ACTION,ACTION                                            06630000
*WI0550  MVC   PANMEM(8),BLDLMEM                                        06640000
         MVC   PANMEM,BLANK           CLEAR...                   WI0550
         MVC   PANMEM(7),LIBDCODC+1   MOVE PREFIX                WI0550
         SR    R15,R15                                           WI0550
         IC    R15,LIBDCODC           FETCH PREF LENGTH          WI0550
         LA    R15,PANMEM(R15)        STEP OVER PREF             WI0550
         MVC   0(8,R15),BLDLMEM       MOVE THE REST IN           WI0550
         BAL    R14,AMOD24                                       WI0847
         CALL  PSRCH,(ACTION,DIRENTRY,PANMEM,BACKUP,COMMENT,SUBSET),VL  06650000
         BAL    R14,AMOD31                                       WI0847
*  PRTDBG ' PAN SRCH MEMNAME=_ R15=# ACTION=#',(BLDLMEM,8,?R15,ACTION)  06660000
         CLC   ACTION(4),=F'23'                                         06670000
*        BE    PANNOMEM                                                 06680003
         B     EBLDL                                            WM407   06690003
         CLC   ACTION(4),=F'0'                                          06700000
         BE    END                                                      06710000
*PANNOMEM LA    R15,4                                                   06720003
*         B     END                                                     06730003
         B     EBLDL                                           WM407    06740003
         TITLE  'OPEN USING A MEMBER FOR GETING'                        06750000
*        LIBACT  (PDS,PDSOPEN),(PAN,PANOPEN),(LIB,LIBRBLDL),    W240    06760007
         LIBACT  (PDS,PDSOPEN),(PAN,PANOPEN),(LIB,LIBROPEN),   WM407   *06770007
               (GEM,GEMOPEN),                                    GEM---*
               ACT=OPENMEM,EXCHK=Y,RSET=Y                BM1585 W240    06780016
PDSOPEN  EQU   *                                                        06790000
*                                                                       06800000
*     CHECK   IF  USER  GAVE   MEMBER  NAME                             06810000
*                                                                       06820000
         LIBPCHK  3,BLDLMEM,8,MISSING                                   06830000
         SPACE    3                                                     06840000
*                                                                       06850000
***      BLDL  IF  USER  MEMBER   EXIST                                 06860000
*                                                                       06870000
         L     R5,LIBDCBLD   POINT TO DCB                               06880000
         BAL   R10,BLDL                                                 06890000
         LTR   R15,R15       OK?                                        06900000
         BNZ   SETRC1                                                   06910000
         SPACE  3                                                       06920000
*                                                                       06930000
*   PREPARE JFCB FOR OPEN TYPE=J                                        06940000
*                                                                       06950000
         L     R7,LIBDCJFC         POINT TO JFCB                        06960000
         USING  INFMJFCB,R7                                             06970015
         MVC   JFCBELNM,BLDLMEM    FIX MEMBER-NAME                      06980000
         OI    JFCBTSDM,JFCNWRIT   DON'T WRITE JFCB BACK DURING OPEN    06990000
         OI    JFCBIND1,JFCPDS     DATA-SET IS A MEMBER OF A PDS        07000000
         SPACE 3                                                        07010000
*                                                                       07020000
*  OPEN   USER   MEMBER                                                 07030000
*                                                                       07040000
         L     R5,LIBDCDCB         POINT  TO  DCB                       07050000
         OPEN  ((5)),TYPE=J        OPEN LIBRARY WITH TYPE=J             07060000
         LTR   R15,R15             OPEN ENDED SUCCESSFULLY?             07070000
         BZ    END                 YES - GO FINISH                      07080000
SETRC1   BAL   R10,NEXTDD                                       WM407   07090007
         LTR   R15,R15                                          WM407   07100007
         BE    OPENMEM                                          WM407   07110007
         LA    R15,4               INDICATE OPEN FAILED                 07120008
         B     END                 GO FINISH                            07130008
*                                                                GEM---
*    OPEN MEMBER FOR GEM                                         GEM---
*                                                                GEM---
GEMOPEN  EQU   *                                                 GEM---
*PRTDBG ' CTMLIB GEMOPEN'                                        GEM---
***   R3  POINTS TO THE ENTRY THAT DESCRIBES DSN                 GEM---
         MVC   BLDLMEM,BLANK                                     GEM---
         LIBPCHK 3,BLDLMEM,8,GEMOPEN1                            GEM---
GEMOPEN1 DS    0H                                                GEM---
         BAL    R14,AMOD24                                       WI0847
         CALL  CTMGEM,        CALL GEM INTERFACE                 GEM---*
               (GEMOMEM,      FUNCTION REQUIRED                  GEM---*
               BLDLMEM,       PROJECT DDNAME                     GEM---*
               (3)),VL        DATA SET ENTRY                     GEM---
         BAL    R14,AMOD31                                       WI0847
*PRTDBG ' CALL CTMGEM OPENMEM R15=#',(?R15)                      GEM---
         LTR   R15,R15                                           GEM---
         BZ    END                                               GEM---
         LA    R15,4                                             GEM---
         B     END                                               GEM---
         SPACE  3                                                       07140000
LIBROPEN BAL   R10,LIBRBLD                                      WM407   07150007
         LTR   R15,R15                                          WM407   07160007
         BNE   SETRC1                                           WM407   07170007
         B     END                                              WM407   07180007
*                                                                       07190000
*   OPEN PANVALET ....HAHAHAHAHA                                        07200000
*                                                                       07210000
PANOPEN  EQU   *                                                        07220000
*                                                                       07230000
*     NO NEED TO OPEN BUT LETS SEE IF MEMBER EXISTS                     07240000
*                                                                       07250000
         LIBPCHK  3,BLDLMEM,8,MISSING                                   07260000
         SPACE    3                                                     07270000
         L     R5,LIBDCBLD  POINT TO DCB (REMAINS OF PDS JUST IN CASE)  07280000
         XC    ACTION,ACTION                                            07290000
*WI0550  MVC   PANMEM(8),BLDLMEM                                        07300000
         MVC   PANMEM,BLANK           CLEAR...                   WI0550
         MVC   PANMEM(7),LIBDCODC+1   MOVE PREFIX                WI0550
         SR    R15,R15                                           WI0550
         IC    R15,LIBDCODC           FETCH PREF LENGTH          WI0550
         LA    R15,PANMEM(R15)        STEP OVER PREF             WI0550
         MVC   0(8,R15),BLDLMEM       MOVE THE REST IN           WI0550
         BAL    R14,AMOD24                                       WI0847
         CALL  PSRCH,(ACTION,DIRENTRY,PANMEM,BACKUP,COMMENT,SUBSET),VL  07310000
         BAL    R14,AMOD31                                       WI0847
*  PRTDBG ' PAN SRCH MEMNAME=_ R15=# ACTION=#',(BLDLMEM,8,?R15,ACTION)  07320000
         CLC   ACTION(4),=F'23'                                         07330000
*        BE    PANOPNM                 PAN VALE MEMBER DOSE NOT EXIST   07340008
         BE    SETRC1             PAN VALE MEMBER DOSE NOT EXIST WM407  07350008
         CLC   ACTION(4),=F'0'                                          07360000
         SR    R15,R15                                                  07370000
         BE    END                                                      07380000
*PANOPNM LA    R15,4                                            WM407   07390007
*        B     END                                              WM407   07400007
         B     SETRC1                                           WM407   07410007
         TITLE  'END WORKING WITH A MEMBER IN DSN'                      07420000
         LIBACT  (PDS,PDSCLOSE),(PAN,PANCLOSE),(LIB,LIBRCLSM),  W240   *07430000
               (GEM,GEMCLOSE),                                   GEM---*
               ACT=CLOSEMEM,EXCHK=Y                             W240    07440000
PDSCLOSE EQU   *                                                        07450000
         L     R5,LIBDCDCB                                              07460000
         BAL    R14,AMOD24                                       WI0847
         CLOSE ((5))                                                    07470000
         FREEPOOL ((5))                                                 07480000
         BAL    R14,AMOD31                                       WI0847
         B     END                                                      07490000
         SPACE  3                                                       07500000
*                                                             W240      07510000
*  LIBRARIAN:  NO CLOSING OF MODULE PERFORMED AT THIS TIME    W240      07520000
*                                                             W240      07530000
LIBRCLSM SR    R15,15             FIX GOOD RC                 W240      07540000
         B     END                RETURN TO CALLER            W240      07550000
         SPACE  3                                                       07560000
*                                                                       07570000
*   CLOSE PANVALET ....HAHAHAHAHA                                       07580000
*                                                                       07590000
PANCLOSE EQU   *                                                        07600000
         SR    R15,R15            WE CLOSE PANVALET ONLY AT END DSN     07610000
         B     END                                                      07620000
*                                                                GEM---
*    OPEN MEMBER FOR GEM                                         GEM---
*                                                                GEM---
GEMCLOSE EQU   *                                                 GEM---
***   R3  POINTS TO THE ENTRY THAT DESCRIBES DSN                 GEM---
         BAL    R14,AMOD24                                       WI0847
         CALL  CTMGEM,        CALL GEM INTERFACE                 GEM---*
               (GEMCLMEM,     FUNCTION REQUIRED                  GEM---*
               0,                                                GEM---*
               (3)),VL        DATA SET ENTRY                     GEM---
         BAL    R14,AMOD31                                       WI0847
*PRTDBG ' CALL CTMGEM CLOSEMEM R15=#',(?R15)                     GEM---
         B     END                                               GEM---
         TITLE  'OPEN MEMBER FOR OUTPUT PRESESING'                      07630000
         LIBACT  (PDS,PDSOOUT),(PAN,PANOOUT),(LIB,LIBROOUT),   W240    *07640000
               (GEM,GEMOOUT),                                    GEM---*
               ACT=OMEMOUT,EXCHK=Y                             W240     07650000
PDSOOUT  EQU   *                                                        07660000
***      MOVE   BUFFER,DCB FOR OUTPUT PROCESSING                 W1064  07670015
*                                                                W1064  07680015
         LA     R0,DCBOLEN                                              07690015
         AH     R0,LIBBLKSI                                             07700015
         GETMAIN  R,LV=(0)                                       W1064  07710015
         ST     R1,LIBDCODC                                      W1064  07720015
         LR     R5,R1                                            W1064  07730015
         L      R15,=A(DCBO)                                     WI0847
         MVC    0(DCBOLEN,R1),0(R15) MOVE MODEL OF DCB           WI0847 07740015
         LA     R1,DCBOLEN(R1)                                   W1064  07750015
         ST     R1,LIBDCBUF                                      W1064  07760015
         XC    LIBDCU#,LIBDCU#                                   W1064  07770015
         USING IHADCB,R5                                                07780000
*        MVC   DCBDDNAM,LIBDCDDN                                        07790007
         MVC   DCBDDNAM,LIBODDN                               WM407     07800007
         OPEN  ((5),OUTPUT)                                             07810000
         LTR   R15,R15                                                  07820000
         BZ    NOTTR                                                    07830000
         LA    R15,4                                                    07840000
         B     END                                                      07850000
NOTTR    EQU   *                                                        07860000
         XC    LIBDCTTR,LIBDCTTR                                        07870000
         B     END                                                      07880000
         SPACE 3                                                        07890000
LIBROOUT EQU   *                                                W240    07900000
         LA    R15,4          INDICATE FUNCTION NOT SUPPORTED   W240    07910000
         B     END            RETURN TO CALLER                  W240    07920000
         SPACE 3                                                        07930000
PANOOUT  EQU   *                                                        07940000
         LA    R15,4                   PAN UPDATE NOT SUPPORTED YET     07950000
         B     END                                                      07960000
GEMOOUT  EQU   *                                                 GEM---
         LA    R15,4             GEM UPDATE NOT SUPPORTED YET    GEM---
         B     END                                               GEM---
         TITLE 'PUT RECORDS ON MEMBER'                                  07970000
         LIBACT  (PDS,PDSPUT),(PAN,PANPUT),(LIB,LIBRPUT),      W240    *07980000
               (GEM,GEMPUT),                                     GEM---*
               ACT=PUT,EXCHK=Y                                 W240     07990000
PDSPUT   EQU   *                                                        08000000
         L     R5,LIBDCODC                                              08010000
         L     R1,PARMADDR                                              08020000
         L     R6,12(R1)                                                08030000
         L     R7,LIBDCU#                                               08040000
         LH    R8,LIBLRECL                                              08050000
         BCTR  R8,0                                                     08060000
         L     R9,LIBDCBUF                                              08070000
         AR    R9,R7                                                    08080000
         BAL   R14,AMOD31                                      WI0847
         EX    R8,MOVREC    MVC   0(*-*,R9),0(R6)    MOVE RECORD        08090000
         BAL   R14,AMOD24                                      WI0847
         AH    R7,LIBLRECL                                              08100000
         CH    R7,LIBBLKSI                                              08110000
         BE    WRITEIT                                                  08120000
         ST    R7,LIBDCU#                                               08130000
         B     ENDPUT                                                   08140000
WRITEIT  EQU   *                                                        08150000
         L     R9,LIBDCBUF                                              08160000
         BAL    R14,AMOD24                                       WI0847
         WRITE  DECBA,SF,(5),(9),'S'                                    08170000
         CHECK  DECBA                                                   08180000
         XC    LIBDCU#,LIBDCU#                                          08190000
         NC    LIBDCTTR,LIBDCTTR                                        08200000
         BNZ   ENDPUT                                                   08210000
         NOTE  ((5))                                                    08220000
         ST    R1,LIBDCTTR                                              08230000
ENDPUT   EQU   *                                                        08250000
         BAL    R14,AMOD31                                       WI0847
         SR    R15,R15                                                  08260000
         B     END                                                      08270000
         SPACE  3                                                       08280000
*                                                            W240       08290000
*  LIBRARIAN:  NO WRITE SUPPORT EXISTS                       W240       08300000
*                                                            W240       08310000
LIBRPUT  LA    R15,4        INDICATE FUNCTION NOT SUPPORTED  W240       08320000
         B     END          RETURN TO CALLER                 W240       08330000
         SPACE 3                                                        08340000
PANPUT   EQU   *                                                        08350000
         LA    R15,4                   PAN UPDATE NOT SUPPORTED YET     08360000
         B     END                                                      08370000
GEMPUT   EQU   *                                                 GEM---
         LA    R15,4             GEM PUT NOT SUPPORTED YET       GEM---
         B     END                                               GEM---
MOVREC   MVC   0(*-*,R9),0(R6)    MOVE RECORD                           08380000
         TITLE   'END OUTPUT PROSSING OF A MEMBER'                      08390000
         LIBACT  (PDS,PDSCOUT),(PAN,PANCOUT),(LIB,LIBRCOUT), W240      *08400000
               (GEM,GEMCOUT),                                    GEM---*
               ACT=CMEMOUT,EXCHK=Y                           W240       08410000
PDSCOUT  EQU   *                                                        08420000
***      LIBPCHK   4,USERAREA,4,MISSING                                 08430000
****     LIBPCHK   6,ADDREP,1,MISSING                                   08440000
         L         R1,PARMADDR                                          08450000
         L         R1,20(R1)                                            08460000
         MVC       ADDREP,0(R1)                                         08470000
         BAL    R14,AMOD24                                       WI0847
         CLI   ADDREP,C'C'         IS IT CANCEL?                 WI0378
         BE    CLOSE1              YES - SKIP WRITING            WI0378
         L     R5,LIBDCODC                                              08480000
         L     R9,LIBDCBUF                                              08490000
         L     R7,LIBDCU#                                               08500000
         LTR   R7,R7                                                    08510000
         BZ    BUFEMP                                                   08520000
         USING IHADCB,R5                                                08530000
         STH   R7,DCBBLKSI                                              08540000
         WRITE  DECBB,SF,(5),(9),'S'                                    08550000
         XC    LIBDCU#,LIBDCU#                                          08560000
         CHECK  DECBB                                                   08570000
BUFEMP   NC    LIBDCTTR,LIBDCTTR                                        08580000
         BNZ   STOWIT                                                   08590000
         NOTE  ((5))                                                    08600000
         ST    R1,LIBDCTTR                                              08610000
STOWIT   XC    KR15,KR15                                         W1064  08620015
         BAL    R14,AMOD31                                       WI0847
         L     R1,PARMADDR                                              08630000
         L     R6,12(R1)                                                08640000
         MVC   8(3,R6),LIBDCTTR+1     MOVE TTR                          08650000
         MVC   AREA2(12),0(R6)                                   WI0847
         BAL    R14,AMOD24                                       WI0847
         CLI   ADDREP,C'A'                                              08660000
         BE    STOWNEW                                                  08670000
         CLI   ADDREP,C'R'                                              08680000
         BE    STOWREP                                                  08690000
         LA    R15,12                                                   08700000
         B     END                                                      08710000
STOWNEW  EQU   *                                                        08720000
         STOW  (5),AREA2,A                                       WI0847 08800000
         LTR   R15,R15                                                  08740000
         BZ    CLOSE1                                            BM203  08750015
         C     R15,=F'4'                                         BM203  08760015
         BE    RC121                MEM EXIST IN LIB             BM203  08770015
         B     RC122                SPACE OR OTHER               BM203  08780015
STOWREP  EQU   *                                                        08790000
         STOW  (5),AREA2,R                                       WI0847 08800000
         LTR   R15,R15                                                  08810000
         BZ    CLOSE1                                                   08820000
         C     R15,=F'8'            CANT BE - CTMMEM CHECK IT    BM203  08830015
         BE    RC121                MEM NOT EXIST IN LIB         BM203  08840015
         B     RC122                SPACE OR OTHER               BM203  08850015
RC122    MVC   KR15,=F'48'                                       BM203  08860015
         B     CLOSE1                                            BM203  08870015
*RC121    CLOSE  ((5))                                           W1064  08880015
RC121    MVC   KR15,=F'44'                                       W1064  08890015
CLOSE1   CLOSE ((R5))                                            W1064  08900015
         LA    R0,DCBOLEN                                        W1064  08910015
         AH    R0,LIBBLKSI                                       W1064  08920015
         FREEMAIN R,LV=(0),A=(5)                                 W1064  08930015
         XC    LIBDCODC,LIBDCODC                                 W1064  08940015
         BAL    R14,AMOD31                                       WI0847
         B     END1                                              W1064  08950015
*        LA    R15,44                                            W1064  08960015
*        B     END                                               W1064  08970015
*CLOSE1   CLOSE  ((5))                                           W1064  08980015
*        B     END                                                      08990015
*                                                              W240     09000000
*   LIBRARIAN:  OUTPUT PROCESSING NOT SUPPORTED                W240     09010000
*                                                              W240     09020000
LIBRCOUT EQU   *                                               W240     09030000
         LA    R15,4      FUNCTION NOT SUPPORTED               W240     09040000
         B     END        RETURN TO CALLER                     W240     09050000
         SPACE 3                                                        09060000
PANCOUT  EQU   *                                                        09070000
         LA    R15,4                   PAN UPDATE NOT SUPPORTED YET     09080000
         B     END                                                      09090000
GEMCOUT  EQU   *                                                 GEM---
         LA    R15,4              NOT SUPPORTED YET              GEM---
         B     END                                               GEM---
         TITLE   'END OUTPUT PROSSING OF A MEMBER (IF X37 OR SO)'       09100000
         LIBACT  (PDS,PDSCEMR),(PAN,PANCEMR),(LIB,LIBRCEMR),    W240   *09110000
               (GEM,GEMCEMR),                                    GEM---*
               ACT=EMRCLOSE,EXCHK=Y                             W240    09120000
PDSCEMR  EQU   *                                                        09130000
         L     R5,LIBDCODC                                              09140000
         LTR   R5,R5                                             W1064  09150015
         BE    EMRC2                                             W1064  09160015
         TM    DCBOFLGS,DCBOFOPN    DATA SET OPEN ??                    09170000
         BZ    EMRC2                                                    09180000
         CLOSE ((5))                                                    09190000
         LA    R0,DCBOLEN                                        W1064  09200015
         AH    R0,LIBBLKSI                                       W1064  09210015
         FREEMAIN R,LV=(0),A=(5)                                 W1064  09220015
         XC    LIBDCODC,LIBDCODC                                 W1064  09230015
EMRC2    L     R5,LIBDCDCB                                              09250000
         BAL    R14,AMOD24                                       WI0847
         TM    DCBOFLGS,DCBOFOPN    DATA SET OPEN ??                    09260000
         BZ    EMRC3                                                    09270000
         CLOSE ((5))                                                    09280000
         FREEPOOL ((5))                                                 09290000
EMRC3    LA    R5,DIRDNAME                                              09300000
         TM    DCBOFLGS,DCBOFOPN    DATA SET OPEN ??                    09310000
         BZ    EMRC4                                                    09320000
         CLOSE ((5))                                                    09330000
         FREEPOOL ((5))                                                 09340000
EMRC4    BAL    R14,AMOD31                                       WI0847
         B     END                                                      09350000
         SPACE 3                                                        09360000
LIBRCEMR EQU   *                                                        09370000
RC0      SR    R15,R15        CLOSING ONLY  ON END DSN        W240      09380002
         B     END                                            W240      09390000
         SPACE 3                                                        09400000
PANCEMR  EQU   *                                                        09410000
         SR    R15,R15        CLOSING ONLY  ON END DSN                  09420000
         B     END                                                      09430000
GEMCEMR  EQU   *                                                 GEM---
         LA    R15,4              NOT SUPPORTED YET              GEM---
         B     END                                               GEM---
         TITLE  'DELETE A MEMBER'                                IM0384 07630000
         LIBACT  (PDS,PDSDMEM),(PAN,PANDMEM),(LIB,LIBRDMEM),     IM0384*07640000
               (GEM,GEMDMEM),                                    GEM---*
               ACT=DMEMOUT,EXCHK=Y                               IM0384 07650000
PDSDMEM  EQU   *                                                 IM0384 07660000
         LIBPCHK 3,BLDLMEM,8,MISSING   CHECK FOR MEMBER NAME     IM0384 06110000
         L     R5,LIBDCBLD             R5->DCB                   IM0384 06170000
         OPEN  ((5),UPDAT)             OPEN THE LIBRARY          IM0384 06180000
         LTR   R15,R15                                           IM0384 07820000
         BZ    DMEMOPND                                          IM0384 07830000
         LA    R15,4                                             IM0384 07840000
         B     END                                               IM0384 07850000
DMEMOPND EQU   *                                                 IM0384 07860000
         BAL    R14,AMOD24                                       WI0847
         STOW  (5),BLDLMEM,D           DELETE THE MEMBER         IM0384 06190017
         BAL    R14,AMOD31                                       WI0847
         LR    R9,R15                  KEEP RETURN CODE          IM0384 06200000
         CLOSE ((R5))                  CLOSE THE LIBRARY         IM0384 06210000
         LR    R15,R9                  RESTORE RETURN CODE       IM0384 06220015
*  PRTDBG ' DEL MEM MEMNAME=_ R15=# ACTION=#',(BLDLMEM,8,?R15,ACTION)   07320000
         LTR   R15,R15                                           IM0384 07820000
         BZ    END                                               IM0384 07830000
         LA    R15,4                                             IM0384 07840000
         B     END                     RETURN TO CALLER          IM0384 06230000
         SPACE 3                                                 IM0384 07890000
PANDMEM  EQU   *                                                 IM0384 07940000
         LA    R15,4          PAN UPDATE NOT SUPPORTED YET       IM0384 07950000
         B     END                                               IM0384 07960000
LIBRDMEM EQU   *                                                 IM0384 07900000
         LA    R15,4          INDICATE FUNCTION NOT SUPPORTED    IM0384 07910000
         B     END            RETURN TO CALLER                   IM0384 07920000
GEMDMEM  EQU   *                                                 GEM---
         LA    R15,4              NOT SUPPORTED YET              GEM---
         B     END                                               GEM---
         SPACE 3                                                 IM0384 07930000
         TITLE  'END WORKING WITH A DSN'                                09440000
*GEM---  LIBACT  ACT=ENDDSN,ROUTALL=ENDLIB,EXCHK=Y
         LIBACT  (PDS,ENDLIB),(PAN,ENDLIB),(LIB,ENDLIB),         GEM---*
               (GEM,GEMENDLB),                                   GEM---*
               ACT=ENDDSN,EXCHK=Y                                GEM---
ENDLIB   EQU   *                                                        09460000
         BAL   R14,ENDDS                                        WM407   09470007
         OC    LIB#DD,LIB#DD                                    WM407   09480007
         BE    NFR                                              WM407   09490007
         LA    R0,LIBODDN                                       WM407   09500007
         CALL  CTSADUN,((R0)),VL                                WM407   09510015
NFR      L     R1,TEADD                                         WM407   09520007
         MVI   0(R1),0      SET  NOT  ALLOCATED                 WM407   09530007
         B     END                                              WM407   09540007
*                                                                GEM---
*    CLOSE GEM LIBRARY                                           GEM---
*                                                                GEM---
GEMENDLB EQU   *                                                 GEM---
***   R3  POINTS TO THE ENTRY THAT DESCRIBES DSN                 GEM---
         CALL  CTMGEM,        CALL GEM INTERFACE                 GEM---*
               (GEMENDDS,     FUNCTION REQUIRED                  GEM---*
               0,                                                GEM---*
               (3)),VL        DATA SET ENTRY                     GEM---
*PRTDBG ' CALL CTMGEM ENDLIB R15=#',(?R15)                       GEM---
         B     NFR                                               GEM---
*                                                               WM407   09550007
         TITLE   'GET  NEXT  RECORD  FROM DATA SET'                     09560000
         LIBACT  (PDS,PDSGET),(PAN,PANREAD),(LIB,LIBRREAD),     W240   *09570000
               (GEM,GEMGET),                                     GEM---*
               ACT=GET,EXCHK=Y                                  W240    09580000
PDSGET   EQU  *                                                         09590000
*                                                                       09600000
*   GETING  A  RECORD    FROM  USER   PDS                               09610000
*                                                                       09620000
         L    R5,LIBDCDCB             DCB                               09630000
         L    R1,PARMADDR                                               09640000
         L    R6,12(R1)               TAKE ADDR                         09650000
         BAL  R14,AMOD24                                         WI0847
         GET  (5)                     GET LOCATE                 WI0847 09660000
         BAL  R14,AMOD31                                         WI0847
         LH   R15,DCBLRECL-IHADCB(R5)     LRECL                  WI0847
         CH   R15,=H'80'                  IS IT MORE THAN 256 ?  WI0847
         BNE  MVCLREC                                            WI0847
         MVC  0(80,R6),0(R1)  MOVE RECORD TO USER BUFFER         WI0847
READOK   BAL  R14,AMOD24                                         WI0847
         SR   R15,R15                                            WI0847 09670000
         B    END                                                WI0847 09680000
MVCLREC  LR   R0,R6                                              WI0847
         LR   R14,R1                                             WI0847
         LR   R1,R15                                             WI0847
         MVCL R0,R14                                             WI0847
         B    READOK                                             WI0847
EODAD    LA   R15,4                                                     09690000
         B    END                                                       09700000
*                                                                GEM---
*    GET A RECORD FROM GEM LIBRARY                               GEM---
*                                                                GEM---
GEMGET   EQU   *                                                 GEM---
***   R3  POINTS TO THE ENTRY THAT DESCRIBES DSN                 GEM---
         L    R5,LIBDCDCB             DCB                        GEM---
         L    R1,PARMADDR                                        GEM---
         L    R6,12(R1)               TAKE ADDR                  GEM---
         BAL    R14,AMOD24                                       WI0847
         CALL  CTMGEM,        CALL GEM INTERFACE                 GEM---*
               (GETLINE,      FUNCTION REQUIRED                  GEM---*
               0,                                                GEM---*
               (3),           DATA SET ENTRY                     GEM---*
               BUFFER),VL     AREA ADDRES                        GEM---
         BAL    R14,AMOD31                                       WI0847
*PRTDBG ' CALL CTMGEM GETLINE R15=#',(?R15)                      GEM---
         MVC   0(80,R6),BUFFER      MOVE RECORD TO BUFFER        WI0847
         B     END                                               GEM---
         SPACE 3                                                        09710000
*                                                                       09720000
*  LIB:  GET (NEXT) RECORD FROM MODULE IN LIBRARY                       09730000
*                                                                       09740000
LIBRREAD EQU   *                                                 W240   09750000
         LIBPCHK 3,BLDLMEM,8,MISSING                             W240   09760000
         L     R5,LIBDCBLD  POINT TO DCB (REMAINS OF PDS)        W240   09770000
*BI0543  CALL  FAIRREC,(FAIRWKAR,0,FAIRROPS),VL                  W240   09780000
         BAL    R14,AMOD24                                       WI0847
         CALL  FAIRREC,((R5),0,FAIRROPS),VL                      BI0543 09780000
         BAL    R14,AMOD31                                       WI0847
         LTR   R15,R15        NORMAL COMPLETION ?                W240   09790000
         BNZ   CTMLIBER       IF NOT - SKIP                      W240   09800000
         USING RECRES,R1      ESTABLISH ADDRESSABILITY           W240   09810000
         CLI   RECRET,C'1'    EOD ENCOUNTED ?                    W240   09820000
         BE    LIBRRED1       IF SO - SKIP                       W240   09830000
         CLI   RECRET,C'0'    GET ENDED SUCCESSFULLY ?           W240   09840000
         BNE   CTMLIBER       IF NOT - SKIP                      W240   09850000
         L     R15,PARMADDR   POINT TO PARAMS                    W240   09860000
         L     R6,12(R15)     POINT TO ANSWER AREA               W240   09870000
         MVC   0(80,R6),RECRECD MOVE NEW RECORD                  W240   09880000
         SR    R15,R15        FIX GOOD RC                        W240   09890000
         B     END            RETURN TO CALLER                   W240   09900000
         DROP  R1             DROP ADDRESSABILITY                W240   09910000
LIBRRED1 LA    R15,4          INDICATE EOD                       W240   09920000
         B     END            RETURN TO CALLER                   W240   09930000
         SPACE 3                                                        09940000
*                                                                       09950000
*  GETING  A  RECORD    FROM  A PANVALET MEMBER                         09960000
*                                                                       09970000
PANREAD  EQU  *                                                         09980000
         LIBPCHK 3,BLDLMEM,8,MISSING                                    09990000
         L     R5,LIBDCBLD  POINT TO DCB (REMAINS OF PDS JUST IN CASE)  10000000
*WI0550  MVC   PANMEM(8),BLDLMEM                                        10010000
         MVC   PANMEM,BLANK           CLEAR...                   WI0550
         MVC   PANMEM(7),LIBDCODC+1   MOVE PREFIX                WI0550
         SR    R15,R15                                           WI0550
         IC    R15,LIBDCODC           FETCH PREF LENGTH          WI0550
         LA    R15,PANMEM(R15)        STEP OVER PREF             WI0550
         MVC   0(8,R15),BLDLMEM       MOVE THE REST IN           WI0550
         MVC   COMMENT(8),SUBSET                                        10020000
         MVC   BACKUP(8),SUBSET                                         10030000
         XC    ACTION,ACTION                                            10040000
         BAL    R14,AMOD24                                       WI0847
         CALL  PREAD,(ACTION,BUFFER,PANMEM,INCLUDE,COMMENT),VL  W442    10050000
         BAL    R14,AMOD31                                       WI0847
*   PRTDBG ' PAN READ MEM=_ R15=# ACTION=#',(PANMEM,10,?R15,ACTION)     10060000
*   PRTDBG ' PAN BUF=_',(BUFFER,80)                                     10070000
         CLC   ACTION(4),=F'0'                                          10080000
*        BNE   CTMLIBER                                   B504          10090000
         BNE   RET08          GO RETURN RC=8              B504          10100000
         CLC   =C'$*',BUFFER                                            10110000
         BE    EODADPAN       END MEMBER                                10120000
         L    R1,PARMADDR                                               10130000
         L    R6,12(R1)               TAKE ADDR                         10140000
         MVC  0(80,R6),BUFFER                                           10150000
         SR   R15,R15                                                   10160000
         B    END                                                       10170000
EODADPAN LA   R15,4                                                     10180000
         B    END                                                       10190000
         TITLE     'UNALLOC A DSNAME'                                   10200000
         LIBACT    ACT=UNALLOC,ROUTALL=UNAL,EXCHK=N                     10210000
UNAL     EQU  *                                                         10220000
         LIBPCHK   5,DDNAME,8,MISSING                                   10230000
         MVC       UNDDNAM+6(8),DDNAME                                  10240000
         BAL       R10,H2DALU                                           10250000
         L     R1,LIBTABA+4                                      WI0550
         LA    R1,(4*&MAXLIB)(R1)    ON PREFIX TABLE             WI0550
         LA    R0,&MAXLIB            NUMBER OF ENTRIES           WI0550
PFLOOP   CLC   0(8,R1),DDNAME        OUR DDNAME?                 WI0550
         BE    CLPREF                                            WI0550
         LA    R1,16(R1)                                         WI0550
         BCT   R0,PFLOOP                                         WI0550
         B     END                                               WI0550
CLPREF   MVI   0(R1),0               CLEAR IT                    WI0550
         B         END                                                  10260000
         TITLE     'BRING  ENTRIES  FROM  DIRECTORY'                    10270000
         LIBACT    (PDS,PDSDIR),(PAN,PANDIR),(LIB,LIBRDIR),    W240    *10280000
               (GEM,GEMDIR),                                     GEM---*
               ACT=DIR,EXCHK=Y                                 W240     10290000
PDSDIR   EQU   *                                                        10300000
* W407   LIBPCHK   5,DDNAME,8,MISSING                                   10310010
         LA        R1,DIRDNAME                                   WI0847
         MVC       40(8,R1),DDNAME                               WI0847 10320000
*        LIBPCHK   6,USERAREA,4,MISSING                                 10330000
*        LIBPCHK   7,NUMENT,4,MISSING                                   10340000
         L         R1,PARMADDR                                          10350000
         MVC       USERAREA,20(R1)                                      10360000
***      MVC       NUMENT,24(R1)  ***PTF16                              10370000
         L         R1,24(R1)      ***PTF16                              10380000
         MVC       NUMENT,0(R1)   ***PTF16                              10390000
         OPEN      (DIRDNAME,INPUT)                                     10400000
         LTR       R15,R15                                              10410000
         BZ        GETDIR                                               10420000
         LA        R15,8                                                10430000
         B         END                                                  10440000
GETDIR   EQU       *                                                    10450000
         SR        R15,R15                                              10460000
         ST        R15,RC                                               10470000
         SR        R8,R8            NUMBER OF ENTRIES                   10480000
         L         R5,USERAREA      ADDR OF USER AREA                   10490000
GETDIR1  EQU       *                                                    10500000
         BAL       R14,AMOD24                                    WI0847
         LA        R2,AREA2                                             10520000
         GET       DIRDNAME,(R2)                                        10510000
         BAL       R14,AMOD31                                    WI0847
         LH        R1,0(R2)         NUMBER OF BYTES USED IN BLOCK       10530000
         LA        R2,2(,R2)                                            10540000
         SH        R1,=Y(2)                                             10550000
MOVINFO  EQU       *                                                    10560000
         CLC       0(8,R2),=8X'FF'                                      10570000
         BE        RETDIR                                               10580000
         MVC       0(11,R5),0(R2)   MOVE NAME AND TTR OF MEMBER  BM2108 10590000
*BM2108  MVC       0(12,R5),0(R2)   MOVE NAME AND TTR OF MEMBER         10590000
*BM2108  NI        11(R5),B'00011111'                                   10600000
*BM2108  SR        R6,R6                                                10610000
*BM2108  ICM       R6,B'0001',11(R5)                                    10620000
         IC        R6,11(R2)      FLAG BYTE                     BM2108
         N         R6,=XL4'1F'    DIR ENTRY LENGTH IN HALFWRDS  BM2108  10430000
         LA        R5,11(R5)                                            10630000
         LA        R9,12(R6,R6)     LENGTH OF ENTRY                     10640000
         AR        R2,R9                                                10650000
         LA        R8,1(R8)                                             10660000
         C         R8,NUMENT                                            10670000
         BNL       RETDIRX       ***PTF16 (ORIGINAL = BH)               10680000
         SR        R1,R9                                                10690000
         BNP       GETDIR1                                              10700000
         B         MOVINFO                                              10710000
RETDIRX  MVC       RC,=F'4'                                             10720000
RETDIR   CLOSE     DIRDNAME                                             10730000
         BAL    R14,AMOD24                                       WI0847
         FREEPOOL  DIRDNAME                                             10740000
         BAL    R14,AMOD31                                       WI0847
         L         R1,PARMADDR                                          10750000
         L         R1,((7-1)*4)(,R1)                                    10760000
         ST        R8,0(R1)       STORE NUMBER OF ENTRIES               10770000
         L         R15,RC                                               10780000
         B         END                                                  10790000
PANDIR   LA    R15,8      PANVALET DIR NOT SUPPORTED YET                10800000
         B     END                                                      10810000
LIBRDIR  LA    R15,8      INDICATE FUNCTION NOT SUPPORTED     W240      10820000
         B     END        RETURN TO CALLER                    W240      10830000
GEMDIR   LA    R15,8      INDICATE FUNCTION NOT SUPPORTED        GEM---
         B     END        RETURN TO CALLER                       GEM---
*              GET DIRECTORY WITH ISPF STATISTICS                MW1161
         LIBACT    (PDS,PDSDIRF),(PAN,PANDIRF),(LIB,LIBRDIRF),   MW1161*10280000
               (GEM,GEMDIRF),                                    GEM---*
               ACT=DIRF,EXCHK=Y                            W240  MW1161 10290000
PDSDIRF  EQU   *                                                 MW1161 10300000
*      THE FOLLOWING CODE READS DIRECTORY AND RETURNS ITS        MW1161
*      CONTENTS AS A LIST OF FIXED LENGTH ENTRIES. EACH ENTRY    MW1161
*      CONTAINS MEMBER NAME AND 26 BYTES OF ISPF STATISTICAL     MW1161
*      DATA CLEARED OF RESERVED FIELDS. IF ORIGINAL USER DATA    MW1161
*      LENGTH IN DIRECTORY ENTRY DIFFERS FROM 30, RETURNED       MW1161
*      STATISTICS AREA WILL CONTAIN HEX ZEROES.                  MW1161
*                                                                MW1161
         LA        R1,DIRDNAME                                   WI0847
         MVC       40(8,R1),DDNAME                               WI0847 10320000
         L         R1,PARMADDR                                   MW1161 10350000
         L     R6,7*4(R1)         LOAD AREA SIZE ADDRESS         MW1161
         L     R6,0(R6)           LOAD AREA SIZE                 MW1161
         MVC       USERAREA,20(R1)                               MW1161 10360000
         L         R1,24(R1)      ***PTF16                       MW1161 10380000
         MVC       NUMENT,0(R1)   ***PTF16                       MW1161 10390000
         OPEN      (DIRDNAME,INPUT)                              MW1161 10400000
         LTR       R15,R15                                       MW1161 10410000
         BZ        GETDIRF                                       MW1161 10420000
         LA        R15,8                                         MW1161 10430000
         B         END                                           MW1161 10440000
GETDIRF  EQU       *                                             MW1161 10450000
         SR        R15,R15                                       MW1161 10460000
         ST        R15,RC                                        MW1161 10470000
         SR        R8,R8            NUMBER OF ENTRIES            MW1161 10480000
         L         R5,USERAREA      ADDR OF USER AREA            MW1161 10490000
GETDIRF1 EQU       *                                             MW1161 10500000
         BAL       R14,AMOD24                                    WI0847
         LA        R2,AREA2                                      MW1161 10520000
         GET       DIRDNAME,(R2)                                 MW1161 10510000
         BAL       R14,AMOD31                                    WI0847
         LH        R1,0(R2)       NUMBER OF BYTES USED IN BLOCK  MW1161 10530000
         LA        R2,2(,R2)                                     MW1161 10540000
         SH        R1,=Y(2)                                      MW1161 10550000
MOVINFOF EQU       *                                             MW1161 10560000
         CLC       0(8,R2),=8X'FF'                               MW1161 10570000
         BE        RETDIRF                                       MW1161 10580000
         IC        R14,11(R2)                                    MW1161 10620000
         N     R14,=F'31'           CLEAR ALL EXCEPT LENGTH BITS MW1161
         LA        R9,12(R14,R14)   LENGTH OF ENTRY              MW1161 10640000
         SH    R6,=H'34'               REMAINED MEMORY           MW1161
         BM    SKIPENTF                                          MW1161
         C         R8,NUMENT                                     MW1161 10670000
         BNL   SKIPENT0                                          MW1161
         LA        R8,1(R8)                                      MW1161 10660000
         MVC   0(8,R5),0(R2)                  MOVE MEMBER NAME   MW1161
         MVC   8(2,R5),12(R2)                 VERSION AND LEVEL  MW1161
         MVC   10(24,R5),16(R2)               REST OF STATISTICS MW1161
         CH    R9,=H'42'              IS IT EXPECTED LENGTH?     MW1161
         BE    STAT1                                             MW1161
         XC    8(26,R5),8(R5)        IF NOT, CLEAR STAT AREA     MW1161
STAT1    DS    0H                                                MW1161
         AH    R5,=H'34'                                         MW1161
*        LA        R8,1(R8)                                      MW1161 10660000
*        C         R8,NUMENT                                     MW1161 10670000
*        BNL       RETDIRXF                                      MW1161 10680000
SKIPENTF AR        R2,R9                                         MW1161 10650000
         SR        R1,R9                                         MW1161 10690000
         BNP       GETDIRF1                                      MW1161 10700000
         B         MOVINFOF                                      MW1161 10710000
SKIPENT0 MVC       RC,=F'4'                                      MW1161 10720000
         B     SKIPENTF                                          MW1161
RETDIRF  CLOSE     DIRDNAME                                      MW1161 10730000
         BAL       R14,AMOD24                                    WI0847
         FREEPOOL  DIRDNAME                                      MW1161 10740000
         BAL       R14,AMOD31                                    WI0847
         L         R1,PARMADDR                                   MW1161 10750000
         L         R2,((7-1)*4)(,R1)                             MW1161 10760000
         ST        R8,0(R2)       STORE NUMBER OF ENTRIES        MW1161 10770000
         L         R2,((8-1)*4)(,R1)                             MW1161 10760000
         ST        R6,0(R2)       UNUSED AREA SIZE               MW1161 10770000
         LA    R15,4                                             MW1161 10770000
         LTR   R6,R6                                             MW1161 10770000
         BM    END                                               MW1161 10780000
         L     R15,RC                                            MW1161 10780000
         B         END                                           MW1161 10790000
PANDIRF  LA    R15,8      PANVALET DIR NOT SUPPORTED YET         MW1161 10800000
         B     END                                               MW1161 10810000
LIBRDIRF LA    R15,8      INDICATE FUNCTION NOT SUPPORTED   W240 MW1161 10820000
         B     END        RETURN TO CALLER                  W240 MW1161 10830000
GEMDIRF  LA    R15,8      INDICATE FUNCTION NOT SUPPORTED        GEM---
         B     END        RETURN TO CALLER                       GEM---
         TITLE     'INIT  WORKING WITH  CTMLIB'                         10840000
         LIBACT   ACT=INIT,ROUTALL=INITWORK,EXCHK=N                     10850000
INITWORK DS    0F                                                       10860000
*                                                                       10870000
***      INIT  OF  CTMLIB  ROUTINE                                      10880000
*                                                                       10890000
****     GETMAIN  FOR  WORK  AREA:  LIBDC'S,DCB'S,JFCBS'                10900015
*                                                                       10910000
****     GETMAIN  AREA FOR  &MAXLIB  DESC AREA                          10920000
         LA    R5,&MAXLIB      MAX NUMBER OF LIBRARIES                  10930000
         MH    R5,=Y(LIBDCLN+4+DCBLEN+200+DCBLEN1)                      10940000
         AH    R5,=Y(4*&MAXLIB) ADD FOR TABLE OF TABLES                 10950000
         AH    R5,=Y(24*&MAXLIB) ADD FOR PV PREFIX TABLE         WI0550 10950000
         GETMAIN  RC,LV=(R5)                                            10960000
         LTR   R15,R15         CHECK RC                                 10970000
         BZ    STMAREA                                                  10980000
         B     NOMEM                                                    10990000
         SPACE  3                                                       11000000
*                                                                       11010000
***      INIT   WORK   AREA :ZERO IT AND  SET POINTERS                  11020000
*                                                                       11030000
STMAREA  EQU   *                                                        11040000
         LR    R0,R5           THE LENGTH IS ACTUALLY IN R5    *B1319   11050015
         STM   R0,R1,LIBTABA                                            11060000
         LR    R3,R0           LENGTH                                   11070000
         LR    R2,R1           AREA                                     11080000
         XR    R15,R15                                                  11090000
         MVCL  R2,R14          ZERO AREA                                11100000
         AH    R1,=Y(4*&MAXLIB)                                         11110000
         AH    R1,=Y(24*&MAXLIB) ADD FOR PV PREFIX TABLE         WI0550 10950000
         ST    R1,LIBTABA+8                                             11120000
         XR    R15,R15                                                  11130000
         B     END                                                      11140000
         TITLE   'FINISH  WORKING WITH CTMLIB'                          11150000
         LIBACT   ACT=FIN,ROUTALL=FINWORK,EXCHK=N                       11160000
*                                                                       11170000
***      FREE  ALLOCATAD  AREA                                          11180000
*                                                                       11190000
FINWORK  LM    R4,R5,LIBTABA                                            11200000
         FREEMAIN  R,LV=(4),A=(5)                                       11210000
         B     END                                                      11220000
         TITLE   'GET  INFORMATION ABOUT A  DSN'                        11230000
         LIBACT   ACT=INFO,ROUTALL=INFOOUT,EXCHK=Y                      11240000
**  R3  POINTS OUR LIBDC                                                11250000
INFOOUT  EQU     *                                                      11260000
         GIVPARM  4                                                     11270000
         USING    INFOUT,R1                                             11280000
*                                                                       11290000
***      MOVE    DSORG,RECFM,BLKSIZE,LRECL,DSN TYPE AND                 11300000
***              NAME  OF  DSN  TO  USER  ARERA                         11310000
*                                                                       11320000
BLK      EQU     *                                                      11330000
         MVC     INFDSORG,LIBDSORG                                      11340000
         MVC     INFRECFM,LIBRECFM                                      11350000
         MVC     INFBLKSI,LIBBLKSI                                      11360000
         MVC     INFLRECL,LIBLRECL                                      11370000
         MVC     INFTYPE,LIBDCTYP                                       11380000
         MVC     INFDSNAM,LIBDCDSN                                      11390000
         SR      R15,R15                                                11400000
         B       END                                                    11410000
         TITLE   'ROUTINES OF DYNAMIC ALLOCATION'                       11420000
H2DALA   DS      0F                                                     11430000
*                                                                       11440000
***      CHECK  IF   DSNAME  IS  CATALOGED                              11450000
*                                                                       11460000
         LOCATE  LOCLIB                                                 11470000
         LTR     R15,R15                                                11480000
         BZ      DYNALC                                                 11490000
         LA      R15,4                                                  11500000
         BR      R10                   DATA SET NOT IN CATALOG          11510000
         SPACE   3                                                      11520000
*                                                                       11530000
***      PREPARE   PARAMETERS  TO  H2DALTXT                             11540000
*                                                                       11550000
DYNALC   EQU  *  'LOCATE  FOR DYNAMIC ALLOC  OK'                        11560000
DD1      LA      R1,ALLTXT      MACRO  H2DAL DOES NOT DO THIS           11570000
         ST      R1,DD+16                                               11580000
         SPACE   3                                                      11590000
*                                                                       11600000
***      CALL   DYNAMIC  ALLOCATION                                     11610000
*                                                                       11620000
*DD       H2DAL    VERB=AL,TEXTPP=ALLTXT,RBNAME=RBNAME                  11630000
DD       H2DAL    VERB=AL,RBNAME=RBNAME                                 11640000
         LTR     R15,R15                                                11650000
         BZ      DYNOK                                                  11660000
         SPACE   3                                                      11670000
*                                                                       11680000
***      CHECK  WHY  DYNAMIC  ALLOCATION  FAILED                        11690000
*                                                                       11700000
         CLC     DD+12(2),=X'0210' ALREADY ALLOCATED TO ANOTHER?        11710000
         BE      SETRC8                                                 11720000
         LA      R15,36              UN EXPECTED                        11730000
         BR      R10                                                    11740000
         SPACE                                                          11750000
SETRC8   LA      R15,8                                                  11760000
         BR      R10                                                    11770000
DYNOK    EQU  *                                                         11780000
         SR      R15,R15                                                11790000
         BR      R10                                                    11800000
         TITLE     'ROUTINE  FOR  DYNAMIC UNALLOCATION'                 11810000
*                                                                       11820000
***      ROUTINE   FOR   DYNAMIC  DEALLOCATION                          11830000
*                                                                       11840000
         SPACE   3                                                      11850000
*                                                                       11860000
***      PREPARE   PARAMETRS  FOR  H2DALTXT  USE                        11870000
*                                                                       11880000
H2DALU   LA       R1,UNTXT                                              11890000
         ST       R1,H2DALU1+16                                         11900000
         SPACE    3                                                     11910000
*                                                                       11920000
***      CALL   DYNAMIC  DEALLOCATION                                   11930000
*                                                                       11940000
*H2DALU1  H2DAL    VERB=UN,TEXTPP=UNTXT                                 11950000
H2DALU1  H2DAL    VERB=UN                                               11960000
         LTR      R15,R15                                               11970000
         BZR      R10                                                   11980000
         LA       R15,4                                                 11990000
         BR       R10                                                   12000000
         TITLE 'ROUTINE BLDL FOR MEMBER'                                12010000
BLDL     OPEN  ((5))                                      B446          12020000
         BLDL  (5),BLDLAREA                                             12030000
         LR    R9,R15                                     B446          12040000
         CLOSE ((R5))                                     B446          12050000
         LTR   R9,R9                                      B446          12060015
         BZR   R10                                        B446          12070000
         LA    R15,4                                      B446          12080000
         BR    R10                                        B446          12090000
         EJECT                                                          12100000
*                                                                       12110015
*  ALLOCATION OF THE NEXT DD-CARD                                       12120015
*  INITIALIZATION OF THE DATASET                                        12130015
*                                                                       12140015
RSETDD   EQU   *                                                BM1585  12150016
         CLI   WLIB,0          IS IT FIRST CYCLE ?              BM1585  12150116
         BNER  R10             YES, BYPASS RESETING             BM1585  12150216
         CLC   LIB#DD,=H'1'    IS IT FIRST OR ONLY DS ?         BM1585  12150316
         BNHR  R10          YES, BYPASS REINITIALIZATION        BM1585  12150416
         XC    LIB#DD,LIB#DD   TAKE THE FIRST                   BM1585  12150516
         B     NDD                                              BM1585  12150616
NEXTDD   EQU   *                                                WM407   12151015
         OC    LIB#DD,LIB#DD                                    WM407   12160015
         BNE   NDD                                              WM407   12170015
EDD      LA    R15,4                                            WM407   12180015
         BR    R10                                              WM407   12190015
NDD      CLI   LIBODDN,C' ' WAS DD-CARD FREED BEFORE ?          BM1585  12200016
         BE    GETNEXT      YES                                 BM1585  12210016
         BAL   R14,ENDDS                                        WM407   12220015
         LA    R0,LIBODDN                                       WM407   12250015
         CALL  CTSADUN,((R0)),VL       FREE PREV DD-CARD        WM407   12260015
         LTR   R15,R15                                          WM407   12270015
         BNE   RC36                                             WM407   12280015
         MVC   LIBODDN,=CL8' '   MARK DD CARD WAS FREED         BM1585  12300016
GETNEXT  LH    R15,LIB#DD                                       WM407   12300115
         LA    R15,1(R15)                                       WM407   12330015
         STH   R15,LIB#DD                                       WM407   12340015
         MVI   WLIB,1       FIRST CYCLE FLAG                    BM1585  12350016
         LA    R0,LIBODDN                                       WM407   12360015
         L     R7,LIBDCJFC                                      WM407   12370015
         LA    R1,LIBDCDDN                                      WM407   12380015
         CALL  CTSADAL,((R1),(R15),(R0),(R7))     ALLOC NEXT DD  WM407  12390015
         CH    R15,=H'4'                                        WM407   12400015
         BE    EDD                                              WM407   12410015
         BH    RC36                                             WM407   12420015
INITDS   EQU   *                                                WM407   12430015
         L     R5,LIBDCDCB                                      WM407   12440015
         XC    DCBBLKSI,DCBBLKSI                                WM407   12450015
         XC    DCBLRECL,DCBLRECL                                WM407   12460015
         MVI   DCBRECFM,0                                       WM407   12470015
         MVI   DCBOPTCD,0                                       WM407   12480015
*        MVC     DCBDDNAM,LIBDCDDN                                      12490015
         MVC    DDNAME,LIBODDN                                  WM407   12500015
         MVC    DCBDDNAM,DDNAME                                 WM407   12510015
*                                                                       12520015
***      MOVE   KIND  OF  PDS                                           12530015
*                                                                       12540015
         USING  INFMJFCB,R7                                             12550015
         MVC    LIBDCDSN,JFCBDSNM    MOVE DSNAME                        12560015
         MVC    LIBDCTYP,=CL4'PDS'   ASSUME IT IS A PDS                 12570015
*                                                                       12580015
***     OBTAIN   INFORMATION   ABOUT  FILE  AND  FIX  THEN IN LIBDC     12590015
*                                                                       12600015
         LA     R1,LIBDCDSN                                             12610015
         ST     R1,READDSCB+4                                           12620015
         LA     R1,JFCBVOLS                                             12630015
         ST     R1,READDSCB+8                                           12640015
         OBTAIN  READDSCB                                               12650015
         LTR    R15,R15                                                 12660015
         BZ     MOVEINFO                                                12670015
         LA     R15,8                                                   12680015
         B      END                                                     12690015
         SPACE  3                                                       12700015
*                                                                       12710015
***      MOVING   INFORMATION  FROM  OBTAIN TO  LIBDC                   12720015
*                                                                       12730015
MOVEINFO EQU    *                                                       12740015
         SPACE                                                          12750015
*        MOVING  DSORG                                                  12760015
         SPACE                                                          12770015
         TRANBYT (DS1DSGIS,IS),(DS1DSGPS,PS),(DS1DSGDA,DA),            *12780015
               (DS1DSGPO,PO),(DS1DSGU,UN),FR=DS1DSORG,TO=LIBDSORG,FO=RE 12790015
         TRANBYT (DS1ORGAM,AM),FR=DS1DSGGS,TO=LIBDSORG,FO=RE            12800015
         MVC     LIBDSORG,=C'TC'      TELECOMMUNICATION                 12810015
         SPACE   3                                                      12820015
RE       EQU     *                                                      12830015
*                                                                       12840015
***      MOVING    RECFM                                                12850015
*                                                                       12860015
         SPACE   3                                                      12870015
         TRANBYT   (JFCUND,UN),(JFCFIX,FX),(JFCVAR,VR),FR=DS1RECFM,    *12880015
               TO=LIBRECFM,FO=BLK1                                      12890015
         SPACE   3                                                      12900015
*                                                                       12910015
***     MOVING    LRECL  AND   BLOCKSIZE                                12920015
*                                                                       12930015
BLK1     MVC    LIBLRECL,DS1LRECL                                       12940015
         MVC    LIBBLKSI,DS1BLKL                                        12950015
*   PRTDBG ' CTMLIB DSORG=_',(LIBDSORG,2)                               12960015
         CLC    LIBDSORG(2),=C'PO'      IBM PDS ?                W241   12970015
         BE     DSORGEXM                IF SO - SKIP             W241   12980015
         CLC    LIBDSORG(2),=C'PS'      DSORG=PS ?               W241   12990015
         BE     YESPAN                  IF SO - ASSUME PANVALET  W241   13000015
*        BE     YESLIB                  IF SO - TRY LIB THEN PAN I358   13010015
         CLC    LIBDSORG(2),=C'DA'      DSORG=DA ?               W240   13020015
         BNE    DSORGEXM                IF NOT - PROCEED         W240   13030015
*                                                                       13040015
*   DSORG=DA                                                            13050015
*   --------                                                            13060015
*                     ASSUME LIBRARIAN LIBRARY                          13070015
*                                                                       13080015
YESLIB   CLC    =V(FAIROPN),=A(0)    LIBRARIAN CODE EXISTS ?     W240   13090015
         BE     YESPAN               IF NOT - ASSUME PANVALET    W240   13100015
         MVC    LIBDCTYP,=CL4'LIB'   INDICATE LIBRARIAN          W240   13110015
         MVC    LIBDSORG(2),=C'PO'   FOR FURTHER CHECKS          W240   13120015
         MVC    LIBLRECL,=H'80'      FOR FURTHER CHECKS          W240   13130015
         B      DSORGEXM             GO PROCEED NORMALLY         W240   13140015
*                                                                       13150015
*   DSORG=DA OR PS                                                      13160015
*   --------------                                                      13170015
*                     ASSUME PANVALET LIBRARY                           13180015
*                                                                       13190015
YESPAN   CLC    =V(POPEN),=A(0)      PANVALET CODE EXISTS ?      W241   13200015
         BE     DSORGEXM             IF NOT - PROCEED NORMALLY   W241   13210015
         MVI   LIBDCODC,0            CLEAR PREFLEN               WI0550
         L     R1,LIBTABA+4                                      WI0550
         LA    R1,(4*&MAXLIB)(R1)    ON PREFIX TABLE             WI0550
         LA    R0,&MAXLIB            NUMBER OF ENTRIES           WI0550
PFLOOP1  CLC   0(8,R1),DDNAME        OUR DDNAME?                 WI0550
         BE    MVPREF                                            WI0550
         LA    R1,16(R1)                                         WI0550
         BCT   R0,PFLOOP1                                        WI0550
         B     YESPAN1               SKIP                        WI0550
MVPREF   MVC   LIBDCODC(8),8(R1)     STORE THE PREFIX IN LIBDC   WI0550
YESPAN1  DS    0H                                                WI0550
         MVC    LIBDCTYP,=CL4'PAN'   ASSUME IT IS A PANVALET     W241   13220015
         MVC    LIBDSORG(2),=C'PO'                               W241   13230015
         MVC    LIBLRECL,=H'80'                                  W241   13240015
         SPACE  3                                                       13250015
*                                                                       13260015
***      MOVE  INFORMATION  TO  DCBBLDL                                 13270015
*                                                                       13280015
DSORGEXM EQU    *                   DSORG EXAMINED AND HANDLED   W240   13290015
*   PRTDBG ' CTMLIB TYPE=_',(LIBDCTYP,4)                                13300015
         LA     R6,200(R7)          UPON  BLDL DCB                      13310015
         LR     R5,R6               R5  USED FOR DCB                    13320015
         L      R8,=A(DCBBLDL)      UPON  MODEL                  WI0847 13330015
         LA     R7,DCBLEN1          LENGTH                              13340015
         LR     R9,R7                                                   13350015
         MVCL   R6,R8                                                   13360015
*        MOVE  DDNAME                                                   13370015
*        MVC    DCBDDNAM,DDNAME                                         13380015
         MVC    DCBDDNAM,LIBODDN                                  WM407 13390015
         SPACE  3                                                       13400015
*                                                                       13410015
***      MOVE   BUFFER,DCB FOR OUTPUT PROCESSING                        13420015
*W1064                                                                  13430015
*        LA     R8,DCBO             UPON  MODEL                         13440015
*        LA     R7,DCBOLEN                                              13450015
*        LR     R9,R7                                                   13460015
*        GETMAIN  R,LV=(R9)                                             13470015
*        ST     R1,LIBDCODC                                             13480015
*        LR     R6,R1                                                   13490015
*        MVCL   R6,R8               MOVE MODEL OF DCB                   13500015
*        SPACE  3                                                       13510015
*                                                                       13520015
***   GETMAIN FOR ONE BLOCK                                             13530015
*                                                                       13540015
*        LH     R0,DS1BLKL                                              13550015
*        LTR    R0,R0                                            B1326  13560015
*        BZ     NOGET                                            B1326  13570015
*        GETMAIN  R,LV=(0)                                              13580015
*OGET    ST     R1,LIBDCBUF                                             13590015
*        XC     LIBDCU#,LIBDCU#     NO  USED SO FAR                     13600015
         CLC    LIBDCTYP,=CL4'PAN'  IS IT PANVALET ?           W241     13610015
         BE     PANOPEN1            IF SO - SPECIAL OPEN       W241     13620015
         CLC    LIBDCTYP,=CL4'LIB'  IS IT LIBRARIAN ?          W240     13630015
         BE     LIBROPN1            IF SO - SPECIAL OPEN       W240     13640015
         SPACE  3                                                       13650015
*                                                                       13660015
*   OPEN   DCB     USED   TO   BLDL  MEMBERS - FOR PDS                  13670015
*                                                                       13680015
*        OPEN   ((5))              OPEN  BLDL  DCB      B446            13690015
*        LTR    R15,R15            CHECK  RC            B446            13700015
*        BZ     SETENT                                  B446            13710015
*        LA     R15,12                                  B446            13720015
*        B      END                                                     13730015
         B      SETENT                                  B446            13740015
         SPACE  3                                                       13750015
*                                                               W240    13760015
*   LIBRARIAN:   OPEN MASTER LIBRARY                            W240    13770015
*                                                               W240    13780015
LIBROPN1 EQU    *                                               W240    13790015
*BI0543  CALL  FAIROPN,(FAIRWKAR,0,0,FAIROOPS,DDNAME),VL        W240    13800015
         BAL    R14,AMOD24                                       WI0847
         CALL  FAIROPN,((R5),0,0,FAIROOPS,DDNAME),VL             BI0543 13800015
         BAL    R14,AMOD31                                       WI0847
         LTR   R15,R15           NORMAL COMPLETION ?            W240    13810015
         BNZ   LIBROPN2          IF NOT - SKIP                  W240    13820015
         USING OPENRES,R1        ESTABLISH ADDRESSABILITY       W240    13830015
         CLI   OPENRET,C'0'      OPEN SUCCESSFULLY COMPLETED ?  W240    13840015
         BE    SETENT            IF SO - CONTINUE               W240    13850015
         DROP  R1                DROP ADDRESSABILITY            W240    13860015
LIBROPN2 LA    R15,12            INDICATE OPEN FAILED           W240    13870015
         B     END               GO FINISH                      W240    13880015
         SPACE 3                                                        13890015
*                                                                       13900015
*   OPEN   FILE SUSPECTED OF BEING A PANVALET, TO CHECK WHETHER IT IS   13910015
*   A PANVALET FILE                                                     13920015
*                                                                       13930015
PANOPEN1 EQU    *                                                       13940015
         XC    ACTION,ACTION                                            13950015
         BAL    R14,AMOD24                                       WI0847
         CALL  POPEN,(ACTION,DDNAME,BACKUP),VL                          13960015
         BAL    R14,AMOD31                                       WI0847
*   PRTDBG ' PAN OPEN DDNAME=_ R15=# ACTION=#',(DDNAME,8,?R15,ACTION)   13970015
         CLC   ACTION(4),=F'0'                                          13980015
         BE    SETENT                                                   13990015
         LA     R15,12            FAILURE OF OPEN                       14000015
         B      END                                                     14010015
         SPACE  3                                                       14020015
*                                                                       14030015
***      STORE    ADDR  OF NEW  ALLOCATED  ENTRY  IN  DSNAMES  TABLE    14040015
*                                                                       14050015
SETENT   ST     R5,LIBDCBLD                                             14060015
         SR     R15,R15                                                 14070015
         BR    R10                                              WM407   14080015
*                                                                       14090015
*           DATASET TERMINATION                                         14100015
*                                                                       14110015
ENDDS    ST    R14,SVER14                                       WM407   14120015
*                                                                       14130015
***      CLOSE   MEMBER                                                 14140015
*                                                                       14150015
         BAL    R14,AMOD24                                       WI0847
         CLI   LIBDSORG,0      WAS THE FILE OPENED ?         BM2022
         BE    PANCLSE         NO                            BM2022
         L     R5,LIBDCBLD   POINT TO BLDL DCB                          14160015
         CLC   LIBDCTYP,=CL4'LIB'    IS IT LIBRARIAN ?          W240    14170015
         BE    LIBRCLSF              IF SO - SPECIAL CLOSE      W240    14180015
         CLC   LIBDCTYP,=CL4'PAN'                                       14190015
         BE    PANCLS                                                   14200015
         CLOSE  ((5))                                                   14210015
         TM    DCBBUFCB-IHADCB+3(R5),1                        BM1335    14220015
         BO    PANCLSE                                        BM1335    14230015
         FREEPOOL (R5)                                        BM1335    14240015
         B     PANCLSE                                                  14250015
*                                                                       14260015
*   LIBRARIAN:   CLOSE MASTER LIBRARY                                   14270015
*                                                                       14280015
LIBRCLSF DS    0H                                                       14290015
*BI0543  CALL  FAIRCLS,(FAIRWKAR),VL     CLOSE LIBRARY          W240    14290015
         CALL  FAIRCLS,((R5)),VL         CLOSE LIBRARY           BI0543 14290015
         B     PANCLSE                   GO PROCEED             W240    14300015
         SPACE 3                                                        14310015
PANCLS   XC    ACTION,ACTION                                            14320015
         CALL  PCLOSE,(ACTION),VL                                       14330015
*   PRTDBG ' PAN CLOSE R15=# ACTION=#',(?R15,ACTION)                    14340015
         SPACE 3                                                        14350015
PANCLSE  EQU   *                                                        14360015
         BAL    R14,AMOD31                                       WI0847
         L     R14,SVER14                                       WM407   14460015
         BR    R14                                              WM407   14470015
SVER14   DS    F                                                WM407   14480015
*        CODES  AND   MESSAGES                                          14490015
***      GENERAL   CODES   FROM  CTMLIB  : FROM  ANY  ROUTINE           14500000
*                                                                       14510000
RET08    LA       R15,8         FIX RC=08                B504           14520000
         B        END           GO FINISH                B504           14530000
*                                                                       14540000
INVPARM  LA       R15,12        DDNAME/DSNAME  NOT  FOUND               14550000
         B        END                                                   14560000
MISSING  LA       R15,16        ONE OF PARAMETERS  MISSING              14570000
         B        END                                                   14580000
INVREQ   LA       R15,20        INVALID  REQUEST                        14590000
         B        ENDNOSTA                                              14600000
TOOMANY  LA       R15,24        MORE  THEN  &MAXLIB  LIBRARIES          14610000
         B        END                                                   14620000
CTMLIBER LA       R15,28        DSN TYPE NOT FOUND                      14630007
         B        END                                                   14640000
NOMEM    LA       R15,32        NO  STORAGE  AVAIBLE                    14650000
         B        END                                                   14660000
         LTORG                                                          14670000
         TITLE    'A  ROUTINE TO GET  CONTROL IF ABEND OCCURED'         14690000
TRAPEXIT EQU     *                                                      14700000
         PUSH    USING                                          BM1665  14720015
         DROP    ,                                              BM1665  14720015
         STM     R0,R15,SAVEAREA-*(R15)                         BM1665  14720015
         BALR    R12,0                                                  14740000
         USING   *,R12                                                  14750000
         XC      SDWAP,SDWAP                                            14760000
         CH      R0,=H'12'     WE HAVE SDWA?                    W262    14770000
         BE      SETCOD        IF NOT R1 CONTAIND COMP CODE             14780000
         LR      R3,R1                                                  14790000
         ST      R3,SDWAP                                               14800000
         USING   SDWA,R3       R3 POINTS SDWA                           14810000
         L       R2,SDWAABCC   TAKE COMP CPDE                           14820000
         DROP    R3                                                     14830000
         LR      R1,R2                                                  14840000
SETCOD   EQU     *                                                      14850000
         ICM     R1,B'1000',=AL1(0)     CANCEL LEFT BYTE                14860000
         ST      R1,COMPCODE                                            14870000
         LA      R0,RETRY                                               14880000
         LM      R1,R14,SAVEAREA+4                                      14890000
         LA      R15,4                  RETRY                           14900000
         BR      R14                                                    14910000
         DROP    R12                                                    14920000
RETRY    DS      0F                                                     14940000
         USING   *,R12                                                  14960000
         LR      R12,R15                                                14950000
         L       R13,=V(CTSALIB)       UPON ENVIROMENT OF CTMLIB        14970000
         L       R3,SDWAP                                               14980000
         LTR     R3,R3                                                  14990000
         BZ      EST0                                                   15000000
         LA      R0,104                                                 15010000
         FREEMAIN  R,LV=(0),A=(R3)                                      15020000
EST0     EQU     *                                                      15030012
         TM      FL,FL31       WAS CALLER IN AMODE=31?           WI0847
         BZ      NOT31       NO                                  WI0847
         L       R14,=A(X'80000000'+NOT31) AMODE=31              WI0847
         BSM     R0,R14        CHANGE AMODE                      WI0847
NOT31    L       R0,COMPCODE                                            15040000
         LA      R15,40                ESTAE                            15050000
         L       R13,4(R13)                                             15060000
         L       R14,12(,R13)                                           15070000
         LM      R1,R12,24(R13)                                         15080000
         BR      R14                                                    15090000
         DROP    R12                                                    15100000
         POP     USING                                          BM1665  14720015
*                                                                GEM---
*              CHECK WHETHER A GEM LIBRARY WAS REQUESTED         GEM---
*                                                                GEM---
GEMCHECK DS    0H                                                GEM---
         MVC   GEMLIB,BLANK           CLEAR GEMLIB               GEM---
         LA    R15,DSNAME                                        GEM++-
         LR    R1,R15                                            GEM---
         LA    R0,9           MAX DELIMITER OFFSET               GEM++-
GEMLOOP1 DS    0H                                                GEM---
         CLI   0(R15),C'/'    C'/' IN DSNAME FIELD INDICATES GEM GEM+--
         BE    GEMMVNAM                                          GEM---
         LA    R15,1(R15)                                        GEM---
         BCT   R0,GEMLOOP1                                       GEM---
GEMRET4  LA    R15,4          NOT GEM LIBRARY                    GEM---
         BR    R14                                               GEM---
GEMMVNAM DS    0H                                                GEM---
         SR    R15,R1                                            GEM---
         EX    R15,GEMMOVE        TAKE LIBRARY NAME              GEM---
         MVC   GEMMEM,BLANK                                      GEM---
         LA    R15,1(R1,R15)  ON MEMBER NAME BEGINNING           GEM---
         LA    R1,GEMMEM                                         GEM---
         LA    R0,26                                             GEM+--
GEMLOOP2 DS    0H                                                GEM---
         CLI   0(R15),C'/'                                       GEM+--
         BE    GEML2END                                          GEM---
         MVC   0(1,R1),0(R15)                                    GEM---
         LA    R15,1(R15)                                        GEM---
         LA    R1,1(R1)                                          GEM---
         BCT   R0,GEMLOOP2                                       GEM---
         CLI   0(R15),C')'                                       GEM---
         BNE   GEMRET4                                           GEM---
GEML2END CLI   GEMMEM,C' '    ANYTHING IN MEMBER FIELD?          GEM---
         BE    GEMRET4                                           GEM---
GEMRET0  SR    R15,R15                                           GEM---
         BR    R14                                               GEM---
GEMMOVE  MVC   GEMLIB(0),DSNAME                                  GEM---
*                                                                GEM---
*        MAKE SURE DDNAME IS NOT ALLOCATED CURRENTLY             GEM---
*                                                                GEM---
CKREPEAT DS    0H                                                GEM---
         ST    R5,CKRSAVE                                        GEM---
         LA    R5,&MAXLIB          MAX NUMBER OF ENTRIES         GEM---
         L     R2,LIBTABA+4        TABLE OF DSN ENTRIES          GEM---
         SR    R3,R3                                             BI0967
GEMCKLIB CLI   0(R2),X'FF'         ENTRY IN USE?                 GEM---
         BNE   GEMCKLN             NO, SKIP                      GEM---
*BI0967  L     R3,0(R2)                                          GEM---
         ICM   R3,7,1(R2)                                        BI0967
         CLC   DDNAME,LIBDCDDN     OUR DDNAME?                   GEM---
         BNE   GEMCKLN                                           GEM---
         LA    R15,8         ERROR - IT IS THERE ALREADY         GEM---
         B     CKREXIT                                           GEM---
GEMCKLN  LA    R2,4(R2)                                          GEM---
         BCT   R5,GEMCKLIB                                       GEM---
         SR    R15,R15                                           GEM---
CKREXIT  L     R5,CKRSAVE                                        GEM---
         BR    R14                                               GEM---
CKRSAVE  DS    F                                                 GEM---
AMOD31   TM    FL,FL31       WAS CALLER IN AMODE=31?             WI0847
         BZR   R14           NO                                  WI0847
         LA    R14,0(R14)    ZERO OUT HIGH ORDER BYTE            WI0847
         O     R14,=X'80000000' SET AMODE=31                     WI0847
         BSM   R0,R14        CHANGE AMODE                        WI0847
AMOD24   TM    FL,FL31       WAS CALLER IN AMODE=31?             WI0847
         BZR   R14           NO                                  WI0847
         LA    R14,0(R14)    ZERO OUT HIGH ORDER BIT             WI0847
         BSM   R0,R14        CHANGE AMODE                        WI0847
FL       DC    B'0'      FLAGS                                   WI0847
FL31     EQU   B'10000000' CALLER IS IN AMODE=31                 WI0847
*                                                                       15110000
***      VARIABLES                                                      15120000
*                                                                       15130000
*****    TABLE  OF  ALL  ACTIONS , VALUSE SET  BY  LIBACT MACRO'        15140000
*                                                                       15150000
ACTTAB   LIBTBGEN                                                       15160000
ACTTBEND EQU   *                                                        15170000
*                                                                       15180000
***      H2DALTXT   PARAMETERS  FOR  DYNAMIC  ALLOCATION                15190000
*                                                                       15200000
ALLTXT  H2DALTXT   VERB=AL,PREFIX=ALL,DDNAM=*,DSNAM=*,STATS=SHR         15210000
****           PERMA=*                    RTDDN=*                       15220000
*                                                                       15230000
***      H2DALTXT   PARAMETRS  FOR  SYNAMIC   UNALLOCATION              15240000
UNTXT   H2DALTXT   VERB=UN,PREFIX=UN,DDNAM=*                            15250000
*                                                                       15260000
***      PARAMETERS  AREA  FOR  BLDL    DSNAME  OPERATION               15270007
*                                                                       15280000
BLDLAREA  DC   Y(1,74)            EXTENDED ROOM FOR ISPF STAT WM1161    15290000
BLDLMEM   DC   CL8' '                                                   15300000
          DC   CL66' '            EXTENDED ROOM FOR ISPF STAT WM1161    15310000
PANMEM    DC   CL22' '                                                  15320000
BACKUP   DC    CL52'NO-ENTRY'                                           15330000
ACTION   DC    A(0)                                                     15340000
DIRENTRY DC    CL80' '                                                  15350000
COMMENT  DC    CL52'NO-ENTRY'                                           15360000
SUBSET   DC    CL52'NO-ENTRY'                                           15370000
INCLUDE  DC    CL8'YES'            PANVALET TO PERFORM INCLUDE   W442   15380000
BUFFER   DC    CL80' '                                                  15390000
*                                                                       15400000
***      PARAMETRS  AREA  FOR  LOCATE  DSNAME  OPERATION                15410002
*                                                                       15420000
LOCLIB CAMLST NAME,DSNAME,,WORKAREA                                     15430000
WORKAREA  DS   265C                                                     15440000
DDNAME    DS   CL8                                                      15450000
DSNAME    DS   CL44                                                     15460000
EXLST     DC   A(0)          DURING RUN GETS VALUE                      15470000
*                                                                       15480000
***   VARIBLES FOR STAE ROUTINE                                         15490000
*                                                                       15500000
KEEPRC    DC    A(0)                                                    15510000
COMPCODE  DC    A(0)                                                    15520000
SAVEAREA  DS    16F                                                     15530000
SDWAP     DC    A(0)                                                    15540000
*                                                                       15550000
***       PARAMETERS AREA FOR OBTAIN PARAMETERS                         15560007
*                                                                       15570000
READDSCB  CAMLST  SEARCH,0,0,WORKARE4                                   15580000
          DS    0D                                                      15590000
WORKARE1  EQU  *                                                        15600000
          IECSDSL1   (1)                                                15610000
          ORG  WORKARE1+44                                              15620000
WORKARE4  EQU  *                                                        15630000
          ORG                                                           15640000
DUMMY5    DS    CL5           THIS AREA IS USED BY OBTAIN       **SL**
          SPACE  3                                                      15650000
*                                                                       15660000
*   VARIABLES/CONSTANTS NEEDED FOR LIBRARIAN SUPPORT                    15670000
*                                                                       15680000
*BI0543  FAIRWKAR DS    6F    WORKAREA FOR LIBRARIAN FUNCTIONS
FAIRMMDN DS    CL8            MODULE NAME IN MASTER LIBRARY             15700000
FAIROOPS DC    C'2'           OPEN DISK MASTER FILE ONLY                15710000
         DC    C'0'           IGNORE ANY CYCLE CONTROL FILE             15720000
         DC    C'0'           GUESS IF VIA AN OS OR DOS O.S.            15730000
         DC    C'2'           USE TWO BUFFERS                           15740000
         DC    16C'0'         RESERVED FOR FUTURE USE                   15750000
         SPACE 3                                                        15760000
FAIRMOPS DC    C'0'           USE FAIRMMDN AS THE MODULE NAME           15770000
         DC    C'0'           GUESS IF VIA OS OR DOS O.S.               15780000
         DC    C'0'           FAIRREC DOES NOT EXPAND -INC STATEM       15790000
         DC    C'0'           NON-ARCHIE OR LAST ARCHIE MODULE          15800000
         DC    C'0'           RETRIEVES MOST RECENTLY MODULE            15810000
         DC    C'0'           IGNORES THE VARIABLES                     15820000
         DC    2C'0'          TAKE DEFAULTS                             15830000
         DC    12C'0'         RESERVED FOR FUTURE USE                   15840000
         SPACE 3                                                        15850000
FAIRROPS DC    C'0'           DO NOT RETRIEVE THE HISTORY RECORDS       15860000
         DC    C'0'           SEQUENCE NO. WILL OVERLAY SOME PORTIONS   15870000
         DC    C'0'           RETRIEVE NEXT RECORD                      15880000
         DC    17C'0'         RESERVED FOR FUTURE USE                   15890000
         SPACE 3                                                        15900000
*                                                                       15910000
***       WORKING  VARIABLES                                            15920015
*                                                                       15930000
AREA2     EQU  WORKAREA                                                 15990000
PARMADDR  DS   A         ADDRESS  OF  USER  PARAMETRS                   15940000
RECA      DS   A         ADDRESS  OF  USER  RECORD (FOR GET/INFO)       15950000
ALLTYPE   DS   F         TYPE     OF  DSNAME                            15960000
RC        DS   F                                                        15970000
LIBTABA   DS   3A        ADDRESS  OF  TABLE,LENGTH,DSN TABLE            15980000
USERAREA  DC   A(0)      ADDR OF USER AREA                              16000000
NUMENT    DC   A(0)      NUMBER OF ENTRIES REQUSTED BY USER             16010000
ADDREP    DS   X         R OR A REPLACE OR NOT                          16020000
DOUBLE    DS   D                                                        16030000
CHAR      DS   F                                                        16040000
TEADD     DS   F         ADDR OF TABLE ENTRY                    WM407   16050005
WLIB      DS   X         FIRST CYCLE FLAG                        BM1585 16060016
TEMPDSN  DS    CL44                                              WI0550
PVPREF   DS    CL8                                               WI0550
PREFL    EQU   PVPREF,1                                          WI0550
PREFIX   EQU   PVPREF+1,7                                        WI0550
BLANK    DC    CL44' '                                           GEM---
GEMLIB   DC    CL26' '                                           GEM---
         ORG   GEMLIB+16                                         GEM+--
GEMMEM   DC    CL26' '                                           GEM+--
GEMOMEM  DC    CL8'OPENMEM'                                      GEM---
GEMCLMEM DC    CL8'CLOSEMEM'                                     GEM---
FINDMEM  DC    CL8'FINDMEM'                                      GEM---
GEMENDDS DC    CL8'ENDLIB'                                       GEM---
GETLINE  DC    CL8'GETLINE'                                      GEM---
          LTORG                                                         16080000
          SPACE   3                                                     16090000
*                                                                       16100000
***       MODEL   FOR  DCB  FOR    READING  MEMBER (USING RDJFCB)       16110001
*                                                                       16120000
DCB1      EQU  *                                                        16130000
DCB       DCB  DDNAME=LIB,DSORG=PS,MACRF=GL,EXLST=EXLST,BUFNO=1  WI0847 16140015
DCBLEN    EQU  *-DCB                                                    16150000
          SPACE   3                                                     16160000
*                                                                       16170000
***       MODEL   FOR  DCB  FOR    READING  MEMBER (USING RDJFCB)       16180001
*                                                                       16190000
DCB2      EQU  *                                                        16200000
DIRDNAME  DCB  DDNAME=LIB,DSORG=PS,BLKSIZE=256,LRECL=256,RECFM=F,      *16210000
               MACRF=GM,EODAD=RETDIR                                    16220000
DCBLEN2   EQU  *-DCB2                                                   16230000
          SPACE   3                                                     16240000
*                                                                       16250000
***       MODEL  FOR  BLDL   MEMBERS                                    16260000
*                                                                       16270000
DCBBLDL   DCB  DDNAME=LIB,DSORG=PO,MACRF=R                              16280000
DCBLEN1   EQU  *-DCBBLDL                                                16290000
*                                                                       16300000
***       MODEL  FOR  WRITING MEMBERS                                   16310000
*                                                                       16320000
DCBO      DCB  DDNAME=LIB,DSORG=PO,MACRF=W                              16330000
DCBOLEN   EQU  *-DCBO                                                   16340000
          FAIRDS                                                 W240   16350000
          IHASDWA                                                       16360000
          END                                                           16370000
