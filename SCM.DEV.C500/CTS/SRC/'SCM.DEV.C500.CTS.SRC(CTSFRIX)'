         TITLE 'CONTROL-SA ICHRIX02 EXIT FOR ONLINE INTERCEPTOR'        00010000
*                                                                       00020000
*********************************************************************** 00030000
****                                                               **** 00040000
****       CONTRL-SA RELEASE 1.3.0                                 **** 00050000
****                                                               **** 00060000
****       LICENCED MATERIAL - NEW DIMENSION SOFTWARE LTD.         **** 00070000
****                                                               **** 00080000
*********************************************************************** 00090000
*                                                                       00100000
*********************************************************************** 00110000
*                                                                     * 00120000
* MODULE NAME : CTSFRIX                                               * 00130000
*                                                                     * 00140000
* DESCRIPTION : CONTROL-SA ICHRIX02 EXIT ROUTINE                      * 00150000
*                                                                     * 00160000
* FUNCTION:                                                           * 00170000
*                                                                     * 00180000
*    ICHRIX02 IS RACF POST RACINIT EXIT WHICH CONTROL-SA USES FOR     * 00190000
*    PASSWORD SYNCRONIZTION SUPPORT.                                  * 00200000
*    THE EXIT INTERCEPTS PASSWORD CHANGES THAT WERE GENERATED AT      * 00210000
*    LOGON TIME AND NOTIFIES OF THE EVENT TO CONTROL-SA ONLINE        * 00220000
*    INTERCEPTOR SERVER VIA CROSS MEMORY SERVICES.                    * 00230000
*                                                                     * 00240000
* ATTRIBUTES  : THE EXIT MODULE SHOULD BE LINK-EDITED WITH RMODE 24   * 00250000
*               AND AMODE 31 , REUSABLE AND REENTRABLE .              * 00260000
*                                                                     * 00270000
* ENVIRONMENT : THE EXIT RECEIVES CONTROL IN SUPERVISOR STATE AND PSW * 00280000
*               KEY 0.                                                * 00290000
*                                                                     * 00300000
* RESTRICTIONS : NONE                                                 * 00310000
*                                                                     * 00320000
* DEPENDENCIES : NONE                                                 * 00330000
*                                                                     * 00340000
* REGISTER USAGE :  R0  - TEMPORARY WORK REGISTER                     * 00350000
*                   R1  - TEMPORARY WORK REGISTER                     * 00360000
*                   R2  - TEMPORARY WORK REGISTER                     * 00370000
*                   R3  -> NEW PASSWORD                               * 00380000
*                   R4  -> USERID                                     * 00390000
*                   R5  -  LENGTH REGISTER                            * 00400000
*                   R6  -  NOT USED                                   * 00410000
*                   R7  -  NOT USED                                   * 00420000
*                   R8  -> EVT                                        * 00430000
*                   R9  -> RQC                                        * 00440000
*                   R10 -> MODULE PREFIX AREA                         * 00450000
*                   R11 -> PARAMETER LIST                             * 00460000
*                   R12 -> PROGRAM BASE                               * 00470000
*                   R13 -> DYNAMIC WORK AREA (SAVE AREA)              * 00480000
*                   R14 -  RETURN ADDRESS                             * 00490000
*                   R15 -  RETURN CODE                                * 00500000
*                                                                     * 00510000
* INPUT :                                                             * 00520000
*                                                                     * 00530000
*    REGISTER 1 POINTS TO A RACF POST RACINIT EXIT PARAMETER LIST     * 00540000
*    WHICH IS MAPPED BY THE RIXPL CONTROL BLOCK (ICHRIXP MARCO)       * 00550000
*                                                                     * 00560000
* OUTPUT:                                                             * 00570000
*                                                                     * 00580000
*    THIS EXIT ALWAYS RETURNS A RETURN CODE OF 0 .                    * 00590000
*                                                                     * 00600000
* ICHRIX02 RETURN CODES ARE :                                         * 00610000
*                                                                     * 00620000
*    0 - CONTINUE WITH RACINIT PROCESSING                             * 00630000
*    4 - TRY THE RACROUTE REQUEST AGAIN                               * 00640000
*                                                                     * 00650000
* CHANGE ACTIVITY :                                                   * 00660000
*                                                                     * 00670000
*    24/10/94 DC CREATED                                              * 00680000
*                                                                     * 00690000
*********************************************************************** 00700000
*--------------------- CTS V 1.3.0 ----------------------------*        00700100
* *CTS1  07.06.95 DC USE X'FFFFFFFF' TO INDICATE NO PREVIOUS   *        00700200
*                    EXIT IN EXPPREV FIELD                     *        00700300
*--------------------- CTS V 2.0.1 ----------------------------*        00700400
* *CTS2  31.12.96 DC CORRECT FLAGS PROCESSING                  *        00700500
*--------------------- CTS V 2.1.0 ----------------------------*        00700600
* PS0244 25.02.98 DC LONG RQC SUPPORT                          *        00700700
*--------------------- CTS V 3.2.01 ---------------------------*        00700800
* WS2555 12.01.06 EM NOTIFY WHEN NO FREE RQC IS LEFT IN CHAIN. *        00700900
*--------------------- CTS V 4.0.00 ---------------------------*        00701001
* SAS2IBMN NURITY   12/12/16 RESOLVE USING WARNING.            *        00701101
*    "      "       17/12/16 RMODE CHANGED FROM 24 TO ANY.     *        00701302
****************************************************************        00701400
*                                                                       00701500
****************************************************************        00701600
*        REGISTERS EQUATES                                     *        00701700
****************************************************************        00701800
*                                                                       00701900
R0       EQU   0                                                        00702000
R1       EQU   1                                                        00702100
R2       EQU   2                                                        00702200
R3       EQU   3                                                        00702300
R4       EQU   4                                                        00702400
R5       EQU   5                                                        00702500
R6       EQU   6                                                        00702600
R7       EQU   7                                                        00702700
R8       EQU   8                                                        00702800
R9       EQU   9                                                        00703000
R10      EQU   10                                                       00704000
R11      EQU   11                                                       00705000
R12      EQU   12                                                       00706000
R13      EQU   13                                                       00707000
R14      EQU   14                                                       00708000
R15      EQU   15                                                       00709000
*                                                                       00710000
****************************************************************        00720000
*        PROLOG CODE                                           *        00730000
****************************************************************        00740000
*                                                                       00750000
CTSFRIX  CSECT ,                                                        00760000
CTSFRIX  AMODE 31                                                       00770000
*SAS2IBMN CTSFRIX  RMODE 24                                             00780002
CTSFRIX  RMODE ANY                                             SAS2IBMN 00781002
         SAVE  (14,12),,CTSFRIX-&SYSDATE-&SYSTIME                       00790000
         LR    R12,R15                                                  00800000
         USING CTSFRIX,R12                                              00810000
         CTSLEVEL ,                                                     00820000
         LR    R11,R1                                                   00830000
         USING RIXPL,R11                                                00840000
*                                                                       00850000
****************************************************************        00860000
*        CHECK MODULE HEADER                                   *        00870000
****************************************************************        00880000
*                                                                       00890000
         LR    R10,R12                                                  00900000
         S     R10,=A(EXPLEN)          R10 -> EXIT PREFIX               00910000
         USING EXP,R10                                                  00920000
         CLC   =CL4'CSAX',EXPID        ARE WE OK ?                      00930000
         BE    CHKZOMBI                NO - WHAT THE ???                00940000
         WTO   'CTSFRIX: EXIT OVERLAYED. NO MODULE HEADER'              00950000
         B     QUIT                                                     00960000
*                                                                       00970000
****************************************************************        00980000
*        IF EXIT IS DISABLED, CONTINUE WITH NEXT ONE                    00990000
****************************************************************        01000000
*                                                                       01010000
CHKZOMBI DS    0H                                                       01020000
         TM    EXPFLAGS,EXPZOMBI       SKIP EXIT FOR ZOMBI FLAG         01030000
         BO    NEXTEXIT                SKIP EXIT FOR ZOMBI FLAG         01040000
*                                                                       01050000
****************************************************************        01060000
*        VERIFY THAT UID, NEWPW AND SUCCESS RETURN CODE WERE SET        01070000
****************************************************************        01080000
*                                                                       01090000
         ICM   R4,15,RIXNEWPA          NEWPW PASSED ?                   01100000
         BZ    NEXTEXIT                NO, IGNORE                       01110000
         CLI   0(R4),0                 IS THERE A NEWPW ?               01120000
         BE    NEXTEXIT                NO, IGNORE                       01130000
*                                                                       01140000
         ICM   R3,15,RIXUID            USERID PASSED ?                  01150000
         BZ    NEXTEXIT                NO, IGNORE                       01160000
         CLI   0(R3),0                 IS THERE A USER ?                01170000
         BE    NEXTEXIT                NO, IGNORE                       01180000
*                                                                       01190000
*CTS2    ICM   R1,15,RIXPSCKN          IS PASSWORD ENCRYPTED ?          01200000
         ICM   R1,15,RIXFLAG           IS PASSWORD ENCRYPTED ?    *CTS2 01210000
         BZ    CHKCOMP                 NO, CANT BE ENCRYPTED            01220000
         TM    0(R1),RIXENCNO          ENCRYPT=NO SPECIFIED ?           01230000
         BO    NEXTEXIT                YES, IGNORE THE PASSWORD CHNG    01240000
         TM    0(R1),RIXPSCKN          BYPASS PASSWORD CHECK ?    *CTS2 01250000
         BO    NEXTEXIT                YES, IGNORE THE PASSWORD   *CTS2 01260000
CHKCOMP  DS    0H                                                       01270000
*                                                                       01280000
         ICM   R1,15,RIXCOMP           COMPLETION CODE PASSED ?         01290000
         BZ    NEXTEXIT                NO, IGNORE                       01300000
         CLC   =A(0),0(R1)             IS THERE AN ABEND ?              01310000
         BNE   NEXTEXIT                YES, IGNORE                      01320000
*                                                                       01330000
         ICM   R1,15,RIXRCODE          RETURN CODE PASSED ?             01340000
         BZ    NEXTEXIT                NO, IGNORE                       01350000
         CLC   =A(4),0(R1)             IS THERE AN ABEND ?              01360000
         BL    NEXTEXIT                YES, IGNORE                      01370000
*                                                                       01380000
****************************************************************        01390000
*        INCREASE MODULE USE COUNT                                      01400000
****************************************************************        01410000
*                                                                       01420000
INCUSECT DS    0H                      INCREASE MODULE USE COUNT        01430000
         L     R1,EXPUSECT             INCREASE MODULE USE COUNT        01440000
         LA    R0,1(R1)                INCREASE MODULE USE COUNT        01450000
         CS    R1,R0,EXPUSECT          INCREASE MODULE USE COUNT        01460000
         BNZ   INCUSECT                INCREASE MODULE USE COUNT        01470000
*                                                                       01480000
****************************************************************        01490000
*        OBTAIN WORKAREA                                       *        01500000
****************************************************************        01510000
*                                                                       01520000
GETWORK  DS    0H                                                       01530000
         GETMAIN RC,LV=WORKLEN                                          01540000
         LTR   R15,R15                                                  01550000
         BZ    CHAINSA                                                  01560000
         WTO   'CTSFRIX: GETMAIN FAILED ERROR'                          01570000
         B     RETURN                                                   01580000
*                                                                       01590000
*        CHAIN SAVE AREAS                                               01600000
*                                                                       01610000
CHAINSA  DS    0H                                                       01620000
         ST    R1,8(R13)               CHAIN                            01630000
         ST    R13,4(R1)               SAVE AREAS                       01640000
         LR    R13,R1                  ESTABLISH WORK AREA              01650000
         USING WORKAREA,R13               ADDRESSABILITY                01660000
*                                                                       01670000
****************************************************************        01680000
*        CREATE RECOVERY ENVIRONMENT                                    01690000
****************************************************************        01700000
*                                                                       01710000
         ST    R10,ADDREXP             SAVE EXP FOR ABEND RETRY         01720000
         XC    ABNDCODE,ABNDCODE       CLEAR ABEND CODE                 01730000
         MVC   WRKESTAE,LSTESTAE                                        01740000
         ESTAE ABNDEXIT,PARAM=WORKAREA,TERM=YES,MF=(E,WRKESTAE)         01750000
*                                                                       01760000
****************************************************************        01770000
*        BUILD RQC AND EVT                                              01780000
****************************************************************        01790000
*                                                                       01800000
*        BUILD RQC                                                      01810000
*                                                                       01820000
*PS0244  XC    RQCAREA,RQCAREA        CLEAR LOCAL RQC AREA              01830100
         LA    R0,RQCAREA              CLEAR THE AREA           PS0244  01830200
         LA    R1,RQCLEN               SET LENGTH               PS0244  01830300
         XR    R15,R15                 PADD WITH X'00'          PS0244  01830400
         MVCL  R0,R14                  CLEAR                    PS0244  01831000
         LA    R9,RQCAREA              R9 -> RQC                        01840000
         USING RQC,R9                  MAP RQC AREA                     01850000
*PS0244  MVI   RQCTYPE,RQCTNOT         SET RQC TYPE TO NOTIFY           01860000
         MVI   RQCTYPE,RQCTNOTX        SET RQC TYPE TO NOTIFY   PS0244  01861000
         TIME  DEC                     GET TIME                         01870000
         STM   R0,R1,RQCTSTMP          TIMESTAMP RQC                    01880000
*                                                                       01890000
*        BUILD EVT                                                      01900000
*                                                                       01910000
         LA    R8,RQCEVT               R8 -> EVENT BLOCK                01920000
         USING EVT,R8                  MAP EVENT BLOCK                  01930000
         MVC   EVTEVT,=CL4'EVT '       SET EVENT BLOCK EYE CATCHER      01940000
         MVC   EVTFLAG,=A(EVTFULL)     SET EVT INFO ON                  01950000
         MVI   EVTTYPE,EVTTUSER        TYPE = USER                      01960000
         MVI   EVTACT,EVTAPSWD         ACTION = PASSWORD CHANGE         01970000
*                                                                       01980000
         TIME  BIN                                                      01990000
         ST    R0,EVTTIME              EVENT TIME STAMP                 02000000
         ST    R1,EVTDATE              EVENT TIME STAMP                 02010000
*                                                                       02020000
*        ORIGINATOR USERID                                              02030000
*                                                                       02040000
         L     R1,PSATOLD-PSA         R1 -> CURRENT TCB                 02050000
         ICM   R1,15,TCBSENV-TCB(R1)  R1 -> TASK ACEE                   02060000
         BNZ   COPYOUID               HAVE IT, COPY TO EVT              02070000
         L     R1,PSAAOLD-PSA         R1 -> CURRENT ASCB                02080000
         L     R1,ASCBASXB-ASCB(R1)   R1 -> ASXB                        02090000
         ICM   R1,15,ASXBSENV-ASXB(R1) R1 -> ADDRESS SPACE ACEE         02100000
         BZ    SKIPOUID               NO, FAIL TO FIND AN ACEE          02110000
COPYOUID DS    0H                                                       02120000
         MVC   EVTOUID,ACEEUSRI-ACEE(R1) COPY UID FROM ACEE             02130000
SKIPOUID DS    0H                                                       02140000
*                                                                       02150000
*        COPY ORIGINATOR JOBNAME                                        02160000
*                                                                       02170000
         L     R1,PSAAOLD-PSA          R1 -> ASCB                       02180000
         USING ASCB,R1                 ASCB ADDRESS ABILITY             02190000
         ICM   R15,15,ASCBJBNI         JOBNAME EXISTS ?                 02200000
         BNZ   COPYOJBN                YES, THEN COPY IT                02210000
         ICM   R15,15,ASCBJBNS         STCNAME EXISTS ?                 02220000
         BZ    SKIPOJBN                NO, NOTHING CAN BE COPIED        02230000
COPYOJBN DS    0H                                                       02240000
         MVC   EVTOJBN,0(R15)          COPY JOBNAME/STCNAME             02250000
SKIPOJBN DS    0H                                                       02260000
         DROP  R1                      DONE WITH ASCB                   02270000
*                                                                       02280000
*        COPY ORIGINATOR PROGNAME (JOBSTEP TCB, OLDEST RB)              02290000
*                                                                       02300000
         L     R1,PSATOLD-PSA          R1 -> CURRENT TCB                02310000
         ICM   R15,15,TCBJSTCB-TCB(R1) R15 -> JOBSTEP TCB               02320000
         BZ    PROGRB                  NO, SAY WITH CURRENT TCB         02330000
         LR    R1,R15                  R1 -> JOB STEP TCB               02340000
PROGRB   DS    0H                                                       02350000
         L     R15,TCBRBP-TCB(,R1)     R15 -> NEWEST RB FOR TCB         02360000
         USING RBBASIC,R15             MAP RB                           02370000
LOOPPROG DS    0H                                                       02380000
         XR    R14,R14                 CLEAR TO BE SURE                 02390000
         ICM   R14,7,RBLINKB           R14 -> PREVIOUS RB IN CHAIN      02400000
         BZ    SKIPPROG                NO, DEAD END                     02410000
         CR    R1,R14                  IS RB THE OLDEST ?               02420000
         BE    COPYPROG                YES, COPY PROGNAME               02430000
         LR    R15,R14                 KEEP LOOKING FOR OLDEST RB       02440000
         B     LOOPPROG                                                 02450000
COPYPROG DS    0H                                                       02460000
         XR    R1,R1                   CLEAR R1                         02470000
         ICM   R1,7,RBCDE1             R1  -> CDE                       02480000
         MVC   EVTOPROG,CDNAME-CDENTRY(R1) COPY PROGNAME FROM CDE       02490000
SKIPPROG DS    0H                                                       02500000
         DROP  R15                                                      02510000
*                                                                       02520000
*        COPY USERID                                                    02530000
*                                                                       02540000
         MVC   EVTUSER,=CL8' '         USERID SHOULD BE BLANK PADDED    02550000
         XR    R5,R5                   PREPARE FOR 'IC'                 02560000
         IC    R5,0(R3)                R5 = LENGTH OF USER ID           02570000
         BCTR  R5,0                    ADJUST USERID LENGTH FOR 'EX'    02580000
         MVC   EVTUSER(*-*),1(R3)      DUMMY CODE FOR 'EX'              02590000
         EX    R5,*-6                  COPY THE USERID TO EVT           02600000
*                                                                       02610000
*        COPY NEW PASSWORD                                              02620000
*                                                                       02630000
         MVC   EVTGROUP,=CL8' '        GROUP SHOULD BE BLANK PADDED     02640000
         XR    R5,R5                   PREPARE FOR 'IC'                 02650000
         IC    R5,0(R4)                R5 = NEW PASSWORD LENGTH         02660000
         BCTR  R5,0                    ADJUST FOR 'EX'                  02670000
         MVC   EVTGROUP(*-*),1(R4)     DUMMY CODE FOR 'EX'              02680000
         EX    R5,*-6                  COPY PASSWORD                    02690000
*                                                                       02700000
*WS2555  DROP  R8                                                WS2555 02710000
*                                                                       02720000
****************************************************************        02730000
*        NOTIFY SERVER VIA PC ROUTINE                                   02740000
****************************************************************        02750000
*                                                                       02760000
         MVC   SSNAME,EXPSSNAM         INTERCEPTOR SUBSYSTEM NAME       02770000
         MVC   JOBNAME,EXPJOBNM        INTERCEPTOR XMM JOBNAME          02780000
         CALL  CTSAPCC,(FUJIFLAG,SSNAME,JOBNAME,(R9),PCCWORK),         X02790000
               MF=(E,CALLAREA)                                          02800000
         LTR   R15,R15                 REQUEST PASSED SUCCESSFULLY ?    02810000
         BZ    CLEANUP                 YES, CONITNUE                    02820000
*                                                                       02830000
         CH    R15,=H'8'               FREE CHAIN EXISTS ?       WS2555 02831000
         BE    NOFRCHN                 NO, FREE CHAIN RUN OUT    WS2555 02832000
*                                                                       02833000
         CH    R15,=H'160'             IS SERVER UP ?                   02840000
         BH    ERRPCC                  NO, ERROR IN PC ROUTINE          02850000
         CTSMSG1 CODE=CTS200E,ROUT=WTO,RAREA=WTOAREA                    02860000
         B     CLEANUP                 FINISH                           02870000
*                                                                       02870100
NOFRCHN  DS    0H                                                       02871000
         CTSMSG1 CODE=CTS203I,ROUT=WTO,RAREA=WTOAREA,            WS2555X02871100
               PLANT=(8,EVTUSER)                                 WS2555 02871200
         MVC   WTOAREA(WTOEVTL),WTOEVT                           WS2555 02871300
         MVC   WTOAREA+22(L'EVTUSER),EVTUSER                     WS2555 02871400
         WTO   MF=(E,WTOAREA)                                    WS2555 02871500
         DROP  R8                                                WS2555 02871600
         B     CLEANUP                                                  02872000
*                                                                       02880000
ERRPCC   DS    0H                                                       02890000
         CVD   R15,PACKD               CONVERT RC TO EBCDIC             02900000
         UNPK  CHARRC,PACKD            CONVERT RC TO EBCDIC             02910000
         OI    CHARRC+7,X'F0'          CONVERT RC TO EBCDIC             02920000
         CTSMSG1 CODE=CTS201E,ROUT=WTO,RAREA=WTOAREA,                  X02930000
               PLANT=(4,CHARRC+4)                                       02940000
         DROP  R9                      FINISH                           02950000
*                                                                       02960000
****************************************************************        02970000
*        ISSUE ABEND MESSGAE                                   *        02980000
****************************************************************        02990000
*                                                                       03000000
CLEANUP  DS    0H                                                       03010000
         ICM   R2,15,ABNDCODE          R2 = ABEND CODE WORD             03020000
         BZ    NOABEND                 NO, NO ABEND                     03030000
         MVI   ABNDTYPE,C'U'           ASSUME USER ABEND                03040000
         N     R2,=XL4'00000FFF'       TEST FOR USER ABEND CODE         03050000
         BNZ   ABENDMSG                YES, HAVE USER ABEND CODE        03060000
         L     R2,ABNDCODE             R2 = ABEND CODE WORD             03070000
         SRL   R2,12                   ISOLATE SYSTEM ABEND CODE        03080000
         MVI   ABNDTYPE,C'S'           SET SYSTEM ABEND CODE            03090000
ABENDMSG DS    0H                                                       03100000
         ST    R2,ABNDBIN              SAVE BINARY ABEND CODE           03110000
         UNPK  ABNDCHAR(9),ABNDBIN(5)  CONVERT TO ZONED                 03120000
         TR    ABNDCHAR(8),HEX2CHAR    MAKE IT CHARACTER                03130000
         MVC   ABNDCHAR+4(1),ABNDTYPE  INSERT ABEND TYPE CHARACTER      03140000
         CTSMSG1 CODE=CTS202S,ROUT=WTO,RAREA=WTOAREA,                  X03150000
               PLANT=(4,ABNDCHAR+4)                                     03160000
NOABEND  DS    0H                                                       03170000
*                                                                       03180000
****************************************************************        03190000
*        CLRER RECOVERY ENVIRONMENT                            *        03200000
****************************************************************        03210000
*                                                                       03220000
         ESTAE 0                                                        03230000
*                                                                       03240000
****************************************************************        03250000
*        RELEASE WORKAREA STORAGE                              *        03260000
****************************************************************        03270000
*                                                                       03280000
         DROP  R13                                                      03290000
         LR    R1,R13                  ADDRESS FOR FREEMAIN             03300000
         L     R13,4(R13)              RESTORE CALLERS SAVE AREA        03310000
         LA    R0,WORKLEN                                               03320000
         FREEMAIN RC,LV=(R0),A=(R1)                                     03330000
         LTR   R15,R15                                                  03340000
         BZ    RETURN                                                   03350000
         WTO   'CTSFRIX: FREEMAIN FAILED ERROR'                         03360000
*                                                                       03370000
****************************************************************        03380000
*        FINISHED                                              *        03390000
****************************************************************        03400000
*                                                                       03410000
RETURN   DS    0H                      RETURN TO RACHECK                03420000
*                                                                       03430000
*        DECREASE EXIT USE COUNT                                        03440000
*                                                                       03450000
DECUSECT DS    0H                      DECREASE MODULE USE COUNT        03460000
         L     R0,EXPUSECT             DECREASE MODULE USE COUNT        03470000
         LR    R1,R0                   DECREASE MODULE USE COUNT        03480000
         BCTR  R1,0                    DECREASE MODULE USE COUNT        03490000
         CS    R0,R1,EXPUSECT          DECREASE MODULE USE COUNT        03500000
         BNZ   DECUSECT                DECREASE MODULE USE COUNT        03510000
*                                                                       03520000
*        BRANCH TO NEXT EXIT IF EXISTS                         *        03530000
*                                                                       03540000
NEXTEXIT DS    0H                                                       03550000
         ICM   R15,15,EXPPREV          R15 -> NEXT EXIT                 03560000
         BZ    QUIT                    NO EXIT - RETURN TO CALLER       03570000
         C     R15,=XL4'FFFFFFFF'      NO PREVIOUS ?            *CTS1   03580000
         BE    QUIT                    NO EXIT - RETURN         *CTS1   03590000
         DROP  R10                                                      03600000
         L     R14,R12(R13,0)                                           03610000
         LM    R0,R12,20(R13)                                           03620000
         BSM   R0,R15                                                   03630000
*                                                                       03640000
****************************************************************        03650000
*        TERMINATE TO CALLER                                   *        03660000
****************************************************************        03670000
*                                                                       03680000
QUIT     DS    0H                                                       03690000
         SR    R15,R15                 LOAD RETURN CODE                 03700000
         RETURN (14,12),T,RC=(15)      RESTORE REGISTERS AND RETURN     03710000
*                                                                       03720000
****************************************************************        03730000
*        CONSTANTS                                             *        03740000
****************************************************************        03750000
*                                                                       03760000
         DS    0D                                                       03770000
FUJIFLAG DC    AL1(128)                                                 03780000
*                                                                       03790000
LSTESTAE ESTAE MF=L                    LIST FORM FOR ESTAE              03800000
LENESTAE EQU   *-LSTESTAE                                               03810000
*                                                                       03821000
WTOEVT   WTO   'CTSFRIX: CHNG PWD <USERID> EVENT IS LOST. START AGENT A*03822000
               SAP TO EMPTY QUEUE AND MEMORY.',MF=L              WS2555 03823000
WTOEVTL  EQU   *-WTOEVT                                          WS2555 03824000
*                                                                       03825000
HEX2CHAR DC    256AL1(*-HEX2CHAR)      ZONED TO HEX EBCDIC              03830000
         ORG   HEX2CHAR+X'FA'             CONVERSION                    03840000
         DC    CL6'ABCDEF'                     TABLE                    03850000
         ORG                                                            03860000
         LTORG                                                          03870000
         DROP                                                           03880000
*                                                                       03890000
****************************************************************        03900000
*        ABEND RECOVERY ROUTINE                                *        03910000
****************************************************************        03920000
*                                                                       03930000
ABNDEXIT DS    0H                                                       03940000
         USING ABNDEXIT,R15            ABEND EXIT ADDRESSABILITY        03950000
         L     R12,=A(CTSFRIX)         RESTORE LMOD BASE REG            03960000
         DROP  R15                                             SAS2IBMN 03961001
         USING CTSFRIX,R12             RESTORE ITS ADDRESSABILITY       03970000
*SAS2IBMN DROP  R15                                                     03980001
         C     R0,=F'12'               SDWA PROVIDED ?                  03990000
         BE    NOSDWA                  NO, CAN NOT RETRY                04000000
         USING SDWA,R1                 MAP SDWA                         04010000
         L     R13,SDWAPARM            RESTORE WORKAREA REGISTER        04020000
         USING WORKAREA,R13            MAP WORKAREA                     04030000
         MVC   ABNDCODE,SDWAABCC       SET ABEND CODE                   04040000
         TM    SDWAERRD,SDWACLUP       RETRY ALLOWED ?                  04050000
         BNZ   NORETRY                 NO, CAN NOT RETRY                04060000
*                                                                       04070000
RETRY    DS    0H                                                       04080000
         ST    R12,SDWASR12            SET BASE REGISTER FOR RETRY      04090000
         ST    R13,SDWASR13            SET WORKAREA REGISTER FOR RETRY  04100000
*                                                                       04110000
         STM   R14,R1,SAVEREGS                                          04120000
         SDUMP HDR='CONTROL-SA ICHRIX02 RACF EXIT ABEND',              X04130000
               SDATA=(ALLPSA,CSA,LSQA,RGN,SUMDUMP)                      04140000
         LM    R14,R1,SAVEREGS                                          04150000
*                                                                       04160000
         SETRP RETREGS=YES,RC=4,RETADDR=CLEANUP,                       X04170000
               FRESDWA=YES,DUMP=YES                                     04180000
         BR    R14                                                      04190000
*                                                                       04200000
NOSDWA   DS    0H                                                       04210000
         LR    R13,R2                   NO SDWA, PARM IN R2             04220000
         ST    R1,ABNDCODE              SAVE ABEND CODE                 04230000
         XR    R1,R1                    CLEAR                           04240000
NORETRY  DS    0H                                                       04250000
         XR    R15,R15                  INDICATE NO RETRY               04260000
         BR    R14                      RETURN TO RTM                   04270000
         LTORG                                                          04280000
         DROP                                                           04290000
*                                                                       04300000
****************************************************************        04310000
*        DYNAMIC WORK AREA DSECT                               *        04320000
****************************************************************        04330000
*                                                                       04340000
WORKAREA DSECT                                                          04350000
SAVEAREA DS    18F                     SAVE AREA TO CALL OTHERS         04360000
CALLAREA CALL  ,(,,,,,,,,),MF=L        EXECUTE FORM CALL AREA           04370000
PCCWORK  DS    XL512                   WORK AREA FOR CTSAPCC ROUTINE    04380000
RQCAREA  DS    CL(RQCLEN)              AREA FOR RQC                     04390000
PACKD    DS    D                       RETURN CODE CONVERSION           04400000
CHARRC   DS    CL8                     RETURN CODE CONVERSION           04410000
WTOAREA  DS    XL384                   CTSMSG1 WTO WORK AREA            04420000
ABNDCODE DS    XL4                     ABCODE SAVED BY ESTAE ROUTINE    04430000
ABNDBIN  DS    XL5                     ISOLATED ABEND CODE + PAD BYTE   04440000
ABNDTYPE DS    CL1                     ABEND TYPE (S/U)                 04450000
ABNDCHAR DS    CL9                     CHARCTER ABEND CODE FOR CTSMSG   04460000
WRKESTAE DS    CL(LENESTAE)            EXECUTE FORM FOR ESTAE           04470000
ADDREXP  DS    A                       SAVE EXP ADDR FOR ABEND RETRY    04480000
SSNAME   DS    CL4                     SSNAME FROM EXP                  04490000
JOBNAME  DS    CL8                     JOBNAME FROM EXP                 04500000
SAVEREGS DS    15F                     TEMPORARY SAVE REGISTERS AREA    04510000
RESERVED DS    16X                     RESERVED AREA                    04520000
WORKLEN  EQU   *-WORKAREA                                               04530000
*                                                                       04540000
****************************************************************        04550000
*        CONTROL-SA/IOA CONTROL BLOCKS                         *        04560000
****************************************************************        04570000
*                                                                       04580000
RQC      DSECT                                                          04590000
         COPY  CTSRQC                  XMS REQUEST ELEMENT              04600000
EVT      DSECT                                                          04610000
         COPY  CTSEVT                  EVENT CONTROL BLOCK              04620000
EXP      DSECT                                                          04630000
         COPY  CTSAEXP                  MODULE PREFIX                   04640000
*                                                                       04650000
****************************************************************        04660000
*        SYSTEM DSECTS                                         *        04670000
****************************************************************        04680000
*                                                                       04690000
         ICHRIXP ,                                                      04700000
         IHASDWA                                                        04710000
         IHAPSA                                                         04720000
         CVT   DSECT=YES                                                04730000
         IHAASCB                                                        04740000
         IHAASXB                                                        04750000
         IHAACEE                                                        04760000
         IKJTCB                                                         04770000
         IHARB                                                          04780000
         IHACDE                                                         04790000
         END   ,                                                        04800000
