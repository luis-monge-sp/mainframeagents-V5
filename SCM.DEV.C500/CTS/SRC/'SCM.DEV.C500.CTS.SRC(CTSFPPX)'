         TITLE 'SA-AGENT ICHPWX11 Exit for RACF online interceptor'     00010000
*********************************************************************** 00020000
****                                                               **** 00030000
****   SA-AGENT VERSION 4.0.XX                                     **** 00040000
****                                                               **** 00050000
****   (C) COPYRIGHT 1999-2000 Sailpoint Software Inc.             **** 00060000
****                                                               **** 00070000
*********************************************************************** 00080000
*                                                                     * 00090000
*********************************************************************** 00100000
*                                                                     * 00110000
* Module Name : CTSFPPX (Dynamic Version)                             * 00120000
*                                                                     * 00130000
* Description : SA-Agent ICHPWX11 RACF exit ROUTINE for dynamic       * 00140000
*               installation                                          * 00150000
* Function:                                                           * 00160000
*                                                                     * 00170000
*    ICHPWX11 is RACF new password phrase (passphrase) exit which     * 00180000
*    SA-Agent uses for passphrase syncronization support.             * 00190000
*    The exit intercepts passphrase changes that were generated by    * 00200000
*    the RACF commands 'ALTUSER' and 'PASSWORD', as well as when      * 00210000
*    the user changes his passphrase during LOGON, due to his/her     * 00220000
*    request or RACF request when passphrase interval time expires.   * 00230000
*    Once the exit intercept the passphrase change, it notifies of    * 00240000
*    the event to SA-Agent online interceptor server via cross        * 00250000
*    memory services.                                                 * 00260000
*                                                                     * 00270000
* Attributes  : the exit module should be link-edited with RMODE ANY  * 00280000
*               and AMODE 31, reusable and reentrable.                * 00290000
*                                                                     * 00300000
* Environment : The exit receives control in problem state and PSW    * 00310000
*               key 8 when called from 'ADDUSER', 'ALTUSER' or        * 00320000
*               'PASSWORD' commands.                                  * 00330000
*               When called from RACROUTE REQUEST=VERIFY processing,  * 00340000
*               (i.e. when user is requested to change passphrase),   * 00350000
*               it receives control in Supervisor state and key zero  * 00360000
*                                                                     * 00370000
* Restrictions : None                                                 * 00380000
*                                                                     * 00390000
* Register usage :  R0  - Temporary work register                     * 00400000
*                   R1  - Temporary work register                     * 00410000
*                   R2  - saved storage key                           * 00420000
*                   R3  -> PWX2PL RACF's DSECT                        * 00430000
*                   R4  -> new password                               * 00440000
*                   R5  -  length register                            * 00450000
*                   R6  -  user-id                                    * 00460000
*                   R7  -  not used                                   * 00470000
*                   R8  -> not used                                   * 00480000
*                   R9  -> not used                                   * 00490000
*                   R10 -> not used                                   * 00500000
*                   R11 -> not used                                   * 00510000
*                   R12 -> program base                               * 00520000
*                   R13 -> Dynamic Work Area (save area)              * 00530000
*                   R14 -  return address                             * 00540000
*                   R15 -  return code                                * 00550000
*                                                                     * 00560000
* Input :                                                             * 00570000
*                                                                     * 00580000
*    Register 1 points to a RACF password phrase exit parameter list  * 00590000
*    which is mapped by the PWX2PL control block (ICHPWX2 marco)      * 00600000
*                                                                     * 00610000
* Output:                                                             * 00620000
*                                                                     * 00630000
*    This exit always returns a Return Code of 0.                     * 00640000
*                                                                     * 00650000
* CHANGE ACTIVITY :                                                   * 00660000
*                                                                     * 00670000
*    01/10/17 WS10064 MS Created                                      * 00680000
*                                                                     * 00690000
*********************************************************************** 00700000
         SYSSTATE ARCHLVL=2                                             00710000
*=====================================================================* 00720000
*               C  T  S  F  P  P  X                                   * 00730000
*               ===================                                   * 00740000
*=====================================================================* 00750000
*----------------------*                                                00760000
* Globals and  Equates *                                                00770000
*----------------------*                                                00780000
FF       EQU   X'FF'                                                    00790000
BLANK    EQU   C' '                                                     00800000
CSASUBP  EQU   241                                                      00810000
*                                                                       00820000
R0       EQU   0                                                        00830000
R1       EQU   1                                                        00840000
R2       EQU   2                                                        00850000
R3       EQU   3                                                        00860000
R4       EQU   4                                                        00870000
R5       EQU   5                                                        00880000
R6       EQU   6                                                        00890000
R7       EQU   7                                                        00900000
R8       EQU   8                                                        00910000
R9       EQU   9                                                        00920000
R10      EQU   10                                                       00930000
R11      EQU   11                                                       00940000
R12      EQU   12                                                       00950000
R13      EQU   13                                                       00960000
R14      EQU   14                                                       00970000
R15      EQU   15                                                       00980000
*---------------------------------------------------------------------* 00990000
CTSFPPX  CSECT ,                                                        01000000
CTSFPPX  AMODE 31                                                       01010000
CTSFPPX  RMODE ANY                                                      01020000
         SAVE  (14,12),,CTSFPPX-&SYSDATE-&SYSTIME                       01030000
         LR    R12,R15                                                  01040000
         USING CTSFPPX,R12                                              01050000
         LR    R3,R1                   R3  -> Parameters List           01060000
         USING PWX2PL,R3               ..Addressability                 01070000
         CTSLEVEL ,                                                     01080000
*--------------------------------------------------------------*        01090000
*        Check module header                                   *        01100000
*--------------------------------------------------------------*        01110000
         LR    R10,R12                                                  01120000
         S     R10,=A(EXPLEN)          R10 -> EXIT PREFIX               01130000
         USING EXP,R10                                                  01140000
         CLC   =CL4'CSAX',EXPID        ARE WE OK ?                      01150000
         JE    CHKZOMBI                NO - WHAT THE ???                01160000
         WTO   'CTSFPPX: EXIT OVERLAYED. NO MODULE HEADER'              01170000
         J     RETURN                                                   01180000
*--------------------------------------------------------------*        01190000
*        if exit is disabled, continue with next one           *        01200000
*--------------------------------------------------------------*        01210000
CHKZOMBI DS    0H                                                       01220000
         TM    EXPFLAGS,EXPZOMBI       Is it zombi?                     01230000
         JO    NEXTEXIT                ..yes, invoke prev exit          01240000
         ICM   R4,15,PWX2NEW           new passphrase given?            01250000
         JZ    NEXTEXIT                ..no,  invoke prev exit          01260000
         CLI   0(R4),0                 is there a newpw ?               01270000
         JE    NEXTEXIT                no, ignore                       01280000
*                                                                       01290000
*        R4->  new PassPhrase          must be saved for future         01300000
*                                                                       01310000
         ICM   R6,15,PWX2USER          User-ID passed ?                 01320000
         JZ    NEXTEXIT                ..no,  invoke prev exit          01330000
         CLI   0(R6),0                 is it a real user-id?            01340000
         JE    NEXTEXIT                ..no,  invoke prev exit          01350000
*                                                                       01360000
*        R6->  User-ID                 must be saved for future         01370000
*                                                                       01380000
*--------------------------------------------------------------*        01390000
*        Obtain Dynamic Work Area                              *        01400000
*--------------------------------------------------------------*        01410000
GETWORK  DS    0H                                                       01420000
         GETMAIN RC,LV=WSASIZE,LOC=ANY                                  01430000
         LTR   R15,R15                                                  01440000
         JZ    CHAINSA                                                  01450000
         WTO   'CTSFPPX: GETMAIN FAILED ERROR'                          01460000
         J     RETURN                                                   01470000
*--------------------------------------------------------------*        01480000
*        Chain Save Area                                                01490000
*--------------------------------------------------------------*        01500000
CHAINSA  DS    0H                                                       01510000
         ST    R1,8(0,R13)             chain...                         01520000
         ST    R13,4(0,R1)             ...save areas                    01530000
         LR    R13,R1                  R13->Dynamic Work Area           01540000
*                                                                       01550000
         USING WSA,R13                 Establish Addressability         01560000
*--------------------------------------------------------------*        01570000
*        PWX11 might be invoked in PROB state, should be SUP   *        01580000
*--------------------------------------------------------------*        01590000
         MVI   WSASTAT,C'S'            default is SUP state             01600000
*@DBG    MVC   WTOAREA(WTO1L),WTO1                                      01610000
*@DBG    MVC   WTOAREA+4+19(4),=CL4'SUP'                                01620000
         TESTAUTH STATE=YES,RBLEVEL=1  is it?                           01630000
         LTR   R15,R15                 check it out                     01640000
         JZ    SETKEY0                 yes, it is in SUP mode           01650000
         MVI   WSASTAT,C'P'            no, it is in PROB. Keep it       01660000
*@DBG    MVC   WTOAREA+4+19(4),=CL4'PROB'                               01670000
         MODESET MODE=SUP              change to SUPervisor state       01680000
*--------------------------------------------------------------*        01690000
*        Increase module use count                             *        01700000
*--------------------------------------------------------------*        01710000
SETKEY0  DS    0H                                                       01720000
         MODESET SAVEKEY=(2)           save storage key                 01730000
         ST    R2,WSASKY               save it                          01740000
         MODESET KEY=ZERO              transform to key zero            01750000
INCUSECT DS    0H                                                       01760000
         L     R1,EXPUSECT             increase module use count        01770000
         LA    R0,1(0,R1)                                               01780000
         CS    R1,R0,EXPUSECT                                           01790000
         JNZ   INCUSECT                                                 01800000
         L     R2,WSASKY               pick up what we've saved         01810000
         MODESET KEYREG=(2)            restore storage key              01820000
*----------------------------------------------------------------*      01830000
*        Debug - Displaying the SUP/PROB mode and new passphrase *      01840000
*----------------------------------------------------------------*      01850000
*@DBG    WTO   MF=(E,WTOAREA)                                           01860000
*@DBG    MVC   WTOAREA(WTO2L),WTO2                                      01870000
*@DBG    XR    R1,R1                                                    01880000
*@DBG    IC    R1,0(0,R4)                                               01890000
*@DBG    CHI   R1,WTO2L-23                                              01900000
*@DBG    JL    GOWTO2                                                   01910000
*@DBG    LHI   R1,WTO2L-23                                              01920000
*@DBG    GOWTO2   BCTR  R1,0                                            01930000
*@DBG    MVC   WTOAREA+4+19(*-*),1(R4)                                  01940000
*@DBG    EX    R1,*-6                                                   01950000
*@DBG    WTO   MF=(E,WTOAREA)                                           01960000
*----------------------------------------------------------------*      01970000
*        Inform ESTAE exit                                       *      01980000
*----------------------------------------------------------------*      01990000
         XC    ABNDCODE,ABNDCODE       CLEAR ABEND CODE                 02000000
         MVC   WRKESTAE,LSTESTAE                                        02010000
         ESTAE ABNDEXIT,PARAM=WSA,TERM=YES,MF=(E,WRKESTAE)              02020000
*----------------------------------------------------------------*      02030000
*        Build RQC and EVT                                       *      02040000
*----------------------------------------------------------------*      02050000
         LA    R0,RQCAREA              CLEAR THE AREA                   02060000
         LA    R1,RQCLEN               SET LENGTH                       02070000
         XR    R15,R15                 PADD WITH X'00'                  02080000
         MVCL  R0,R14                  CLEAR                            02090000
         USING RQC,RQCAREA             MAP RQC AREA                     02100000
         MVI   RQCTYPE,RQCTNOTX        SET RQC TYPE TO NOTIFY           02110000
         TIME  DEC                     GET TIME                         02120000
         STM   R0,R1,RQCTSTMP          TIMESTAMP RQC                    02130000
*                                                                       02140000
*        build EVT                                                      02150000
*                                                                       02160000
         USING EVT,RQCEVT              MAP EVENT BLOCK                  02170000
         MVC   EVTEVT,=CL4'EVT '       SET EVENT BLOCK EYE CATCHER      02180000
         MVC   EVTFLAG,=A(EVTFULL)     SET EVT INFO ON                  02190000
         MVI   EVTTYPE,EVTTUSER        TYPE = USER                      02200000
         MVI   EVTACT,EVTAPPH          ACTION = PASSphrase CHANGE       02210000
*                                                                       02220000
         TIME  BIN                                                      02230000
         ST    R0,EVTTIME              EVENT TIME STAMP                 02240000
         ST    R1,EVTDATE              EVENT TIME STAMP                 02250000
*                                                                       02260000
*        Inform EVT the caller type (LOGON, ALTUSER, PASSWORD)          02270000
*                                                                       02280000
         L     R1,PWX2CLLR            R1 -> Calling function identity   02290000
         MVI   EVTPHCLR,EVTPH$OT      default caller is 'OTHER'         02300000
         CLI   0(R1),PWX2RINI         Comes from LOGON                  02310000
         JNE   *+8                    ..no, leave default               02320000
         MVI   EVTPHCLR,EVTPH$LG      ..yes, it is from LOGON           02330000
*                                                                       02340000
*        Originator User-ID                                             02350000
*                                                                       02360000
         L     R1,PSATOLD-PSA         R1 -> CURRENT TCB                 02370000
         ICM   R1,15,TCBSENV-TCB(R1)  R1 -> TASK ACEE                   02380000
         JNZ   COPYOUID               HAVE IT, COPY TO EVT              02390000
         L     R1,PSAAOLD-PSA         R1 -> CURRENT ASCB                02400000
         L     R1,ASCBASXB-ASCB(R1)   R1 -> ASXB                        02410000
         ICM   R1,15,ASXBSENV-ASXB(R1) R1 -> ADDRESS SPACE ACEE         02420000
         JZ    SKIPOUID               NO, FAIL TO FIND AN ACEE          02430000
COPYOUID DS    0H                                                       02440000
         MVC   EVTOUID,ACEEUSRI-ACEE(R1) COPY UID FROM ACEE             02450000
SKIPOUID DS    0H                                                       02460000
*                                                                       02470000
*        Copy originator Jobname                                        02480000
*                                                                       02490000
         L     R1,PSAAOLD-PSA          R1 -> ASCB                       02500000
         USING ASCB,R1                 ASCB ADDRESS ABILITY             02510000
         ICM   R15,15,ASCBJBNI         JOBNAME EXISTS ?                 02520000
         JNZ   COPYOJBN                YES, THEN COPY IT                02530000
         ICM   R15,15,ASCBJBNS         STCNAME EXISTS ?                 02540000
         JZ    SKIPOJBN                NO, NOTHING CAN BE COPIED        02550000
COPYOJBN DS    0H                                                       02560000
         MVC   EVTOJBN,0(R15)          COPY JOBNAME/STCNAME             02570000
SKIPOJBN DS    0H                                                       02580000
         DROP  R1                      DONE WITH ASCB                   02590000
*                                                                       02600000
*        Copy originator progname (Jobstep TCB, oldest RB)              02610000
*                                                                       02620000
         L     R1,PSATOLD-PSA          R1 -> CURRENT TCB                02630000
         ICM   R15,15,TCBJSTCB-TCB(R1) R15 -> JOBSTEP TCB               02640000
         JZ    PROGRB                  NO, SAY WITH CURRENT TCB         02650000
         LR    R1,R15                  R1 -> JOB STEP TCB               02660000
PROGRB   DS    0H                                                       02670000
         L     R15,TCBRBP-TCB(,R1)     R15 -> NEWEST RB FOR TCB         02680000
         USING RBBASIC,R15             MAP RB                           02690000
LOOPPROG DS    0H                                                       02700000
         XR    R14,R14                 CLEAR TO BE SURE                 02710000
         ICM   R14,7,RBLINKB           R14 -> PREVIOUS RB IN CHAIN      02720000
         JZ    SKIPPROG                NO, DEAD END                     02730000
         CR    R1,R14                  IS RB THE OLDEST ?               02740000
         JE    COPYPROG                YES, COPY PROGNAME               02750000
         LR    R15,R14                 KEEP LOOKING FOR OLDEST RB       02760000
         J     LOOPPROG                                                 02770000
COPYPROG DS    0H                                                       02780000
         XR    R1,R1                   CLEAR R1                         02790000
         ICM   R1,7,RBCDE1             R1  -> CDE                       02800000
         MVC   EVTOPROG,CDNAME-CDENTRY(R1) COPY PROGNAME FROM CDE       02810000
         L     R1,PWX2CLLR            R1 -> Calling function identity   02820000
         CLI   0(R1),PWX2ALTU         Comes from ALTUSER                02830000
         JNE   SKIPALU                ..no, leave default               02840000
         MVC   EVTOPROG,=C'ALTUSER '  YES - MOVE INDICATION             02850000
SKIPALU  DS    0H                                                       02860000
SKIPPROG DS    0H                                                       02870000
         DROP  R15                                                      02880000
*                                                                       02890000
*        copy UserID                                                    02900000
*                                                                       02910000
         MVC   EVTUSER,=CL8' '         USERID SHOULD BE BLANK PADDED    02920000
         XR    R5,R5                   PREPARE FOR 'IC'                 02930000
         IC    R5,0(0,R6)              R5 = LENGTH OF USER ID           02940000
         BCTR  R5,0                    ADJUST USERID LENGTH FOR 'EX'    02950000
         MVC   EVTUSER(*-*),1(R6)      DUMMY CODE FOR 'EX'              02960000
         EX    R5,*-6                  COPY THE USERID TO EVT           02970000
*                                                                       02980000
*        copy new PassPhrase                                            02990000
*                                                                       03000000
         XR    R5,R5                   PREPARE FOR 'IC'                 03010000
         IC    R5,0(0,R4)              R5 = NEW PASSPHRASE LENGTH       03020000
         AHI   R5,1                    + one byte of length             03030000
         LA    R0,EVTPWPH-1            R0-> second byte of length       03040000
         LA    R1,L'EVTPWPH            R1=destination length            03050000
         MVCL  R0,R4                   move length + passphrase         03060000
*                                      ..and also padd with nulls       03070000
*                                      ..because R5's high order byte   03080000
*                                      ..is null                        03090000
*--------------------------------------------------------------*        03100000
*        Notify server via PC routine                          *        03110000
*--------------------------------------------------------------*        03120000
         MVC   SSNAME,EXPSSNAM         INTERCEPTOR SUBSYSTEM NAME       03130000
         MVC   JOBNAME,EXPJOBNM        INTERCEPTOR XMM JOBNAME          03140000
         MVC   PGMNAME,=CL8'CTSFPPX'                                    03150000
         CALL  CTSAPCC,(FUJIFLAG,                                      X03160000
               SSNAME,                                                 X03170000
               JOBNAME,                                                X03180000
               RQCAREA,                                                X03190000
               PCCWORK),                                               X03200000
               MF=(E,CALLAREA)                                          03210000
         LTR   R15,R15                 REQUEST PASSED SUCCESSFULLY ?    03220000
         JZ    CLEANUP                 YES, CONITNUE                    03230000
*                                                                       03240000
         CHI   R15,8                   FREE CHAIN EXISTS ?              03250000
         JE    NOFRCHN                 NO, FREE CHAIN RUN OUT           03260000
*                                                                       03270000
         CHI   R15,160                 IS SERVER UP ?                   03280000
         JH    ERRPCC                  NO, ERROR IN PC ROUTINE          03290000
         CTSMSG1 CODE=CTS230E,ROUT=WTO,RAREA=WTOAREA                    03300000
         J     CLEANUP                 FINISH                           03310000
*                                                                       03320000
NOFRCHN  DS    0H                                                       03330000
         CTSMSG1 CODE=CTS233I,ROUT=WTO,RAREA=WTOAREA,                  X03340000
               PLANT=(7,PGMNAME,8,EVTUSER)                              03350000
         J     CLEANUP                                                  03360000
*                                                                       03370000
ERRPCC   DS    0H                                                       03380000
         CVD   R15,PACKD               CONVERT RC TO EBCDIC             03390000
         UNPK  CHARRC,PACKD            CONVERT RC TO EBCDIC             03400000
         OI    CHARRC+7,X'F0'          CONVERT RC TO EBCDIC             03410000
         CTSMSG1 CODE=CTS231E,ROUT=WTO,RAREA=WTOAREA,                  X03420000
               PLANT=(4,CHARRC+4)                                       03430000
*----------------------------------------------------------------*      03440000
*        Issue ABEND message (if occured)                        *      03450000
*----------------------------------------------------------------*      03460000
CLEANUP  DS    0H                                                       03470000
         ICM   R2,15,ABNDCODE          R2 = ABEND CODE WORD             03480000
         JZ    NOABEND                 NO, NO ABEND                     03490000
         MVI   ABNDTYPE,C'U'           ASSUME USER ABEND                03500000
         N     R2,=XL4'00000FFF'       TEST FOR USER ABEND CODE         03510000
         JNZ   ABENDMSG                YES, HAVE USER ABEND CODE        03520000
         L     R2,ABNDCODE             R2 = ABEND CODE WORD             03530000
         SRL   R2,12                   ISOLATE SYSTEM ABEND CODE        03540000
         MVI   ABNDTYPE,C'S'           SET SYSTEM ABEND CODE            03550000
ABENDMSG DS    0H                                                       03560000
         ST    R2,ABNDBIN              SAVE BINARY ABEND CODE           03570000
         UNPK  ABNDCHAR(9),ABNDBIN(5)  CONVERT TO ZONED                 03580000
         TR    ABNDCHAR(8),HEX2CHAR    MAKE IT CHARACTER                03590000
         MVC   ABNDCHAR+4(1),ABNDTYPE  INSERT ABEND TYPE CHARACTER      03600000
         CTSMSG1 CODE=CTS232S,ROUT=WTO,RAREA=WTOAREA,                  X03610000
               PLANT=(8,PGMNAME,4,ABNDCHAR+4)                           03620000
NOABEND  DS    0H                                                       03630000
*--------------------------------------------------------------*        03640000
*        Decrease module use count                             *        03650000
*--------------------------------------------------------------*        03660000
         MODESET KEY=ZERO                                               03670000
DECUSECT DS    0H                      DECREASE MODULE USE COUNT        03680000
         L     R0,EXPUSECT             DECREASE MODULE USE COUNT        03690000
         LR    R1,R0                   DECREASE MODULE USE COUNT        03700000
         BCTR  R1,0                    DECREASE MODULE USE COUNT        03710000
         CS    R0,R1,EXPUSECT          DECREASE MODULE USE COUNT        03720000
         JNZ   DECUSECT                DECREASE MODULE USE COUNT        03730000
         L     R2,WSASKY                                                03740000
         MODESET KEYREG=(2)                                             03750000
*                                                                       03760000
*        restoring state - PROB or SUP                                  03770000
*                                                                       03780000
         CLI   WSASTAT,C'P'            Have we received control ..      03790000
*                                      ..in PROB state?                 03800000
         JNE   INSUP                   ..no,                            03810000
         MODESET MODE=PROB             ..yes, restore PROB state        03820000
INSUP    DS    0H                                                       03830000
*--------------------------------------------------------------*        03840000
*        Clrer Recovery Environment                            *        03850000
*--------------------------------------------------------------*        03860000
         ESTAE 0                                                        03870000
*--------------------------------------------------------------*        03880000
*        Release Dynamic Work Area                             *        03890000
*--------------------------------------------------------------*        03900000
         DROP  R13                                                      03910000
         LR    R1,R13                  ADDRESS FOR FREEMAIN             03920000
         L     R13,4(R13)              RESTORE CALLERS SAVE AREA        03930000
         LHI   R0,WSASIZE                                               03940000
         FREEMAIN RC,LV=(0),A=(1)                                       03950000
         LTR   R15,R15                                                  03960000
         JZ    NEXTEXIT                                                 03970000
         WTO   'CTSFPPX: FREEMAIN FAILED ERROR'                         03980000
         J     RETURN                                                   03990000
*--------------------------------------------------------------*        04000000
*        Branch to next exit if exists                         *        04010000
*--------------------------------------------------------------*        04020000
NEXTEXIT DS    0H                                                       04030000
         ICM   R15,15,EXPPREV          R15 -> NEXT EXIT                 04040000
         JZ    RETURN                  NO EXIT - RETURN TO CALLER       04050000
         C     R15,=XL4'FFFFFFFF'      NO PREVIOUS ?                    04060000
         JE    RETURN                  NO EXIT - RETURN                 04070000
         DROP  R10                                                      04080000
         L     R14,R12(R13,0)                                           04090000
         LM    R0,R12,20(R13)                                           04100000
         BSM   R0,R15                                                   04110000
*--------------------------------------------------------------*        04120000
*        terminate to caller                                   *        04130000
*--------------------------------------------------------------*        04140000
RETURN   DS    0H                                                       04150000
         SR    R15,R15                 LOAD RETURN CODE                 04160000
         RETURN (14,12),T,RC=(15)      RESTORE REGISTERS AND RETURN     04170000
*                                                                       04180000
*@DBG    WTO   'CTSFPPX: Entring in XXXX mode',MF=L,ROUTCDE=(2)         04190000
*@DBG    EQU   *-WTO1                                                   04200000
*                                                                       04210000
*@DBG    WTO   'NewPassPhrase:                                         X04220000
                                               ',MF=L,ROUTCDE=(2)       04230000
*@DBG    EQU   *-WTO2                                                   04240000
*                                                                       04250000
FUJIFLAG DC    AL1(128)                                                 04260000
LSTESTAE ESTAE MF=L                    LIST FORM FOR ESTAE              04270000
LENESTAE EQU   *-LSTESTAE                                               04280000
*                                                                       04290000
HEXDIG   DC    CL16'0123456789ABCDEF'                                   04300000
HEX2CHAR EQU   HEXDIG-C'0'                                              04310000
         LTORG ,                                                        04320000
         DROP  R12                                                      04330000
*--------------------------------------------------------------*        04340000
*        Abend Exit (informed be ESTAE macro)                  *        04350000
*--------------------------------------------------------------*        04360000
ABNDEXIT DS    0H                                                       04370000
         USING ABNDEXIT,R15            ABEND EXIT ADDRESSABILITY        04380000
         LARL  R12,CTSFPPX              RESTORE LMOD BASE REG           04390000
         DROP  R15                                                      04400000
         USING CTSFPPX,R12            RESTORE ITS ADDRESSABILITY        04410000
         CHI   R0,12                   SDWA PROVIDED ?                  04420000
         JE    NOSDWA                  NO, CAN NOT RETRY                04430000
         USING SDWA,R1                 MAP SDWA                         04440000
         L     R13,SDWAPARM            RESTORE WSA REGISTER             04450000
         USING WSA,R13                 MAP WSA                          04460000
         MVC   ABNDCODE,SDWAABCC       SET ABEND CODE                   04470000
         TM    SDWAERRD,SDWACLUP       RETRY ALLOWED ?                  04480000
         JNZ   NORETRY                 NO, CAN NOT RETRY                04490000
*                                                                       04500000
RETRY    DS    0H                                                       04510000
         ST    R12,SDWASR12            SET BASE REGISTER FOR RETRY      04520000
         ST    R13,SDWASR13            SET WSA REGISTER FOR RETRY       04530000
*                                                                       04540000
         STM   R14,R1,SAVEREGS                                          04550000
         SDUMP HDR='SA-AGENT ICHPWX11 RACF EXIT ABEND',                X04560000
               SDATA=(ALLPSA,CSA,LSQA,RGN,SUMDUMP)                      04570000
         LM    R14,R1,SAVEREGS                                          04580000
*                                                                       04590000
         SETRP RETREGS=YES,RC=4,RETADDR=CLEANUP,                       X04600000
               FRESDWA=YES,DUMP=YES                                     04610000
         BR    R14                                                      04620000
*                                                                       04630000
NOSDWA   DS    0H                                                       04640000
         LR    R13,R2                   NO SDWA, PARM IN R2             04650000
         ST    R1,ABNDCODE              SAVE ABEND CODE                 04660000
         XR    R1,R1                    CLEAR                           04670000
NORETRY  DS    0H                                                       04680000
         XR    R15,R15                  INDICATE NO RETRY               04690000
         BR    R14                      RETURN TO RTM                   04700000
         LTORG                                                          04710000
         DROP                                                           04720000
*---------------------------------------------------------------------* 04730000
*        CONTROL-SA/IOA CONTROL BLOCKS                                * 04740000
*---------------------------------------------------------------------* 04750000
RQC      DSECT                                                          04760000
         COPY  CTSRQC                  XMS REQUEST ELEMENT              04770000
EVT      DSECT                                                          04780000
         COPY  CTSEVT                  EVENT CONTROL BLOCK              04790000
EXP      DSECT                                                          04800000
         COPY  CTSAEXP                  MODULE PREFIX                   04810000
*---------------------------------------------------------------------* 04820000
*        Dynamic Work Area DSECT                                      * 04830000
*---------------------------------------------------------------------* 04840000
WSA      DSECT   ,                Mapping of the Dynamic Save Area      04850000
         DS    18F                                                      04860000
WSAEYCT  DS    CL4                                                      04870000
CALLAREA CALL  ,(,,,,,,,,),MF=L        EXECUTE FORM CALL AREA           04880000
PCCWORK  DS    XL512                   WORK AREA FOR CTSAPCC ROUTINE    04890000
WSAR14   DS    A                                                        04900000
WSASKY   DS    F                                                        04910000
WRKESTAE DS    CL(LENESTAE)            EXECUTE FORM FOR ESTAE           04920000
SAVEREGS DS    15F                     TEMPORARY SAVE REGISTERS AREA    04930000
PACKD    DS    D                       RETURN CODE CONVERSION           04940000
CHARRC   DS    CL8                     RETURN CODE CONVERSION           04950000
RQCAREA  DS    CL(RQCLEN)              AREA FOR RQC                     04960000
WTOAREA  DS    XL384                   CTSMSG1 WTO WORK AREA            04970000
SSNAME   DS    CL4                     SSNAME FROM EXP                  04980000
JOBNAME  DS    CL8                     JOBNAME FROM EXP                 04990000
WSASTAT  DS    CL1                                                      05000000
         DS    0F                                                       05010000
ABNDCODE DS    XL4                     ABCODE SAVED BY ESTAE ROUTINE    05020000
ABNDBIN  DS    XL5                     ISOLATED ABEND CODE + PAD BYTE   05030000
ABNDTYPE DS    CL1                     ABEND TYPE (S/U)                 05040000
ABNDCHAR DS    CL9                     CHARCTER ABEND CODE FOR MSG      05050000
PGMNAME  DS    CL8                     PROGRAM NAME FOR MSG             05060000
         DS    0D                                                       05070000
WSASIZE  EQU   *-WSA                                                    05080000
*---------------------------------------------------------------------* 05090000
* System Data Areas                                                   * 05100000
*---------------------------------------------------------------------* 05110000
         PRINT GEN                                                      05120000
         ICHPWX2                                                        05130000
         IHASDWA                                                        05140000
         IHAPSA                                                         05150000
         CVT   DSECT=YES                                                05160000
         IHAASCB                                                        05170000
         IHAASXB                                                        05180000
         IHAACEE                                                        05190000
         IKJTCB                                                         05200000
         IHARB                                                          05210000
         IHACDE                                                         05220000
******   ***** ***                                                      05230000
         END                                                            05240000
