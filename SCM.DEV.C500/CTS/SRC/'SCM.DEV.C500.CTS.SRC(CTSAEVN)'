         START                                                          00010000
*                                                                       00020000
****************************************************************        00030000
****                                                        ****        00040000
****     CONTROL-SA  RELEASE 1.3.0                          ****        00050000
****                                                        ****        00060000
****     LICENCED MATERIAL - NEW DIMENSION SOFTWARE LTD.    ****        00070000
****                                                        ****        00080000
****************************************************************        00090000
*                                                                       00100000
****************************************************************        00110000
*                                                              *        00120000
* TITLE            : CONTROL-SA EVENTS BRODCASTING             *        00130000
*                                                              *        00140000
* FILE NAME        : CTSAEVN                                   *        00150000
*                                                              *        00160000
* AUTHOR           : DORON COHEN                               *        00170000
*                                                              *        00180000
* CREATION DATE    : 24/01/95                                  *        00190000
*                                                              *        00200000
* DESCRIPTION      : EVENTS FLAG OPERATIONS                    *        00210000
*                                                              *        00220000
* ASSUMPTIONS AND                                              *        00230000
*   CONSIDERATIONS : 1. CALLER IS APF AUTHORIZED               *        00240000
*                                                              *        00250000
****************************************************************        00260000
*--------V.1.3.0-----------------------------------------------*        00270000
* NEW     DC 01/01/95                                          *        00280000
* WS10047 NY 14.09.14  SUPPORT JOB STARTED TASKS - TAKE        *        00281000
*                      STC ID FROM CSCB INSTEAD OF TIOT.       *        00282000
* IS10188 AL 06.10.24  MOVE OUR MODULES ABOVE 16M LINE         *        00283100
****************************************************************        00284000
         GBLC   &AMODUSE                                                00285000
&AMODUSE SETC   'CVT'                                                   00286000
*                                                                       00287000
****************************************************************        00288000
*        PARAMETERS BLOCK                                      *        00289000
****************************************************************        00290000
*                                                                       00300000
PARM     DSECT                                                          00310000
*                                                                       00320000
*        FIXED PARAMETERS SECTION                                       00330000
*                                                                       00340000
PARMOP   DS    A                       OPCODE                           00350000
PARMSSN  DS    A                       SUBSYS                           00360000
PARMDBG  DS    A                       DBG LEVEL                        00370000
PARMRC   DS    A                       RETURN CODE                      00380000
PARMRS   DS    A                       REASON CODE                      00390000
PARMVAR  EQU   *                                                        00400000
*                                                                       00410000
*        MYXMMH OPERATION PARAMETERS                                    00420000
*                                                                       00430000
         ORG   PARMVAR                                                  00440000
PRMXJBN  DS    A                       XMM JOBNAME                      00450000
PRMXADDR DS    A                       XMM ADDRESS                      00460000
         ORG   ,                                                        00470000
*                                                                       00480000
*        RESET OPERATION PARAMETERS                                     00490000
*                                                                       00500000
         ORG   PARMVAR                                                  00510000
PRMRXMMH DS    A                       XMMH ADDRESS                     00520000
PRMRJBN  DS    A                       XMM JOBNAME                      00530000
PRMRMAIN DS    A                       MAIN NAME                        00540000
         ORG   ,                                                        00550000
*                                                                       00560000
*        CLEAR OPERATION PARAMETERS                                     00570000
*                                                                       00580000
         ORG   PARMVAR                                                  00590000
PRMCXMMH DS    A                       XMMH ADDRESS                     00600000
PRMCJBN  DS    A                       XMMH JOBNAME                     00610000
PRMCMAIN DS    A                       XMMH MAIN NAME                   00620000
PRMCEVNM DS    A                       EVENT NUMBER  (1 - 32)           00630000
PRMCEVST DS    A                       EVENT STATUS  (0/1)              00640000
         ORG   ,                                                        00650000
*                                                                       00660000
*        GET OPERATION PARAMETERS                                       00670000
*                                                                       00680000
         ORG   PARMVAR                                                  00690000
PRMGXMMH DS    A                       XMMH ADDRESS                     00700000
PRMGJBN  DS    A                       XMMH JOBNAME                     00710000
PRMGMAIN DS    A                       XMMH MAIN NAME                   00720000
PRMGVAL  DS    A                       EVENT AREA OUTPUT                00730000
         ORG   ,                                                        00740000
*                                                                       00750000
*        BRODCAST OPERATION PARAMETERS                                  00760000
*                                                                       00770000
         ORG   PARMVAR                                                  00780000
PRMBXMMH DS    A                       OUR XMM ADDRESS                  00790000
PRMBJBN  DS    A                       OUR JBN                          00800000
PRMBMAIN DS    A                       MAIN NAME FOR BRODCASTING        00810000
PRMBEVNM DS    A                       EVENT NUMBER  (1 - 32 )          00820000
PRMBEVST DS    A                       0 - FOR OFF, 1 - FOR ON          00830000
         ORG   ,                                                        00840000
*                                                                       00850000
****************************************************************        00860000
****                                                        ****        00870000
****     MAIN ROUTINE                                       ****        00880000
****                                                        ****        00890000
****************************************************************        00900000
*                                                                       00910000
CTSAEVN  CSECT                                                          00920000
CTSAEVN  AMODE ANY                                                      00930002
*IS10188 CTSAEVN  RMODE 24                                              00930101
CTSAEVN  RMODE ANY                                              IS10188 00941000
*                                                                       00950000
****************************************************************        00960000
*        INITIALIZE                                            *        00970000
****************************************************************        00980000
*                                                                       00990000
         BEGIN *,R11                                                    01000000
         CTSEQUR                                                        01010000
         CTSLEVEL CTSAEVN                                               01020000
*                                                                       01030000
         LR    R10,R1                                                   01040000
         USING PARM,R10                                                 01050000
*                                                                       01060000
         CTSAMOD 31,R=R2                                                01070000
         ST    R2,AMODE                                                 01080000
*                                                                       01090000
         L     R15,PARMDBG             R15 -> DEBUG LEVEL (4 BYTES)     01100000
         XC    DBGLEVEL,DBGLEVEL       STORE DEBUG LEVEL                01110000
         ICM   R15,15,0(R15)           DEBUG LEVEL                      01120000
         BNP   NODEBUG                 SKIP DEBUG LVL IF MINUS          01130000
         STC   R15,DBGLEVEL            STORE DEBUG LEVEL (1 BYTE)       01140000
NODEBUG  DS    0H                                                       01150000
*                                                                       01160000
****************************************************************        01170000
*        BRACH ACCORDING TO OPCODE                             *        01180000
****************************************************************        01190000
*                                                              *        01200000
*   MYXMMH - RETURN JOBNAME AND XMM HEADER ADDR OF CURRENT JOB *        01210000
*   RESET  - CLEAR EVENT FLAGS AND SET MAIN NAME OF XMM BLOCK  *        01220000
*   CLEAR  - CLEAR EVENT STATUS AND RETURN ITS PREVIOUS STATUS *        01230000
*   GET    - GET EVENT FLAGS MASK                              *        01240000
*   BRDCST - BRODCAST EVENT ACCORDING TO MAIN NAME MASK        *        01250000
*                                                              *        01260000
****************************************************************        01270000
*                                                              *        01280000
*   RETURN CODES :                                             *        01290000
*                                                              *        01300000
*    0 - SUCCESS                                               *        01310000
*    4 - FOR SET ONLY - NO EVENT WAS BRODCATED                 *        01320000
*    8 - XMM BLOCK NOT FOUND OR OVERLAYED                      *        01330000
*   12 -                                                       *        01340000
*   16 - PARAMETERS ERROR                                      *        01350000
*   20 - INVALID OPCODE                                        *        01360000
*                                                              *        01370000
****************************************************************        01380000
*                                                                       01390000
         L     R15,PARMOP                                               01400000
         CLC   =C'MYXMMH',0(R15)                                        01410000
         BE    MYXMMH                                                   01420000
         CLC   =C'RESET',0(R15)                                         01430000
         BE    RESET                                                    01440000
         CLC   =C'CLEAR',0(R15)                                         01450000
         BE    CLEAR                                                    01460000
         CLC   =C'GET',0(R15)                                           01470000
         BE    GET                                                      01480000
         CLC   =C'BRDCST',0(R15)                                        01490000
         BE    BRDCST                                                   01500000
         CLC   =C'SNAP',0(R15)                                          01510000
         BE    SNAP                                                     01520000
         MVC   RCREG,=F'20'                                             01530000
         B     EXIT                                                     01540000
*                                                                       01550000
****************************************************************        01560000
*        LOCATE REQUIRED XMM HEADER                                     01570000
****************************************************************        01580000
*                                                                       01590000
MYXMMH   DS    0H                                                       01600000
         L     R4,PRMXJBN                                               01610000
         CLI   0(R4),C' '                                               01620000
         BH    MYXJBNOK                                                 01630000
         L     R1,PSATOLD-PSA          POINT TO TCB                     01640000
*WS10047 L     R1,TCBTIO-TCB(R1)       POINT TO TIOT                    01650000
*WS10047 LA    R4,TIOCNJOB-TIOT(R1)    GET JOB NAME                     01660000
*WS10047 CLI   TIOCSTEP-TIOT(R1),C' '                                   01670000
*WS10047 BNH   MYXJBNOK                                                 01680000
*WS10047 LA    R4,TIOCSTEP-TIOT(R1)    GET JOB NAME                     01690000
         LHI   R15,0                                           WS10047  01700000
         ICM   R15,B'0111',TCBJSTCA-TCB(R1) R15 -> JSTCB       WS10047  01710000
         ICM   R15,B'0111',TCBJSCBB-TCB(R15) R15 -> JSCB       WS10047  01720000
         L     R15,JSCBCSCB-IEZJSCB(,R15) R15 -> CSCB.         WS10047  01730000
         LA    R4,CHKEY-CSCB(,R15)     R4 -> STC ID.           WS10047  01740000
         CLI   0(R4),C' '               ID EXISTS ?            WS10047  01741000
         BH    MYXJBNOK                ..YES - USE IT.         WS10047  01741100
         LA    R4,CHCLS-CSCB(,R15)     R4 -> JOBNAME.          WS10047  01741200
MYXJBNOK DS    0H                                                       01741300
*                                                                       01741400
*        LOCATE REQUIRED XMM HEADER                                     01741500
*                                                                       01741600
         L     R3,PARMSSN              R3 -> SUBSYS NAME                01741700
         CTSCALL CTSAXMH,((3),(4),ADDRXMMH)                             01741800
         CTSADBG LEVEL=(DBGLEVEL,1),                                   X01741900
               'GET XMM HEADER FOR JOBANAME=_/~~ RC=#',                X01742000
               (0(R4),8,0(R4),4(R4),?R15)                               01743000
         LTR   R15,R15                                                  01744000
         BNZ   ERRXMM                                                   01745000
*                                                                       01746000
*        RETURN INFO TO CALLER                                          01747000
*                                                                       01748000
         L     R5,PRMXJBN                                               01749000
         MVC   0(8,R5),0(R4)                                            01750000
         L     R5,PRMXADDR                                              01760000
         MVC   0(4,R5),ADDRXMMH                                         01770000
         B     EXIT0                                                    01780000
*                                                                       01790000
****************************************************************        01800000
*        RESET OPERATION                                        *       01810000
****************************************************************        01820000
*                                                              *        01830000
*  THE RESET OPERATION CLEAR ALL THE EVENT FLAGS FROM THE      *        01840000
*  XMM HEADER AND SET THE MAIN NAME THAT IS ASSOCIATED WITH    *        01850000
*  THE XMM HEADER                                              *        01860000
*                                                              *        01870000
****************************************************************        01880000
*                                                                       01890000
RESET    DS    0H                                                       01900000
*                                                                       01910000
*        CHECK MAIN NAME VALIDITY                                       01920000
*                                                                       01930000
         L     R5,PRMRMAIN             R5 -> MAIN NAME PARAMETER        01940000
         CLI   0(R5),C' '              SUPPLIED ?                       01950000
         BNH   ERRMAIN                 NO - ERROR                       01960000
*                                                                       01970000
*        CHECK XMM HEADER VALIDITY                                      01980000
*                                                                       01990000
         L     R9,PRMRXMMH             R5 -> XMM HEADER ADDRESS         02000000
         USING XMMHDR,R9                                                02010000
         L     R2,PRMRJBN              R2 -> XMM JOBNAME                02020000
         CLC   XMMMNAME,0(R2)          XMM HEADER MATCH JOBNAME         02030000
         BNE   ERRXMMP                 NO, ERRORNOUS XMM POINTER        02040000
*                                                                       02050000
*        SET MAIN NAME AND CLEAR EVENT INFO FROM XMM HEADER             02060000
*                                                                       02070000
         MODESET MODE=SUP,KEY=ZERO                                      02080000
         MVC   XMMEVNM,0(R5)           SET MAIN NAME                    02090000
         XC    XMMEVFLG,XMMEVFLG       CLEAR ALL EVENT FLAGS            02100000
         MODESET MODE=PROB,KEY=NZERO                                    02110000
         B     EXIT0                                                    02120000
         DROP  R9                                                       02130000
*                                                                       02140000
****************************************************************        02150000
*        GET OPERATION                                         *        02160000
****************************************************************        02170000
*                                                              *        02180000
* THE GET OPERATION RETURNS THE EVENT FLAGS WORD OF THE        *        02190000
* CURRENT XMM HEADER                                           *        02200000
*                                                              *        02210000
****************************************************************        02220000
*                                                                       02230000
GET      DS    0H                                                       02240000
*                                                                       02250000
*        CHECK XMM HEADER VALIDITY                                      02260000
*                                                                       02270000
         L     R9,PRMGXMMH             R9 -> XMM HEADER                 02280000
         USING XMMHDR,R9               MAP IT P                         02290000
*                                                                       02300000
         CTSADBG LEVEL=(DBGLEVEL,1),                                   X02310000
               'XMM HEADER AT ~ JBN=_/$ MAIN=_/$ EVENT FLAGS=~',       X02320000
               (?R9,XMMMNAME,8,XMMMNAME,8,XMMEVNM,8,XMMEVNM,8,XMMEVFLG) 02330000
*                                                                       02340000
         L     R2,PRMGJBN              R2 -> XMM JOBNAME                02350000
         CLC   XMMMNAME,0(R2)          XMM HEADER MATCH JOBNAME ?       02360000
         BNE   ERRXMMP                 NO, ERROR XMM POINTER            02370000
         L     R2,PRMGMAIN             R2 -> XMM MAIN NAME              02380000
         CLC   XMMEVNM,0(R2)           XMM HEADER MATCH MAIN NAME ?     02390000
         BNE   ERRXMMP                 NO, ERROR XMM POINTER            02400000
*                                                                       02410000
*        GET INFO FROM XMM HEADER                                       02420000
*                                                                       02430000
         L     R5,PRMGVAL              R5 -> OUTPUT AREA FOR FLAGS      02440000
         MVC   0(4,R5),XMMEVFLG        COPY FLAGS TO OUTPUT AREA        02450000
         CTSADBG LEVEL=(DBGLEVEL,1),                                   X02460000
               'XMM HEADER AT ~ EVENT FLAGS=~',(?R9,XMMEVFLG)           02470000
         B     EXIT0                                                    02480000
         DROP  R9                                                       02490000
*                                                                       02500000
****************************************************************        02510000
*        CLEAR OPERATION                                       *        02520000
****************************************************************        02530000
*                                                              *        02540000
* THE CLEAR OPERATION CLEARS THE EVENT FOR THE CURRENT JOBNAME *        02550000
* AND JOBNAME, WHILE RETURNING THE STATUS OF THE EVENT BEFORE  *        02560000
* IT WAS CLEARED                                               *        02570000
*                                                              *        02580000
****************************************************************        02590000
*                                                                       02600000
CLEAR    DS    0H                                                       02610000
*                                                                       02620000
*        GET EVENT NUMBER TO BE CLEARED                                 02630000
*                                                                       02640000
         L     R5,PRMCEVNM             R5 -> EVENT NUMBER TO CLEAR      02650000
         L     R5,0(R5)                R5 =  EVENT NUMBER TO CLEAR      02660000
         CTSADBG LEVEL=(DBGLEVEL,1),                                   X02670000
               'CLEARING EVENT NUM = #',?R5                             02680000
*                                                                       02690000
*        CHECK EVENT NUMBER VALIDITY (1 - 32)                           02700000
*                                                                       02710000
         LTR   R5,R5                   EVENT NUM >= 1 ?                 02720000
         BNP   ERREVNM1                NO, EVENT NUM ERROR              02730000
         CH    R5,=H'32'               EVENT NUM <= 32 ?                02740000
         BH    ERREVNM2                NO, EVENT NUM ERROR              02750000
*                                                                       02760000
*        CHECK XMM HEADER VALIDITY                                      02770000
*                                                                       02780000
         L     R9,PRMCXMMH             R9 -> CURRENT XMM HEADER         02790000
         USING XMMHDR,R9               MAP IT                           02800000
*                                                                       02810000
         CTSADBG LEVEL=(DBGLEVEL,1),                                   X02820000
               'XMM HEADER AT ~ JBN=_/$ MAIN=_/$ EVENT FLAGS=~',       X02830000
               (?R9,XMMMNAME,8,XMMMNAME,8,XMMEVNM,8,XMMEVNM,8,XMMEVFLG) 02840000
*                                                                       02850000
         L     R2,PRMCJBN              R2 -> XMM JOBNAME                02860000
         CLC   XMMMNAME,0(R2)          XMM HEADER MATCH JOBNAME ?       02870000
         BNE   ERRXMMP                 NO, ERROR XMM POINTER            02880000
         L     R2,PRMCMAIN             R2 -> XMM MAIN NAME              02890000
         CLC   XMMEVNM,0(R2)           XMM HEADER MATCH MAIN NAME ?     02900000
         BNE   ERRXMMP                 NO, ERROR XMM POINTER            02910000
*                                                                       02920000
*        CREATE EVENT MASK                                              02930000
*                                                                       02940000
         LR    R1,R5                   R1 = EVENT NUM                   02950000
         L     R5,=X'80000000'         R5 = EVENT BIT 1 IS ON           02960000
         SH    R1,=H'1'                                                 02970000
         BZ    CLRMOK                                                   02980000
CLRMLUP  SRL   R5,1                                                     02990000
         BCT   R1,CLRMLUP                                               03000000
CLRMOK   DS    0H                                                       03010000
*                                                                       03020000
*        RETURN STATUS OF THE EVENT                                     03030000
*                                                                       03040000
         CTSADBG LEVEL=(DBGLEVEL,1),                                   X03050000
               'EVENT MASK = ~  EVENT FLAGS=~',                        X03060000
               (?R5,XMMEVFLG)                                           03070000
*                                                                       03080000
         L     R2,PRMCEVST             R2 -> OUTPUT STATUS              03090000
         XC    0(4,R2),0(R2)           ASSUME THE EVENT ALREADY OFF     03100000
         L     R1,XMMEVFLG             R0 = FLAG WORD                   03110000
         NR    R1,R5                   R1 = UPDATED FLAG WORD           03120000
         BZ    EXIT0                   STATUS WAS OFF, NOTHING TO CLEAR 03130000
         MVC   0(4,R2),=F'1'           SET STATUS PARAMETER TO ON       03140000
*                                                                       03150000
*        CLEAR THE EVENT FROM THE XMM HEADER                            03160000
*                                                                       03170000
         MODESET MODE=SUP,KEY=ZERO     NEED TO UPDATE KEY0 STROAGE      03180000
CLRCSOFF DS    0H                                                       03190000
         L     R0,XMMEVFLG             R0 = FLAG WORD                   03200000
         LR    R1,R0                   R1 = FLAG WORD                   03210000
         XR    R1,R5                   R1 = UPDATED FLAG WORD           03220000
         CS    R0,R1,XMMEVFLG          UDPATE FLAG WORD IN XMM          03230000
         BNZ   CLRCSOFF                IF ERROR, RETRY                  03240000
         MODESET MODE=PROB,KEY=NZERO                                    03250000
*                                                                       03260000
         CTSADBG LEVEL=(DBGLEVEL,1),                                   X03270000
               'NEW XMM FLAGS = ~',(XMMEVFLG)                           03280000
         B     EXIT0                                                    03290000
         DROP  R9                                                       03300000
*                                                                       03310000
****************************************************************        03320000
*        BRODCAST OPERATION                                    *        03330000
****************************************************************        03340000
*                                                              *        03350000
*    BRODCAST OPERATION USES THE MAIN NAME MASK TO SET/CLR AN  *        03360000
*    EVENT FLAG FOR ALL THE XMM HEADERS WITH A MATCHING MAIN   *        03370000
*    NAME EXECPT FOR OUR OWN XMM HEADER                        *        03380000
*                                                              *        03390000
****************************************************************        03400000
*                                                                       03410000
BRDCST   DS    0H                                                       03420000
*                                                                       03430000
*        GET EVENT NUMBER AND STATUS                                    03440000
*                                                                       03450000
         L     R5,PRMBEVNM             R5 -> EVENT NUMBER               03460000
         L     R5,0(R5)                R5 =  EVENT NUMBER               03470000
         L     R6,PRMBEVST             R6 -> EVENT STATUS               03480000
         L     R6,0(R6)                R6 = EVENT STATUS                03490000
*                                                                       03500000
         CTSADBG LEVEL=(DBGLEVEL,1),                                   X03510000
               'EVENT NUM = # STATUS = #',(?R5,?R6)                     03520000
*                                                                       03530000
*        CHECK EVENT NUMBER VALIDITY (1 - 32)                           03540000
*                                                                       03550000
         LTR   R5,R5                   EVENT NUM >= 1 ?                 03560000
         BNP   ERREVNM1                NO, EVENT NUM ERROR              03570000
         CH    R5,=H'32'               EVENT NUM <= 32 ?                03580000
         BH    ERREVNM2                NO, EVENT NUM ERROR              03590000
*                                                                       03600000
*        CHECK EVENT STATUS (1 - ON/0 - OFF)                            03610000
*                                                                       03620000
         LTR   R6,R6                   EVENT STATUS = 0 ?               03630000
         BZ    EVSTTOK                 YES, OK - EVENT TO BE TURNED OFF 03640000
         CH    R6,=H'1'                EVENT STATUS = 1 ?               03650000
         BNE   ERREVSTT                NO, EVENT STATUS ERROR           03660000
EVSTTOK  DS    0H                                                       03670000
*                                                                       03680000
*        CHECK MAIN NAME VALIDITY                                       03690000
*                                                                       03700000
         L     R7,PRMBMAIN             R7 -> MAIN NAME MASK             03710000
         CLI   0(R7),C' '              MASK SPECIFIED ?                 03720000
         BNH   ERRMAIN                 NO, ERROR                        03730000
*                                                                       03740000
*        CREATE EVENT MASK - BIT NN IS ON (WHERE NN IS THE EVENT NUM)   03750000
*                                                                       03760000
         LR    R1,R5                   R1 = EVENT NUM                   03770000
         L     R5,=X'80000000'         R5 = EVENT BIT 1 IS ON           03780000
         SH    R1,=H'1'                                                 03790000
         BZ    BRDMOK                                                   03800000
BRDMLUP  SRL   R5,1                                                     03810000
         BCT   R1,BRDMLUP                                               03820000
BRDMOK   DS    0H                                                       03830000
         CTSADBG LEVEL=(DBGLEVEL,1),                                   X03840000
               'EVENT MASK = ~',?R5                                     03850000
*                                                                       03860000
*        GET XMM FIRST HEADER ADDRESS                                   03870000
*                                                                       03880000
         L     R3,PARMSSN              R3 -> SUBSYSTEM NAME             03890000
         CTSCALL CTSAXMH,((3),BLANK,ADDRXMMH)                           03900000
         CH    R15,=H'4'               ANY XMM BLOCK FOUND ?            03910000
         BH    ERRXMM                  ERROR - RETURN ERROR RC          03920000
         BE    EXIT4                   NO XMM BLOCKS                    03930000
         L     R9,ADDRXMMH             R9 -> FIRST XMM BLOCK            03940000
         USING XMMHDR,R9               MAP XMM HEADER BLOCK             03950000
         MVI   BRDFLAG,C'N'                                             03960000
*                                                                       03970000
*        LOOP ON XMM HEADERS                                            03980000
*                                                                       03990000
BRDLOOP  DS    0H                                                       04000000
         CTSADBG LEVEL=(DBGLEVEL,1),                                   X04010000
               'BRDLOOP: CURRENT XMM AT ~ NEXT XMM ~',                 X04020000
               (?R9,XMMNXTAD)                                           04030000
*                                                                       04040000
*        IGNORE XMM BLOCK IF IT IS OUR OWN BLOCK                        04050000
*                                                                       04060000
         L     R2,PRMBXMMH             R2 -> OUR OWN XMM BLOCK          04070000
         CR    R2,R9                   CURRENT BLOCK OUR OWN ?          04080000
         BE    BRDNEXT                 YES, IGNORE IT                   04090000
         L     R2,PRMBJBN              R2 -> OUR XMM JBN                04100000
         CLC   XMMMNAME,0(R2)          CURRENT BLOCK OUR OWN ?          04110000
         BE    BRDNEXT                 YES, IGNORE IT                   04120000
*                                                                       04130000
*        IGNORE XMM BLOCK IF IT HAS NOT INITIALIZED ITS EVENTS          04140000
*                                                                       04150000
         TRT   XMMEVNM,TABNOPRT        XMM MAIN NAME INITIALIZED ?      04160000
         BNZ   BRDNEXT                 UNPRINTABLES FOUND - NO INIT     04170000
*                                                                       04180000
*        IGNORE XMM BLOCK IF MAIN NAME DOES NOT MATCH                   04190000
*                                                                       04200000
         CTSADBG LEVEL=(DBGLEVEL,1),                                   X04210000
               'XMM MAIN=_/$ BRD MAIN=_/$',                            X04220000
               (XMMEVNM,8,XMMEVNM,8,0(R7),8,0(R7),8)                    04230000
         CLC   =C'*ALL*',0(R7)         IS IT BROADCAST TO ALL ?         04240000
         BE    BRDDO                   YES, THEN SKIP MAIN NAME CHECK   04250000
         CLC   XMMEVNM,0(R7)           NO, CHECK MAIN NAME MATCHING     04260000
         BNE   BRDNEXT                 NO, IGNORE CURRENT XMM BLOCK     04270000
BRDDO    DS    0H                                                       04280000
         MVI   BRDFLAG,C'Y'            AT LEAST ONE BROADCAST DONE      04290000
*                                                                       04300000
*        UPDATE EVENT BIT IN XMM HEADER                                 04310000
*                                                                       04320000
         MODESET MODE=SUP,KEY=ZERO     NEED TO UPDATE KEY0 STROAGE      04330000
         LTR   R6,R6                   TURN EVENT BIT ON ?              04340000
         BNZ   BRDCSON                 YES, DO IT                       04350000
*                                                                       04360000
*        TURN EVENT BIT OFF                                             04370000
*                                                                       04380000
BRDCSOFF DS    0H                                                       04390000
         L     R0,XMMEVFLG             R0 = FLAG WORD                   04400000
         LR    R1,R0                   R1 = FLAG WORD                   04410000
         XR    R1,R5                   R1 = UPDATED FLAG WORD           04420000
         CS    R0,R1,XMMEVFLG          UDPATE FLAG WORD IN XMM          04430000
         BNZ   BRDCSOFF                IF ERROR, RETRY                  04440000
         B     BRDDONE                 OK , CONTINU TO NEXT XMM         04450000
*                                                                       04460000
*        TURN EVENT BIT ON                                              04470000
*                                                                       04480000
BRDCSON  DS    0H                                                       04490000
         L     R0,XMMEVFLG             R0 = FLAG WORD                   04500000
         LR    R1,R0                   R1 = FLAG WORD                   04510000
         OR    R1,R5                   R1 = UPDATED FLAG WORD           04520000
         CS    R0,R1,XMMEVFLG          UDPATE FLAG WORD IN XMM          04530000
         BNZ   BRDCSON                 IF ERROR, RETRY                  04540000
         B     BRDDONE                 OK , CONTINU TO NEXT XMM         04550000
*                                                                       04560000
*        BACK TO PROBLEM STATE                                          04570000
*                                                                       04580000
BRDDONE  DS    0H                                                       04590000
         MODESET MODE=PROB,KEY=NZERO                                    04600000
         CTSADBG LEVEL=(DBGLEVEL,1),                                   X04610000
               'NEW XMM FLAGS = ~',(XMMEVFLG)                           04620000
*                                                                       04630000
*        ADVANCE TO NEXT XMM BLOCK                                      04640000
*                                                                       04650000
BRDNEXT  DS    0H                                                       04660000
         ICM   R9,15,XMMNXTAD          R9 -> NEXT XMM HEADER            04670000
         BNZ   BRDLOOP                 KEEP THE GOOD WORK               04680000
         CLI   BRDFLAG,C'Y'            ANY BRODCAST EXECUTED ?          04690000
         BNE   EXIT4                   NO, SPECIAL RC                   04700000
         B     EXIT0                   NO MORE XMM BLOCKS               04710000
         DROP  R9                                                       04720000
*                                                                       04730000
****************************************************************        04740000
*        SNAP OPERATION                                        *        04750000
****************************************************************        04760000
*                                                                       04770000
SNAP     DS    0H                                                       04780000
*                                                                       04790000
*        GET XMM FIRST HEADER ADDRESS                                   04800000
*                                                                       04810000
         L     R3,PARMSSN              R3 -> SUBSYSTEM NAME             04820000
         CTSCALL CTSAXMH,((3),BLANK,ADDRXMMH)                           04830000
         CH    R15,=H'4'               ANY XMM BLOCK FOUND ?            04840000
         BH    ERRXMM                  ERROR - RETURN ERROR RC          04850000
         BE    EXIT4                   NO XMM BLOCKS                    04860000
         L     R9,ADDRXMMH             R9 -> FIRST XMM BLOCK            04870000
         USING XMMHDR,R9               MAP XMM HEADER BLOCK             04880000
*                                                                       04890000
*        LOOP ON XMM HEADERS                                            04900000
*                                                                       04910000
SNPLOOP  DS    0H                                                       04920000
         CTSADBG LEVEL=(DBGLEVEL,1),TYPE=SNAP,ID=1,                    X04930000
               HDR=' ** XMM HEADER **',                                X04940000
               ADDR=(0(R9),XMMHDRLN(R9))                                04950000
*                                                                       04960000
         CTSADBG 'XMM=~ NXT=$ JBN=_ MAIN=_ FLAGS=$',                   X04970000
               (?R9,XMMNXTAD,4,XMMMNAME,8,XMMEVNM,8,XMMEVFLG,4)         04980000
*                                                                       04990000
         ICM   R9,15,XMMNXTAD          R9 -> NEXT XMM HEADER            05000000
         BNZ   SNPLOOP                 KEEP THE GOOD WORK               05010000
         B     EXIT0                   NO MORE XMM BLOCKS               05020000
         DROP  R9                                                       05030000
*                                                                       05040000
****************************************************************        05050000
*        RETURN CODE AND EXIT                                  *        05060000
****************************************************************        05070000
*                                                                       05080000
*        FINISH OK                                                      05090000
*                                                                       05100000
EXIT0    DS    0H                                                       05110000
         XC    RCREG,RCREG                                              05120000
         B     EXIT                                                     05130000
*                                                                       05140000
*        XMM BLOCK NOT FOUND                                            05150000
*                                                                       05160000
EXIT4    DS    0H                                                       05170000
         MVC   RCREG,=F'4'                                              05180000
         MVC   RC,=F'4'                                                 05190000
         B     EXIT                                                     05200000
*                                                                       05210000
*        NO XMM ERROR                                                   05220000
*                                                                       05230000
ERRXMM   DS    0H                                                       05240000
         MVC   RCREG,=F'8'                                              05250000
         MVC   RC,=F'8'                                                 05260000
         ST    R15,REASON                                               05270000
         B     EXIT                                                     05280000
*                                                                       05290000
ERRXMMP  DS    0H                                                       05300000
         MVC   RCREG,=F'8'                                              05310000
         MVC   RC,=F'8'                                                 05320000
         B     EXIT                                                     05330000
*                                                                       05340000
*        PARAMETERS ERROR                                               05350000
*                                                                       05360000
ERREVNM1 DS    0H                                                       05370000
         MVC   REASON,=F'4'                                             05380000
         B     ERRPARM                                                  05390000
ERREVNM2 DS    0H                                                       05400000
         MVC   REASON,=F'8'                                             05410000
         B     ERRPARM                                                  05420000
ERREVSTT DS    0H                                                       05430000
         MVC   REASON,=F'12'                                            05440000
         B     ERRPARM                                                  05450000
ERRMAIN  DS    0H                                                       05460000
         MVC   REASON,=F'16'                                            05470000
         B     ERRPARM                                                  05480000
ERRPARM  DS    0H                                                       05490000
         MVC   RC,=F'16'                                                05500000
         MVC   RCREG,=F'16'                                             05510000
         B     EXIT                                                     05520000
*                                                                       05530000
*        RETURN TO CALLER                                               05540000
*                                                                       05550000
EXIT     DS    0H                                                       05560000
         L     R1,PARMRC                                                05570000
         MVC   0(4,R1),RC                                               05580000
         L     R1,PARMRS                                                05590000
         MVC   0(4,R1),REASON                                           05600000
*                                                                       05610000
         L     R2,AMODE                                                 05620000
         CTSAMOD RESTORE,R=R2                                           05630000
*                                                                       05640000
         L     R15,RCREG                                                05650000
         BRTRN (15)                                                     05660000
         LTORG ,                                                        05670000
*                                                                       05680000
*        WORK AREA                                                      05690000
*                                                                       05700000
ADDRXMMH DS    F                                                        05710000
RC       DS    F                                                        05720000
REASON   DS    F                                                        05730000
RCREG    DS    F                                                        05740000
AMODE    DS    F                                                        05750000
BLANK    DC    CL8' '                                                   05760000
DBGLEVEL DC    X'00'                                                    05770000
BRDFLAG  DC    C'N'                                                     05780000
TABNOPRT DC    256X'00'                                                 05790000
         ORG   TABNOPRT                                                 05800000
         DC    64X'FF'                                                  05810000
         ORG   ,                                                        05820000
*                                                                       05830000
****************************************************************        05840000
*        IOA CONTROL BLOCKS                                    *        05850000
****************************************************************        05860000
*                                                                       05870000
         COPY  CTSAXMM                                                  05880000
*                                                                       05890000
****************************************************************        05900000
*        MVS CONTROL BLOCKS                                    *        05910000
****************************************************************        05920000
*                                                                       05930000
         PRINT  NOGEN                                                   05940000
         IHAPSA                                                         05950000
         IKJTCB                                                         05960000
         IEESMCA                                                        05970000
         IHASDWA                                                        05980000
CVT      CVT   DSECT=YES,PREFIX=YES,LIST=YES                            05990000
*WS10047 TIOT  DSECT                                                    06000000
*WS10047 IEFTIOT1                                                       06010000
         IEFJSCVT                                                       06020000
         IHAASCB ,                                                      06030000
         IHAASVT ,                                                      06040000
*                                                                       06050000
         IEZJSCB ,                                             WS10047  06060000
*                                                                       06070000
CSCB     DSECT                                                 WS10047  06080000
         IEECHAIN ,                                            WS10047  06090000
         END                                                            06100000
