         TITLE 'CTSAVPS - VERIFY USER PASSWORD'                         00010000
*                                                                       00020000
****************************************************************        00030000
****                                                        ****        00040000
****     CONTROL-SA  RELEASE 3.1.02                         ****        00050000
****                                                        ****        00060000
****     LICENCED MATERIAL - BMC INC.                       ****        00070000
****                                                        ****        00080000
****************************************************************        00090000
*                                                                       00100000
****************************************************************        00110000
*                                                              *        00120000
* TITLE            : VERIFY THAT THE PASSWORD IS INDEED THE    *        00130000
*                    SPECIFIED USERS PASSWORD.                 *        00140000
*                                                              *        00150000
* FILE NAME        : CTSAVPS                                   *        00160000
*                                                              *        00170000
* AUTHOR           : RAMI KLEIN                                *        00180000
*                                                              *        00190000
* CREATION DATE    : 02/12/01                                  *        00200000
*                                                              *        00210000
* DESCRIPTION      :                                           *        00220000
*                                                              *        00230000
* ASSUMPTIONS AND                                              *        00240000
*   CONSIDERATIONS : 1. CALLER IS APF AUTHORIZED               *        00250000
*                                                              *        00260000
****************************************************************        00270000
*                                                                       00280000
****************************************************************        00290000
* MOD.ID   WHO      WHEN     DESCRIPTION                       *        00300000
* -------- -------- -------- --------------------------------- *        00310000
* WS2460    YONATAN 11/2/02  ADD AN OPTION TO VERIFY WITHOUT   *        00320000
*                            PERFORMING LOGON (RACF)           *        00330000
* BS2509   RAMIK  03/03/2002 INTERNAL ERRORS IN ONLINE INTRCPTR*        00340000
* BS2558   AVNERL 12/02/2003 DIAG MSG CAUSES AUTH ABEND.       *        00350000
* IS0041   AVNERL 28/02/2003 USE EXTRACT PASSWORD FOR ACF2.    *        00360000
* WS2557   ELIMY  22/05/2006 RACF MIXEDCASE PASSWORD SUPPORT   *        00370000
*                            FOR ZOS1.7                        *        00380000
* WS2565   ELIMY  22/05/2006 RACF MIXEDCASE PASSWORD SUPPORT   *        00390000
*                            FOR ACF2 R8 AND UP                *        00400000
* IS10002  AVNERL 12/02/2007 FIX EXTRACT PSWD CODE.            *        00410000
* BS10011  AV&SHM 16/07/2008 S878 IN ONLI.                     *        00420000
* WS10020  AVNERL 04/02/2009 MIXED CASE PASS 4 TSS             *        00430000
* IS10065  NURITY 15/01/2012 ABEND S0C4 IN CTSAMVN             *        00440000
* IS10066  NURITY 16/01/2012 VERIFY PASSWORD SUCCEEDS EVEN     *        00450000
*                            WHEN THE USER IS REVOKED / EXPIRED*        00460000
*                            NOTE: MOST MOVED/DELETED COMMANDS *        00470000
*                                  ARE NOT MARKED WITH CHANGEID*        00480000
* IS10107  NURITY 23/12/2013 CORRECT MIXED-CASE PASSWORD       *        00490000
*                            HANDLING.                         *        00500000
* BS10045  AVNERL 12/05/2015 S0C4 WHEN VERIFY PASSWORD FAILS.  *        00510000
* WS10051  AVNERL 06/09/2015 SUPPORT KDFAES                    *        00520000
* WS10052  AVNERL 04/02/2016 SUPPORT ACF2 R16                  *        00530000
* SAS2IBMN NURITY 12/12/2016 1. REMOVE PATCH= FROM CTSLEVEL    *        00540000
*                            2. HANDLE USING WARNING.          *        00550000
*                            3. CHANGE RMODE TO 24 (CTSADBG)   *        00560000
* IS10147A SELIGT 29/05/2017 ADD SUPPORT FOR PASSWORD PHRASE   *        00570000
* BS10088  NURITY 23/05/2018 PSWD-TOD CHECK CAUSES A PROBLEM   *        00570000
*                            WHEN AES2 ENCRYPTION IS ACTIVE.   *        00570000
* BS10104  SELIGT 01/07/2020 WHEN PSWD PHRASE IS IN INPUT BUT  *        00570000
*                            RACF EXTRACT RETURNS NO PSWD      *        00570000
*                            PHRASE, TREAT IT AS 'PSWD PHRASE  *        00570000
*                            DOES NOT MATCH' (R15=8; SAF RC=8; *        00570000
*                            RSS RC=8; RSS RS=0) AND DO NOT    *
*                            PRINT THE 'VERXRACF FAILED' DIAG  *
*                            MESSAGE AND THE SNAP DUMP         *
* IS10183  THOMAS 02/11/2020 REMOVE PASWD IN CLEAR FROM DIAG   *        00440000
* IS10188  AVNERL 06/10/24   MOVE OUR MODULES ABOVE 16M LINE   *
****************************************************************        00590000
*                                                                       00600000
* WS2565 - CA MACRO FOR ACF2 R9 WERE ADDED FOR COMPILE AND LINK.        00610000
*                                                                       00620000
         PRINT GEN                                                      00630000
*IS10066 GBLC   &AMODUSE                                                00640000
*IS10066 &AMODUSE SETC    'CVT'                                         00650000
****************************************************************        00660000
*                    INTERNAL MACROS                           *        00670000
****************************************************************        00680000
         MACRO                                                  IS10066 00690000
&NAME    CRFLST &FIELDS,           LIST OF FIELD NAMES          IS10066X00700000
               &LSTALGN=X,         LIST ALIGNMENT (X, A, Y, ETC.) 10066X00710000
               &ENTLEN=,           ENTRY LENGTH.                IS10066X00720000
               &CRECNTB=NO,        CREATE COUNT FIELD BEFORE NAMES. 066X00730000
               &CRECNTA=NO,        CREATE COUNT FIELD AFTER NAMES. 0066X00740000
               &CNTLEN=,           COUNT FIELD LENGTH.          IS10066X00750000
               &CRERTNA=NO,        CREATE ROUTINE POINTERS LIST.IS10066X00760000
               &RTNPFX=            ROUTINE NAMES PREFIX.        IS10066 00770000
.**                                                             IS10066 00780000
.**      CRFLST                                                 IS10066 00790000
.**      ======                                                 IS10066 00800000
.**                                                             IS10066 00810000
.**      CREATE THE LIST OF THE FIELDS TO BE RETRIEVED USING    IS10066 00820000
.**      ACF2 SVC OR RACROUTE AND, IF REQUESTED, THE            IS10066 00830000
.**      CORRESPONDING LIST OF OF A-CONSTANTS POINTING TO       IS10066 00840000
.**      TYHE FIELDS' PROCESSING ROUTINES. THESE ROUTINES       IS10066 00850000
.**      WILL BE CALLED BY THE PROGRAM TO PROCESS THE DATA      IS10066 00860000
.**      RETRIEVED BY ACF2 SVC.                                 IS10066 00870000
.**                                                             IS10066 00880000
.**      THE NAMES OF THE ROURTINES ARE CREATED USING THE       IS10066 00890000
.**      FIELD NAMES, PREFIXED WHEN &PRFRTN AND APPENDED        IS10066 00900000
.**      WITH 'A'.                                              IS10066 00910000
.**                                                             IS10066 00920000
.**      FIELD NAMES MAY CONTAIN HYPHENS ('-') WHICH ARE NOT    IS10066 00930000
.**      SUPPRTED IN SYMBOL NAME. THEREFORE, WHEN CREATING      IS10066 00940000
.**      THE NAMES OF THE ROUTINES, HYPHENS ARE REMOVED FROM    IS10066 00950000
.**      THE FIELD NAMES AND THE ROUTINE NAMES ARE CREATED      IS10066 00960000
.**      USING THE FIELD NAME WITHOUT THE HYPHENS.  (SEE        IS10066 00970000
.**      EXAMPLE BELOW).                                        IS10066 00980000
.**                                                             IS10066 00990000
.**      THE PROGRAM SHOULD CONTAIN THESE ROUTINES. OTHERWISE,  IS10066 01000000
.**      ASSEMBLY WILL FAIL.                                    IS10066 01010000
.**                                                             IS10066 01020000
.**      INPUT:                                                 IS10066 01030000
.**      1. LABEL                                               IS10066 01040000
.**      2. FIELD NAMES, SEPARATED WITH A COMMA.                IS10066 01050000
.**      3. LSTALGN - LIST ALIGNMENT (X, A, Y, ETC.)            IS10066 01060000
.**                   DEFAULT - X                               IS10066 01070000
.**      4. CRECNTB - CREATE A COUNT FIELD AT THE BEGINNING     IS10066 01080000
.**                   OF THE LIST (YES, NO). DEFAULT = NO       IS10066 01090000
.**      5. CRECNTA - CREATE COUNT FIELD AT THE END OF THE      IS10066 01100000
.**                   LIST (YES, NO). DEFAULT = NO              IS10066 01110000
.**      6. CNTLEN  - COUNT FIELD LENGTH. NO DEFAULT.           IS10066 01120000
.**      7. CRERTNA - CREATE LIST OF ROUTINE ADDRESSES AS       IS10066 01130000
.**                   EXPLAINED ABOVE (YES, NO). DEFAULT = NO   IS10066 01140000
.**      8. RTNPFX  - PREFIX FOR ROUTINE NAMES. REQUIRED WHEN   IS10066 01150000
.**                   CRERTNA=YES.                              IS10066 01160000
.**                                                             IS10066 01170000
.**      OUTPUT:                                                IS10066 01180000
.**      &NAME#  EQU N    <--  NUMBER OF FIELDS.                IS10066 01190000
.**      &NAME   DS  0X                                         IS10066 01200000
.**              DC  CL8'FIELD1'                                IS10066 01210000
.**              DC  CL8'FIELD2'                                IS10066 01220000
.**                  . . .                                      IS10066 01230000
.**              DC  CL8'FIELDN'                                IS10066 01240000
.**      &NAMEA  DS  0A                                         IS10066 01250000
.**              DC  A(FIELD1A)                                 IS10066 01260000
.**              DC  A(FIELD2A)                                 IS10066 01270000
.**                  . . .                                      IS10066 01280000
.**              DC  A(FIELDNA)                                 IS10066 01290000
.**                                                             IS10066 01300000
.**                                                             IS10066 01310000
.**      CALL EXAMPLE:                                          IS10066 01320000
.**      ACFFLS  CRFLST  PSWD-XTR,PSWD-EXP,SUSPEND              IS10066 01330000
.**                                                             IS10066 01340000
.**      OUTPUT:                                                IS10066 01350000
.**      ACFFLS# EQU 3                                          IS10066 01360000
.**      ACFFLS  DS  0X                                         IS10066 01370000
.**              DC  CL8'PSWD-XTR'                              IS10066 01380000
.**              DC  CL8'PSWD-EXP'                              IS10066 01390000
.**              DC  CL8'SUSPEND'                               IS10066 01400000
.**      ACFFLSA DS  0A                                         IS10066 01410000
.**              DC  A(PSWDXTRA)                                IS10066 01420000
.**              DC  A(PSWDEXPA)                                IS10066 01430000
.**              DC  A(SUSPENDA)                                IS10066 01440000
.**                                                             IS10066 01450000
.**      THE PROGRAM SHOULD CONTAIN LABELS PSWDXTRA, PSWDEXPA   IS10066 01460000
.**      AND SUSPEND, IN WHICH THE DATA FOR THE CORRESPONDING FIELD0066 01470000
.**      SHOULD BE PROCESSE.                                    IS10066 01480000
.**                                                             IS10066 01490000
.**                                                             IS10066 01500000
         LCLA  &N,&I,&INDX,&CL,&NI                              IS10066 01510000
         LCLC  &FLDNM,&TEMPNM,&EL,&LA                           IS10066 01520000
         LCLB  &CCA,&CCB,&CC                                    IS10066 01530000
.*                                                              IS10066 01540000
.**   SET DEFAULTS                                              IS10066 01550000
.*                                                              IS10066 01560000
&LA      SETC  'X'                 BYTE ALIGNMENT.              IS10066 01570000
&CCB     SETB  0                   NO COUNT BEFORE LIST.        IS10066 01580000
&CCA     SETB  0                   NO COUNT AFTER LIST.         IS10066 01590000
&CL      SETA  0                   COUNT FIELD LENGTH.          IS10066 01600000
&EL      SETC  ''                                               IS10066 01610000
.*                                                              IS10066 01620000
.**   VERIFY INPUT PARAMERTERS.                                 IS10066 01630000
.*                                                              IS10066 01640000
         AIF   (T'&NAME EQ 'O').NONAME NAME IS MANDATORY.       IS10066 01650000
         AIF   (N'&SYSLIST EQ 0).NOFLDS FIELDS ARE MANDATORY.   IS10066 01660000
         AIF   (T'&LSTALGN EQ 'O').CHKEL                        IS10066 01670000
&LA      SETC  '&LSTALGN'                                       IS10066 01680000
.CHKEL   ANOP                                                   IS10066 01690000
         AIF   (T'&ENTLEN EQ 'O').CHKCCNT                       IS10066 01700000
&EL      SETC  'L'.'&ENTLEN'                                    IS10066 01710000
.CHKCCNT ANOP                                                   IS10066 01720000
         AIF   ('&CRECNTB' EQ 'NO' AND                                 X01730000
               '&CRECNTA' EQ 'NO').CHKCL  ENTRIES COUNT IS NOT NEEDED 6 01740000
         AIF   ('&CRECNTB' EQ 'YES' AND                                X01750000
               '&CRECNTA' EQ 'YES').CRABERR ONLY ONE COUNT IS ALLOWED 6 01760000
.*                                                              IS10066 01770000
         AIF   ('&CRECNTB' EQ 'NO').CHKCCA                      IS10066 01780000
         AIF   ('&CRECNTB' NE 'YES').CCBERR                     IS10066 01790000
&CCB     SETB  1                                                IS10066 01800000
.CHKCCA  ANOP                                                   IS10066 01810000
         AIF   ('&CRECNTA' EQ 'NO').CHKCCL                      IS10066 01820000
         AIF   ('&CRECNTA' NE 'YES').CCAERR                     IS10066 01830000
&CCA     SETB  1                                                IS10066 01840000
         AIF   (&CCB EQ 1).CCABERR                              IS10066 01850000
.CHKCCL  ANOP                                                   IS10066 01860000
&CL      SETA  1                   DEFAULT COUNT FIELD LENGTH = 1. 0066 01870000
         AIF   (T'&CNTLEN EQ 'O' OR &CNTLEN EQ 0).CREATE        IS10066 01880000
         AIF   (T'&CNTLEN NE 'N' OR &CNTLEN GT 8).CCLERR        IS10066 01890000
&CL      SETA  &CNTLEN                                          IS10066 01900000
         AGO   .CREATE                                          IS10066 01910000
.CHKCL   ANOP                      NO NEED TO CREATE COUNT FIELD. 10066 01920000
         AIF   (T'&CNTLEN EQ 'O').CREATE                        IS10066 01930000
         MNOTE 4,'CNTLEN IS REDUNDANT, COUNT FIELD IS NOT REQUESTED' 66 01940000
.*                                                              IS10066 01950000
.**   CREATE FIELDS LIST                                        IS10066 01960000
.*                                                              IS10066 01970000
.CREATE  ANOP                                                   IS10066 01980000
&I       SETA  1                                                IS10066 01990000
&NI      SETA  0                                                IS10066 02000000
&N       SETA  N'&SYSLIST                                       IS10066 02010000
&NAME    DS    0&LSTALGN           ALIGN LIST.                  IS10066 02020000
         AIF   (NOT &CCB).PUTFLD                                IS10066 02030000
CFL&SYSNDX DS  ADL&CL                                           IS10066 02040000
.PUTFLD  ANOP                                                   IS10066 02050000
         AIF   (T'&SYSLIST(&I) EQ 'O').CFLSKPN                  IS10066 02060000
         DC    C&EL.'&SYSLIST(&I)'                              IS10066 02070000
&NI      SETA  &NI+1               COUNT ENTRIES.               IS10066 02080000
.CFLSKPN ANOP                                                   IS10066 02090000
&I       SETA  &I+1                                             IS10066 02100000
         AIF   (&I LE &N).PUTFLD                                IS10066 02110000
         AIF   (NOT (&CCB OR &CCA)).EQUCNT                      IS10066 02120000
         AIF   (&CCA).SETCNT                                    IS10066 02130000
         ORG   CFL&SYSNDX                                       IS10066 02140000
.SETCNT  ANOP                                                   IS10066 02150000
&NAME.CNT DC   ADL&CL.(&NI)         SET COUNT FIELD.            IS10066 02160000
         ORG   ,                                                IS10066 02170000
.EQUCNT  ANOP                                                   IS10066 02180000
&NAME.#  EQU   &NI                                              IS10066 02190000
         AIF   (T'&ENTLEN EQ 'O').CHCRTNA                       IS10066 02200000
&NAME.EL EQU   &ENTLEN                                          IS10066 02210000
*                                                               IS10066 02220000
.*                                                              IS10066 02230000
.**   CREATE ROUTINE NAMES LIST                                 IS10066 02240000
.*                                                              IS10066 02250000
.CHCRTNA ANOP                                                   IS10066 02260000
         AIF   (T'&CRERTNA EQ 'O' OR '&CRERTNA' EQ 'NO').CFLEND IS10066 02270000
         AIF   ('&CRERTNA' NE 'YES').CRTNAER                    IS10066 02280000
         AIF   (T'&RTNPFX EQ 'O').RTPFXER                       IS10066 02290000
&I       SETA  1                                                IS10066 02300000
&NAME.A  DS   0A                                                IS10066 02310000
.CRNA    ANOP                                                   IS10066 02320000
         AIF   (T'&SYSLIST(&I) EQ 'O').CRNSKPA                  IS10066 02330000
&FLDNM   SETC  '&SYSLIST(&I)'                                   IS10066 02340000
.CRNCNM  ANOP                                                   IS10066 02350000
&INDX    SETA  ('&FLDNM' INDEX '-') REMOVE '-' FROM NAME        IS10066 02360000
         AIF   (&INDX EQ 0).CRNDEFA                             IS10066 02370000
         AIF   (&INDX EQ K'&FLDNM).CRNTRNM                      IS10066 02380000
&TEMPNM  SETC  '&FLDNM'(1,&INDX-1).'&FLDNM'(&INDX+1,*)          IS10066 02390000
         AGO   .CRNSETA                                         IS10066 02400000
.CRNTRNM ANOP                                                   IS10066 02410000
&TEMPNM  SETC  '&FLDNM'(1,&INDX-1)  TRUNCATE THE NAME.          IS10066 02420000
.CRNSETA ANOP                                                   IS10066 02430000
&FLDNM   SETC  '&TEMPNM'                                        IS10066 02440000
         AGO   .CRNCNM                                          IS10066 02450000
.CRNDEFA ANOP                                                   IS10066 02460000
         DC    A(&RTNPFX._&FLDNM.A)                                     02470000
.CRNSKPA ANOP                                                   IS10066 02480000
&I       SETA  &I+1                                             IS10066 02490000
         AIF   (&I LE &N).CRNA                                  IS10066 02500000
         AGO   .CFLEND                                          IS10066 02510000
.*                                                              IS10066 02520000
.**   ISSUE ERROR MESSAGES                                      IS10066 02530000
.*                                                              IS10066 02540000
.NONAME  ANOP                                                   IS10066 02550000
         MNOTE 8,'LABEL IS MANDATORY'                           IS10066 02560000
         AGO   .CFLEND                                          IS10066 02570000
.NOFLDS  ANOP                                                   IS10066 02580000
         MNOTE 8,'AT LEAST ONE FIELD NAME SHOULD BE SPECIFIED'  IS10066 02590000
         AGO   .CFLEND                                          IS10066 02600000
.CRABERR ANOP                                                   IS10066 02610000
         MNOTE 8,'CONFLICTING PARAMETERS CRECNTB=YES AND CRECNTA=YES' 6 02620000
         AGO   .CFLEND                                          IS10066 02630000
.CCBERR  ANOP                                                   IS10066 02640000
         MNOTE 8,'CRECNTB VALUE SHOULD BE "YES" OR "NO"'        IS10066 02650000
         AGO   .CFLEND                                          IS10066 02660000
.CCAERR  ANOP                                                   IS10066 02670000
         MNOTE 8,'CRECNTA VALUE SHOULD BE "YES" OR "NO"'        IS10066 02680000
         AGO   .CFLEND                                          IS10066 02690000
.CCLERR  ANOP                                                   IS10066 02700000
         MNOTE 8,'CRELEN SHOULD BE A NUMBER BETWEEN 1-8'        IS10066 02710000
         AGO   .CFLEND                                          IS10066 02720000
.CRTNAER ANOP                                                   IS10066 02730000
         MNOTE 8,'CRERTNA VALUE SHOULD BE "YES" OR "NO"'        IS10066 02740000
         AGO   .CFLEND                                          IS10066 02750000
.RTPFXER ANOP                                                   IS10066 02760000
         MNOTE 8,'RTNPFX IS REQUIRED WHEN CRERTNA="YES"'        IS10066 02770000
         AGO   .CFLEND                                          IS10066 02780000
.CFLEND  ANOP                                                   IS10066 02790000
         MEND                                                   IS10066 02800000
*                                                               IS10066 02810000
*---------------------------------------------------------------IS10066 02820000
*                                                               IS10066 02830000
         MACRO                                                  IS10066 02840000
&LABEL   CREPSDTF &DSECT=NO,&PREFIX=                            IS10066 02850000
.**                                                             IS10066 02860000
.**      CREPSDTF                                               IS10066 02870000
.**      ========                                               IS10066 02880000
.**                                                             IS10066 02890000
.**      CREATE FIELDS FOR EXPIRATION DATE PROCESSING.          IS10066 02900000
.**                                                             IS10066 02910000
         AIF   (T'&PREFIX EQ 'O').NOPRFX                        IS10066 02920000
         AIF   (T'&LABEL EQ 'O').NOLABEL                        IS10066 02930000
         AIF   ('&DSECT' EQ 'NO').NODSCT,                              X02940000
               ('&DSECT' NE 'YES').DSECTER                      IS10066 02950000
&LABEL   DSECT                                                  IS10066 02960000
         AGO   .FLDS                                            IS10066 02970000
.NODSCT  ANOP                                                   IS10066 02980000
&LABEL   DS    0F                                               IS10066 02990000
.FLDS    ANOP                                                   IS10066 03000000
&PREFIX.PASDAT DS A                PASSWORD DATE (0CYYDDDF)     IS10066 03010000
&PREFIX.PASINT DS H                PASSWORD INTERVAL            IS10066 03020000
&PREFIX.PSEXPF DS X                PASSWORD EXPIRATION FLAG:    IS10066 03030000
&PREFIX.PSEXP  EQU X'FF'           ..PASSWORD EXPIRED.          IS10066 03040000
         AGO   .CPDFEND                                         IS10066 03050000
.NOPRFX  ANOP                                                   IS10066 03060000
         MNOTE 8,'PREFIX IS MANDATORY'                          IS10066 03070000
         AGO   .CPDFEND                                         IS10066 03080000
.NOLABEL ANOP                                                   IS10066 03090000
         MNOTE 8,'LABEL IS MANDATORY'                           IS10066 03100000
         AGO   .CPDFEND                                         IS10066 03110000
.DSECTER ANOP                                                   IS10066 03120000
         MNOTE 8,'DSECT SHOULD BE "YES" OR "NO'                 IS10066 03130000
         AGO   .CPDFEND                                         IS10066 03140000
.CPDFEND ANOP                                                   IS10066 03150000
         MEND                                                   IS10066 03160000
*                                                               IS10066 03170000
*---------------------------------------------------------------IS10066 03180000
*                                                               IS10066 03190000
         MACRO                                                  IS10066 03200000
&LABEL   CONVDATE &DATE,&R                                      IS10066 03210000
.**                                                             IS10066 03220000
.**      CONVDATE                                               IS10066 03230000
.**      ========                                               IS10066 03240000
.**                                                             IS10066 03250000
.**      CONVERT DATE FROM YYDDDF TO 0CYYDDDF                   IS10066 03260000
.**                                                             IS10066 03270000
.**      DATE -> DATE TO CONVERT.                               IS10066 03280000
.**      R - REGISTER NUMBER IN WHICH THE CONVERTED DATE WILL   IS10066 03290000
.**          BE RETURNED.                                       IS10066 03300000
.**                                                             IS10066 03310000
         AIF   (T'&LABEL EQ 'O').SKPLBL                         IS10066 03320000
&LABEL   DS    0H                                               IS10066 03330000
.SKPLBL  ANOP                                                   IS10066 03340000
         LHI   &R,0                                             IS10066 03350000
         CLI   &DATE,X'70'         1900 ?                       IS10066 03360000
         BNL   CDSET_&SYSNDX       ..YES - C=0.                 IS10066 03370000
         IILH  &R,X'0100'          ..NO - C=1.                  IS10066 03380000
CDSET_&SYSNDX  DS 0H                                            IS10066 03390000
         ICM   &R,B'0111',&DATE    R0 = 0CYYDDDF                IS10066 03400000
         OILL  &R,X'000F'          FORCE DECIMAL CHAR TO 'F'.   IS10066 03410000
         MEND                                                   IS10066 03420000
*                                                               IS10066 03430000
*---------------------------------------------------------------IS10066 03440000
*                                                               IS10066 03450000
         MACRO                                                  IS10066 03460000
&LABEL   COMPDATE &RDATE,&DATEFLG                               IS10066 03470000
.**                                                             IS10066 03480000
.**      COMPDATE                                               IS10066 03490000
.**      ========                                               IS10066 03500000
.**                                                             IS10066 03510000
.**      COMPARE DATE TO TODAY AND SET AN FLAG ACCORDING        IS10066 03520000
.**      TO THE RESULTS.                                        IS10066 03530000
.**                                                             IS10066 03540000
.**      RDATE = REGISTER CONTAINING THE DATE.                  IS10066 03550000
.**      DATEFLG - DATE FLAG (FIELD NAME OF D(B) FORMAT)).      IS10066 03560000
.**                                                             IS10066 03570000
         AIF   (T'&LABEL EQ 'O').SKPLBL                         IS10066 03580000
&LABEL   DS    0H                                               IS10066 03590000
.SKPLBL  ANOP                                                   IS10066 03600000
         CL    &RDATE,TODAYDAY     COMPARE DATE WITH TODAY      IS10066 03610000
         BL    DLT&SYSNDX         DATE < TODAY.                 IS10066 03620000
         BE    DEQ&SYSNDX         DATE = TODAY.                 IS10066 03630000
         MVI   &DATEFLG,DATATDAY   DATE > TODAY.                IS10066 03640000
         B     DCE&SYSNDX                                       IS10066 03650000
DLT&SYSNDX DS 0H                  DATE < TODAY                  IS10066 03660000
         MVI   &DATEFLG,DATBTDAY                                IS10066 03670000
         B     DCE&SYSNDX                                       IS10066 03680000
DEQ&SYSNDX DS 0H                  DATE < TODAY                  IS10066 03690000
         MVI   &DATEFLG,DATETDAY                                IS10066 03700000
DCE&SYSNDX DS  0H                                               IS10066 03710000
         MEND                                                   IS10066 03720000
*                                                                       03730000
*--------------------------------------------------------------*        03740000
*        START OF PROGRAM                                               03750000
*--------------------------------------------------------------*        03760000
CTSAVPS  CSECT                                                          03770000
*SAS2IBMN CTSAVPS  RMODE ANY                                            03780000
*IS10188 CTSAVPS  RMODE 24            CTSADBG                 SAS2IBMN  03790000
CTSAVPS  RMODE ANY                                  SAS2IBMN  IS10188   03790000
CTSAVPS  AMODE ANY                                                      03800000
*                                                                       03810000
*--------------------------------------------------------------*        03820000
*        INITIALIZE                                                     03830000
*--------------------------------------------------------------*        03840000
         BEGIN *                                                        03850000
         CTSEQUR                                                        03860000
         LA    R11,4095(,R13)          2ND BASE REG IS SET      IS0041  03870000
*IS10066 LA    R11,1(,R11)             ------""-----------      IS0041  03880000
*IS10066 USING CTSAVPS+4096,R11        ------""-----------      IS0041  03890000
*IS10066 LA    R9,4095(R11)            3ID BASE REG IS SET      WS2565  03900000
*IS10066 LA    R9,1(R9)                ------""-----------      WS2565  03910000
*IS10066 USING CTSAVPS+4096+4096,R9    ------""-----------      WS2565  03920000
*IS10066 CTSLEVEL                                                       03930000
         LARL  R11,CONST                                        IS10066 03940000
         LA    R12,4095(,R11)          SET 2ND BASE REGISTER   IS10147A 03950000
         LA    R12,1(,R12)             SET 2ND BASE REGISTER   IS10147A 03960000
*IS10147AUSING CONST,R11                                                03970000
         USING CONST,R11,R12           SET 2ND BASE REGISTER   IS10147A 03980000
*SAS2IBMN CTSLEVEL PATCH=NO                                     IS10066 03990000
         CTSLEVEL                                              SAS2IBMN 04000000
*                                                                       04010000
         LR    R10,R1                  R10 CONTAINS POINTER TO PARMS    04020000
         USING PRM,R10                 R10 POINTS TO INPUT PARMS        04030000
*                                                                       04040000
*IS10066 CTSAMOD 31,R=R2               MOVE INTO AMODE 31               04050000
*IS10066 ST    R2,AMODE                SAVE OLD AMODE                   04060000
*IS10188 TAM   ,                   TEST ADDRESSING MODE         IS10066 04070000
*IS10188 IPM   R1                  RETRIEVE CC AND PROGRAM MASK IS10066 04080000
*IS10188 NILH  R1,X'3000'          LEAVE ONLY CC.               IS10066 04090000
*IS10188 SRL   R1,28               MOVE CC TO THE RIGHT.        IS10066 04100000
*IS10188 ST    R1,AMODE            SAVE TAM TEST RESULTS.       IS10066 04110000
*IS10188 SAM31                     SET AMODE 31.                IS10066 04120000
         CTSAAMD 31,AMODSAV=AMODE                              IS10188
*                                                                       04130000
         L     R4,PRMDBG               R4 -> DEBUG LEVEL (4 BYTES)      04140000
         XC    DBGLEVEL,DBGLEVEL       STORE DEBUG LEVEL                04150000
         ICM   R4,15,0(R4)             DEBUG LEVEL                      04160000
         BNP   NODEBUG                 SKIP DEBUG LVL IF MINUS          04170000
         STC   R4,DBGLEVEL             STORE DEBUG LEVEL (1 BYTE)       04180000
NODEBUG  DS    0H                                                       04190000
*                                                                       04200000
****************************************************************        04210000
*        CHECK ZOS VERSION AND ALLOW LOWER CASE PASSWORD                04220000
****************************************************************        04230000
*                                                               IS10066 04240000
**   TAKE RSS TYPE.                                             IS10066 04250000
*                                                               IS10066 04260000
*IS10147AMVC   RSSTYPE,BLANKS8         PUTTING ALL BLANKS IN RSS TYPE.  04270000
         MVC   RSSTYPE,BLANKS          CLEAR RSS TYPE FIELD    IS10147A 04280000
         L     R4,PRMTYPE              R4 POINTS TO USERID      IS10066 04290000
         LA    R1,RSSTYPE              R1 POINTS TO RSS TYPE FIELD10066 04300000
         LA    R2,L'RSSTYPE            R2 CONTAINS MAX LEN OF RSS TYPE. 04310000
RSSTLOOP DS    0H                                               IS10066 04320000
         CLI   0(R4),C' '              IS CHAR BLANK\X'00' OR LOWER? 66 04330000
         BNH   RSSTENDL                IF YES WE STOP LOOP.     IS10066 04340000
         MVC   0(1,R1),0(R4)           MOVE CHAR FROM PARM TO FIELD 066 04350000
         LA    R1,1(,R1)               ADVANCE FIELD POINTER    IS10066 04360000
         LA    R4,1(,R4)               ADVANCE PARM POINTER     IS10066 04370000
         BCT   R2,RSSTLOOP             CHECK NEXT CHAR, IF EXISTS. 0066 04380000
RSSTENDL DS    0H                                               IS10066 04390000
         CTSADBG LEVEL=(DBGLEVEL,1),                            IS0041 *04400000
               'RSS TYPE=_',                                    IS0041 *04410000
               (RSSTYPE,4),                                     IS0041 X04420000
               RAREA=RAREA,DBGAREA=DBGAREA                      IS10066 04430000
*IS10147ACLC   RSSTYPE,BLANKS8     RSS NAME SUPPLIED ?          IS10066 04440000
         CLC   RSSTYPE,BLANKS      RSS NAME SUPPLIED ?         IS10147A 04450000
         BE    RSSNMERR            ..NO - ERROR.                IS10066 04460000
*                                                                       04470000
**   VERIFY RSS TYPE AND CHECK IF RSS ACTIVE                            04480000
*                                                                       04490000
         CLC   RSSTYPE,ACF2        ACF2 ?                       IS10066 04500000
         BE    ACF2LUP                                          IS10066 04510000
*                                                                       04520000
         L     R1,CVTPTR              LOAD ADDR CVT              WS2557 04530000
         USING CVT,R1                 ADDRESSABILITY CVT DSECT   WS2557 04540000
*                                                                       04550000
         L     R2,CVTRAC              LOAD ADDR RACF CVT         WS2557 04560000
         LTR   R2,R2                  ADDR SUPPLIED ?            WS2557 04570000
*IS10066 BZ    NORACF                 NO, RACF 'DOWN'                   04580000
         BZ    NORSS                  NO, RACF 'DOWN'           IS10066 04590000
*IS10066 CTSADBG LEVEL=(DBGLEVEL,1),                             WS2557X04600000
               'RCVT ADDR=#',(?R2),                              WS2557X04610000
               RAREA=RAREA,DBGAREA=DBGAREA                      IS10066 04620000
*                                                                       04630000
         LR    R4,R2                                             WS2557 04640000
         LA    R4,1000(,R4)                                      WS2557 04650000
         LR    R1,R2               R1 = VALUE FOR TRANSLATE     IS10066 04660000
         BRAS  R14,HEX2CHAR        TRANSLATE TO CHARACTER.      IS10066 04670000
         MVC   RCVTSNPA,H2COUT     MOVE TO SNAP HEADER.         IS10066 04680000
         LA    R0,RCVTSNPH                                      IS10066 04690000
         CTSADBG TYPE=SNAP,ID=1,HDR=(R0),                        WS2557104700000
               ADDR=(0(,R2),0(,R4)),                             WS2557204710000
               LEVEL=(DBGLEVEL,1,2,3,4,5),                      WS10020X04720000
               RAREA=RAREA,DBGAREA=DBGAREA                      IS10066 04730000
***WS10020     LEVEL=(DBGLEVEL,5)                                WS2557 04740000
         DROP  R1                                                WS2557 04750000
*                                                                       04760000
         USING RCVT,R2             ADDRESSABILITY CVT RACF DSECT WS2557 04770000
         CTSADBG 'RCVTID=_ RELEASE=_',                           WS2557104780000
               (RCVTID,4,RCVTVRMN,4),                            WS2557204790000
               LEVEL=(DBGLEVEL,1,2,3,4,5),                       WS2557X04800000
               RAREA=RAREA,DBGAREA=DBGAREA                      IS10066 04810000
*                                                                       04820000
**   VERIFY RSS MAIN BLOCK ID.                                          04830000
*                                                                       04840000
         CLC   RSSTYPE,RACF        RACF ?                       IS10066 04850000
         BNE   ISITTSS             ..NO - CHECK TSS             IS10066 04860000
         CLC   =CL4'RCVT',RCVTID       CHECK BLOCK ID            WS2557 04870000
*WS10020 BNE   NORACF                  INVALID BLOCK ID          WS2557 04880000
         BE    RACFLUP                 RACF IS SET              WS10020 04890000
         B     NORSS                   NO RACF CONTROL BLOCK.   IS10066 04900000
ISITTSS  DS    0H                                               IS10066 04910000
         CLC   RSSTYPE,TSS         TSS ?                        IS10066 04920000
         BNE   RSSNMERR            ..NO - UNKNOWN TYPE PASSED.  IS10066 04930000
         CLC   =CL4'RTSS',RCVTID       IS IT TSS?               WS10020 04940000
         BE    TSSLUP                  NO, NOT RACF & NOT TSS   WS10020 04950000
         B     NORSS                   NO TSS CONTROL BLOCK.    IS10066 04960000
RACFLUP  DS    0H                      RACF ESM      OR         WS10020 04970000
         MVI   WRSST,WRACFI            IND. RSST=RACF           WS10051 04980000
*IS10147AMVC   WPALG,RCVTPALG          KEEP KDFAES IND.         WS10051 04990000
* TO BE REPLACED WITH ABOVE WHEN RCVTPALG AVAILABLE IN SYS1.MACLIB      05000000
         MVC   WPALG,X'27B'(R2)        KEEP KDFAES IND.         WS10051 05010000
         B     AFTRSST                                          WS10051 05030000
TSSLUP   DS    0H                      TSS ESM                  WS10020 05040000
         MVI   WRSST,WTSSI             IND. RSST=TSS            WS10051 05050000
AFTRSST  DS    0H                                               WS10051 05060000
*                                      STRUCTURE OF RTSS IS THE WS10020 05070000
*                                      SAME (AS FAR AS BELOW    WS10020 05080000
*                                      RELEVANT FIELDS ARE      WS10020 05090000
*                                      CONCERNED) LIKE RCVT     WS10020 05100000
*                                      (RACF CVT).              WS10020 05110000
         TM    RCVTSTAT,RCVTRNA        RACF / TSS ACTIVE?        WS2557 05120000
*IS10066 BO    NORACF                  NO                        WS2557 05130000
         BO    NORSS                   NO                       IS10066 05140000
         TM    RCVTFLGS,RCVTROFF       RACF / TSS ACTIVE ?       WS2557 05150000
*IS10066 BO    NORACF                  NO                        WS2557 05160000
         BO    NORSS                   NO                       IS10066 05170000
*                                                                       05180000
*IS10066 L     R5,RCVTVRMN             LOAD Z/OS VERSION         WS2557 05190000
*IS10066 C     R5,ZOSV17               IS ZOS17?                 WS2557 05200000
* WS2565 BL    NORACF                  NO,BELOW ZOS 1.7          WS2557 05210000
*IS10066 BL    NOACF2                  NO,BELOW ZOS 1.7          WS2557 05220000
         CLC   RCVTVRMN,ZOSV17     IS IT Z/OS 1.7 OR ABOVE ?    IS10066 05230000
         BL    NOTMIXED            ..NO - MIXED CASE NOT SUPPORTED. 066 05240000
         TM    RCVTFLG3,RCVTPLC        IS PASSWORD MIXED CASE?   WS2557 05250000
         BO    LRCFLC                  YES, PASSWORD LOWER CASE  WS2557 05260000
* WS2565 B     NORACF                                            WS2557 05270000
*IS10066 B     NOACF2                                            WS2565 05280000
         B     NOTMIXED                                         IS10066 05290000
*                                                                       05300000
**   LOOK FOR ACF2 MAIN CONTROL BLOCK                                   05310000
*                                                                       05320000
*IS10066 NORACF   DS    0H                                       WS2557 05330000
ACF2LUP  DS    0H                                                WS2557 05340000
         MVI   WRSST,WACF2I        SET ACF2 RSST IND.           WS10051 05350000
         XC    ACCVTADR,ACCVTADR   CLEAR ACCVT ADDRESS.         IS10066 05360000
         ACFINCVT R4,NONE=NORSS        GET ACF2 CVT              WS2565 05370000
         ST    R4,ACCVTADR         SAVE ACCVT ADDRESS.          IS10066 05380000
         USING  ACCVT,R4                                         WS2565 05390000
*                                                                       05400000
*WS10052 CTSADBG LEVEL=(DBGLEVEL,1,2,3,4,5),                     WS2565X05410000
               'VER=$  FL2=$ VER=<_>',                IS10066   WS10052X05420000
               (ACCRELID,1,ACCNPFL2,1,ACCREL#,3),     IS10066   WS10052X05430000
               RAREA=RAREA,DBGAREA=DBGAREA                      IS10066 05440000
*IS10065       'VER=$',(ACCRELID(R4),1)                                 05450000
*                                                                       05460000
* STOP SUPPORTING ACF2 RELEASES EARLIER THAN R8 (6.5...)                05470000
* THEREFORE, NO NEED TO VERIFY WHETHER MIXED CASE IS SUPPORTED.         05480000
*                                                                       05490000
*WS10052 CLI   ACCRELID,ACCR800        ACF2 RELEASE 8.0?         WS2565 05500000
*IS10066 BL    NOACF2                  NO, BELOW                 WS2565 05510000
*WS10052 BL    NOTMIXED                NO, BELOW                 WS2565 05520000
*                                                                       05530000
         TM    ACCNPFL2,ACCNPMIX       MIXEDCASE PASSWORD ON?    WS2565 05540000
         BO    LRCFLC                  YES, MIXEDCASE ON         WS2565 05550000
*                                                                       05560000
**  SET PASSWORD UPPER/MIXED FLAG                                       05570000
*                                                                       05580000
NOTMIXED DS    0H                                               IS10066 05590000
         MVI   RCFLWCS,0               NO, MIXEDCASE OFF         WS2565 05600000
         B     CHMXEND                                           WS2565 05610000
         DROP  R4                                                WS2565 05620000
*                                                                       05630000
LRCFLC   DS    0H                                                WS2557 05640000
         MVI   RCFLWCS,1               SET PASSWORD LOWER CASE   WS2557 05650000
*IS10147ACTSADBG 'MIXED CASE IS SET IN ESM.',                    WS1002005660000
               LEVEL=(DBGLEVEL,1,2,3,4,5),                       WS1002X05670000
               RAREA=RAREA,DBGAREA=DBGAREA                      IS10066 05680000
*                                                                       05690000
CHMXEND  DS    0H                                                       05700000
         CTSADBG 'CASE=$ (UPPER=00, MIXED=01)',        WS25571 IS10147AX05710000
               (RCFLWCS,1),                                      WS2557205720000
               LEVEL=(DBGLEVEL,1,2,3,4,5),             WS25571 IS10147AX05730000
               RAREA=RAREA,DBGAREA=DBGAREA                      IS10066 05740000
         B     MOVE                                                     05750000
NORSS    DS    0H                                               IS10066 05760000
         CTSMSG1  CODE=CTS331E,PLANT=(4,RSSTYPE),               IS10066*05770000
               ROUT=WTO,WTOCON=CTS                              IS10066 05780000
         CTSADBG TYPE=SNAP,ID=1,HDR='NORSS - CVT **',            WS2557105790000
               ADDR=(0(,R2),0(,R4)),                             WS2557205800000
               RAREA=RAREA,DBGAREA=DBGAREA                      IS10066 05810000
         B     RSSERROR                                                 05820000
*                                                                       05830000
RSSNMERR DS    0H                                               IS10066 05840000
         L     R4,PRMTYPE                                       IS10066 05850000
         CTSADBG 'SUPPLIED RSS NAME _ ($) INCORRECT',           IS10066X05860000
               (0(R4),4,0(R4),4),                               IS10066X05870000
               RAREA=RAREA,DBGAREA=DBGAREA                      IS10066 05880000
RSSERROR DS    0H                                                       05890000
         LA    R1,RCINTERR         SAF RC = 99. RSS: RC = 99, RS = 99.  05900000
         BRAS  R14,SETRCS                                       IS10066 05910000
         B     EXIT                                             IS10066 05920000
         DROP  R2                                               IS10066 05930000
*                                                                       05940000
*****************************************************************       05950000
*                                                               *       05960000
*        MOVING PARAMETERS AND CALCULATING LENGTHS              *       05970000
*                                                               *       05980000
*****************************************************************       05990000
*                                                                       06000000
MOVE     DS    0H                                                       06010000
*                                                                       06020000
**   TAKE USERID                                                        06030000
*                                                                       06040000
         MVI   USERL,0                                          IS10066 06050000
*IS10147AMVC   USERID,BLANKS8          PUTTING ALL BLANKS IN USERID     06060000
         MVC   USERID,BLANKS           CLEAR USERID FIELD      IS10147A 06070000
         L     R4,PRMUSER              R4 POINTS TO USERID              06080000
         LA    R1,USERID               R1 POINTS TO NEW USER FIELD      06090000
         LA    R2,L'USERID             R2 CONTAINS MAX LEN OF USERID    06100000
LOOPUSR  DS    0H                                                       06110000
         CLI   0(R4),C' '              IS CHAR BLANK\X'00' OR LOWER?    06120000
         BNH   ENDLUSR                 IF YES WE STOP LOOP.             06130000
         MVC   0(1,R1),0(R4)           MOVE CHAR FROM PARM TO FIELD     06140000
         LA    R1,1(,R1)               ADVANCE FIELD POINTER            06150000
         LA    R4,1(,R4)               ADVANCE PARM POINTER             06160000
         BCT   R2,LOOPUSR              SUBTRACT 1 FROM COUNTER & RELOOP 06170000
ENDLUSR  DS    0H                                                       06180000
         LARL  R0,USERID                                        IS10066 06190000
         SR    R1,R0                   CALCULATE LENGTH         IS10066 06200000
         STC   R1,USERL                STORE LENGTH                     06210000
*                                                                       06220000
**   TAKE PASSWORD                                                      06230000
*                                                                       06240000
         MVI   PASSL,0                                          IS10066 06250000
*IS10147AMVC   PASSWORD,BLANKS8        PUTTING ALL BLANKS IN PASSWORD   06260000
         MVC   PASSWORD,BLANKS         CLEAR PASSWORD FIELD    IS10147A 06270000
         L     R4,PRMPASS              R4 POINTS TO PASSWORD PARM       06280000
         LA    R1,PASSWORD             R1 POINTS TO NEW PSWRD FIELD     06290000
         LA    R2,L'PASSWORD           R2 CONTAINS MAX LEN OF PASSWORD  06300000
*                                                                       06310000
LOOPPASS DS    0H                                                       06320000
*IS10147ACLI   0(R4),C' '              IS CHAR BLANK\X'00' OR LOWER?    06330000
*IS10147ABNH   ENDLPAS                 IF YES WE STOP LOOP.             06340000
         CLI   0(R4),X'00'             IS THIS A TERMINATOR?   IS10147A 06350000
         BE    ENDLPAS                 YES, STOP LOOPING       IS10147A 06360000
         MVC   0(1,R1),0(R4)           MOVE CHAR FROM PARM TO FIELD     06370000
         LA    R1,1(,R1)               ADVANCE FIELD POINTER            06380000
         LA    R4,1(,R4)               ADVANCE PARM POINTER             06390000
         BCT   R2,LOOPPASS             SUBTRACT 1 FROM COUNTER & RELOOP 06400000
ENDLPAS  DS    0H                                                       06410000
         LARL  R0,PASSWORD                                      IS10066 06420000
         SR    R1,R0                   CALCULATE LENGTH         IS10066 06430000
         STC   R1,PASSL                STORE LENGTH                     06440000
*                                                              IS10147A 06450000
**   SET PASSWORD OR PASSWORD PHRASE FLAG                      IS10147A 06460000
**   NOTE: THIS FLAG TELLS US WHETHER THE CALLER PASSED US     IS10147A 06470000
**         A PASSWORD OR PASSWORD PHRASE.                      IS10147A 06480000
*                                                              IS10147A 06490000
         MVI   PSWPHFLG,X'00'          CLEAR PSWD/PHRASE FLAG  IS10147A 06500000
         CH    R1,=Y(PSWDPHRL)         IS THIS PSWD OR PHRASE? IS10147A 06510000
         BL    SETPSWD                 LT 9, IT IS A PASSWORD  IS10147A 06520000
         MVI   PSWPHFLG,PSWDPHRS       GE 9, IT IS A PSWDPHRS  IS10147A 06530000
         CLC   RSSTYPE,TSS             IS THIS TSS+PSWDPHRS?   IS10147A 06540000
         BNE   CHKACF2                 NO, CONTINUE THERE      IS10147A 06550000
         MVI   RCFLWCS,1               SET PSWDPHRS LOWER CASE IS10147A 06560000
         B     ENDPSWD                 CONTINUE THERE          IS10147A 06570000
CHKACF2  DS    0H                                              IS10147A 06580000
         CLC   RSSTYPE,ACF2            IS THIS ACF2+PSWDPHRS?  IS10147A 06590000
         BNE   ENDPSWD                 NO, SKIP NEXT STATEMENT IS10147A 06600000
         MVI   RCFLWCS,1               SET PSWDPHRS LOWER CASE IS10147A 06610000
         B     ENDPSWD                 CONTINUE THERE          IS10147A 06620000
SETPSWD  DS    0H                                              IS10147A 06630000
         MVI   PSWPHFLG,PSWD           LT 9, IT IS A PASSWORD  IS10147A 06640000
ENDPSWD  DS    0H                                              IS10147A 06650000
*                                                                       06660000
**   TRANSLATE PASSWORD, IF NEEDED                                      06670000
**                                                                      06680000
**   FOR RACF - DELAY THE TRANSLATE UNTIL WE KNOW IF THE USER   IS10107 06690000
**              SUPPORTS MIXED-CASE PASSWORD.                   IS10107 06700000
*                                                                       06710000
         CLC   RSSTYPE,RACF        RACF ?                       IS10107 06720000
         BE    SKIPL2U             ..YES - DO NOT TRANSLATE.    IS10107 06730000
         CLI   RCFLWCS,1              RACF LOWER CASE SENSITIVE? WS2557 06740000
         BE    SKIPL2U                 YES, SKIP LOWER TO UPPER  WS2557 06750000
         TR    PASSWORD,LOW2UPR                                         06760000
SKIPL2U  DS    0H                                                WS2557 06770000
*                                                                       06780000
*IS10066 CTSADBG 'PASSWORD=_ ',                                  WS2557106790000
               (PASSWORD,8),                                     WS2557206800000
               LEVEL=(DBGLEVEL,1,2,3,4,5),                       WS2557X06810000
               RAREA=RAREA,DBGAREA=DBGAREA                      IS10066 06820000
*                                                                       06830000
*****************************************************************       06840000
*                                                               *       06850000
*        CHECK USER AND PASSWORD                                *       06860000
*                                                               *       06870000
*****************************************************************       06880000
*                                                                       06890000
*IS10066 CHECK    DS    0H                                              06900000
         CTSADBG LEVEL=(DBGLEVEL,1),                                   X06910000
               'ISSUE RACROUTE WITH USER=$,_',                         X06920000
               (USERL,1,USERID,8),                                     X06930000
               RAREA=RAREA,DBGAREA=DBGAREA                      IS10066 06940000
         CTSADBG LEVEL=(DBGLEVEL,1),                           IS10147AX06950000
               '...AND PSWD (TYPE=_)=$,_',                     IS10147AX06960000
               (PSWPHFLG,1,PASSL,1,PRNTPSWD,8),                IS10183 X06970000
               RAREA=RAREA,DBGAREA=DBGAREA                     IS10147A 06980000
*IS10183       (PSWPHFLG,1,PASSL,1,PASSWORD,100),              IS10147A 06970000
*                                                               IS10066 06990000
**   IF NO PASSWORD RECEIEVED, ISSUE A DEBUG MESSAGE AND RETURN IS10066 07000000
**   AN INTERNAL ERROR RC. THIS IS DONE BECAUSE WE HAVE NO VALUE S10066 07010000
**   TO VALIDATE.                                               IS10066 07020000
**                                                              IS10066 07030000
**   IN ACF2, WE MAY GET AN EMPTY PASSWORD, WHEN A USER WITH NO IS10066 07040000
**   INITIAL PASSWORD LOGS ON. THE PASSWORD SPECIFIED DURING THE S10066 07050000
**   LOGON IS TREATED BY ACF2 AS THE NEW PASSWORD FOR THE USER. IS10066 07060000
**   ACF2 CALLS IT'S NEW PASSWORD EXIT, BUT DOES NOT PASS THIS  IS10066 07070000
**   PASSWORD TO THE EXIT - THE EXITS RECEIVES AN EMPTY PASSWORD. 10066 07080000
**   NEW PASSWORD EXIT AS THE NEW PASSWORD. THE NEW PASSWORD    IS10066 07090000
**   THIS RESULTS IN A REQUESTTO VERIFY AN EMPTY PASSWORD.      IS10066 07100000
*                                                               IS10066 07110000
         CLI   PASSL,0             PASSWORD RECEIEVED ?         IS10066 07120000
         BNE   CKHOW2VR            ..YES - CHECK HOW TO VERIFY  IS10066 07130000
*                                  ..NO - ISSUE DEBUG AND RETURNIS10066 07140000
*                                         INTERNAL ERROR RETURN CODE.66 07150000
         CTSADBG 'NO PASSWORD RECEIVED FOR VERIFICATION',       IS10066X07160000
               RAREA=RAREA,DBGAREA=DBGAREA                      IS10066 07170000
         LA    R1,RCINTERR         SAF RC = 99. RSS: RC = 99, RS = 99 6 07180000
         BRAS  R14,SETRCS                                       IS10066 07190000
         B     EXIT                                             IS10066 07200000
*                                                                       07210000
**   DECIDE WHETHER TO VERIFY USING LOGON (RACROUTE VERIFY)             07220000
**   OR BY EXTRACTING VALUES FROM THE SECURITY PRODUCT.                 07230000
*                                                                       07240000
CKHOW2VR DS    0H                  DECIDE HOW TO VERIFY.        IS10066 07250000
         L     R1,PRMHOW    VERIFY USING LOGIN?              WS2460     07260000
         CLI   0(R1),C'Y'   YES, CONTINUE                    WS2460     07270000
         BNE   VERCMPR      NO, USE PASSWORD COMPARISON      WS2460
         LARL  R15,VERLOGON PREPARE TO VERIFY USING LOGIN      IS10147A 07370000
         BASR  R14,R15      CALL THE VERLOGON ROUTINE          IS10147A 07380000
         B     EXIT         RETURN TO CALLER                   IS10147A 07390000
*                                                                       07400000
*WS2460 START                                                           07410000
*---------------------------------------------------------------*       07420000
*                                                                       07430000
*        VERIFY PASSWORDS USING RACROUTE EXTRACT                        07440000
*                                                                       07450000
* NOTE: THE FOLLOWING SECTION WORKS FOR RACF & ACF2                     07460000
*       A FUTURE WISH SHOULD MAKE IT OPERATIONAL FOR TSS.               07470000
*                                                                       07480000
*---------------------------------------------------------------*       07490000
VERCMPR  DS    0H                                                       07500000
         CTSADBG LEVEL=(DBGLEVEL,1),                            IS10066X07510000
               'VERIFYING WITHOUT LOGON',                       IS10066X07520000
               RAREA=RAREA,DBGAREA=DBGAREA                      IS10066 07530000
*                                                                       07540000
         TIME  DEC                                              IS10066 07550000
         OILL  R1,X'000F'          CHANGE DECIMAL CHAT TO 'F'.  IS10066 07560000
         ST    R1,TODAYDAY         SAVE DATE.                   IS10066 07570000
*                                                                       07580000
         CLC   RSSTYPE,RACF                                     IS0041  07590000
         BE    TYPERACF                                         IS0041  07600000
         CLC   RSSTYPE,ACF2                                     IS0041  07610000
         BE    TYPEACF2                                         IS0041  07620000
*IS10066 B     EXIT                    TSS IS NOT SUPPORTED YET IS0041  07630000
*IS10147AB     VERLOGON                TSS IS NOT SUPPORTED YET IS0041  07640000
         LARL  R15,VERLOGON PREPARE TO VERIFY USING LOGIN      IS10147A 07650000
         BASR  R14,R15      CALL THE VERLOGON ROUTINE          IS10147A 07660000
         B     EXIT         RETURN TO CALLER                   IS10147A 07670000
*        CTSADBG LEVEL=(DBGLEVEL,1),                                  X 07680000
*              'DOING THE TSS EXTRACT...'                               07690000
*        MVC   TYPE,=C'TSS '                                            07700000
*XTTSS   RACROUTE REQUEST=EXTRACT,TYPE=EXTRACT,                       X 07710000
*              ENTITY=USERID,          REQUESTED UID                  X 07720000
*              SUBPOOL=1,              RELEASE NUMBER                 X 07730000
*              FIELDS=RACFLDS,         FIELDS TO EXTRACT              X 07740000
*              WORKA=RACWORK           WORKAREA                         07750000
*        LM    R2,R3,EXTTSS+4                                           07760000
*        B     POSTEXT                                                  07770000
*                                                                       07780000
         SPACE ,                                                        07790000
***************************************************************         07800000
**                                                                      07810000
**   ACF2 SUPPORT                                                       07820000
**                                                                      07830000
**   RACROUTE CANNOT BE USED TO RETRIEVE ALL THE INFORMATION    IS10066 07840000
**   REQUIRED FOR VERIFYING THAT THE USER IS NOT SUSPENDED OR   IS10066 07850000
**   EXPIRED, AND THAT THE PASSWORD CAN BE EXTRACTED. THEREFORE,IS10066 07860000
**   ACFSVC IS USED TO RETRIEVE THES INFORMATION. FOR USERS WHO IS10066 07870000
**   ARE NOT SUSPENDED, NOT EXPIRED, AND ALLOW PASSWORD EXTRACT, S10066 07880000
**   RACROUTE IS USED TO EXTRACT THE PASSWORD.                  IS10066 07890000
**                                                              IS10066 07900000
**   NOTE FOR USERS WITH TIME SHIFT:                            IS10066 07910000
**   WHEN VERIFIED USING RACROUTE VERIFY, THE VERIFY WILL FAIL  IS10066 07920000
**   WHILE WHEN VERIFIED USING EXTRACT, THE VERIFY WILL SUCCEED. S10066 07930000
**   WE DID NOT IMPLEMENT TIME SHIFT PROCESSING HERE BECASUE IT IS10066 07940000
**   REQUIRES THE USE OF ACF2 MACROS AND LINKAGE WITH AN ACF2   IS10066 07950000
**   MODULE.                                                    IS10066 07960000
**                                                                      07970000
***************************************************************         07980000
TYPEACF2 DS    0H                                               IS0041  07990000
*                                                               IS0041  08000000
**   VERIFY THAT RACROUTE EXTRACT CAN BE DONE FOR PASSWORD      IS0041  08010000
**   NOTE: THIS CHECK IS DONE BY CHECKING DIFFERENT BITS       IS10147A 08020000
**         DEPENDING ON WHETHER CALLER PASSED US A PASSWORD    IS10147A 08030000
**         OR A PASSWORD PHRASE                                IS10147A 08040000
*                                                               IS0041  08050000
         L      R4,ACCVTADR        R4 -> ACCVT.                 IS10066 08060000
         USING  ACCVT,R4                                        IS0041  08070000
         MVI   TMPXTRFL,0          CLEAR 'EXTRACT ALLOWED' FLD IS10147A 08080000
         CLI   PSWPHFLG,PSWD       DID USER PROVIDE PASSWORD?  IS10147A 08090000
         BE    CHKPSWXT            YES, CONTINUE THERE         IS10147A 08100000
*                                  NO, USER PROVIDED PSWDPHRS  IS10147A 08110000
*                                                              IS10147A 08120000
**       CURRENTLY, IT SEEMS LIKE THIS BIT DOES NOT HAVE TO BE IS10147A 08130000
**       CHECKED.  APPARENTLY WE CAN ALWAYS DO AN EXTRACT.     IS10147A 08140000
*                                                              IS10147A 08150000
*??????* TM    ACC_PWPFLAG1,ACC_PWPF1XTR EXTRACT ALLOWED?      IS10147A 08160000
*??????* BZ    TALOGON             NO, VERIFY USING LOGON      IS10147A 08170000
*??????* MVI   TMPXTRFL,ACPXTRFA   YES, SET 'EXTRACT ALLOWED'  IS10147A 08180000
         B     TELLPXTR            CONTINUE THERE              IS10147A 08190000
*                                                                       08200000
CHKPSWXT DS    0H                                              IS10147A 08210000
         TM     ACCYFLG,ACCYPXTR       PASSWORD EXTRACT ALLOWED?IS0041  08220000
         BZ     TALOGON                NO, VERIFY USING LOGON   IS10066 08230000
*                                                                       08240000
TELLPXTR DS    0H                                              IS10147A 08250000
         CTSADBG LEVEL=(DBGLEVEL,1),                            IS0041 *08260000
               'PSWD-XTR OR PWPF1XTR BIT IS ON',                IS0041 X08270000
               RAREA=RAREA,DBGAREA=DBGAREA                      IS10066 08280000
*                                                               IS10066 08290000
**   RETRIEVE USER INFORMATION USING ACF2 SVC.                  IS10066 08300000
*                                                               IS10066 08310000
         LARL  R15,DOACFSVC                                     IS10066 08320000
         CALL  (15),(ACFSVCFL,ACFSVCFLA,ACFSVCFLCNT),VL         IS10066 08330000
*                                  RETRIEVE USER DATA AND ANALYZE 10066 08340000
         B     *+L'*(R15)          BRANCH ACCORDING TO RC:      IS10066 08350000
         B     TACUSTAT            0 - CHECK USER STATUS.       IS10066 08360000
         B     TANOUSER            4 - NOTHING RETRIEVED, VERIFY S10066 08370000
         B     TAEND               8 - RETURN. ERROR RC ALREAY  IS10066 08380000
*                                      SET.                     IS10066 08390000
*                                                               IS10066 08400000
**   CAN WE GO ON WITH EXTRACT ?                                IS10066 08410000
*                                                               IS10066 08420000
*                                                               IS10066 08430000
**   ANALYZE THE USER STATUS:                                   IS10066 08440000
**                                                              IS10066 08450000
**   1. IF PASSWORD CANNOT BE EXTRACTED, VERIFY USING LOGON.    IS10066 08460000
**   2. IF SUSPEND/CANCEL - USER IS NOT ACTIVE.                 IS10066 08470000
**   3. CHECK ACTIVE DATE.                                      IS10066 08480000
**      IF ACTIVE DATE > TODAY - USER IS NOT ACTIVE.            IS10066 08490000
**   4. CHECK EXPIRE DATE:                                      IS10066 08500000
**      IF EXPIRE DATE <> 0 AND <= TODAY - USER IS NOT ACTIVE.  IS10066 08510000
**   5. PSWD-TOD = 0 (NO PASSWORD) - NO MATCH.                  IS10066 08520000
**   6. IF PSWD-VIO >= ACCPLMT (GLOBAL MAX VIO LIMIT) - USER    IS10066 08530000
**      NOT ACTIVE.                                             IS10066 08540000
**   7. RETRIEVE THE PASSWORD USING RACROUTE.                   IS10066 08550000
**   8. ENCRYPT THE INPUT PASSWORD AND COMPARE IT TO THE        IS10066 08560000
**      RETRIEVED PASSWORD. IF PASSWORDS MATCH, CONTINUE.       IS10066 08570000
**   9. IF PSWD-EXP - PASSWORD EXPIRED.                         IS10066 08580000
**  10. IF (MAXDAYS > 0 AND PSWD-TOD + MAXDAYS <= TODAY) OR     IS10066 08590000
**         (MAXDAYS = 0 AND ACCPSWMX > 0 AND LIDZMAX = X'00' AND S10066 08600000
**          PSWD-TOD + ACCPSWMX <= TODAY) - PASSWORD EXPIRED.   IS10066 08610000
*                                                               IS10066 08620000
TACUSTAT DS    0H                                               IS10066 08630000
* 1                                                                     08640000
         CLI   PSWPHFLG,PSWD       DID USER PROVIDE PASSWORD?  IS10147A 08650000
         BE    CHKPXTRF            YES, CONTINUE THERE         IS10147A 08660000
         MVC   ACPXTRFL,TMPXTRFL   NO, COPY THE TEMP PXTRFL FLDIS10147A 08670000
CHKPXTRF DS    0H                                              IS10147A 08680000
         CLI   ACPXTRFL,ACPXTRFA   PSWD-XTR ALLOWED ?           IS10066 08690000
         BNE   TALOGON             .NO - VERIFY USING LOGON.    IS10066 08700000
* 2                                                             IS10066 08710000
         CLI   ACSUSCNF,ACSUSCAN   SUSPEND / CANCEL ?           IS10066 08720000
         BE    TAUSRNA             ..YES - USER NOT ACTIVE.     IS10066 08730000
* 3                                                             IS10066 08740000
         CLI   ACACDATF,DATATDAY   ACTIVE DATE > TODAY ?        IS10066 08750000
         BE    TAUSRNA             ..YES - USER NOT ACTIVE.     IS10066 08760000
* 4                                                             IS10066 08770000
         CLI   ACEXDATF,0          EXPIRE DATE EXISTS ?         IS10066 08780000
         BE    TACNPSWD            ..NO - CHECK NO-PASSWORD.    IS10066 08790000
         TM    ACEXDATF,DATBTDAY+DATETDAY EXPIRE DATE <= TODAY ? S10066 08800000
         BNZ   TAUSRNA             ..YES - USER NOT ACTIVE.     IS10066 08810000
* 5                                                             IS10066 08820000
TACNPSWD DS    0H                  CHECK PASSWORD DATE.         IS10066 08830000
         OC    ACPASDAT,ACPASDAT   PASSWORD DATE EXISTS ?       IS10066 08840000
         BZ    TAPSWDNE            ..NO - NO PASSWORD = NOT EQUAL. 0066 08850000
* 6                                                             IS10066 08860000
         CLC   ACPSVIO#,ACCPLMT    PASSWORD VIOLATIONS EXCEEDED ? 10066 08870000
         BE    TAUSRNA             ..YES - USER NOT ACTIVE.     IS10066 08880000
* 7                                                             IS10066 08890000
         CLI   PSWPHFLG,PSWD       DID USER PROVIDE PASSWORD?  IS10147A 08900000
         BE    XTRPSWD             YES, CONTINUE THERE         IS10147A 08910000
         LARL  R15,DOXTRACT                                    IS10147A 08920000
         CALL  (15),(ACFRXFLP,ACFRXFLPA,ACFRXFLPCNT),VL        IS10147A 08930000
         B     AFTXTR                                          IS10147A 08940000
XTRPSWD  DS    0H                                              IS10147A 08950000
         LARL  R15,DOXTRACT                                     IS10066 08960000
         CALL  (15),(ACFRXFLD,ACFRXFLDA,ACFRXFLDCNT),VL         IS10066 08970000
AFTXTR   DS    0H                                              IS10147A 08980000
*                                  EXTRACT THE PASSWORD.        IS10066 08990000
         CHI   R15,0               EXTRACT WAS OK ?             IS10066 09000000
         BNZ   TAEND               ..NO - RETURN. ERROR RC ALREADY 0066 09010000
*                                         SET.                  IS10066 09020000
* 8                                                             IS10066 09030000
         LARL  R15,COMPPSWD                                     IS10066 09040000
         BASR  R14,R15             COMPARE PASSWORDS.           IS10066 09050000
         CHI   R15,0                                            IS10066 09060000
         BNE   TAPSWDNE            PASSWORDS ARE NOT EQUAL.     IS10066 09070000
* 9                                                             IS10066 09080000
         CLI   ACPSEXPF,ACPSEXP    PASSWORD EXPIRED ?           IS10066 09090000
         BE    TAPSWDEX            ..YES - PASSWORD EXPIRED.    IS10066 09100000
* 10                                                            IS10066 09110000
         LH    R0,ACPASINT         R0 = PASSWORD INTERVAL.      IS10066 09120000
         CHI   R0,0                PASSWORD INTERVAL DEFINED ?  IS10066 09130000
         BH    TACHPEXP            ..YES - CHECK EXPIRATION.    IS10066 09140000
         TM    ACMXDOVF,ACMXDOVR   MAXDAYS 0 OVERIDE GLOBAL ?   IS10066 09150000
         BO    TAPSWDOK            ..YES - PASSWORD NOT EXPIRED. S10066 09160000
         LH    R0,ACCPSWMX         R0 = GLOBAL INTERVAL.        IS10066 09170000
         CHI   R0,0                GLOBAL INTERVAL DEFINED ?    IS10066 09180000
         BNH   TAPSWDOK            ..NO - PASSWORD NOT EXPIRED. IS10066 09190000
         STH   R0,ACPASINT         SET PASSWORD INTERVAL.       IS10066 09200000
TACHPEXP DS    0H                                               IS10066 09210000
         LA    R1,ACPSDTFL         R1 -> PASSWORD EXPIRATION FIELDS. 66 09220000
         BRAS  R14,CHKPEXP         CHECK IF PASSWORD EXPIRED.   IS10066 09230000
         LTR   R15,R15             EXPIRED ?                    IS10066 09240000
         BNZ   TAPSWDEX            ..YES - SET RETURN CODE.     IS10066 09250000
*                                                               IS10066 09260000
**   SET RETURN CODES                                           IS10066 09270000
*                                                               IS10066 09280000
TAPSWDOK DS    0H                                               IS10066 09290000
         LA    R1,RCOK             SAF RC = 0, ACF2: RC = 0, RS = 0. 66 09300000
         BRAS  R14,SETRCS          SET RETURN CODES IN CALLER PARMS. 66 09310000
         B     TREND                                            IS10066 09320000
TANOUSER DS    0H                  USER DOES NOT EXIST:         IS10066 09330000
         LA    R1,RCANOU           SAF RC = 8, ACF2: RC = 4, RS = 0. 66 09340000
         BRAS  R14,SETRCS                                       IS10066 09350000
         B     TREND                                            IS10066 09360000
TAUSRNA  DS    0H                  USER IS NOT ACTIVE.          IS10066 09370000
         LA    R1,RCAUNA           SAF RC = 8, ACF2: RC = 28, RS = 0. 6 09380000
         BRAS  R14,SETRCS                                       IS10066 09390000
         B     TAEND                                            IS10066 09400000
TAPSWDNE DS    0H                  PASSWORDS ARE NOT EQUAL.     IS10066 09410000
         LA    R1,RCAPNE           SAF RC = 8, ACF2: RC = 8, RS = 0. 66 09420000
         BRAS  R14,SETRCS                                       IS10066 09430000
         B     TAEND                                            IS10066 09440000
TAPSWDEX DS    0H                  PASSWORD EXPIRED.            IS10066 09450000
         LA    R1,RCAPEXP          SAF RC = 8, ACF2: RC = 12, RS = 0. 6 09460000
         BRAS  R14,SETRCS                                       IS10066 09470000
         B     TAEND                                            IS10066 09480000
*                                                               IS10066 09490000
**   RETURN (RETURN CODES ARE SET).                             IS10066 09500000
*                                                               IS10066 09510000
TAEND    DS    0H                                               IS10066 09520000
         B     EXIT                                             IS10066 09530000
*                                                               IS10066 09540000
**   VERIFY USING LOGON                                         IS10066 09550000
*                                                               IS10066 09560000
TALOGON  DS    0H                                               IS10066 09570000
         CTSADBG LEVEL=(DBGLEVEL,1),                           IS10147AX09580000
               'CALLING VERLOGON TO VERIFY USING LOGIN',       IS10147AX09590000
               RAREA=RAREA,DBGAREA=DBGAREA                     IS10147A 09600000
*IS10147AB     VERLOGON                                         IS10066 09610000
         LARL  R15,VERLOGON PREPARE TO VERIFY USING LOGIN      IS10147A 09620000
         BASR  R14,R15      CALL THE VERLOGON ROUTINE          IS10147A 09630000
         B     EXIT         RETURN TO CALLER                   IS10147A 09640000
         SPACE ,                                                        09650000
*************************************************************** IS10066 09660000
**                                                              IS10066 09670000
**   RACF SUPPORT                                               IS10066 09680000
**                                                              IS10066 09690000
**   RACROUTE EXTRACT IS USED TO RETRIEVE THE USER PASSWORD AND IS10066 09700000
**   ADDITIONAL INFORMATION REQUIRED FOR ANALYZING THE USER     IS10066 09710000
**   STATUS AND THE PASSWORD STATUS.                            IS10066 09720000
**                                                              IS10066 09730000
**   THIS INFORMATION IS ANALYZED AND THE APPROPRIATE RETURN    IS10066 09740000
**   CODES ARE SET ACCORIDNG TO THE USER STATUS (ACTIVE, REVOKED) 10066 09750000
**   PASSWORD STATUS (EXPIRED) AND WHETHER THE PASSWORD MATCHES IS10066 09760000
**   THE INPUT PASSWORD.                                        IS10066 09770000
**                                                              IS10066 09780000
**   THE RETURN CODES ARE THE SAME AS RETURNED BY RACROUTE      IS10066 09790000
**   VERIFY FOR EACH USER/PASSWORD STATUS.                      IS10066 09800000
**                                                              IS10066 09810000
*************************************************************** IS10066 09820000
TYPERACF DS    0H                                               IS0041  09830000
         LARL  R15,DOXTRACT                                     IS10066 09840000
         CALL  (15),(RACRXFLD,RACRXFLDA,RACRXFLDCNT),VL         IS10066 09850000
*                                  EXTRACT AND ANALYZE THE DATA.IS10066 09860000
         B     *+L'*(R15)          BRANCH ACCORDING TO RC:      IS10066 09870000
         B     TRANLZUS            0 - ANALYZE USER STATUS.     IS10066 09880000
         B     TRANLZRC            4 - EXTRACT FAILED, ANALYZE  IS10066 09890000
*                                      EXTRACT RETURN CODE.     IS10066 09900000
         B     TREND               8 - PARAMETERS PROCESSING FAILED. 66 09910000
*                                      ERROR RC ALREAY SET.     IS10066 09920000
*                                                               IS10066 09930000
**   ANALYZE THE USER STATUS:                                   IS10066 09940000
**                                                              IS10066 09950000
**   1. CHECK IF USER WITH NOPASSWORD (PASSWORD=X'FF'). THIS    IS10066 09960000
**      IS DONE FIRST BECAUSE RACF RETURNS 'INVALID PASSWORD'   IS10066 09970000
**      WHEN NOPASSWORD EVEN WHEN THE USER IS REVOKED.          IS10066 09980000
**   2. CHECK REVOKED FLAG. IF REVOKED, CHECK RESUME DATE.      IS10066 09990000
**   3. CHECK REVOKE DATE.                                      IS10066 10000000
**      IF REVOKE DATE = 0 / > TODAY - USER IS ACTIVE, CHECK    IS10066 10010000
**      CONNECTION.                                             IS10066 10020000
**   4. CHECK RESUME DATE (WHEN REVOKED BY FLAG OR DATE)        IS10066 10030000
**      IF RESUME DATE = 0 / > TODAY - USER IS NOT ACTIVE.      IS10066 10040000
**   5. ENCRYPT THE INPUT PASSWORD AND COMPARE WITH THE         IS10066 10050000
**      RETRIEVED PASSWORD.                                     IS10066 10060000
**   6. IF PASSWORDS MATCH, CHECK IF PASSWORD EXPIRED.          IS10066 10070000
**   7. CHECK CONNECTION RESUME DATE (WHEN REVOKED BY FLAG OR DATE) 066 10080000
**      IF RESUME DATE = 0 / > TODAY - USER IS NOT ACTIVE.      IS10066 10090000
**   8. CHECK CONNECTION REVOKED FLAG. IF REVOKED, CHECK        IS10066 10100000
**      CONNECTION RESUME DATE.                                 IS10066 10110000
**   9. CHECK CONNECTION REVOKE DATE.                           IS10066 10120000
**      IF REVOKE DATE = 0 / > TODAY - USER IS ACTIVE, CHECK    IS10066 10130000
**      PASSWORD EXPIRATION.                                    IS10066 10140000
**                                                              IS10066 10150000
TRANLZUS DS    0H                                               IS10066 10160000
* 1                                                             IS10066 10170000
*                                                               BS10104
*        PLEASE NOTE: WE ASSUME THAT THE ONLY WAY RSSPSWDL IS   BS10104
*                     ZERO AT THIS POINT IS WHEN THE ROUTINE    BS10104
*                     WAS PASSED A PHRASE BUT THIS WAS THE      BS10104
*                     FIRST TIME THAT A PHRASE WAS USED SO THE  BS10104
*                     PHRASE FIELD IS ZERO.  (SEE THE           BS10104
*                     DXP_PASSWORDA AND DXP_PHRASEA ROUTINE.)   BS10104
*                                                               BS10104
*IS10147ACLC   RSSPSWD,XL8FF       NOPASSWORD ?                 IS10066 10180000
         ICM   R1,15,RSSPSWDL      GET LEN OF PSWD (PHRASE)    IS10147A 10190000
         BNP   TRPSWDNE            NOPASSWORD / NOPHRASE ?     IS10147A 10200000
         AHI   R1,-1               DECREMENT BY 1              IS10147A 10210000
         EX    R1,CHKFF            CHECK FOR ALL X'FF'S        IS10147A 10220000
*                                  (NOPASSWORD / NOPHRASE) ?   IS10147A 10230000
         BE    TRPSWDNE            ..YES - INCORRECT PASSWORD   IS10066 10240000
*                                          BECAUSE USER IS DEFINED 0066 10250000
*                                          WITH NOPASSWORD.     IS10066 10260000
         B     TRANLZU2            CONTINUE THERE              IS10147A 10270000
CHKFF    CLC   RSSPSWD(0),ALLFF    CHECK FOR ALL X'FF'S        IS10147A 10280000
TRANLZU2 DS    0H                                              IS10147A 10290000
* 2                                                             IS10066 10300000
         CLI   XTURVKFL,RVFRVKD    USER REVOKED ?               IS10066 10310000
         BE    TRCHURSD            ..YES - CHECK RESUME DATE.   IS10066 10320000
* 3                                                             IS10066 10330000
         CLI   XTRVDATF,0          REVOKE DATE SPEICIFED ?      IS10066 10340000
         BE    TRCMPPWD            ..NO - COMPARE PASSWORDS.    IS10066 10350000
         CLI   XTRVDATF,DATATDAY   REVOKE DATE > TODAY ?        IS10066 10360000
         BE    TRCMPPWD            ..YES - COMPARE PASSWORDS.   IS10066 10370000
* 4                                                             IS10066 10380000
TRCHURSD DS    0H                  USER REVOKED, CHECK RESUME DATE. 066 10390000
         CLI   XTRSDATF,0          RESUME DATE SPECIFIED ?      IS10066 10400000
         BE    TRUSRRVK            ..NO - USER IS REVOKED.      IS10066 10410000
         CLI   XTRSDATF,DATATDAY   RESUME DATE > TODAY ?        IS10066 10420000
         BE    TRUSRRVK            ..YES - USER IS REVOKED.     IS10066 10430000
* 5                                                             IS10066 10440000
TRCMPPWD DS    0H                  COMPARE PASSWORD             IS10066 10450000
         CLI   PSWPHFLG,PSWDPHRS   DID USER PROVIDE PSWDPHRS?  IS10147A 10460000
         BE    TRDOCMP             YES, LEAVE AS IS            IS10147A 10470000
         CLI   RCFLWCS,0           GLOBAL NON-MIXED ?           IS10107 10480000
         BE    TRUPRPWD            ..YES - CHANGE TO UPPERCASE. IS10107 10490000
         TM    XTPASSMX,X'80'      PASSWORD MIXED ?             IS10107 10500000
         BO    TRDOCMP             ..YES - LEAVE AS-IS.         IS10107 10510000
TRUPRPWD DS    0H                                               IS10107 10520000
         TR    PASSWORD,LOW2UPR    CHAGE TO UPPERCASE.          IS10107 10530000
TRDOCMP  DS    0H                                               IS10107 10540000
         LARL  R15,COMPPSWD                                     IS10066 10550000
         BASR  R14,R15             COMPARE PASSWORDS.           IS10066 10560000
         CHI   R15,0                                            IS10066 10570000
         BNE   TRPSWDNE            PASSWORDS ARE NOT EQUAL.     IS10066 10580000
* 6                                                             IS10066 10590000
         L     R15,XTPASDAT        R15 = DATE.                  IS10066 10600000
         CHI   R15,0               DATE = 0 ?                   IS10066 10610000
         BE    TRPASEXP            ..YES - EXPIRED.             IS10066 10620000
         LH    R15,XTPASINT        R15 = PASSWORD INTERVAL.     IS10066 10630000
         CHI   R15,255             INTERVAL EXISTS ?            IS10066 10640000
         BE    TRCHGRV             ..NO - PASSWORD IS NOT EXPIRED. 0066 10650000
         LA    R1,XTPSDTFL         R1 -> PASSWORD FIELDS.       IS10066 10660000
         BRAS  R14,CHKPEXP         CHECK IF PASSWORD EXPIRED.   IS10066 10670000
         CHI   R15,0                                            IS10066 10680000
         BNE   TRPASEXP            PASWORD EXPIRED.             IS10066 10690000
* 7                                                             IS10066 10700000
TRCHGRV  DS    0H                                               IS10066 10710000
         CLI   XTGRVKFL,RVFRVKD    CONNETION REVOKED ?          IS10066 10720000
         BE    TRCHGRSD            ..YES - CHECK RESUME DATE.   IS10066 10730000
* 8                                                             IS10066 10740000
         CLI   XTGVDATF,0          CONNECTION REVOKE DATE SPEICIFED ? 6 10750000
         BE    TRPDWSEQ            ..NO - PASSWORD OK.          IS10066 10760000
         CLI   XTGVDATF,DATATDAY   REVOKDE DATE > TODAY ?       IS10066 10770000
         BE    TRPDWSEQ            ..YES - PASSWORD OK.         IS10066 10780000
* 9                                                             IS10066 10790000
TRCHGRSD DS    0H                  CONNECT. REVOKED, CHECK RESUME DATE  10800000
         CLI   XTGSDATF,0          RESUME DATE SPECIFIED ?      IS10066 10810000
         BE    TRDCNRVK            ..NO - DEFAULT CONNECTION IS IS10066 10820000
*                                         REVOKED.              IS10066 10830000
         CLI   XTGSDATF,DATATDAY   RESUME DATE > TODAY ?        IS10066 10840000
         BE    TRDCNRVK            ..YES - DEFAULT CONNECTION IS S10066 10850000
*                                          REVOKED.             IS10066 10860000
*                                                               IS10066 10870000
**   SET RETURN AND RESON CODES LIKE RACROUTE VERIFY            IS10066 10880000
*                                                               IS10066 10890000
TRPDWSEQ DS    0H                                               IS10066 10900000
         LA    R1,RCOK             SAF RC = 0, RACF: RC = 0, RS = 0. 66 10910000
         BRAS  R14,SETRCS                                       IS10066 10920000
         B     TREND                                            IS10066 10930000
TRUSRRVK DS    0H                  USER REVOKED.                IS10066 10940000
         LA    R1,RCRUREV          SAF RC = 8, RACF: RC = 8, RS = 28. 6 10950000
         BRAS  R14,SETRCS                                       IS10066 10960000
         B     TREND                                            IS10066 10970000
TRDCNRVK DS    0H                  CONNECTION REVOKED.          IS10066 10980000
         LA    R1,RCRGREV          SAF RC = 8, RACF: RC = 8, RS = 36. 6 10990000
         BRAS  R14,SETRCS                                       IS10066 11000000
         B     TREND                                            IS10066 11010000
TRPASEXP DS    0H                  PASSWORD EXPIRED.            IS10066 11020000
         LA    R1,RCRPEXP          SAF RC = 8, RACF: RC = 8, RS = 12. 6 11030000
         BRAS  R14,SETRCS                                       IS10066 11040000
         B     TREND                                            IS10066 11050000
TRPSWDNE DS    0H                  PASSWORD DOES NOT MATCH      IS10066 11060000
         LA    R1,RCRPNE           SAF RC = 8, RACF: RC = 8, RS = 8. 66 11070000
         BRAS  R14,SETRCS                                       IS10066 11080000
         B     TREND                                            IS10066 11090000
*                                                               IS10066 11100000
**   ANALYZE EXTRACT RETURN CODE.                               IS10066 11110000
**                                                              IS10066 11120000
**   R15=4, RC=8, RS=0:                                         IS10066 11130000
**    USER DOES NOT EXIST. FAKE VERIFY RETURN CODES (4, 4, 0)   IS10066 11140000
**    SO THAT IT WILL LOOK THE SAME TO THE CALLER.              IS10066 11150000
*                                                               IS10066 11160000
TRANLZRC DS    0H                                               IS10066 11170000
         L     R15,PRMCOUT         R15 -> EXTRACT RETURN CODE.  IS10066 11180000
         L     R15,0(,R15)         R15 = EXTRACT RETURN CODE.   IS10066 11190000
         CHI   R15,4               R15 (SAF RC) = 4 ?           IS10066 11200000
         BNE   TREND               .NO - ERROR.                 IS10066 11210000
         L     R1,PRMCRC                                        IS10066 11220000
         L     R0,0(,R1)           R1 = RSS RC.                 IS10066 11230000
         CHI   R0,8                RACF RC = 8 (NO PROFILE ) ?  IS10066 11240000
         BNE   TREND               ..NO - ERROR.                IS10066 11250000
         L     R14,PRMCRS                                       IS10066 11260000
         L     R0,0(,R14)          R14 = RSS RS.                IS10066 11270000
         CHI   R0,0                RACF RS = 0 (NO PROFILE ) ?  IS10066 11280000
         BNZ   TREND               ..NO - ERROR.                IS10066 11290000
*                                  YES - FAKE VERIFY RC.        IS10066 11300000
         LA    R1,RCRNOU           SAF RC = 4, RACF: RC = 4, RS = 0. 66 11310000
         BRAS  R14,SETRCS                                       IS10066 11320000
         B     TREND                                            IS10066 11330000
*                                                               IS10066 11340000
**   RETURN                                                     IS10066 11350000
*                                                               IS10066 11360000
TREND    DS    0H                                               IS10066 11370000
         B     EXIT                                             IS10066 11380000
*                                                                       11390000
*---------------------------------------------------------------*       11400000
*                          EXIT                                         11410000
*---------------------------------------------------------------*       11420000
EXIT     DS    0H                                                       11430000
*                                                                       11440000
**   FREE THE EXTRACT AREA, IF EXISTS.                                  11450000
*                                                                       11460000
         L     R5,XTRADDR          R5 -> EXTRACT OUTPUT.        IS10066 11470000
         LTR   R5,R5               AREA EXISTS ?                IS10066 11480000
         BZ    RETURN              ..NO - SKIP FREEMAIN.        IS10066 11490000
         USING EXTWKEA,R5                                       IS10066 11500000
         XR    R3,R3                                                    11510000
         ICM   R3,1,EXTWSP                                              11520000
         XR    R4,R4                                                    11530000
*BS10011 ICM   R4,1,EXTWLN                                              11540000
         ICM   R4,7,EXTWLN             LENGTH OF 3 BYTES        BS10011 11550000
         CTSADBG LEVEL=(DBGLEVEL,1),                           BS10011 X11560000
               'FREEMAIN ADDR=~ LENGTH=~ SP=~',                BS10011 X11570000
               (?R5,?R4,?R3),                                  BS10011 X11580000
               RAREA=RAREA,DBGAREA=DBGAREA                      IS10066 11590000
         DROP  R5                                                       11600000
         XC    XTRADDR,XTRADDR     RESET THE ADDRESS.           IS10066 11610000
         FREEMAIN RC,SP=(3),LV=(4),A=(5)                                11620000
         LTR   R15,R15             FREEMAIN SUCCESSFULL ?               11630000
         BZ    RETURN                                                   11640000
         CTSADBG 'EXTRACT AREA FREEMAIN FAILED. A=~ L=# SP=# RC=#', 066X11650000
               (?R5,?R4,?R3,?R15),                              IS10066X11660000
               RAREA=RAREA,DBGAREA=DBGAREA                      IS10066 11670000
         CTSMSG1  CODE=CTS332E,                                 IS10066*11680000
               ROUT=WTO,WTOCON=CTS                                      11690000
*                                                                       11700000
**   RESTORE AMODE, SET RETURN CODE AND RETURN                          11710000
*                                                                       11720000
RETURN   DS    0H                                               IS10066 11730000
*IS10066 EXIT1    DS    0H                                       BS2558 11740000
*IS10066 L     R2,AMODE                                                 11750000
*IS10066 CTSAMOD RESTORE,R=R2          RESTORING AMODE                  11760000
*                                                                       11770000
         L     R4,PRMCOUT              LOADING RETURN CODE              11780000
         L     R15,0(,R4)              LOADING RETURN CODE              11790000
*                                                                       11800000
         L     R2,PRMCRC                                        IS10066 11810000
         L     R2,0(,R2)           "CREATE" RC.                 IS10066 11820000
         L     R3,PRMCRS                                        IS10066 11830000
         L     R3,0(,R3)           "CREATE" RS.                 IS10066 11840000
         CTSADBG LEVEL=(DBGLEVEL,1),                                   X11850000
               'EXIT R15=#, RC=#,#,#',                          IS10066X11860000
               (?R15,?R15,?R2,?R3),                             IS10066X11870000
               RAREA=RAREA,DBGAREA=DBGAREA                      IS10066 11880000
*                                                                       11890000
*IS10188 L     R2,AMODE            R2 = CALLER AMODE (TAM RC    IS10066 11900000
*IS10188                                SAVED AT ENTRY.         IS10066 11910000
*IS10188 LHI   R1,0                                             IS10066 11920000
*IS10188 MHI   R2,L'AMODE24        USE THE RC (0/1/3) AS INDEX  IS10066 11930000
*IS10188                           TO THE SET AMODE COMMANDS TABLE. 066 11940000
*IS10188 EX    R1,AMDCMDTB(R2)     RESTORE AMODE BY PERFORMING  IS10066 11950000
*IS10188                           THE SAM COMMAND CORRESPONDING S10066 11960000
*IS10188                           TO THE TAM RC.               IS10066 11970000
*IS10188                                                                11980000
         CTSAAMD RESTORE,AMODSAV=AMODE                         IS10188
         BRTRN (15)                                                     11990000
         DROP  ,                                                        12000000
*****************************************************************       12010000
*                                                               *       12020000
*        DOXTRACT                                               *       12030000
*                                                               *       12040000
*  PERFORM RACROUTE EXTRACT AND ANALYZE ITS OUTPUT. IF RACROUTE *       12050000
*  EXTRACT FAILS, PUT ITS RETURN CODES IN CALLER PARAMETERS.    *       12060000
*                                                               *       12070000
*  INPUT:                                                       *       12080000
*  R1 -> PARMS.                                                 *       12090000
*  R11 -> CONST.                                                *       12100000
*  R13 -> CALLER SAVE AREA.                                     *       12110000
*  R14 = RETURN ADDRESS.                                        *       12120000
*  R15 = ENTRY ADDRESS.                                         *       12130000
*                                                               *       12140000
*  RETURN CODES:                                                *       12150000
*  0 - OK.                                                      *       12160000
*  4 - RACROUTE FAILED.                                         *       12170000
*  8 - PARAMETERS PROCESING FAILED.                             *       12180000
*                                                               *       12190000
*****************************************************************       12200000
DOXTRACT BEGIN DOXTRACT                                         IS10066 12210000
*IS10147AUSING CONST,R11                                        IS10066 12220000
         USING CONST,R11,R12                                   IS10147A 12230000
         USING PRM,R10                                          IS10066 12240000
*                                                               IS10066 12250000
         LR    R8,R1               R8 -> PARMS.                 IS10066 12260000
         USING DXPARMS,R8                                       IS10066 12270000
*                                                               IS10066 12280000
         XC    XTRADDR,XTRADDR     EXTRACT OUTPUT ADDRESS.      IS10066 12290000
         L     R15,DXPFLDSA        R15 -> FIELDS LIST.          ISA0066 12300000
*BS10104 CLI   PSWPHFLG,PSWDPHRS   DID USER PROVIDE PSWDPHRS?  IS10147A 12310000
*BS10104 BE    XTRPWPHR            YES, CONTINUE THERE         IS10147A 12320000
         RACROUTE REQUEST=EXTRACT,TYPE=EXTRACT,                 IS10066X12330000
               FIELDS=(R15),       FIELDS TO EXTRACT            IS10066X12340000
               MF=(E,EXTRACTL)                                  IS10066 12350000
         LTR   R15,R15             OK ?                         IS10066 12360000
         BNZ   DXSETRC             ..NO - RETURN.               IS10066 12370000
*BS10104 REMOVING THESE LINES BECAUSE NOT NEEDED.
*BS10104 B     XTRAFT1             CONTINUE THERE              IS10147A 12380000
*XTRPWPHR RACROUTE REQUEST=EXTRACT,TYPE=EXTRACT,               IS10066X 12390000
*BS10104       FIELDS=(R15),       FIELDS TO EXTRACT           IS10066X 12400000
*BS10104       MF=(E,EXTRACTP)                                  IS10066 12410000
*BS10104 LTR   R15,R15             OK ?                         IS10066 12420000
*BS10104 BNZ   DXSETRCP            ..NO - RETURN.               IS10066 12430000
*XTRAFT1 DS    0H                                              IS10147A 12440000
*                                                               IS10066 12450000
         ST    R1,XTRADDR          SAVE EXTRACT OUTPUT ADDRESS. IS10066 12460000
         LR    R14,R1                                           IS10066 12470000
         USING EXTWKEA,R14                                      IS10066 12480000
         ICM   R15,B'0111',EXTWLN                               IS10066 12490000
         AHI   R15,-1                                           IS10066 12500000
         CTSADBG LEVEL=(DBGLEVEL,1),TYPE=SNAP,                  IS10066X12510000
               HDR='EXTRACT OUTPUT',                            IS10066X12520000
               ADDR=(0(,R14),0(R15,R14))                        IS10066 12530000
*                                                               IS10066 12540000
         CTSADBG LEVEL=(DBGLEVEL,1),                            IS10066X12550000
               'AREA AT ~/~,~ DATA _/_/~~',                     IS10066X12560000
               (?R14,EXTWSP,EXTWOFF,EXTWUID,8,EXTWGRP,8,        IS10066X12570000
               EXTWOPT+4,EXTWOPT+8),                            IS10066X12580000
               RAREA=RAREA,DBGAREA=DBGAREA                      IS10066 12590000
         DROP  R14                                             SAS2IBMN 12600000
                                                                        12610000
*                                                               IS10066 12620000
*---------------------------------------------------------------*       12630000
**                                                                      12640000
**       ANALYZE THE EXTRACTED DATA                                     12650000
**                                                                      12660000
**   THE EXTRACT OUTPUT CONTAINS A FIXED PART MAPPED BY                 12670000
**   IRRPRXTW AND A VARIBAE PART CONTAINING THE REQUESTED               12680000
**   DATA.                                                              12690000
**                                                                      12700000
**   THE ORDER OF THE DATA IN THE VARIABLE PART IS THE SAME             12710000
**   AS THE ORDER OF THE FIELDS IN THE RACROUTE REQUEST.                12720000
**                                                                      12730000
**   WHEN A FIELD IS PART OF A REPEATED GROUP (E.G, GROUP               12740000
**   CONNECTION), DATA IS RETRIEVED FROM ALL REPEATS OF THIS            12750000
**   FIELD.                                                             12760000
**                                                                      12770000
**   VARIABLE AREA STRUCTURE:                                           12780000
**                                                                      12790000
**   SIMPLE PARM (MAPPED BY XTPARM)                                     12800000
**   0      4                                      LEN+4                12810000
**   +--------------------------------------------+                     12820000
**   | LEN | DATA                                 |                     12830000
**   +--------------------------------------------+                     12840000
**                                                                      12850000
**                                                                      12860000
**   REPEATED PARM (MAPPED BY XTGPARM)                                  12870000
**   0      4                                                  LEN+4    12880000
**   +--------------------------------------------------------+         12890000
**   | LEN |   PARM1      |     PARM2   |  ...   |   PARMN    |         12900000
**   +-------------------------+------------------------------+         12910000
**         | L1 | DATA1   | L2 | DATA2  |  ...   | LN | DATAN |         12920000
**         +--------------+-------------+--------+------------+         12930000
**         4    8         L1+8  L1+12    L1+L2+12 ...                   12940000
**                                                                      12950000
**                                                                      12960000
*---------------------------------------------------------------*       12970000
         L     R9,DXPRTNSA         R9 -> PROCESS ROUTINES LIST. IS10066 12980000
         L     R7,DXPFLDS#         R7 -> NUMBER OF FIELDS.      IS10066 12990000
         L     R7,0(,R7)           R7 = NUMBER OF FIELDS.       IS10066 13000000
*        CTSADBG LEVEL=(DBGLEVEL,1),                            WS10051X13010000
               'FIELDS NUMBER=(#)',(?R7),                       WS10051X13020000
               RAREA=RAREA,DBGAREA=DBGAREA                      WS10051 13030000
         SLL   R7,2                R7 = ROUTINES LIST LENGTH.   IS10066 13040000
*                                                               IS10066 13050000
         XC    XTCFUFLG(XTCFUFLL),XTCFUFLG CLEAR.               IS10066 13060000
         L     R5,XTRADDR          R5 -> EXTRACT OUTPUT.        IS10066 13070000
         LA    R5,0(,R5)           CLEAR AMODE FLAG, IF ON.     IS10066 13080000
         USING EXTWKEA,R5                                       IS10066 13090000
*                                                               IS10066 13100000
         LHI   R1,0                                             IS10066 13110000
         ICM   R1,B'0111',EXTWLN                                IS10066 13120000
         LA    R1,0(R1,R5)                                      IS10066 13130000
         ST    R1,XTRADDRE         SAVE AREA END ADDRESS.       IS10066 13140000
         MVC   XTDFLTGR,EXTWGRP    SAVE DEFAULT GROUP NAME.     IS10066 13150000
         AH    R5,EXTWOFF          R5 -> PARAMETERS DATA.       IS10066 13160000
         DROP  R5                                               IS10066 13170000
         USING XTPARM,R5                                        IS10066 13180000
         LHI   R6,0                R6 = OFFSET OF FIRST ROUTINE.IS10066 13190000
DXNEXTP  DS    0H                                               IS10066 13200000
         CL    R5,XTRADDRE         END OF OUTPUT AREA ?         IS10066 13210000
         BNL   DXEXOUTE            ..YES - TOO EARLY - ERROR.   IS10066 13220000
*                                                               IS10066 13230000
         L     R15,0(R6,R9)        R15 -> PARM PROCESS ROUTINE  IS10066 13240000
         BRAS  R14,DXPPROC         GO PROCESS THE FIELD.        IS10066 13250000
*                                  INPUT: R5 -> PARM.           IS10066 13260000
         LTR   R15,R15             PROCESSED SUCCESSULLY ?      IS10066 13270000
         BNZ   DXEXTPRF            ..NO - ERROR.                IS10066 13280000
         AL    R5,XTPLEN           R5 -> NEXT...                IS10066 13290000
         AHI   R5,L'XTPLEN                 ..PARAMETER.         IS10066 13300000
         AHI   R6,4                R6 = OFFSET OF NEXT ROUTINE. IS10066 13310000
         CR    R6,R7               END OF TABLE ?               IS10066 13320000
         BL    DXNEXTP             ..NO - CHECK NEXT PARAMETER. IS10066 13330000
*                                                               IS10066 13340000
         CTSADBG TYPE=SNAP,ID=1,HDR='** RACF USER DATA',        IS10066X13350000
               ADDR=(XTCFUFLG,XTCFUFLG+XTCFUFLL-1),             IS10066X13360000
               LEVEL=(DBGLEVEL,1,2,3,4,5),                      IS10066X13370000
               RAREA=RAREA,DBGAREA=DBGAREA                      IS10066 13380000
*                                                               IS10066 13390000
         LHI   R15,0               SET RETURN CODE.             IS10066 13400000
         B     DXRET                                            IS10066 13410000
*                                                               IS10066 13420000
**   RACROUTE EXTRACT FAILED.                                   IS10066 13430000
*                                                               IS10066 13440000
*BS10104 REMOVING THESE LINES BECAUSE NOT NEEDED.
*DXSETRCP DS   0H                                               IS10066 13450000
*BS10104 LA    R1,EXTRACTP         R1 -> RSS RC AND RS.         IS10066 13460000
*BS10104 B     DXSETRC1                                                 13470000
DXSETRC  DS    0H                                               IS10066 13480000
         LA    R1,EXTRACTL         R1 -> RSS RC AND RS.         IS10066 13490000
*DXSETRC1 DS   0H                                                       13500000
         LA    R0,#EXTRACT                                      IS10066 13510000
         BRAS  R14,HANDLERC        HANDLE RETURN CODES.         IS10066 13520000
         LHI   R15,4               SET RETURN CODE.             IS10066 13530000
         B     DXRET                                            IS10066 13540000
*                                                               IS10066 13550000
**   FAILED TO ANALYZE THE EXTRACT OUTPUT                       IS10066 13560000
*                                                               IS10066 13570000
DXEXOUTE DS    0H                  EXTRACT OUTPUT ERROR (TOO SHORT) 066 13580000
         MVC   XTSNAPHN,=CL8'AREA'                              IS10066 13590000
         B     DXEXTESN                                         IS10066 13600000
DXEXTPRF DS    0H                  EXTRACT OUTPUT PROCESSING FAILED 066 13610000
         LR    R15,R6                                           IS10066 13620000
         SLL   R15,1               R15 = OFFSET IN NAMES LIST.  IS10066 13630000
         A     R15,DXPFLDSA        R15 -> FAILING KEYWORD.      IS10066 13640000
         LA    R15,4(,R15)         SKIP ENTRIES COUNT.          IS10066 13650000
         MVC   XTSNAPHN,0(R15)     MOVE NAME TO PARAMETER TO    IS10066 13660000
DXEXTESN DS    0H                                               IS10066 13670000
         CTSADBG 'VERXRACF FAILED: ERROR PROCESSING _. R5=~ R6=~',   66X13680000
               (XTSNAPHN,8,?R5,?R6),                            IS10066X13690000
               RAREA=RAREA,DBGAREA=DBGAREA                      IS10066 13700000
         LA    R0,XTSNAPHD         R0 -> SNAP HEAER.            IS10066 13710000
         L     R14,XTRADDR         R14 -> EXTRACT OUTPUT.       IS10066 13720000
         L     R15,XTRADDRE        R15 -> EXTRACT OUTPUT END.   IS10066 13730000
         AHI   R15,-1                                           IS10066 13740000
         CTSADBG TYPE=SNAP,                                     IS10066X13750000
               HDR=(R0),                                        IS10066X13760000
               ADDR=(0(,R14),0(,R15)),                          IS10066X13770000
               RAREA=RAREA,DBGAREA=DBGAREA                      IS10066 13780000
*                                                               IS10066 13790000
**   SET INTERNAL ERROR CODES IN CALLER RETURN CODES            IS10066 13800000
*                                                               IS10066 13810000
         LA    R1,RCINTERR         SAF RC = 99. RSS: RC = 99, RS = 99 6 13820000
         BRAS  R14,SETRCS                                       IS10066 13830000
         LHI   R15,8               SET RETURN CODE.             IS10066 13840000
*                                                               IS10066 13850000
DXRET    DS    0H                                               IS10066 13860000
         BRTRN (15)                                             IS10066 13870000
*---------------------------------------------------------------*       13880000
**                                                              IS10066 13890000
**   PROCESS PARAMETERS RETRIEVED BY RACROUTE EXTRACT.          IS10066 13900000
**                                                              IS10066 13910000
**   THE CODE ABOVE BRANCHES TO THE APPROPRIATE 'ROUTINE'       IS10066 13920000
**   ACCORDING TO THE PARAMETERS/ROUTINES LIST.                 IS10066 13930000
**                                                              IS10066 13940000
**   THESE ROUTINES USE THE SAME REGISTER AS VERXRACF.          IS10066 13950000
**                                                              IS10066 13960000
**   INPUT:                                                     IS10066 13970000
**   R5 -> PARM - SHOULD NOT BE CHANGED.                        IS10066 13980000
**   R6 = OFFSET IN ROUTINES TABLE.                             IS10066 13990000
**                                                              IS10066 14000000
**   RETURN CODES:                                              IS10066 14010000
**   0 - PROCESSED SUCCESSFULLY.                                IS10066 14020000
**   4 - ERROR.                                                 IS10066 14030000
**                                                              IS10066 14040000
*---------------------------------------------------------------*       14050000
DXPPROC  DS    0H                  PROCESS PARAMETERS           IS10066 14060000
         ST    R14,SAR14           SAVE RETURN ADDRESS.         IS10066 14070000
         BR    R15                 GO PROCESS PARM.             IS10066 14080000
*                                                               IS10066 14090000
**   COMMON PARAMETERS BASE REGISTERS                           IS10066 14100000
*                                                               IS10066 14110000
XTUPARM  USING XTPARM,R5                                        IS10066 14120000
XTGRPT   USING XTREPEAT,R5                                      IS10066 14130000
*                                                               IS10066 14140000
**   PROCESS PASSWORD                                           IS10066 14150000
*                                                               IS10066 14160000
DXP_PASSWORDA DS 0H                                             IS10066 14170000
         CLI   PSWPHFLG,PSWDPHRS   DID USER PROVIDE PSWDPHRS?  IS10147A 14180000
         BE    DXPPROC0            YES, LEAVE IMMEDIATELY      IS10147A 14190000
         L     R1,XTUPARM.XTPLEN   R1 = PASSWORD LENGTH         IS10066 14200000
         ST    R1,RSSPSWDL         SAVE PASSWORD LENGTH        IS10147A 14210000
*IS10147AMVC   RSSPSWD,BLANKS8                                  IS10066 14220000
         MVC   RSSPSWD,BLANKS                                  IS10147A 14230000
*                                                               BS10104
*        PLEASE NOTE: WE ASSUME THAT PASSWORD LENGTH SHOULD     BS10104
*                     NEVER BE ZERO.  IF WE ARE WRONG, THIS     BS10104
*                     CODE AND THE CODE VERIFYING THE PASSWORD  BS10104
*                     MUST BE CHANGED.                          BS10104
*                                                               BS10104
         AHI   R1,-1                                            IS10066 14240000
         BM    DXPPROC4            NOTHING TO MOVE.             IS10066 14250000
         EX    R1,DXPPSWMV         SAVE PASSWORD                IS10066 14260000
         B     *+L'*+L'DXPPSWMV                                 IS10066 14270000
DXPPSWMV MVC   RSSPSWD(0),XTUPARM.XTPPARM                       IS10066 14280000
         B     DXPPROC0                                         IS10066 14290000
*                                                               IS10066 14300000
**   PROCESS PASSWORD DATE                                      IS10066 14310000
*                                                               IS10066 14320000
DXP_PASSDATEA DS 0H                                             IS10066 14330000
PSDTFLDS USING PSDATFLD,XTPSDTFL                                IS10066 14340000
         CLI   PSWPHFLG,PSWDPHRS   DID USER PROVIDE PSWDPHRS?  IS10147A 14350000
         BE    DXPPROC0            YES, LEAVE IMMEDIATELY      IS10147A 14360000
         L     R0,XTUPARM.XTPLEN                                IS10066 14370000
         CHI   R0,3                LENGTH OK ?                  IS10066 14380000
         BNE   DXPPROC4            ..NO - DO NOT PROCESS.       IS10066 14390000
         ICM   R0,B'0111',XTUPARM.XTPPARM R0 = DATE.            IS10066 14400000
         SRL   R0,4                GET RID OF DECIMAL CHAR.     IS10066 14410000
         CHI   R0,0                DATE = 0 ?                   IS10066 14420000
         BE    DXPPDNCV            ..YES - NO NEED TO CONVERT.  IS10066 14430000
         CONVDATE XTUPARM.XTPPARM,R0 R0 = DATE IN 0CYYDDDF FORMAT. 0066 14440000
DXPPDNCV DS    0H                                               IS10066 14450000
         ST    R0,PSDTFLDS.PDPASDAT SAVE PASSWWORD DATE.        IS10066 14460000
         B     DXPPROC0                                         IS10066 14470000
         DROP  PSDTFLDS                                         IS10066 14480000
*                                                              IS10147A 14490000
**   PROCESS PASSWORD PHRASE                                   IS10147A 14500000
*                                                              IS10147A 14510000
DXP_PWPHRASEA DS 0H                                            IS10147A 14520000
DXP_PHRASEA DS 0H                                              IS10147A 14530000
         CLI   PSWPHFLG,PSWD       DID USER PROVIDE PASSWORD?  IS10147A 14540000
         BE    DXPPROC0            YES, LEAVE IMMEDIATELY      IS10147A 14550000
         L     R1,XTUPARM.XTPLEN   R1 = PASSWORD PHRASE LENGTH IS10147A 14560000
         ST    R1,RSSPSWDL         SAVE PASSWORD PHRASE LENGTH IS10147A 14570000
         MVC   RSSPSWD,BLANKS                                  IS10147A 14580000
*                                                               BS10104
*        PLEASE NOTE: THE PASSWORD PHRASE LENGTH CAN BE ZERO AT BS10104
*                     THIS POINT WHEN THE CTSAVPS ROUTINE WAS   BS10104
*                     PASSED A PASSWORD PHRASE BUT THE USER     BS10104
*                     DOES NOT HAVE A PASSWORD PHRASE IN THE    BS10104
*                     EXTRACTED AREA. (THIS CAN OCCUR WHEN THIS BS10104
*                     IS THE FIRST TIME A PASSWORD PHRASE IS    BS10104
*                     BEING USED. RACF HAS NOT YET UPDATED THE  BS10104
*                     PASSWORD PHRASE IN THE RACF DATA BASE SO  BS10104
*                     IT IS STILL ZERO.)                        BS10104
*                                                               BS10104
         CHI   R1,0                IS PASSWORD PHRASE LENGTH 0? BS10104
         BE    DXPPROC0            YES, LEAVE IMMEDIATELY       BS10104
         AHI   R1,-1                                           IS10147A 14590000
         BM    DXPPROC4            NOTHING TO MOVE.            IS10147A 14600000
         EX    R1,DXPPSPMV         SAVE PASSWORD PHRASE        IS10147A 14610000
         B     *+L'*+L'DXPPSPMV                                IS10147A 14620000
DXPPSPMV MVC   RSSPSWD(0),XTUPARM.XTPPARM                      IS10147A 14630000
         B     DXPPROC0                                        IS10147A 14640000
*                                                              IS10147A 14650000
**   PROCESS PASSWORD PHRASE DATE                              IS10147A 14660000
*                                                              IS10147A 14670000
DXP_PHRDATEA DS 0H                                             IS10147A 14680000
PSDTFLDS USING PSDATFLD,XTPSDTFL                               IS10147A 14690000
         CLI   PSWPHFLG,PSWD       DID USER PROVIDE PASSWORD?  IS10147A 14700000
         BE    DXPPROC0            YES, LEAVE IMMEDIATELY      IS10147A 14710000
         L     R0,XTUPARM.XTPLEN                               IS10147A 14720000
         CHI   R0,3                LENGTH OK ?                 IS10147A 14730000
         BNE   DXPPROC4            ..NO - DO NOT PROCESS.      IS10147A 14740000
         ICM   R0,B'0111',XTUPARM.XTPPARM R0 = DATE.           IS10147A 14750000
         SRL   R0,4                GET RID OF DECIMAL CHAR.    IS10147A 14760000
         CHI   R0,0                DATE = 0 ?                  IS10147A 14770000
         BE    DXPFDNCV            ..YES - NO NEED TO CONVERT. IS10147A 14780000
         CONVDATE XTUPARM.XTPPARM,R0 R0=DATE IN 0CYYDDDF FORMATIS10147A 14790000
DXPFDNCV DS    0H                                              IS10147A 14800000
         ST    R0,PSDTFLDS.PDPASDAT SAVE PASSWWORD DATE.       IS10147A 14810000
         B     DXPPROC0                                        IS10147A 14820000
         DROP  PSDTFLDS                                        IS10147A 14830000
*                                                               IS10066 14840000
**   PROCESS PASSWORD INTERVAL                                  IS10066 14850000
*                                                               IS10066 14860000
DXP_PASSINTA DS 0H                                              IS10066 14870000
PSDTFLDS USING PSDATFLD,XTPSDTFL                                IS10066 14880000
         L     R0,XTUPARM.XTPLEN                                IS10066 14890000
         CHI   R0,1                LENGTH OK ?                  IS10066 14900000
         BNE   DXPPROC4            ..NO - DO NOT PROCESS.       IS10066 14910000
         IC    R0,XTUPARM.XTPPARM                               IS10066 14920000
         STH   R0,PSDTFLDS.PDPASINT SAVE PASSWORD INTERVAL.     IS10066 14930000
         B     DXPPROC0                                         IS10066 14940000
         DROP  PSDTFLDS                                         IS10066 14950000
*                                                               IS10107 14960000
**   PROCESS PASSWORD MIXED-CASE INDIATION.                     IS10107 14970000
*                                                               IS10107 14980000
DXP_PASSASISA DS 0H                                             IS10107 14990000
         L     R0,XTUPARM.XTPLEN                                IS10107 15000000
         CHI   R0,1                LENGTH OK ?                  IS10107 15010000
         BNE   DXPPROC4            ..NO - DO NOT PROCESS.       IS10107 15020000
         MVC   XTPASSMX,XTUPARM.XTPPARM  MIXED-CASE PASSWORD.   IS10107 15030000
         B     DXPPROC0                                         IS10107 15040000
*                                                               IS10066 15050000
**   PROCESS REVOKE DATE                                        IS10066 15060000
*                                                               IS10066 15070000
DXP_REVOKEDTA DS 0H                                             IS10066 15080000
         LA    R15,XTUPARM.XTPLEN  R15 -> ENTRY.                IS10066 15090000
         LA    R1,XTRVDATF         R1 -> FLAGS BYTE FOR DATE    IS10066 15100000
*                                        COMPARE RESULTS.       IS10066 15110000
         BAS   R14,DXPCMDAT        COMPARE DATE IN ENTRY TO     IS10066 15120000
*                                  TODAY DATE AND SET THE FLAG  IS10066 15130000
*                                  POINTED BY R1.               IS10066 15140000
         B     DXPPROC0            - DATE PROCESSED.            IS10066 15150000
         B     DXPPROC4            - ERROR PROCESSING DATE.     IS10066 15160000
*                                                               IS10066 15170000
**   PROCESS RESUME DATE                                        IS10066 15180000
*                                                               IS10066 15190000
DXP_RESUMEDTA DS 0H                                             IS10066 15200000
         LA    R15,XTUPARM.XTPLEN  R15 -> ENTRY.                IS10066 15210000
         LA    R1,XTRSDATF         R1 -> FLAGS BYTE FOR DATE    IS10066 15220000
*                                        COMPARE RESULTS.       IS10066 15230000
         BAS   R14,DXPCMDAT        COMPARE DATE IN ENTRY TO     IS10066 15240000
*                                  TODAY DATE AND SET THE FLAG  IS10066 15250000
*                                  POINTED BY R1.               IS10066 15260000
         B     DXPPROC0            - DATE PROCESSED.            IS10066 15270000
         B     DXPPROC4            - ERROR PROCESSING DATE.     IS10066 15280000
*                                                               IS10066 15290000
**   PROCESS FLAG4 (REVOKE FLAG)                                IS10066 15300000
*                                                               IS10066 15310000
DXP_FLAG4A DS 0H                                                IS10066 15320000
         L     R0,XTUPARM.XTPLEN                                IS10066 15330000
         CHI   R0,1                LENGTH OK ?                  IS10066 15340000
         BNE   DXPPROC4            ..NO - DO NOT PROCESS.       IS10066 15350000
         TM    XTUPARM.XTPPARM,X'80' REVOKED ?                  IS10066 15360000
         BZ    DXPFLG4E            ..NO - OUT.                  IS10066 15370000
         MVI   XTURVKFL,RVFRVKD    REVOKED !                    IS10066 15380000
DXPFLG4E DS    0H                                               IS10066 15390000
         B     DXPPROC0                                         IS10066 15400000
*                                                               IS10066 15410000
**   PROCESS GROUP CONNECTIONS NUMBER                           IS10066 15420000
*                                                               IS10066 15430000
DXP_CGGRPCTA DS 0H                                              IS10066 15440000
         L     R0,XTUPARM.XTPLEN                                IS10066 15450000
         CHI   R0,4                LENGTH OK ?                  IS10066 15460000
         BNE   DXPPROC4            ..NO - DO NOT PROCESS.       IS10066 15470000
         L     R1,XTUPARM.XTPPARM                               IS10066 15480000
         ST    R1,XTGRP#           SAVE NUMBER OF GROUPS.       IS10066 15490000
         B     DXPPROC0                                         IS10066 15500000
*                                                               IS10066 15510000
**   PROCESS GROUP NAMES                                        IS10066 15520000
**   LOOK FOR THE DEFAULT GROUP NAME IN THE LIST AND SAVE       IS10066 15530000
**   NUMBER.                                                    IS10066 15540000
**                                                              IS10066 15550000
**   WE SHOULD HAVE AN ENTRY FOR EACH GROUP ACCORDING TO THE    IS10066 15560000
**   NUMBER OF THE GROUPS RETRIEVED FROM CGGRPCT                IS10066 15570000
*                                                               IS10066 15580000
DXP_CGGRPNMA DS 0H                                              IS10066 15590000
***      CLC   XTCFUFLG,BLANKS8    DEFAULT GROUP NAME EXISTS ?  IS10066 15600000
         CLC   XTCFUFLG,BLANKS     DEFAULT GROUP NAME EXISTS ?  IS10066 15610000
         BE    DXPGRNME            ..NO - NOTHING TO LOOK FOR.  IS10066 15620000
         L     R0,XTGRP#           R0 = NUMBER OF GROUPS.       IS10066 15630000
         CHI   R0,0                ANY CONNECTION ?             IS10066 15640000
         BE    DXPPROC4            ..NO - ERROR.                IS10066 15650000
         LA    R15,XTGRPT.XTRPARM  R15 -> 1ST GROUP NAME PARM.  IS10066 15660000
XTGPARM  USING XTPARM,R15                                       IS10066 15670000
DXPFDGLP DS    0H                                               IS10066 15680000
         L     R1,XTGPARM.XTPLEN                                IS10066 15690000
         CHI   R1,8                                             IS10066 15700000
         BNE   DXPPROC4            NAME LENGTH <> 8 - ERROR.    IS10066 15710000
         CLC   XTCFUFLG,XTGPARM.XTPPARM DEFAULT GROUP ?         IS10066 15720000
         BE    DXPDGNFN                                         IS10066 15730000
         AL    R15,XTGPARM.XTPLEN                               IS10066 15740000
         AHI   R15,L'XTGPARM.XTPLEN                             IS10066 15750000
         BCT   R0,DXPFDGLP         CHECK NEXT NAME.             IS10066 15760000
         B     DXPPROC4            NAME NOT FOUND - ERROR.      IS10066 15770000
DXPDGNFN DS    0H                  GROUP NAME FOUINF            IS10066 15780000
         L     R1,XTGRP#           CALCULATE...                 IS10066 15790000
         SR    R1,R0                 ...ENTRY...                IS10066 15800000
         AHI   R1,1                      ...NUMBER.             IS10066 15810000
         ST    R1,XTDFLTG#         SAVE # OF DEFAULT GROUP ENTRY. 10066 15820000
DXPGRNME DS    0H                                               IS10066 15830000
         B     DXPPROC0                                         IS10066 15840000
         DROP  XTGPARM                                          IS10066 15850000
*                                                               IS10066 15860000
**   PROCESS GROUP CONNECTIONS REVOKE FLAG                      IS10066 15870000
*                                                               IS10066 15880000
DXP_CGFLAG4A DS 0H                                              IS10066 15890000
         BAS   R14,DXPLCDGN        LOCATE DEFAULT ENTRY IN LIST IS10066 15900000
*                                  OUTPUT:                      IS10066 15910000
*                                  R15 -> ENTRY FOR DEFAULT GROUP. 0066 15920000
         B     DXPGFL4F            - ENTRY FOUND - PROCESS      IS10066 15930000
         B     DXPGFL4E            - NO DEFAULT GROUP.          IS10066 15940000
XTGPARM  USING XTPARM,R15                                       IS10066 15950000
DXPGFL4F DS    0H                                               IS10066 15960000
         L     R0,XTGPARM.XTPLEN                                IS10066 15970000
         CHI   R0,1                LENGTH OK ?                  IS10066 15980000
         BNE   DXPPROC4            ..NO - DO NOT PROCESS.       IS10066 15990000
         TM    XTGPARM.XTPPARM,X'80' REVOKED ?                  IS10066 16000000
         BZ    DXPGFL4E            ..NO - OUT.                  IS10066 16010000
         MVI   XTGRVKFL,RVFRVKD    REVOKED !                    IS10066 16020000
DXPGFL4E DS    0H                                               IS10066 16030000
         B     DXPPROC0                                         IS10066 16040000
         DROP  XTGPARM                                          IS10066 16050000
*                                                               IS10066 16060000
**   PROCESS GROUP CONNECTIONS REVOKE DATE                      IS10066 16070000
*                                                               IS10066 16080000
DXP_CGREVKDTA DS 0H                                             IS10066 16090000
         BAS   R14,DXPLCDGN        LOCATE DEFAULT ENTRY IN LIST IS10066 16100000
*                                  OUTPUT:                      IS10066 16110000
*                                  R15 -> ENTRY FOR DEFAULT GROUP. 0066 16120000
         B     DXPGRVDF            - ENTRY FOUND - PROCESS      IS10066 16130000
         B     DXPPROC0            - NO DEFAULT ENTRY.          IS10066 16140000
XTGPARM  USING XTPARM,R15                                       IS10066 16150000
DXPGRVDF DS    0H                                               IS10066 16160000
         LA    R1,XTGVDATF         R1 -> FLAGS BYTE FOR DATE    IS10066 16170000
*                                        COMPARE RESULTS.       IS10066 16180000
         BAS   R14,DXPCMDAT        COMPARE DATE IN ENTRY TO     IS10066 16190000
*                                  TODAY DATE AND SET THE FLAG  IS10066 16200000
*                                  POINTED BY R1.               IS10066 16210000
         B     DXPPROC0            - DATE PROCESSED.            IS10066 16220000
         B     DXPPROC4            - ERROR PROCESSING DATE.     IS10066 16230000
         DROP  XTGPARM                                          IS10066 16240000
*                                                               IS10066 16250000
**   PROCESS GROUP CONNECTIONS RESUME DATE                      IS10066 16260000
*                                                               IS10066 16270000
DXP_CGRESMDTA DS 0H                                             IS10066 16280000
         BAS   R14,DXPLCDGN        LOCATE DEFAULT ENTRY IN LIST IS10066 16290000
*                                  OUTPUT:                      IS10066 16300000
*                                  R15 -> ENTRY FOR DEFAULT GROUP. 0066 16310000
         B     DXPGRSDF            - ENTRY FOUND - PROCESS      IS10066 16320000
         B     DXPPROC0            - NO DEFAULT ENTRY.          IS10066 16330000
XTGPARM  USING XTPARM,R15                                       IS10066 16340000
DXPGRSDF DS    0H                                               IS10066 16350000
         LA    R1,XTGSDATF         R1 -> FLAGS BYTE FOR DATE    IS10066 16360000
*                                        COMPARE RESULTS.       IS10066 16370000
         BAS   R14,DXPCMDAT        COMPARE DATE IN ENTRY TO     IS10066 16380000
*                                  TODAY DATE AND SET THE FLAG  IS10066 16390000
*                                  POINTED BY R1.               IS10066 16400000
         B     DXPPROC0            - DATE PROCESSED.            IS10066 16410000
         B     DXPPROC4            - ERROR PROCESSING DATE.     IS10066 16420000
         DROP  XTGPARM                                          IS10066 16430000
*                                                               IS10066 16440000
**   SET RETURN CODE AND RETURN.                                IS10066 16450000
*                                                               IS10066 16460000
DXPPROC0 DS    0H                                               IS10066 16470000
         LHI   R15,0                                            IS10066 16480000
         B     DXPPROCE                                         IS10066 16490000
DXPPROC4 DS    0H                                               IS10066 16500000
         LHI   R15,4                                            IS10066 16510000
         B     DXPPROCE                                         IS10066 16520000
DXPPROCE DS    0H                                               IS10066 16530000
         L     R14,SAR14           RESTORE RETURN ADDRESS.      IS10066 16540000
         BR    R14                                              IS10066 16550000
*                                                               IS10066 16560000
**   LOCATE ENTRY OF DEFAULT GROUP                              IS10066 16570000
**                                                              IS10066 16580000
**   INPUT:                                                     IS10066 16590000
**   R14 = RETURN ADDRESS.                                      IS10066 16600000
**                                                              IS10066 16610000
**   OUTPUT:                                                    IS10066 16620000
**   R15 -> ENTRY.                                              IS10066 16630000
**                                                              IS10066 16640000
**   RETURN TO:                                                 IS10066 16650000
**   0(,R14) - ENTRY FOR DEFAULT GROUP WAS LOCATED.             IS10066 16660000
**   4(,R14) - NO DEFAULT GROUP.                                IS10066 16670000
**                                                              IS10066 16680000
*                                                               IS10066 16690000
DXPLCDGN DS    0H                                               IS10066 16700000
         L     R0,XTDFLTG#         R0 = DEFAULT GROUP # IN LIST.IS10066 16710000
         CHI   R0,0                DEFAULT GROUP EXISTS ?       IS10066 16720000
         BZ    DXPLCDGE            ..NO - ERROR.                IS10066 16730000
         LA    R15,XTGRPT.XTRPARM  R15 -> 1ST GROUP NAME PARM.  IS10066 16740000
XTGPARM  USING XTPARM,R15                                       IS10066 16750000
DXPLDGLP DS    0H                                               IS10066 16760000
         AHI   R0,-1                                            IS10066 16770000
         BZ    DXPLCDGF            R15 -> ENTRY FOR DEFAULT GROUP. 0066 16780000
         AL    R15,XTGPARM.XTPLEN                               IS10066 16790000
         AHI   R15,L'XTGPARM.XTPLEN                             IS10066 16800000
         B     DXPLDGLP            CHECK NENTRY.                IS10066 16810000
DXPLCDGF DS    0H                                               IS10066 16820000
         BR    R14                                              IS10066 16830000
DXPLCDGE DS    0H                                               IS10066 16840000
         B     4(,R14)                                          IS10066 16850000
         DROP  XTGPARM                                          IS10066 16860000
*                                                               IS10066 16870000
**   COMPARE DATES                                              IS10066 16880000
**                                                              IS10066 16890000
**   COMPARE THE DATE IN THE ENTRY TO THE DATE OF TODAY         IS10066 16900000
**   AND SET A FLAG ACCORDING TO THE RESULTS.                   IS10066 16910000
**                                                              IS10066 16920000
**   INPUT DATE FORMAT: YYDDDC                                  IS10066 16930000
**   TODAY DATE FORMAT: 0CYYDDDF                                IS10066 16940000
**                                                              IS10066 16950000
**   INPUT:                                                     IS10066 16960000
**   R15 -> PARM ENTRY.                                         IS10066 16970000
**   R14 = RETURN ADDRESS.                                      IS10066 16980000
**   R1 -> DATE FLAG.                                           IS10066 16990000
**                                                              IS10066 17000000
**   RETURN TO:                                                 IS10066 17010000
**   0(,R14) - WHEN DEFAULT GROUP EXISTS.                       IS10066 17020000
**   4(,R14) - WHEN DEFAULT GROUP DOES NOT EXIST                IS10066 17030000
**                                                              IS10066 17040000
*                                                               IS10066 17050000
DXPCMDAT DS    0H                                               IS10066 17060000
         PUSH  USING                                            IS10066 17070000
XTUPARM  USING XTPARM,R15                                       IS10066 17080000
         L     R0,XTUPARM.XTPLEN                                IS10066 17090000
         CHI   R0,0                DATE EXISTS ?                IS10066 17100000
         BE    DXPCDRET            ..NO - RETURN.               IS10066 17110000
         CHI   R0,3                LENGTH OK ?                  IS10066 17120000
         BNE   DXPCMDER            ..NO - DO NOT PROCESS.       IS10066 17130000
         CONVDATE XTUPARM.XTPPARM,R0 R0 = DATE IN 0CYYDDDF FORMAT 10066 17140000
         COMPDATE R0,0(R1)         COMPARE DATE WITH TODAY AND  IS10066 17150000
*                                  SET THE DATE FLAG.           IS10066 17160000
DXPCDRET DS    0H                                               IS10066 17170000
         BR    R14                 RETURN                       IS10066 17180000
DXPCMDER DS    0H                                               IS10066 17190000
         B     4(,R14)                                          IS10066 17200000
         DROP  XTUPARM                                          IS10066 17210000
         POP   USING                                            IS10066 17220000
*                                                                       17230000
         DROP  ,                                                IS10066 17240000
*****************************************************************       17250000
*                                                               *       17260000
*        DOACFSVC                                               *       17270000
*                                                               *       17280000
*  RETRIEVE USER INFORMATION USING ACF2 SVC AND ANALYZE THE     *       17290000
*  OUTPUT.                                                      *       17300000
*                                                               *       17310000
*  INPUT:                                                       *       17320000
*  R1 -> PARMS.                                                 *       17330000
*  R11 -> CONST.                                                *       17340000
*  R13 -> CALLER SAVE AREA.                                     *       17350000
*  R14 = RETURN ADDRESS.                                        *       17360000
*  R15 = ENTRY ADDRESS.                                         *       17370000
*                                                               *       17380000
*  RETURN CODES:                                                *       17390000
*  0 - OK.                                                      *       17400000
*  4 - USER DOES NOT EXIST.                                     *       17410000
*  8 - ACF SVC FAILED OR PARAMETERS PROCESSING FAILED.          *       17420000
*                                                               *       17430000
*****************************************************************       17440000
DOACFSVC BEGIN DOACFSVC                                         IS10066 17450000
*IS10147AUSING CONST,R11                                        IS10066 17460000
         USING CONST,R11,R12                                   IS10147A 17470000
         USING PRM,R10                                          IS10066 17480000
*                                                               IS10066 17490000
         LR    R8,R1               R8 -> PARMS.                 IS10066 17500000
         USING DAPARMS,R8                                       IS10066 17510000
*                                                               IS10066 17520000
         L     R4,ACCVTADR         R4 -> ACF MAIN TABLE.        IS10066 17530000
         USING ACCVT,R4                                         IS10066 17540000
*                                                              IS10147A 17550000
**   IF WE RECEIVED A PASSWORD PHRASE FROM THE CALLER, WE      IS10147A 17560000
**   MUST (SEPARATELY) OBTAIN THE PWP-EXP AND PWP-TOD FIELDS   IS10147A 17570000
**   FROM THE PWPHRASE SEGMENT OF THE USER PROFILE RECORD.     IS10147A 17580000
**   THIS MUST BE DONE SEPARATELY BECAUSE ALL OF THE OTHER     IS10147A 17590000
**   FIELDS WE RETRIEVE, COME FROM THE LOGONID RECORD WHILE    IS10147A 17600000
**   THE PWP-EXP AND PWP-TOD RESIDE IN THE PWPHRASE SEGMENT    IS10147A 17610000
**   OF THE USER PROFILE RECORD.                               IS10147A 17620000
*                                                              IS10147A 17630000
         CLI   PSWPHFLG,PSWD       DID USER PROVIDE PASSWORD?  IS10147A 17640000
         BE    PRPACALT            YES, CONTINUE THERE         IS10147A 17650000
*                                  NO, USER PROVIDED PSWDPHRS  IS10147A 17660000
         XC    ACF2UFLG(ACF2UFLL),ACF2UFLG CLEAR USER FLAGS    IS10147A 17670000
         XC    ACNTRY(ACNTBLKL),ACNTRY CLEAR PARM LIST AREA    IS10147A 17680000
         XC    AREBUF,AREBUF       CLEAR ARE BUFFER AREA       IS10147A 17690000
         MVI   SVCMSG,C' '         CLEAR THE ENTIRE MESSAGE... IS10147A 17700000
         MVC   SVCMSG+1(L'SVCMSG-1),SVCMSG             ...AREA IS10147A 17710000
         MVI   ACNTFCN,ACNTFC0A    ACNTRY ACCESS REQUEST       IS10147A 17720000
         MVI   ACNTSFCN,ACNF$FRT   GET FLDS FROM STRUCTURED RECIS10147A 17730000
         MVC   ACNTMSG,=A(SVCMSG)  SET MESSAGE AREA            IS10147A 17740000
         MVC   ACNTSCLS,=C'P'      SET STORAGE CLASS           IS10147A 17750000
         MVC   ACNTSTYP,=C'USR'    SET STORAGE TYPE            IS10147A 17760000
         MVC   ACNTSIRI,BLANKS     CLEAR RECORD ID             IS10147A 17770000
         MVC   ACNTSIRI,=C'PWPHRASE' SET RECORD ID (SYSID +    IS10147A 17780000
         MVC   ACNTSIRI+8(8),USERID  SET RECORD ID      RECID) IS10147A 17790000
         MVC   ACNTAREB,=A(AREBUF) POINT TO ARE BUFFER         IS10147A 17800000
         MVC   ACNTAREL,=A(L'AREBUF) SET ARE BUFFER LENGTH     IS10147A 17810000
         MVC   ACNTFLDB,=A(ACNTBL) POINT TO TABLE OF FIELDS    IS10147A 17820000
         MVC   ACNTFLDC,=A(ACNTBL#) SET NUMBER OF TABLE ENTRIESIS10147A 17830000
         MVC   ACNTPSIL,=H'8'      LENGTH OF 'PWPHRASE' SYSID  IS10147A 17840000
         MVC   ACNTPRIL+1(1),USERL LENGTH OF USERID (RECID)    IS10147A 17850000
         OI    ACNTCNTL,ACNTLRET   USE ACNTFLDB/ACNTFLDC FLDS  IS10147A 17860000
************************************************************** IS10147A 17870000
*        CALL ACF2 SVC TO DO ACNTRY CALL                     * IS10147A 17880000
************************************************************** IS10147A 17890000
*                                                              IS10147A 17900000
         ACFSVC ACNTRY,TYPE=A,NONE=ACNT_NOACF2,CVT=HAVE        IS10147A 17910000
*                                                              IS10147A 17920000
         CTSADBG LEVEL=(DBGLEVEL,1),                           IS10147AX17930000
               'ACNTRY RC=# MSG=_',(?R15,SVCMSG,72),           IS10147AX17940000
               RAREA=RAREA,DBGAREA=DBGAREA                     IS10147A 17950000
*                                                              IS10147A 17960000
         B     *+4(R15)            BRANCH INTO BRANCH TABLE    IS10147A 17970000
         B     ACNT_OK             ACNTRY FUNCTION SUCCESSFUL  IS10147A 17980000
         B     ACNT_ACCDENIED      ACCESS DENIED + MSG         IS10147A 17990000
         B     ACNT_CBERROR        CONTROL BLOCK ERROR + MSG   IS10147A 18000000
         B     ACNT_NOACF2         ACF2 NOT ACTIVE + MSG       IS10147A 18010000
         B     ACNT_UNDRC          UNDEFINED RC!!              IS10147A 18020000
*                                                              IS10147A 18030000
ACNT_OK  DS    0H                                              IS10147A 18040000
         CTSADBG LEVEL=(DBGLEVEL,1),TYPE=SNAP,                 IS10147AX18050000
               HDR='ACFSVC PWPHRASE OUTPUT',                   IS10147AX18060000
               ADDR=(AREBUF,AREBUF+L'AREBUF-1),                IS10147AX18070000
               RAREA=RAREA,DBGAREA=DBGAREA                     IS10147A 18080000
*                                                              IS10147A 18090000
         LA    R1,AREBUF           POINT TO THE OUTPUT BUFFER  IS10147A 18100000
         USING ACARE,R1            ESTABLISH ADDRESSABILITY    IS10147A 18110000
         CLC   =CL8'PWP-EXP',AREANAME IS THIS PWP-EXP DATA?    IS10147A 18120000
         BNE   ACNTTOD             NO, CONTINUE THERE          IS10147A 18130000
         LH    R0,ARELNTH          DATA AREA LENGTH            IS10147A 18140000
         CHI   R0,X'12'            LENGTH OK ?                 IS10147A 18150000
         BNE   ACNTERR             ..NO - DO NOT PROCESS.      IS10147A 18160000
         LH    R0,AREVLNTH         DATA ITEM LENGTH            IS10147A 18170000
         CHI   R0,1                LENGTH OK ?                 IS10147A 18180000
         BNE   ACNTERR             ..NO - DO NOT PROCESS.      IS10147A 18190000
         CLI   AREVALUE,X'01'      PSWDPHRS EXPIRED ?          IS10147A 18200000
         BNE   ACNTNEXT                                        IS10147A 18210000
         MVI   ACPSEXPF,ACPSEXP    SET 'PSWDPHRS EXPIRED'      IS10147A 18220000
***      B     ACNTNEXT                                        IS10147A 18230000
ACNTNEXT DS    0H                                              IS10147A 18240000
         TM    AREFLGS,AREFEND     ARE WE AT THE LAST ENTRY?   IS10147A 18250000
         BE    ACNTTODE            YES, CONTINUE THERE         IS10147A 18260000
         AH    R1,ARELNTH          POINT TO THE NEXT ENTRY     IS10147A 18270000
ACNTTOD  DS    0H                                              IS10147A 18280000
         CLC   =CL8'PWP-TOD',AREANAME IS THIS PWP-TOD DATA?    IS10147A 18290000
         BNE   PRPACALT            NO, CONTINUE THERE          IS10147A 18300000
         LH    R0,ARELNTH          DATA AREA LENGTH            IS10147A 18310000
         CHI   R0,X'18'            LENGTH OK ?                 IS10147A 18320000
         BNE   ACNTERR             ..NO - DO NOT PROCESS.      IS10147A 18330000
         LH    R0,AREVLNTH         DATA ITEM LENGTH            IS10147A 18340000
         CHI   R0,8                LENGTH OK ?                 IS10147A 18350000
         BNE   ACNTERR             ..NO - DO NOT PROCESS.      IS10147A 18360000
         L     R0,AREVALUE         DATE                        IS10147A 18370000
         OILL  R0,X'000F'          SET 'F' AS DECIMAL CGAR.    IS10147A 18380000
         CHI   R0,X'000F'          DATE = 0 ?                  IS10147A 18390000
         BE    ACNTTODE            ..YES - NO NEED TO CONVERT. IS10147A 18400000
         ST    R0,ACPASDAT         SAVE PSWDPHRS (PWP-TOD) DATEIS10147A 18410000
*                                                              IS10147A 18420000
ACNTTODE DS    0H                                              IS10147A 18430000
         CTSADBG TYPE=SNAP,ID=1,HDR='PWP USER DATA',           IS10147AX18440000
               ADDR=(ACF2UFLG,ACF2UFLG+ACF2UFLL-1),            IS10147AX18450000
               LEVEL=(DBGLEVEL,1),                             IS10147AX18460000
               RAREA=RAREA,DBGAREA=DBGAREA                     IS10147A 18470000
         B     PRPACALT            CONTINUE THERE              IS10147A 18480000
*                                                              IS10147A 18490000
ACNTERR  DS    0H                                              IS10147A 18500000
         MVC   ACSNAPHN,AREANAME   COPY THE DATA AREA NAME     IS10147A 18510000
         CTSADBG 'DOACFSVC FAILED: ERROR PROCESSING _.',       IS10147AX18520000
               (ACSNAPHN,8)                                    IS10147A 18530000
         CTSADBG TYPE=SNAP,                                    IS10147AX18540000
               HDR='ACFSVC PWPHRASE OUTPUT',                   IS10147AX18550000
               ADDR=(AREBUF,AREBUF+L'AREBUF-1),                IS10147AX18560000
               RAREA=RAREA,DBGAREA=DBGAREA                     IS10147A 18570000
         B     DARC8                                           IS10147A 18580000
         DROP  R1                  DISCONNECT ADDRESSABILITY   IS10147A 18590000
*                                                              IS10147A 18600000
ACNT_ACCDENIED DS 0H                                           IS10147A 18610000
         CLC   SVCMSG+4(8),=CL8'ACF0A005' IS THIS THE MESSAGE: IS10147A 18620000
*                                         RECORD(S) NOT FOUND  IS10147A 18630000
         BNE   DASVCER             CONTINUE THERE              IS10147A 18640000
         CTSADBG 'NO PASSWORD PHRASE DEFINED OR USERID _ NOT FOUND',   X18650000
               (USERID,8)                                      IS10147A 18660000
ACNT_CBERROR   DS 0H                                           IS10147A 18670000
ACNT_NOACF2    DS 0H                                           IS10147A 18680000
ACNT_UNDRC     DS 0H                                           IS10147A 18690000
         B     DASVCER             CONTINUE THERE              IS10147A 18700000
*                                                              IS10147A 18710000
PRPACALT DS    0H                  PREPARE FOR ACALT CALL      IS10147A 18720000
         XC    AREBUF,AREBUF       CLEAR ARE BUFFER AREA       IS10147A 18730000
*                                                               IS10066 18740000
**   RETRIEVE USER INFORMATION USING ACFSVC                     IS10066 18750000
*                                                               IS10066 18760000
         XC    ACALT(ACALTLEN),ACALT                            IS0041  18770000
         MVI   ACAFCN,X'02'         ACALT REQUEST               IS0041  18780000
         MVI   ACASFCN,ACASFRT      RETURN FORMATTED RECORD     IS0041  18790000
         MVI   ACACNTL,0            READ UNDER SPECIFIC LOGONID IS0041  18800000
* ABOVE NO FLAG OPTION IS NOT DOCUMENTED YET.                   IS0041  18810000
* DOC BUG WAS OPENED AT CA                                      IS0041  18820000
*                                                               IS0041  18830000
         MVC   ACALID,USERID        SET LID TO USE              IS0041  18840000
         L     R1,DAPFLDS#                                      IS10066 18850000
         L     R1,0(,R1)                                        IS10066 18860000
         ST    R1,ACAFLDC           # OF FIELDS TO RETRIEVE     IS10066 18870000
         L     R1,DAPFLDSA                                      IS10066 18880000
         ST    R1,ACAFLDB           -> FIELDS TO RETRIEVE.      IS10066 18890000
         OI    ACACNTL,ACACLRET     IND SPECIFIC FIELDS LIST    IS0041  18900000
         LA    R1,AREBUF                                        IS10066 18910000
         ST    R1,ACARETB           SET ARE BUFFER              IS10066 18920000
         LHI   R1,L'AREBUF                                      IS10066 18930000
         ST    R1,ACARETL           OUTPUT BUFFER LENGTH        IS10066 18940000
         LA    R1,SVCMSG                                        IS10066 18950000
         ST    R1,ACAMSG           SET AREA FOR MSG.            IS10066 18960000
*                                                                       18970000
         ACFSVC ACALT,TYPE=A,NONE=DARC8,CVT=HAVE                IS0041  18980000
*                                                                       18990000
         CTSADBG LEVEL=(DBGLEVEL,1),                            IS0041 X19000000
               'ACALT RC=# MSG=_',                              IS0041 X19010000
               (?R15,SVCMSG,72),                                IS0041 X19020000
               RAREA=RAREA,DBGAREA=DBGAREA                      IS10066 19030000
         LTR   R15,R15                 ALTRC OK ?               IS10066 19040000
         BZ    DACHECK                 YES - ANALYZE PARMS      IS0041  19050000
********************* IS10002 STARTS ********************************** 19060000
* ACF2 RETURNS ACF00151 WHEN THERE'S NOTHING TO RETURN.                 19070000
* IN THIS CASE, SINCE PSWD-XTR IS OFF, WE LOGIN TO VERIFY THE PASSWORD. 19080000
* I AM NOT SURE WHETHER THIS IS RELEVANT TO R8 & ABOVE OR TO ALL VERS.  19090000
* CURRENTLY, I SET IT FOR ALL VERS AS THIS CODE IS NOT DOCUMENTED AND   19100000
* PROBABLY WON'T BE USED BY ANYONE AS WE USE LOGIN FOR ACF2 V3202       19110000
* AS WELL.                                                              19120000
*********************************************************************** 19130000
*        CLI   ACCRELID,ACCR800        ACF2 RELEASE 8.0?        IS10002 19140000
*        BL    BADRC                   BELOW R8, RC>0 IS BAD    IS10002 19150000
         CHI   R15,4                   RC = 4 ?                 IS10066 19160000
         BNE   DASVCER                 NO, BAD RC               IS10002 19170000
         CLC   SVCMSG+4(8),=CL8'ACF00151' IF THIS MESAGE:       IS10002 19180000
*                      NO SIGNIFICANT DATA AVAILABLE FOR RETURN IS10002 19190000
         BE    DARC0                   NOTHING TO PROCESS.      IS10066 19200000
         CLC   SVCMSG+4(8),=CL8'ACF02010' IF THIS MESAGE:       IS10066 19210000
*                      RECORD(S) NOT FOUND                      IS10066 19220000
         BE    DARC4                   SET RETURN CODE AND RETURN. 0066 19230000
********************* IS10002 ENDS ***************************          19240000
* HERE ISSUE  AN ERROR MSG WITH CTSMSG1.                        IS0041  19250000
* ADD MSG TO DOC AND MSG MEMBER..AND RETURN RC=16               IS0041  19260000
* TO CALLER (CTSCINT).                                          IS0041  19270000
DASVCER  DS    0H                                               IS10002 19280000
         CVD   R15,PACKD               CONVERT RC TO EBCDIC     IS0041  19290000
         UNPK  CHARRC,PACKD            CONVERT RC TO EBCDIC     IS0041  19300000
         OI    CHARRC+7,X'F0'          CONVERT RC TO EBCDIC     IS0041  19310000
         CTSMSG1  CODE=CTS330E,PLANT=(4,CHARRC+4,72,SVCMSG),    IS0041 *19320000
               ROUT=WTO,WTOCON=CTS                                      19330000
         B     DARC8                   VERIFY BY LOGIN          IS10066 19340000
         DROP  R4                                               IS10066 19350000
*IS10002 L     R4,PRMCOUT              R4->MACRO RC OUT PARM    IS0041  19360000
*IS10002 MVC   0(4,R4),=F'16'        SET FATAL ERROR IN RC PARM IS0041  19370000
*IS10002 LR    R15,R3                  RESTORE ACALT RC AGAIN   IS0041  19380000
*IS10002 B     *+4(R15)                                         IS0041  19390000
*IS10002 B     ALT_OK                                           IS0041  19400000
*IS10002 B     ALT_ERROR                                        IS0041  19410000
*IS10002 B     ALT_ERROR                                        IS0041  19420000
*IS10002 B     ALT_ERROR                                        IS0041  19430000
*IS10002 B     ALT_ERROR                                        IS0041  19440000
*---------------------------------------------------------------*       19450000
**                                                                      19460000
**       ANALYZE THE DATA RETURNED BY ACF2 SVC AND DETERMINE            19470000
**                           USER STATUS                                19480000
**                                                                      19490000
**   ACF2 SVC OUTPUT CONTAINS ENTRIES FOR THE RETURNED PARAMETERS.      19500000
**   THE OUTPUT AREA CONTAINS DATA FOR PARAMETERS DEFINED FOR THE       19510000
**   USER. IS A PARAMETER IS NOT DEFINED FOR THE USER, THE              19520000
**   OUTPUT AREA WILL NE CONTAIN AN ENTRY FOR THIS PARAMETER.           19530000
**                                                                      19540000
**   THE ORDER OF THE RETURNED PARAMETERS IS ALPHA-BETIC.               19550000
**                                                                      19560000
**   THE ENTRIES IN THE OUTPUT AREA ARE MAPPED BY ACARE.                19570000
**                                                                      19580000
*---------------------------------------------------------------*       19590000
DACHECK  DS    0H                                                       19600000
         CTSADBG LEVEL=(DBGLEVEL,1),TYPE=SNAP,                  IS10066X19610000
               HDR='ACFSVC OUTPUT',                             IS10066X19620000
               ADDR=(AREBUF,AREBUF+L'AREBUF-1),                 IS10066X19630000
               RAREA=RAREA,DBGAREA=DBGAREA                      IS10066 19640000
*                                                               IS10066 19650000
**   PROCESS THE PARAMTERS RETURNED BY ACF2 SVC.                IS10066 19660000
**                                                              IS10066 19670000
**   FOR EACH ENTRY IN THE OUTPUT AREA, LOOK FOR THE            IS10066 19680000
**   PARAMETER NAME IN TH ACF2 SVC REQUESTED FIELDS LIST.       IS10066 19690000
**   WHEN FOUND, CALL THE CORRESPONDING ROUTINE.                IS10066 19700000
*                                                               IS10066 19710000
         XC    ACF2UFLG(ACF2UFLL),ACF2UFLG CLEAR USER FLAGS.    IS10066 19720000
*                                                                       19730000
         LA    R5,AREBUF           R5 -> ACF2 SVC OUTPUT.       IS0041  19740000
         USING ACARE,R5                                         IS0041  19750000
         L     R2,DAPFLDS#                                      IS10066 19760000
         L     R2,0(,R2)           R2 = # OF FIELDS.            IS10066 19770000
         LA    R4,AREBUF+L'AREBUF  R4 -> END OF BUFFER          IS10066 19780000
DANEXTP  DS    0H                                               IS10066 19790000
         LR    R3,R5                                            IS10066 19800000
         AH    R3,ARELNTH          R3 -> AFTER ENTRY.           IS10066 19810000
         CLR   R3,R4               OUT OF BUFFER ?              IS10066 19820000
         BH    DABUFERR            ..YES - ERROR.               IS10066 19830000
         SLR   R3,R5               R3 = ENTRY LENGTH            IS10066 19840000
         BZ    DABUFERR            ENTRY LENGTH = 0 - ERROR.    IS10066 19850000
         CHI   R3,AREBLNTH         AT LEAST MINIMUM LENGTH ?    IS10066 19860000
         BL    DABUFERR            ..NO - ERROR.                IS10066 19870000
*                                                               IS10066 19880000
         L     R6,DAPFLDSA         R6 -> KEYWORDS LIST.         IS10066 19890000
         LR    R0,R2               R0 = # OF KEYWORDS.          IS10066 19900000
DAKYWDLP DS    0H                                               IS10066 19910000
         CLC   AREANAME,0(R6)      CURRENT PARAMETER ?          IS10066 19920000
         BE    DAPRCENT            ..YES - GO PROCESS.          IS10066 19930000
         AHI   R6,8                R6 -> NEXT KEYWORD IN TABLE. IS10066 19940000
         BCT   R0,DAKYWDLP                                      IS10066 19950000
         B     DABUFERR            KEYWORD NOT REQUESTED - ERROR. 10066 19960000
DAPRCENT DS    0H                                               IS10066 19970000
         SL    R6,DAPFLDSA         R6 = OFFSET IN KEYWORDS TABLE. 10066 19980000
         SRL   R6,1                R6 = OFFSET IN ROUTINES TABLE. 10066 19990000
         L     R15,DAPRTNSA        R15 -> PROCESS ROUTINES      IS10066 20000000
         L     R15,0(R6,R15)       R15 -> PARM PROCESS ROUTINE. IS10066 20010000
         BRAS  R14,DAPPROC         GO PROCESS THE PARAMETER.    IS10066 20020000
*                                  INPUT: R5 -> PARM.           IS10066 20030000
         CHI   R15,0               PROCESSED SUCCESSULLY ?      IS10066 20040000
         BNE   DAPRFAIL            ..NO - ERROR.                IS10066 20050000
         TM    AREFLGS,AREFEND     LAST ENTRY ?                 IS10066 20060000
         BO    DAEOD               ..YES - GO ANALYZE USER STATUS.10066 20070000
         AH    R5,ARELNTH          R5 -> NEXT PARAMETER.        IS10066 20080000
         B     DANEXTP             PROCESS NEXT PARAMETER.      IS10066 20090000
*                                                               IS10066 20100000
**  ALL DATA RETURNED FROM ACF2 SVC WAS PROCESSED.              IS10066 20110000
*                                                               IS10066 20120000
DAEOD    DS    0H                                               IS10066 20130000
         CTSADBG TYPE=SNAP,ID=1,HDR='** ACF2 USER DATA',        IS10066X20140000
               ADDR=(ACF2UFLG,ACF2UFLG+ACF2UFLL-1),             IS10066X20150000
               LEVEL=(DBGLEVEL,1,2,3,4,5),                      IS10066X20160000
               RAREA=RAREA,DBGAREA=DBGAREA                      IS10066 20170000
*                                                               IS10066 20180000
         B     DARC0                                            IS10066 20190000
*                                                               IS10066 20200000
**   FAILED TO ANALYZE THE ACF SVC OUTPUT                       IS10066 20210000
*                                                               IS10066 20220000
DABUFERR DS    0H                  EXTRACT OUTPUT ERROR (TOO SHORT) 066 20230000
         MVC   ACSNAPHN,=CL8'AREA'                              IS10066 20240000
         B     DAERSNAP                                         IS10066 20250000
DAPRFAIL DS    0H                  EXTRACT OUTPUT PROCESSING FAILED 066 20260000
         LR    R1,R6                                            IS10066 20270000
         SLL   R1,1                R1 = OFFSET IN NAMES LIST.   IS10066 20280000
         L     R15,DAPFLDSA        R15 -> KEYWORDS TABLE.       IS10066 20290000
         LA    R15,0(R1,R15)       R15 -> CURRENT KEYWORD.      IS10066 20300000
         MVC   ACSNAPHN,0(R15)     MOVE NAME TO PARAMETER TO    IS10066 20310000
DAERSNAP DS    0H                                               IS10066 20320000
         CTSADBG 'DOACFSVC FAILED: ERROR PROCESSING _. R5=~ R6=~',   66X20330000
               (ACSNAPHN,8,?R5,?R6)                             IS10066 20340000
         LA    R0,ACSNAPHD         R0 -> SNAP HEAER.            IS10066 20350000
         LA    R14,AREBUF          R14 -> ACF2 SVC OUTPUT.      IS10066 20360000
         LA    R15,L'AREBUF-1(,R14) R15 -> ACF2 SVC OUTPUT END. IS10066 20370000
         CTSADBG TYPE=SNAP,                                     IS10066X20380000
               HDR=(R0),                                        IS10066X20390000
               ADDR=(0(,R14),0(,R15))                           IS10066 20400000
         B     DARC8                                            IS10066 20410000
*                                                               IS10066 20420000
**   SET RETURN CODE AND RETURN                                 IS10066 20430000
*                                                               IS10066 20440000
DARC0    DS    0H                  DATA RETRIEVED SUCCESSFULLY. IS10066 20450000
         LHI   R15,0                                            IS10066 20460000
         B     DAEND                                            IS10066 20470000
DARC4    DS    0H                  USER DOES NOT EXIST.         IS10066 20480000
         LHI   R15,4                                            IS10066 20490000
         B     DAEND                                            IS10066 20500000
DARC8    DS    0H                  FAILURE IN ACF SVC OR IN     IS10066 20510000
*                                  OUTPUT PROCESSING.           IS10066 20520000
*BS10045 LHI   R15,8                                            IS10066 20530000
         LA    R1,RCINTERR         SAF RC = 99. ACF2: RC = 99, RS = 99  20540000
         BRAS  R14,SETRCS                                       IS10066 20550000
         LHI   R15,8                                            BS10045 20560000
DAEND    DS    0H                                               IS10066 20570000
         BRTRN (15)                                             IS10066 20580000
*---------------------------------------------------------------*       20590000
**                                                              IS10066 20600000
**   PROCESS PARAMETERS RETRIEVED BY ACF2 SVC AND EXTRACT       IS10066 20610000
**                                                              IS10066 20620000
**   THE CODE ABOVE BRANCHES TO THE APPROPRIATE 'ROUTINE'       IS10066 20630000
**   ACCORDING TO THE PARAMETERS/ROUTINES LIST.                 IS10066 20640000
**                                                              IS10066 20650000
**   THESE ROUTINES USE THE SAME AS REGISTER AS VERXRACF        IS10066 20660000
**                                                              IS10066 20670000
**   INPUT:                                                     IS10066 20680000
**   R5 -> PARM - SHOULD NOT BE CHENGED.                        IS10066 20690000
**   R6 = OFFSET IN ROUTINES TABLE.                             IS10066 20700000
**                                                              IS10066 20710000
**   RETURN CODES:                                              IS10066 20720000
**   0 - PROCESSED SUCCESSFULLY.                                IS10066 20730000
**   4 - ERROR.                                                 IS10066 20740000
**                                                              IS10066 20750000
*---------------------------------------------------------------*       20760000
DAPPROC  DS    0H                  PROCESS PARAMETERS           IS10066 20770000
         ST    R14,SAR14           SAVE RETURN ADDRESS.         IS10066 20780000
         BR    R15                 GO PROCESS PARM.             IS10066 20790000
*                                                               IS10066 20800000
**   COMMON PARAMETERS BASE REGISTERS                           IS10066 20810000
*                                                               IS10066 20820000
ACSPARM  USING ACARE,R5            ACF2 SVC OUTPUT ENTRY.       IS10066 20830000
*                                                               IS10066 20840000
**   PROCESS PASSWORD DATE                                      IS10066 20850000
*                                                               IS10066 20860000
DAP_PSWDTODA DS 0H                                              IS10066 20870000
PSDTFLDS USING PSDATFLD,ACPSDTFL                                IS10066 20880000
         CLI   PSWPHFLG,PSWDPHRS   DID USER PROVIDE PSWDPHRS?  IS10147A 20890000
         BE    DAPPROC0            YES, LEAVE IMMEDIATELY      IS10147A 20900000
         LH    R0,ACSPARM.ARELNTH  R0 = PARM LENGTH.            IS10066 20910000
         CHI   R0,X'18'            LENGTH OK ?                  IS10066 20920000
         BNE   DAPPROC4            ..NO - DO NOT PROCESS.       IS10066 20930000
         LH    R0,ACSPARM.AREVLNTH R0 = DATA LENGTH.            IS10066 20940000
         CHI   R0,8                LENGTH OK ?                  IS10066 20950000
         BNE   DAPPROC4            ..NO - DO NOT PROCESS.       IS10066 20960000
         L     R0,ACSPARM.AREVALUE R0 = DATE.                   IS10066 20970000
         OILL  R0,X'000F'          SET 'F' AS DECIMAL CGAR.     IS10066 20980000
         CHI   R0,X'000F'          DATE = 0 ?                   IS10066 20990000
         BE    DAPPDEND            ..YES - NO NEED TO CONVERT.  IS10066 21000000
         ST    R0,PSDTFLDS.PDPASDAT SAVE PASSWORD DATE.         IS10066 21010000
DAPPDEND DS    0H                                               IS10066 21020000
         B     DAPPROC0                                         IS10066 21030000
         DROP  PSDTFLDS                                         IS10066 21040000
*                                                               IS10066 21050000
**   PROCESS PASSWORD INTERVAL                                  IS10066 21060000
*                                                               IS10066 21070000
DAP_MAXDAYSA DS 0H                                              IS10066 21080000
PSDTFLDS USING PSDATFLD,ACPSDTFL                                IS10066 21090000
         LH    R0,ACSPARM.ARELNTH  R0 = PARM LENGTH.            IS10066 21100000
         CHI   R0,X'0014'          LENGTH OK ?                  IS10066 21110000
         BNE   DAPPROC4            ..NO - DO NOT PROCESS.       IS10066 21120000
         LH    R0,ACSPARM.AREVLNTH R0 = DATA LENGTH.            IS10066 21130000
         CHI   R0,4                LENGTH OK ?                  IS10066 21140000
         BNE   DAPPROC4            ..NO - DO NOT PROCESS.       IS10066 21150000
         L     R0,ACSPARM.AREVALUE                              IS10066 21160000
         STH   R0,PSDTFLDS.PDPASINT SAVE PASSWORD INTERVAL.     IS10066 21170000
         B     DAPPROC0                                         IS10066 21180000
         DROP  PSDTFLDS                                         IS10066 21190000
*                                                               IS10066 21200000
**   PROCESS 'PASSWORD EXTRACT' FLAG                            IS10066 21210000
*                                                               IS10066 21220000
DAP_PSWDXTRA DS 0H                                              IS10066 21230000
         CLI   PSWPHFLG,PSWDPHRS   DID USER PROVIDE PSWDPHRS?  IS10147A 21240000
         BE    DAPPROC0            YES, LEAVE IMMEDIATELY      IS10147A 21250000
         LH    R0,ACSPARM.ARELNTH  R0 = PARM LENGTH.            IS10066 21260000
         CHI   R0,X'0012'          LENGTH OK ?                  IS10066 21270000
         BNE   DAPPROC4            ..NO - DO NOT PROCESS.       IS10066 21280000
         LH    R0,ACSPARM.AREVLNTH R0 = DATA LENGTH.            IS10066 21290000
         CHI   R0,1                LENGTH OK ?                  IS10066 21300000
         BNE   DAPPROC4            ..NO - DO NOT PROCESS.       IS10066 21310000
         CLI   ACSPARM.AREVALUE,X'01' EXTRACT ALLOWED ?         IS10066 21320000
         BNE   DAPPROC0                                         IS10066 21330000
         MVI   ACPXTRFL,ACPXTRFA   SAVE 'PSWD EXTRACT ALLOWED'  IS10066 21340000
         B     DAPPROC0                                         IS10066 21350000
*                                                               IS10066 21360000
**   PROCESS 'PASSWORD EXPIRED' FLAG                            IS10066 21370000
**   PLEASE NOTE: THIS ROUTINE USE TO BE TOGETHER WITH THE     IS10147A 21380000
**                DAP_LIDTEMPA ROUTINE. THIS MODIFICATION      IS10147A 21390000
**                SPLIT IT INTO ITS OWN ROUTINE.               IS10147A 21400000
*                                                               IS10066 21410000
DAP_PSWDEXPA DS 0H                                              IS10066 21420000
PSDTFLDS USING PSDATFLD,ACPSDTFL                                IS10066 21430000
         CLI   PSWPHFLG,PSWDPHRS   DID USER PROVIDE PSWDPHRS?  IS10147A 21440000
         BE    DAPPROC0            YES, LEAVE IMMEDIATELY      IS10147A 21450000
         LH    R0,ACSPARM.ARELNTH  R0 = PARM LENGTH.            IS10066 21460000
         CHI   R0,X'0012'          LENGTH OK ?                  IS10066 21470000
         BNE   DAPPROC4            ..NO - DO NOT PROCESS.       IS10066 21480000
         LH    R0,ACSPARM.AREVLNTH R0 = DATA LENGTH.            IS10066 21490000
         CHI   R0,1                LENGTH OK ?                  IS10066 21500000
         BNE   DAPPROC4            ..NO - DO NOT PROCESS.       IS10066 21510000
         CLI   ACSPARM.AREVALUE,X'01' PASSWORD EXPIRED ?        IS10066 21520000
         BNE   DAPPROC0                                         IS10066 21530000
         MVI   PSDTFLDS.PDPSEXPF,PDPSEXP SET 'PASSWORD EXPIRED' IS10066 21540000
         B     DAPPROC0                                         IS10066 21550000
         DROP  PSDTFLDS                                         IS10066 21560000
*                                                               IS10066 21570000
**   PROCESS 'PASSWORD TEMPORARY' FLAG                          IS10066 21580000
*                                                               IS10066 21590000
DAP_LIDTEMPA DS 0H                                              IS10066 21600000
PSDTFLDS USING PSDATFLD,ACPSDTFL                                IS10066 21610000
         LH    R0,ACSPARM.ARELNTH  R0 = PARM LENGTH.            IS10066 21620000
         CHI   R0,X'0012'          LENGTH OK ?                  IS10066 21630000
         BNE   DAPPROC4            ..NO - DO NOT PROCESS.       IS10066 21640000
         LH    R0,ACSPARM.AREVLNTH R0 = DATA LENGTH.            IS10066 21650000
         CHI   R0,1                LENGTH OK ?                  IS10066 21660000
         BNE   DAPPROC4            ..NO - DO NOT PROCESS.       IS10066 21670000
         CLI   ACSPARM.AREVALUE,X'01' PASSWORD EXPIRED ?        IS10066 21680000
         BNE   DAPPROC0                                         IS10066 21690000
         MVI   PSDTFLDS.PDPSEXPF,PDPSEXP SET 'PASSWORD EXPIRED' IS10066 21700000
         B     DAPPROC0                                         IS10066 21710000
         DROP  PSDTFLDS                                         IS10066 21720000
*                                                               IS10066 21730000
**   PROCESS 'MAXDAYS OVERIDE' FLAG                             IS10066 21740000
*                                                               IS10066 21750000
DAP_LIDZMAXA DS 0H                                              IS10066 21760000
         LH    R0,ACSPARM.ARELNTH  R0 = PARM LENGTH.            IS10066 21770000
         CHI   R0,X'0012'          LENGTH OK ?                  IS10066 21780000
         BNE   DAPPROC4            ..NO - DO NOT PROCESS.       IS10066 21790000
         LH    R0,ACSPARM.AREVLNTH R0 = DATA LENGTH.            IS10066 21800000
         CHI   R0,1                LENGTH OK ?                  IS10066 21810000
         BNE   DAPPROC4            ..NO - DO NOT PROCESS.       IS10066 21820000
         CLI   ACSPARM.AREVALUE,X'01' MAXDAYS 0 OVERIDES DEFAULT ? 0066 21830000
         BNE   DAPPROC0                                         IS10066 21840000
         MVI   ACMXDOVF,ACMXDOVR   OVERIDE                      IS10066 21850000
         B     DAPPROC0                                         IS10066 21860000
*                                                               IS10066 21870000
**   PROCESS PASSWORD VIOLATION COUNT                           IS10066 21880000
*                                                               IS10066 21890000
DAP_PSWDVIOA DS 0H                                              IS10066 21900000
         CLI   PSWPHFLG,PSWDPHRS   DID USER PROVIDE PSWDPHRS?  IS10147A 21910000
         BE    DAPPROC0            YES, LEAVE IMMEDIATELY      IS10147A 21920000
         LH    R0,ACSPARM.ARELNTH  R0 = PARM LENGTH.            IS10066 21930000
         CHI   R0,X'0014'          LENGTH OK ?                  IS10066 21940000
         BNE   DAPPROC4            ..NO - DO NOT PROCESS.       IS10066 21950000
         LH    R0,ACSPARM.AREVLNTH R0 = DATA LENGTH.            IS10066 21960000
         CHI   R0,4                LENGTH OK ?                  IS10066 21970000
         BNE   DAPPROC4            ..NO - DO NOT PROCESS.       IS10066 21980000
         L     R0,ACSPARM.AREVALUE R0 = VIOLATION NUMBER.       IS10066 21990000
         STH   R0,ACPSVIO#         SAVE PASSWORD VIOLATIONS #.  IS10066 22000000
         B     DAPPROC0                                         IS10066 22010000
*                                                              IS10147A 22020000
**   PROCESS PASSWORD PHRASE VIOLATION COUNT                   IS10147A 22030000
*                                                              IS10147A 22040000
DAP_PWPVIOA DS 0H                                              IS10147A 22050000
         CLI   PSWPHFLG,PSWD       DID USER PROVIDE PASSWORD?  IS10147A 22060000
         BE    DAPPROC0            YES, LEAVE IMMEDIATELY      IS10147A 22070000
         LH    R0,ACSPARM.ARELNTH  R0 = PARM LENGTH.           IS10147A 22080000
         CHI   R0,X'0014'          LENGTH OK ?                 IS10147A 22090000
         BNE   DAPPROC4            ..NO - DO NOT PROCESS.      IS10147A 22100000
         LH    R0,ACSPARM.AREVLNTH R0 = DATA LENGTH.           IS10147A 22110000
         CHI   R0,4                LENGTH OK ?                 IS10147A 22120000
         BNE   DAPPROC4            ..NO - DO NOT PROCESS.      IS10147A 22130000
         L     R0,ACSPARM.AREVALUE R0 = VIOLATION NUMBER.      IS10147A 22140000
         STH   R0,ACPSVIO#         SAVE PSWDPHRS VIOLATIONS #. IS10147A 22150000
         B     DAPPROC0                                        IS10147A 22160000
*                                                               IS10066 22170000
**   PROCESS EXPIRE DATE                                        IS10066 22180000
*                                                               IS10066 22190000
DAP_EXPIREA DS 0H                                               IS10066 22200000
         LA    R1,ACEXDATF         R1 -> FLAGS BYTE FOR DATE    IS10066 22210000
*                                        COMPARE RESULTS.       IS10066 22220000
         BAS   R14,DAPCMDAT        COMPARE DATE IN ENTRY TO     IS10066 22230000
*                                  TODAY DATE AND SET THE FLAG  IS10066 22240000
*                                  POINTED BY R1.               IS10066 22250000
         B     DAPPROC0            - DATE PROCESSED.            IS10066 22260000
         B     DAPPROC4            - ERROR PROCESSING DATE.     IS10066 22270000
*                                                               IS10066 22280000
**   PROCESS ACTIVE DATE                                        IS10066 22290000
*                                                               IS10066 22300000
DAP_ACTIVEA DS 0H                                               IS10066 22310000
         LA    R1,ACACDATF         R1 -> FLAGS BYTE FOR DATE    IS10066 22320000
*                                        COMPARE RESULTS.       IS10066 22330000
         BAS   R14,DAPCMDAT        COMPARE DATE IN ENTRY TO     IS10066 22340000
*                                  TODAY DATE AND SET THE FLAG  IS10066 22350000
*                                  POINTED BY R1.               IS10066 22360000
         B     DAPPROC0            - DATE PROCESSED.            IS10066 22370000
         B     DAPPROC4            - ERROR PROCESSING DATE.     IS10066 22380000
*                                                               IS10066 22390000
**   PROCESS SUSPEND FLAG.                                      IS10066 22400000
**   PROCESS CANCEL FLAG.                                       IS10066 22410000
*                                                               IS10066 22420000
DAP_SUSPENDA DS 0H                                              IS10066 22430000
DAP_CANCELA DS 0H                                               IS10066 22440000
         LH    R0,ACSPARM.ARELNTH  R0 = PARM LENGTH.            IS10066 22450000
         CHI   R0,X'0012'          LENGTH OK ?                  IS10066 22460000
         BNE   DAPPROC4            ..NO - DO NOT PROCESS.       IS10066 22470000
         LH    R0,ACSPARM.AREVLNTH R0 = DATA LENGTH.            IS10066 22480000
         CHI   R0,1                LENGTH OK ?                  IS10066 22490000
         BNE   DAPPROC4            ..NO - DO NOT PROCESS.       IS10066 22500000
         CLI   ACSPARM.AREVALUE,X'01' SUSPENDED ?               IS10066 22510000
         BNE   DAPSCEND            ..NO - OUT.                  IS10066 22520000
         MVI   ACSUSCNF,ACSUSCAN   SUSPENDED /CANCELLED.        IS10066 22530000
DAPSCEND DS    0H                                               IS10066 22540000
         B     DAPPROC0                                         IS10066 22550000
*                                                               IS10066 22560000
**   SET RETURN CODE AND RETURN.                                IS10066 22570000
*                                                               IS10066 22580000
DAPPROC0 DS    0H                                               IS10066 22590000
         LHI   R15,0                                            IS10066 22600000
         B     DAPPROCE                                         IS10066 22610000
DAPPROC4 DS    0H                                               IS10066 22620000
         LHI   R15,4                                            IS10066 22630000
         B     DAPPROCE                                         IS10066 22640000
DAPPROCE DS    0H                                               IS10066 22650000
         L     R14,SAR14           RESTORE RETURN ADDRESS.      IS10066 22660000
         BR    R14                                              IS10066 22670000
*                                                               IS10066 22680000
**   COMPARE DATES                                              IS10066 22690000
**                                                              IS10066 22700000
**   COMPARE THE DATE IN THE ENTRY TO THE DATE OF TODAY         IS10066 22710000
**   AND SET A FLAG ACCORDING TO THE RESULTS.                   IS10066 22720000
**                                                              IS10066 22730000
**   INPUT DATE FORMAT: 0CYYDDDF                                IS10066 22740000
**   TODAY DATE FORMAT: 0CYYDDDF                                IS10066 22750000
**                                                              IS10066 22760000
**   INPUT:                                                     IS10066 22770000
**   R5 -> PARM ENTRY.                                          IS10066 22780000
**   R14 = RETURN ADDRESS.                                      IS10066 22790000
**   R1 -> DATE FLAG.                                           IS10066 22800000
**                                                              IS10066 22810000
**   RETURN TO:                                                 IS10066 22820000
**   0(,R14) - WHEN DEFAULT GROUP EXISTS.                       IS10066 22830000
**   4(,R14) - WHEN DEFAULT GROUP DOES NOT EXIST                IS10066 22840000
**                                                              IS10066 22850000
*                                                               IS10066 22860000
DAPCMDAT DS    0H                                               IS10066 22870000
         LH    R0,ACSPARM.ARELNTH  R0 = PARM LENGTH.            IS10066 22880000
         CHI   R0,X'0014'          LENGTH OK ?                  IS10066 22890000
         BNE   DAPCMDER            ..NO - DO NOT PROCESS.       IS10066 22900000
         LH    R0,ACSPARM.AREVLNTH R0 = DATA LENGTH.            IS10066 22910000
         CHI   R0,4                LENGTH OK ?                  IS10066 22920000
         BNE   DAPCMDER            ..NO - DO NOT PROCESS.       IS10066 22930000
         L     R0,ACSPARM.AREVALUE R0 = DATE.                   IS10066 22940000
         COMPDATE R0,0(R1)         COMPARE DATE WITH TODAY AND  IS10066 22950000
*                                  SET THE DATE FLAG.           IS10066 22960000
         BR    R14                 RETURN                       IS10066 22970000
DAPCMDER DS    0H                                               IS10066 22980000
         B     4(,R14)                                          IS10066 22990000
         DROP  ,                                                IS10066 23000000
*****************************************************************       23010000
*                                                               *       23020000
*        COMPPSWD                                               *       23030000
*                                                               *       23040000
*  ENCRYPT THE PASSWORD AND COMPARE WITH THE RETRIEVED PASSWORD *       23050000
*                                                               *       23060000
*  INPUT:                                                       *       23070000
*  R11 -> CONST.                                                *       23080000
*  R14 = RETURN ADDRESS.                                        *       23090000
*                                                               *       23100000
*  RETURN CODES:                                                *       23110000
*  R1 -> RSS RC AND RS.                                         *       23120000
*  R15 = RACROUTE RETURN CODE.                                  *       23130000
*                                                               *       23140000
*                                                               *       23150000
*****************************************************************       23160000
COMPPSWD BEGIN COMPPSWD                                         IS10066 23170000
*IS10147AUSING CONST,R11                                        IS10066 23180000
         USING CONST,R11,R12                                   IS10147A 23190000
         USING PRM,R10                                          IS10066 23200000
************************ WS10051 START *************************        23210000
         CTSADBG LEVEL=(DBGLEVEL,1),                                   X23220000
               'RSSTYPE=(_)',(WRSST,1),                                X23230000
               RAREA=RAREA,DBGAREA=DBGAREA                              23240000
         CLI   WRSST,WRACFI        RACF ?                               23340000
         BNE   NOKDFAES            NO, SKIP KDFAES                      23350000
         TM    WPALG,01            KDFAES ?                             23360000
         BZ    NOKDFAES            NO, SKIP KDFAES                      23370000
* IT'S RACF & KDFAES IS ACTIVATED                                       23380000
         CTSADBG LEVEL=(DBGLEVEL,1),                                   X23390000
               'KDFAES IS ACTIVE',                                     X23400000
               RAREA=RAREA,DBGAREA=DBGAREA                              23410000
*IS10147AMVC   SPWUSER,BLANKS8                                          23420000
         MVC   SPWUSER,BLANKS                                  IS10147A 23430000
         MVC   SPWUSERL+3(1),USERL SET USER LEN 4 IRRSPW00              23440000
         XR    R1,R1                                                    23450000
         IC    R1,USERL                                                 23460000
         LTR   R1,R1                                                    23470000
         BZ    CPSWDR12            NO USER SUPPLIED                     23480000
         AHI   R1,-1                                                    23490000
         EX    R1,MVUS2SPW                                              23500000
         B     *+4+6                                                    23510000
MVUS2SPW MVC   SPWUSER(*-*),USERID                                      23520000
*                                                                       23530000
*IS10147AMVC   SPWPASS,BLANKS8                                          23540000
         MVC   SPWPASS,BLANKS                                  IS10147A 23550000
         MVC   SPWPASSL+3(1),PASSL SET PSWD LEN 4 IRRSPW00              23560000
         XR    R1,R1                                                    23570000
         IC    R1,PASSL                                                 23580000
         LTR   R1,R1                                                    23590000
         BZ    CPSWDR16            NO PSWD SUPPLIED                     23600000
         AHI   R1,-1                                                    23610000
         EX    R1,MVPS2SPW                                              23620000
         B     *+4+6                                                    23630000
MVPS2SPW MVC   SPWPASS(*-*),PASSWORD                                    23640000
*IS10147AMVC   TEMPPSWD(8),=XL8'FFFFFFFFFFFFFFFF'                       23650000
*IS10147AXC    TEMPPSWD(8),SPWPASS                                      23660000
         MVC   TEMPPSWD,ALLFF                                  IS10147A 23670000
         XC    TEMPPSWD,SPWPASS                                IS10147A 23680000
         CTSADBG LEVEL=(DBGLEVEL,1),                                   X23690000
               'IRRSPW00 INPUT: #/_ #/$',                              X23700000
               (SPWUSERL,SPWUSER,8,SPWPASSL,TEMPPSWD,100),     IS10147AX23710000
               RAREA=RAREA,DBGAREA=DBGAREA                              23720000
*                                                                       23730000
* LOAD IRRSPW00 IF NEEDED                                               23740000
*                                                                       23750000
         L     R15,SPWADDR      IRRSPW00 IS LOADED ?                    23760000
         LTR   R15,R15                                                  23770000
         BNZ   SKIPLD1          SKIP IRRSPW00 LOAD                      23780000
         LOAD  EPLOC=IRRSPW00,ERRET=CPSWDR20                            23790000
         ST    R0,SPWADDR           KEEP IRRSPW00 ADDRESS               23800000
         LR    R15,R0               PREPARE R15 FOR CALL                23810000
SKIPLD1  DS    0H                                                       23820000
         LR    R7,R15              KEEP IRRSPW00 ADDRESS                23830000
*                                                                       23840000
* CHG TO SUPERVISOR STATE (IF NEEDED)                                   23850000
*                                                                       23860000
         LA    R6,1                    ASSUME SUPERVISOR STATE          23870000
         TESTAUTH STATE=YES,RBLEVEL=1  SUPERVISOR STATE?                23880000
         LTR   R15,R15                                                  23890000
         BZ    ISSUPRV                 YES, IT IS SUPERVISOR            23900000
         MODESET MODE=SUP              GET INTO SUPERVISOR              23910000
         XR    R6,R6                   NOT SUPERVISOR STATE             23920000
ISSUPRV  EQU   *                                                        23930000
*                                                                       23940000
         LARL  R1,IRRSPWA           R1 -> PARAMETERS                    23950000
         LR    R15,R7              RESTORE IRRSPW00 ADDRESS             23960000
* CALL TO IRRSPW00 SHOULD BE IN AMODE 31 - WHICH HAS BEEN SET ALREADY   23970000
         CALL  (15),((R1),                                             X23980000
               SAFCALET,                                               X23990000
               SPWSAFRC,                                               X24000000
               RCFCALET,                                               X24010000
               SPWRCFRC,                                               X24020000
               RCFSALET,                                               X24030000
               SPWRCFRS,                                               X24040000
               SPWNUMP,                                                X24050000
               PRMALET,                      PARM_ALET                 X24060000
               SPWFNCTN,                                               X24070000
               SPWUSERL,                                               X24080000
               SPWUSER,                                                X24090000
               SPWPASSL,                                               X24100000
               SPWPASS,                                                X24110000
               SPWFNCPL)                                                24120000
*                                                                       24130000
         CTSADBG LEVEL=(DBGLEVEL,1),                                   X24140000
               'IRRSPW00: SAF RC=(~) RACF RC=(~) RACF RS=(~)',         X24150000
               (SPWSAFRC,SPWRCFRC,SPWRCFRS),                           X24160000
               RAREA=RAREA,DBGAREA=DBGAREA                              24170000
         LTR   R6,R6              WERE IN SUP MODE?                     24180000
         BNZ   STAYSUP            YES, REMAIN THAT WAY                  24190000
         MODESET MODE=PROB                                              24200000
STAYSUP  DS    0H                                                       24210000
         CLC   SPWSAFRC,=XL4'00'   VERIFY PASSWORD OK ?                 24220000
         BNE   CPSWDRC4            NO                                   24230000
         CTSADBG LEVEL=(DBGLEVEL,1),                                   X24240000
               'SET R15=0',                                            X24250000
               RAREA=RAREA,DBGAREA=DBGAREA                              24260000
         B     CPSWDRC0                                                 24270000
*********************** END OF WS10051 ****************************     24320000
*                                                                       24330000
* USE THE "OLD" WAY TO COMPARE PASSWORDS                                24340000
*                                                                       24350000
NOKDFAES DS    0H                                                       24360000
*IS10183 CTSADBG LEVEL=(DBGLEVEL,1),                                   X24370000
               'OPAS CHAR=_',(RSSPSWD,100),                    IS10147AX24380000
               RAREA=RAREA,DBGAREA=DBGAREA                      IS10066 24390000
*IS10183 CTSADBG LEVEL=(DBGLEVEL,1),                                   X24400000
               'OPAS HEX=$',(RSSPSWD,100),                     IS10147AX24410000
               RAREA=RAREA,DBGAREA=DBGAREA                      IS10066 24420000
*                                                                       24430000
         CLI   PSWPHFLG,PSWDPHRS   DID USER PROVIDE PSWDPHRS?  IS10147A 24440000
         BE    ISSRCREX            YES, CONTINUE THERE         IS10147A 24450000
         MVI   PASSL,8                                                  24460000
ISSRCREX DS    0H                                              IS10147A 24470000
         RACROUTE REQUEST=EXTRACT,TYPE=ENCRYPT,                 IS10066X24480000
               ENCRYPT=(PASSALL,INST), ENCRYPTION KEY           IS10066X24490000
               MF=(E,ENCRYPTL)         RACROUTE WORK AREA       IS10066 24500000
*                                                                       24510000
         LA    R0,#ENCRYPT                                      IS10066 24520000
         LA    R1,ENCRYPTL                                      IS10066 24530000
         BRAS  R14,HANDLERC                                     IS10066 24540000
*                                                                       24550000
         LTR   R15,R15                                                  24560000
         BNZ   CPSWDRC8                                         IS10066 24570000
*                                                                       24580000
**   COMPARE ENCRYPTED PASSWORDS                                        24590000
*                                                                       24600000
*IS10183 CTSADBG LEVEL=(DBGLEVEL,1),                                   X24610000
               'OP=$',(RSSPSWD,100),                           IS10147AX24620000
               RAREA=RAREA,DBGAREA=DBGAREA                      IS10066 24630000
*IS10183 CTSADBG LEVEL=(DBGLEVEL,1),                                   X24640000
               'NP=$',(PASSWORD,100),                          IS10147AX24650000
               RAREA=RAREA,DBGAREA=DBGAREA                      IS10066 24660000
*                                                                       24670000
*IS10147ACLC   RSSPSWD,PASSWORD    COMPARE THE PASSWORDS                24680000
         ICM   R1,15,RSSPSWDL      GET LEN OF PSWD (PHRASE)    IS10147A 24690000
         BNP   CPSWDRC4            CANNOT COMPARE, LEAVE       IS10147A 24700000
         AHI   R1,-1               DECREMENT BY 1              IS10147A 24710000
         EX    R1,CMPSWDPH         COMPARE THE PASSWORDS       IS10147A 24720000
         BNE   CPSWDRC4            ..NOT EQUAL.                 IS10066 24730000
         B     CPSWDRC0            CONTINUE THERE              IS10147A 24740000
CMPSWDPH CLC   RSSPSWD(0),PASSWORD COMPARE THE PASSWORDS       IS10147A 24750000
*                                                                       24760000
**   SET THE RETURN CODE.                                               24770000
*                                                                       24780000
CPSWDRC0 DS    0H                                               WS10051 24790000
         LHI   R15,0               ..EQUAL.                     IS10066 24800000
         B     CPSWDEND                                         IS10066 24810000
CPSWDRC4 DS    0H                                               IS10066 24820000
         LHI   R15,4               PASSWORD DOES NOT MATCH.     IS10066 24830000
         B     CPSWDEND                                         IS10066 24840000
CPSWDRC8 DS    0H                                               IS10066 24850000
         LHI   R15,8               ENCRYPT FAILED.              IS10066 24860000
         B     CPSWDEND                                         IS10066 24870000
CPSWDR12 DS    0H                                               WS10051 24920000
         LHI   R15,12              NO USER SUPPLIED             WS10051 24930000
         B     CPSWDEND                                         WS10051 24940000
CPSWDR16 DS    0H                                               WS10051 24950000
         LHI   R15,16              NO PSWD SUPPLIED             WS10051 24960000
         B     CPSWDEND                                         WS10051 24970000
CPSWDR20 DS    0H                                               WS10051 24980000
         LHI   R15,20              IRRSPW00 LOAD FAILED         WS10051 24990000
         B     CPSWDEND                                         WS10051 25000000
CPSWDEND DS    0H                                               IS10066 25020000
*                                                               WS10051 25040000
**   DO CLEANUP -                                               WS10051 25050000
**   DELETE IRRSPW00 IF WE WERE LOADED DYNAMICALLY.             WS10051 25060000
*                                                               WS10051 25070000
         LR    R6,R15              KEEP RC                              25080000
         OC    SPWADDR,SPWADDR     IRRSPW00 WAS LOADED ?                25100000
         BZ    SKIPDL1             NO, SKIP DELETE                      25110000
*        CTSADBG LEVEL=(DBGLEVEL,1),                                   X25120000
               'R6=R15 AND R6=(#)',(?R6),                              X25130000
               RAREA=RAREA,DBGAREA=DBGAREA                              25140000
         CSVQUERY INADDR==A(CTSAVPS),                                  X25150000
               OUTMJNM=WAVPSNM                                          25160000
         CTSADBG LEVEL=(DBGLEVEL,1),                                   X25170000
               'CSVQUERY RC=(#) OUTEPNM=(_)',                          X25180000
               (?R15,WAVPSNM,8),                                       X25190000
               RAREA=RAREA,DBGAREA=DBGAREA                              25200000
         CHI   R15,0                                                    25210000
         BNE   DELSPW00            UNKNOWN ENVIR. - DELETE.             25220000
         CLC   WAVPSNM,=CL8'CTSAVPS' IS CTSAVPS LOADED AS MODULE?       25230000
         BNE   SKIPDL1               NO, SKIP DEL (IT'S CTSCINT)        25240000
DELSPW00 DS    0H                                                       25250000
         XC    SPWADDR,SPWADDR       CLEAR IRRSPW00 ADDRESS.            25260000
         DELETE EPLOC=IRRSPW00                                          25270000
         CTSADBG LEVEL=(DBGLEVEL,1),                                   X25280000
               'AFTER DELETE R15(#)',                                  X25290000
               (?R15),                                                 X25300000
               RAREA=RAREA,DBGAREA=DBGAREA                              25310000
SKIPDL1  DS    0H                                                       25320000
         LR    R15,R6              RESTORE RC                           25330000
************************ END OF WS10051 *************************       25380000
         CTSADBG LEVEL=(DBGLEVEL,1),                                   X25390000
               'R15=(#)',                                              X25400000
               (?R15),                                                 X25410000
               RAREA=RAREA,DBGAREA=DBGAREA                              25420000
         BRTRN (15)                                             IS10066 25430000
         DROP  ,                                                IS10066 25440000
******************************************************************      25450000
*                                                                *      25460000
*        CREATE ACEE - USE RACROUTE REQUEST=VERIFY               *      25470000
*                                                                *      25480000
*                                                                *      25490000
*  NOTE FOR USER WITH TIME SHIFT DEFINITION:                     *      25500000
*  WHEN A TIME SHIFT IS DEFINED FOR A USER, RACF IGNORES THE     *      25510000
*  TIME SHIFT FOR THE VERIFY REQUEST WHILE ACF2 FAILS THE VERIFY *      25520000
*  IF DONE OUTSIDE THE TIME SHIFT (RC=8, ACF2 RC=48, SCF2 RS=8). *      25530000
*                                                                *      25540000
******************************************************************      25550000
VERLOGON BEGIN VERLOGON                                        IS10147A 25560000
         USING CONST,R11,R12       ESTABLISH ADDRESSABILITY    IS10147A 25570000
         USING PRM,R10             ESTABLISH ADDRESSABILITY    IS10147A 25580000
         CTSADBG LEVEL=(DBGLEVEL,1),                            IS0041 *25590000
               'DOING LOGON',                                          X25600000
               RAREA=RAREA,DBGAREA=DBGAREA                      IS10066 25610000
*IS10066 L     R0,=A(RACWORK)          R0 POINTS TO RACWORK             25620000
*IS10066 LA    R1,L'RACWORK            SET LENGTH                       25630000
*IS10066 XR    R15,R15                 PAD WITH X'00'                   25640000
*IS10066 MVCL  R0,R14                  CLEAR                            25650000
*IS10066 XR    R7,R7                   NULLIFYING R7                    25660000
*                                                                       25670000
*BS10088 - START
**                                                              BS10088
**  THE CODE BELOW IS REMOVED BECAUSE OF TWO REASONS:           BS10088
**  1. WHEN AES2 ENCRYPTION IS ACTIVE IN ACF2, PSWD-TOD IS      BS10088
**     0, THEREFORE DECIDING WHETHER A USER HAS A PERMANENT     BS10088
**     PASSWORD ACCORDING TO THE CONTENT OF PSWD-TOD IS NOT     BS10088
**     CORRECT.                                                 BS10088
**  2. ACF2 ALLOWS CREATING A USER WITHOUT A PASSWORD PER GSO   BS10088
**     PARAMETER CALLED PSWDREQ. WHEN NOPSWDREQ IS SET IN GSO , BS10088
**     A USER MAY BE CREATED WITHOUT A PASSWORD AND PSWD-TOD    BS10088
**     FIELD REMAINS WITH ZEROS. WE SHOULD PASS SUCH A USER     BS10088
**     VERIFY-PASSWORD (WHILE CURRENTLY WE FAIL IT).            BS10088
**                                                              BS10088
**  START OF REMOVED CODE:                                      BS10088
**                                                              BS10088
*BS10088 CLC   RSSTYPE,ACF2        ACF2 ?                       IS10066 25680000
*BS10088 BNE   VLVERIFY            ..NO - CALL RACROUTE.        IS10066 25690000
*                                                               IS10066 25700000
**   ACF2 - RETRIEVE PASSWORD DATE.                             IS10066 25710000
**                                                              IS10066 25720000
**   WE CHECK THE DATE BEFORE DOING VERIFY, BECAUSE, WHEN THE   IS10066 25730000
**   USER IS DEFINED WITH NO PASSWORD (PASSWORD DATE = 0) THE   IS10066 25740000
**   VERIFY WILL ADD THE PASSWORD TO THE USER AND RETURN WITH   IS10066 25750000
**   A RETURN CODE OF 0 AS IF THE PASSWORDS MATCH.              IS10066 25760000
**                                                              IS10066 25770000
**   THIS IS NOT WHAT WE WANT:                                  IS10066 25780000
**   1. WE DO NOT WANT TO CHANGE THE USER DEFINITION.           IS10066 25790000
**   2. 'NO PASSWORD' IS CONSIDERED BY US AS 'NOT EQUAL' SO     IS10066 25800000
**      WE NEED TO KNOW THAT THIS IS THE CASE.                  IS10066 25810000
*                                                               IS10066 25820000
**   WHAT WAS WRITTEN ABOVE IS NOT TRUE FOR PASSWORD PHRASES.  IS10147A 25830000
**   WHEN A USERID IS CREATED WITHOUT A PASSWORD OR PASSWORD   IS10147A 25840000
**   PHRASE OR WHEN A USERID IS CREATED WITH A PASSWORD BUT    IS10147A 25850000
**   WITHOUT A PASSWORD PHRASE, ACF2 DOES NOT ALLOW A LOGIN    IS10147A 25860000
**   WITH A PASSWORD PHRASE. (THE SAME IS TRUE FOR TRYING TO   IS10147A 25870000
**   LOG ON TO TSO.) THEREFORE, WE DO NOT HAVE TO LOOK FOR     IS10147A 25880000
**   THE PWP-TOD FIELD HERE AND WE WILL GO DIRECTLY TO THE     IS10147A 25890000
**   LOGIN ATTEMPT.                                            IS10147A 25900000
*                                                              IS10147A 25910000
*BS10088 CLI   PSWPHFLG,PSWDPHRS   DO WE HAVE A PSWDPHRS?      IS10147A 25920000
*BS10088 BE    VLVERIFY            YES, CONTINUE THERE         IS10147A 25930000
*BS10088                                                                25940000
*BS10088 LARL  R15,DOACFSVC                                     IS10066 25950000
*BS10088 CALL  (15),(ACFSVCLF,ACFSVCLFA,ACFSVCLFCNT),VL         IS10066 25960000
*BS10088                           RETRIEVE USER DATA AND ANALYZES 0066 25970000
*BS10088 B     *+L'*(R15)          BRANCH ACCORDING TO RC:      IS10066 25980000
*BS10088 B     VLCHKPDT            0 - CHECK PASSWORD DATE.     IS10066 25990000
*BS10088 B     VLANOUSR            4 - USER DOES NOT EXIST.     IS10066 26000000
*BS10088 B     VLEND               8 - NOTHING RETRIEVED - ERROR.  0066 26010000
*BS10088                                                        IS10066 26020000
*BS10088 VLCHKPDT DS   0H                                       IS10066 26030000
*BS10088 OC    ACPASDAT,ACPASDAT   PASSWORD DATE EXISTS ?       IS10066 26040000
*BS10088 BZ    VLAPNE              ..NO - NO PASSWORD -> NO EQUAL. 0066 26050000
**  END OF REMOVED CODE:                                        BS10088
*                                                               IS10066 26060000
**   CALL RACROUTE TO VERIFY                                    IS10066 26070000
*                                                               IS10066 26080000
*BS10088 VLVERIFY DS   0H                                       IS10066 26090000
         XC    ACEEADDR,ACEEADDR       CLEAR ACEE ADDRESS.      IS10066 26100000
*                                                              IS10147A 26110000
**   CHECK WHETHER WE HAVE AN EMPTY PASSWORD FIELD             IS10147A 26120000
*                                                              IS10147A 26130000
         CLI   PASSL,4                 IS PASSWORD LENGTH = 4? IS10147A 26140000
         BNE   VERUSPSW                NO, CONTINUE THERE      IS10147A 26150000
         CLC   DMYPSWD,PASSWORD        IS PASSWORD=X'FFFFFFFF' IS10147A 26160000
         BNE   VERUSPSW                NO, CONTINUE THERE      IS10147A 26170000
         MVI   PASSL,0                 SET PASSWORD LENGTH TO 0IS10147A 26180000
         CTSADBG LEVEL=(DBGLEVEL,1),                           IS10147AX26190000
               'DUMMY PASSWORD ENCOUNTERED',                   IS10147AX26200000
               RAREA=RAREA,DBGAREA=DBGAREA                     IS10147A 26210000
VERUSPSW DS    0H                                              IS10147A 26220000
*                                                                       26230000
**   VERIFY THE USER AND PASSWORD                                       26240000
*                                                                       26250000
         CLI   PSWPHFLG,PSWDPHRS       DO WE HAVE A PSWDPHRS?  IS10147A 26260000
         BE    DORRVEC1                YES, CONTINUE THERE     IS10147A 26270000
         RACROUTE REQUEST=VERIFY,                               IS10066X26280000
               ENVIR=CREATE,           CREATE AN ACEE           IS10066X26290000
               MF=(E,ACEECREL)                                  IS10006 26300000
*                                                               IS10066 26310000
**   RETURN SAF AND RSS RETURN CODES TO THE CALLER.             IS10066 26320000
*                                                               IS10066 26330000
         LA    R0,#CREATE                                       IS10066 26340000
         LA    R1,ACEECREL                                      IS10066 26350000
         BRAS  R14,HANDLERC                                     IS10066 26360000
         B     DORRVECX                CONTINUE THERE          IS10147A 26370000
*                                                                       26380000
DORRVEC1 DS    0H                                              IS10147A 26390000
         RACROUTE REQUEST=VERIFY,                              IS10147AX26400000
               ENVIR=CREATE,           CREATE AN ACEE          IS10147AX26410000
               RELEASE=(7730,CHECK),   MINIMUM RELEASE REQUIREDIS10147AX26420000
               MF=(E,ACEECREM)                                 IS10147A 26430000
*                                                              IS10147A 26440000
**   RETURN SAF AND RSS RETURN CODES TO THE CALLER.            IS10147A 26450000
*                                                              IS10147A 26460000
         LA    R0,#CREATE                                      IS10147A 26470000
         LA    R1,ACEECREM                                     IS10147A 26480000
         BRAS  R14,HANDLERC                                    IS10147A 26490000
DORRVECX DS    0H                                              IS10147A 26500000
*                                                                       26510000
         LTR   R15,R15             ACEE CREATED SUCCESSFULLY ?  IS10066 26520000
         BNZ   VLEND               ..NO - RETURN.               IS10066 26530000
*                                                                       26540000
**   IF THE ACEE WAS CREATED SUCCESSFULLY, DELETE IT.                   26550000
*                                                                       26560000
         OC    ACEEADDR,ACEEADDR   ANYTHING TO DELETE ?         IS10066 26570000
         BZ    VLEND               ..NO - SKIP DELETE           IS10066 26580000
*IS10066 L     R0,=A(RACWORK)          R0 POINTS TO RAREA               26590000
*IS10066 LA    R1,L'RACWORK            SET LENGTH                       26600000
*IS10066 XR    R15,R15                 PAD WITH X'00'                   26610000
*IS10066 MVCL  R0,R14                  CLEAR                            26620000
*                                                                       26630000
         RACROUTE REQUEST=VERIFY,                               IS10066X26640000
               ENVIR=DELETE,           DELETE THE ACEE          IS10066X26650000
               MF=(E,ACEEDELL)                                  IS10066 26660000
*                                                                       26670000
**    SET DELETE RETURN CODE                                            26680000
*                                                                       26690000
         LM    R2,R3,ACEEDELL          LOADING RACF RETURN CODES S10066 26700000
         L     R4,PRMDOUT              R4 POINTS TO MACRO RC OUT PARM   26710000
         ST    R15,0(,R4)              STORING R15 IN MACRO RC PARM     26720000
         L     R4,PRMDRC               R4 POINTS TO SAF RETURN CODE     26730000
         ST    R2,0(,R4)               STORING R2 IN SAF RETURN CODE    26740000
         L     R4,PRMDRS               R4 POINTS TO SAF REASON CODE     26750000
         ST    R3,0(,R4)               STORING R2 IN SAF REASON CODE    26760000
         CTSADBG LEVEL=(DBGLEVEL,1),                                   X26770000
               'CODES FOR DELETE RC=# RACF RC=#, RS=#',                X26780000
               (?R15,?R2,?R3),                                         X26790000
               RAREA=RAREA,DBGAREA=DBGAREA                      IS10066 26800000
         B     VLEND                                            IS10066 26810000
*                                                               IS10066 26820000
**  SET ACF2 RETURN CODES.                                      IS10066 26830000
*                                                               IS10066 26840000
*BS10088 VLAPNE  DS    0H          PASSWORDS NOT EQUAL:         IS10066 26850000
*BS10088 LA    R1,RCAPNE           SAF RC = 8, ACF2: RC = 8, RS = 0. 66 26860000
*BS10088 BRAS  R14,SETRCS                                       IS10066 26870000
*BS10088 B     VLEND                                            IS10066 26880000
*BS10088 VLANOUSR DS   0H          USER DOES NOT EXIST:         IS10066 26890000
*BS10088 LA    R1,RCANOU           SAF RC = 8, ACF2: RC = 4, RS = 0. 66 26900000
*BS10088 BRAS  R14,SETRCS                                       IS10066 26910000
*                                                                       26920000
VLEND    DS    0H                                               IS10066 26930000
         BRTRN (15)                RETURN TO CALLER            IS10147A 26940000
*IS10147AB     EXIT                                                     26950000
         DROP  ,                                               IS10147A 26960000
*****************************************************************       26970000
*                                                               *       26980000
*        HANDLERC                                               *       26990000
*                                                               *       27000000
*  SAVE RETURN CODES IN CALLER PARMS AND PRODUCE A THE DEBUG    *       27010000
*  MESSAGE,                                                     *       27020000
*                                                               *       27030000
*  INPUT:                                                       *       27040000
*  R0 -> ACTION.                                                *       27050000
*  R1 -> RACROUTE RC + RS                                       *       27060000
*  R10 -> CALLER PARMS.                                         *       27070000
*  R11 -> CONST.                                                *       27080000
*  R13 -> CALLER SAVE AREA.                                     *       27090000
*  R14 = RETURN ADDRESS.                                        *       27100000
*  R15 = RETURN CODE.                                           *       27110000
*                                                               *       27120000
*  ATTENTION:                                                   *       27130000
*  THIS ROUTINE DOES NOT SAVE REGISTERS EXCEPT 9 AND 14.        *       27140000
*  CARE SHOULD BE TAKEN WHEN CALLING OTHER ROUTINES THAT SAVE   *       27150000
*  THESE REGISTERS ONLY.                                        *       27160000
*                                                               *       27170000
*****************************************************************       27180000
HANDLERC DS    0H                                               IS10066 27190000
*IS10147AUSING CONST,R11                                        IS10066 27200000
         USING CONST,R11,R12                                   IS10147A 27210000
         USING PRM,R10                                          IS10066 27220000
*IS10147AST    R12,SAR12           SAVE...                      IS10066 27230000
         ST    R9,SAR9             SAVE...                     IS10147A 27240000
         ST    R14,SAR14           ...REGISTERS.                IS10066 27250000
*                                                               IS10066 27260000
*IS10147ABASR  R12,0               SET BASE.                    IS10066 27270000
*IS10147AUSING *,R12                                            IS10066 27280000
         BASR  R9,0                SET BASE.                   IS10147A 27290000
         USING *,R9                                            IS10147A 27300000
*                                                               IS10066 27310000
         LR    R14,R0              R14 -> ACTION NAME.          IS10066 27320000
         MVC   ACTION,0(R14)       SAVE ACTION                  IS10066 27330000
*                                                               IS10066 27340000
         L     R14,PRMCOUT         R14 -> AREA FOR RETURN CODE. IS10066 27350000
         ST    R15,0(,R14)         SAVE RETURN CODE.            IS10066 27360000
*                                                               IS10066 27370000
         LR    R14,R1              R14 -> RSS RC + RS.          IS10066 27380000
         LM    R0,R1,0(R14)        GET RSS RC AND RS.           IS10066 27390000
         L     R14,PRMCRC          R14 -> AREA FOR RSS RC.      IS10066 27400000
         ST    R0,0(,R14)          SAVE SAF RETURN CODE         IS10066 27410000
         L     R14,PRMCRS          R14 -> AREA FOR RSS RS.      IS10066 27420000
         ST    R1,0(,R14)          SAVE SAF REASON CODE         IS10066 27430000
*                                                               IS10066 27440000
         LR    R14,R1              R14 = RSS RS.                IS10066 27450000
         CTSADBG LEVEL=(DBGLEVEL,1),                            IS10066X27460000
               'RACROUTE _: R15=# RSS-RC=# RSS-RS=#',           IS10066X27470000
               (ACTION,8,?R15,?R0,?R14),                        IS10066X27480000
               RAREA=RAREA,DBGAREA=DBGAREA                      IS10066 27490000
*                                                               IS10066 27500000
*IS10147AL     R12,SAR12           RESTORE...                   IS10066 27510000
         L     R9,SAR9             RESTORE...                  IS10147A 27520000
         L     R14,SAR14            ...REGISTERS.               IS10066 27530000
         BR    R14                 RETURN                       IS10066 27540000
         DROP  ,                                                IS10066 27550000
*****************************************************************       27560000
*                                                               *       27570000
*                         CHKPEXP                               *       27580000
*                         -------                               *       27590000
*                                                               *       27600000
*  CHECK IF PASSWORD EXPIRED:                                   *       27610000
*  PASSWORD DATE + PASSWORD INTERVAL =< TODAY DATE.             *       27620000
*                                                               *       27630000
*  INPUT:                                                       *       27640000
*  R1 -> PASSWORD EXPIRATION FIELDS.                            *       27650000
*  R13 -> CALLER SAVE AREA.                                     *       27660000
*  R14 = RETURN ADDRESS.                                        *       27670000
*                                                               *       27680000
*  RETURN CODES:                                                *       27690000
*  0 - PASSWORD OK.                                             *       27700000
*  4 - PASSWORD EXPIRED.                                        *       27710000
*                                                               *       27720000
*  ATTENTION:                                                   *       27730000
*  THIS ROUTINE DOES NOT SAVE REGISTERS EXCEPT 9 AND 14.        *       27740000
*  CARE SHOULD BE TAKEN WHEN CALLING OTHER ROUTINES THAT SAVE   *       27750000
*  THESE REGISTERS ONLY.                                        *       27760000
*                                                               *       27770000
*****************************************************************       27780000
CHKPEXP  DS    0H                                               IS10066 27790000
*IS10147AUSING CONST,R11                                        IS10066 27800000
         USING CONST,R11,R12                                   IS10147A 27810000
*IS10147AST    R12,SAR12           SAVE RETURN ADDRESS.         IS10066 27820000
         ST    R9,SAR9             SAVE RETURN ADDRESS.        IS10147A 27830000
         ST    R14,SAR14           SAVE RETURN ADDRESS.         IS10066 27840000
*IS10147ABASR  R12,0                                            IS10066 27850000
*IS10147AUSING *,R12                                            IS10066 27860000
         BASR  R9,0                                            IS10147A 27870000
         USING *,R9                                            IS10147A 27880000
         USING PSDATFLD,R1                                      IS10066 27890000
*                                                               IS10066 27900000
**   CALCULATE PASSWORD EXPIRATION DATE AND COMPARE WITH TODAY  IS10066 27910000
*                                                               IS10066 27920000
         XC    WA,WA                                            IS10066 27930000
         MVC   WA+6(2),PDPASDAT+2  WA+5 = DDDF OF PASSWORD      IS10066 27940000
*                                  DATE.                        IS10066 27950000
         CVB   R0,WA               R0 = DDD IN HEX.             IS10066 27960000
         AH    R0,PDPASINT         R0 = DDD + INTERVAL.         IS10066 27970000
*                                                               IS10066 27980000
**   CHECK IF DDD OF PASWORD EXPIRATION DATE PASSES YEAR END.   IS10066 27990000
*                                                               IS10066 28000000
         XC    WA,WA                                            IS10066 28010000
         MVO   WA+6(2),PDPASDAT(2) WA+6 = CYY0                  IS10066 28020000
         OI    WA+7,X'0F'          WA+6 = CYYF (0YYF / 1YYF)    IS10066 28030000
         CVB   R15,WA              R15 = CYY OF PASSWORD DATE (HEX) 066 28040000
         LR    R14,R15                                          IS10066 28050000
         SRA   R14,2               DIVIDE BY 4...               IS10066 28060000
         SLA   R14,2               ...AND MULTIPLY BY 4         IS10066 28070000
         CR    R14,R15             CYY IS DIVISIBLE BY 4 ?      IS10066 28080000
         BE    CPELEAPY            ..YES - ITS A LEAP YEAR.     IS10066 28090000
         LA    R14,365             NUMBER OF DAYS IN YEAR.      IS10066 28100000
         B     CPECHYE                                          IS10066 28110000
CPELEAPY DS    0H                                               IS10066 28120000
         LHI   R14,366             NUMBER OF DAYS IN A LEAP YEAR. 10066 28130000
CPECHYE  DS    0H                  CHECK IF AFTER YEAR END.     IS10066 28140000
         CR    R0,R14              YEAR CHANGED ?               IS10066 28150000
         BNH   CPEPREPD            ..NO - COMPARE DATES.        IS10066 28160000
         AHI   R15,1               ..YES - R15 = CYY+1.         IS10066 28170000
         SR    R0,R14              R0 - DDD IN CYY+1.           IS10066 28180000
*                                                               IS10066 28190000
**   CONVERT PASSWORD EXPIRATION DATE TO 0CYYDDDF               IS10066 28200000
**                                                              IS10066 28210000
**   R0 = DDD                                                   IS10066 28220000
**   R15 = 0CYY                                                 IS10066 28230000
*                                                               IS10066 28240000
CPEPREPD DS    0H                                               IS10066 28250000
         CVD   R0,WA               WA+6 = DDDC                  IS10066 28260000
         LHI   R14,0                                            IS10066 28270000
         ICM   R14,B'0011',WA+6    R14 = 0000DDDC               IS10066 28280000
         OILL  R14,X'000F'                                      IS10066 28290000
*                                                               IS10066 28300000
         CVD   R15,WA              WA+6 = CYYF                  IS10066 28310000
         LHI   R15,0                                            IS10066 28320000
         ICM   R15,B'0111',WA+5    R15 = 0000CYYF               IS10066 28330000
         SRL   R15,4               R15 = 00000CYY               IS10066 28340000
         SLL   R15,16              R15 = 0CYY0000               IS10066 28350000
         OR    R15,R14             R15 = 0CYYDDDF               IS10066 28360000
         CL    R15,TODAYDAY        PASSWORD EXPIRATION DATE > TODAY ?66 28370000
         BNH   CPEEXP              ..NO - PASSWORD EXPIRED.     IS10066 28380000
*                                  ..YES - PASSWORD OK.         IS10066 28390000
         MVI   PDPSEXPF,0          SET 'PASSWORD NOT EXPIRED'.  IS10066 28400000
         LHI   R15,0               SET 'NOT EXPIRED' RETURN CODE. 10066 28410000
         B     CPEEND                                           IS10066 28420000
CPEEXP   DS    0H                                               IS10066 28430000
         MVI   PDPSEXPF,PDPSEXP    SET 'PASSWORD EXPIRED'.      IS10066 28440000
         LHI   R15,4               SET 'EXPIRED' RETURN CODE.   IS10066 28450000
         B     CPEEND                                           IS10066 28460000
CPEEND   DS    0H                                               IS10066 28470000
         L     R14,SAR14           RESTORE...                   IS10066 28480000
*IS10147AL     R12,SAR12             ...REGISTERS.              IS10066 28490000
         L     R9,SAR9               ...REGISTERS.             IS10147A 28500000
         BR    R14                 RETURN.                      IS10066 28510000
         DROP  ,                                                IS10066 28520000
*****************************************************************       28530000
*                                                               *       28540000
*                         HEX2CHAR                              *       28550000
*                         --------                              *       28560000
*                                                               *       28570000
*  TRANSLATE HEX TO CHARACTER                                   *       28580000
*                                                               *       28590000
*  INPUT:                                                       *       28600000
*  R1 = VALUE TO TRANSLATE.                                     *       28610000
*  R14 = RETURN ADDRESS.                                        *       28620000
*                                                               *       28630000
*  ATTENTION:                                                   *       28640000
*  THIS ROUTINE DOES NOT SAVE REGISTERS AND DOES NOT SET A      *       28650000
*  BASE REGISTER.                                               *       28660000
*                                                               *       28670000
*****************************************************************       28680000
HEX2CHAR DS    0H                                               IS10066 28690000
*IS10147AUSING CONST,R11                                        IS10066 28700000
         USING CONST,R11,R12                                   IS10147A 28710000
*                                                                       28720000
         ST    R1,WA               SAVE CONTENT OF REG 15               28730000
         UNPK  H2COUT(9),WA(5)     UNPACK IT + 1                        28740000
         NC    H2COUT(8),XL80F     REMOVE LEFT PART OF BYTES            28750000
         TR    H2COUT(8),TRAN      MAKE BYTES READABLE                  28760000
*                                                                       28770000
         BR    R14                 RETURN                               28780000
         DROP  ,                                                        28790000
*****************************************************************       28800000
*                                                               *       28810000
*                         SETRCS                                *       28820000
*                         ------                                *       28830000
*                                                               *       28840000
*  SET RETURN CODES IN CALLER PARAMETERS.                       *       28850000
*                                                               *       28860000
*  INPUT:                                                       *       28870000
*  R1 -> REQUIRED RETURN AND REASON CODES.                      *       28880000
*  R10 -> CALLER PARAMETERS.                                    *       28890000
*  R11 -> CONST.                                                *       28900000
*  R14 = RETURN ADDRESS.                                        *       28910000
*                                                               *       28920000
*  ATTENTION:                                                   *       28930000
*  THIS ROUTINE DOES NOT SAVE REGISTERS EXCEPT 14,12.           *       28940000
*  CARE SHOULD BE TAKEN WHEN CALLING OTHER ROUTINES THAT SAVE   *       28950000
*  THESE REGISTERS ONLY.                                        *       28960000
*                                                               *       28970000
*****************************************************************       28980000
SETRCS   DS    0H                                               IS10066 28990000
*IS10147AUSING CONST,R11                                        IS10066 29000000
         USING CONST,R11,R12                                   IS10147A 29010000
         USING PRM,R10                                          IS10066 29020000
*                                                               IS10066 29030000
         L     R15,PRMCOUT         R15 -> AREA FOR RETURN CODE. IS10066 29040000
         MVC   0(4,R15),0(R1)      SAVE RETURN CODE.            IS10066 29050000
*                                                               IS10066 29060000
         L     R15,PRMCRC          R15 -> AREA FOR RSS RC.      IS10066 29070000
         MVC   0(4,R15),4(R1)      SAVE RETURN CODE.            IS10066 29080000
*                                                               IS10066 29090000
         L     R15,PRMCRS          R15 -> AREA FOR RSS RS.      IS10066 29100000
         MVC   0(4,R15),8(R1)      SAVE REASON CODE.            IS10066 29110000
*                                                               IS10066 29120000
         BR    R14                                              IS10066 29130000
         DROP  ,                                                IS10066 29140000
*                                                                       29150000
*---------------------------------------------------------------*       29160000
*        CONSTANTS                                                      29170000
*---------------------------------------------------------------*       29180000
CONST    DS    0D                                                       29190000
         LTORG ,                                                IS10066 29200000
*                                                                       29210000
*IS10147ABLANKS8 DC CL8' '                                              29220000
BLANKS   DC    CL100' '                BLANK CONSTANT AREA     IS10147A 29230000
*                                      (USED TO BE BLANKS8 BUT IS10147A 29240000
*                                      NOW NEED 100 CHARS TO   IS10147A 29250000
*                                      HANDLE PASSWORD PHRASE) IS10147A 29260000
*IS10147AXL8FF DC 8X'FF'                                                29270000
ALLFF    DC    100X'FF'                                        IS10147A 29280000
XL80F    DC    8X'0F'                                           IS10066 29290000
*                                                                       29300000
RSSTYPES DS    0X                                                       29310000
RACF     DC    CL4'RACF'                                                29320000
ACF2     DC    CL4'ACF2'                                                29330000
TSS      DC    CL4'TSS'                                                 29340000
*                                                                       29350000
LOW2UPR  DC    256AL1(*-LOW2UPR)       TRANSLATE TABLE TO UPPERCASE     29360000
         ORG   LOW2UPR                                                  29370000
         DC    64C'*'                                                   29380000
         ORG   LOW2UPR+C'A'-X'40'                                       29390000
         DC    C'ABCDEFGHI'                                             29400000
         ORG   LOW2UPR+C'J'-X'40'                                       29410000
         DC    C'JKLMNOPQR'                                             29420000
         ORG   LOW2UPR+C'S'-X'40'                                       29430000
         DC    C'STUVWXYZ'                                              29440000
         ORG   ,                                                        29450000
*                                                                       29460000
TRAN     DC      CL16'0123456789ABCDEF'                         IS10066 29470000
*                                                               IS10066 29480000
**  SAM COMMAND TABLE TO BE USED TO RESTORE THE CALLER AMODE.   IS10066 29490000
**  THE APPROPRIATE COMMAND IS EXECUTED ACCORDING TO THE RC     IS10066 29500000
**  RECEIVED AS A RESULT OF THE TAM COMMAND PERFORMED AT THE    IS10066 29510000
**  BEGINING OF THE PROGRAM.                                    IS10066 29520000
*IS10188                                                        IS10066 29530000
*IS10188 AMDCMDTB DS    0H              FORCE COMMAND ALIGNMENT.IS10066
*IS10188 AMODE24  SAM24                       TAM RC = 0        IS10066
*IS10188 AMODECEL EQU   L'AMODE24                               IS10066
*IS10188 AMODE31  SAM31                       TAM RC = 1        IS10066
*IS10188          DS    XL(AMODECEL)'00' NO TAM RC.             IS10066
*IS10188 AMODE64  SAM64                       TAM RC = 3        IS10066
*IS10188 AMODECME EQU   *                                       IS10066
*                                                                       29610000
#CREATE  DC    CL8'CREATE'                                      IS10066 29620000
#EXTRACT DC    CL8'EXTRACT'                                     IS10066 29630000
#ENCRYPT DC    CL8'ENCRYPT'                                     IS10066 29640000
*                                                                       29650000
ZOSV17   DC    CL4'7720'          RACF ZOS VERSION 1.7          WS2557  29660000
*                                                                       29670000
RCOK     DC    A(0),A(0),A(0)      PASSWORDS MATCH (ALL TYPES). IS10066 29680000
RCINTERR DC    A(99),A(99),A(99)   ERROR DURING PROCESSING.     IS10066 29690000
RCRNOU   DC    A(4),A(4),A(0)      RACF - USER DOES NOT EXIST.  IS10066 29700000
RCRUREV  DC    A(8),A(28),A(0)     RACF - USER IS REVOKED.      IS10066 29710000
RCRGREV  DC    A(8),A(36),A(0)     RACF - DEF. CONNECT. IS REVOKED. 066 29720000
RCRPEXP  DC    A(8),A(12),A(0)     RACF - PASSWORD EXPIRED.     IS10066 29730000
RCRPNE   DC    A(8),A(8),A(0)      RACF - PASSWORD NOT EQUAL.   IS10066 29740000
RCANOU   DC    A(8),A(4),A(0)      ACF2 - USER DOES NOT EXIST.  IS10066 29750000
RCAUNA   DC    A(8),A(28),A(0)     ACF2 - USER IS NOT ACTIVE.   IS10066 29760000
RCAPEXP  DC    A(8),A(12),A(0)     ACF2 - PASSWORD EXPIRED.     IS10066 29770000
RCAPNE   DC    A(8),A(8),A(0)      ACF2 - PASSWORD NOT EQUAL.   IS10066 29780000
*                                                               IS10066 29790000
**  FIELDS LIST FOR ACFSVC, WHEN EXTRACT IS USED                IS10066 29800000
*                                                               IS10066 29810000
ACFSVCFL CRFLST PSWD-XTR,                                       IS10066X29820000
               PSWD-EXP,       PASSWORD HAS BEEN EXPIRED        IS10066X29830000
               PSWD-TOD,       PASSWORD CHANGE DATE/TIME        IS10066X29840000
               MAXDAYS,        PASSWORD INTERVAL                IS10066X29850000
               LIDZMAX,        MAXDAYS=0 IS 0.                  IS10066X29860000
               LIDTEMP,        PASSWORD IN TEMPORARY            IS10066X29870000
               SUSPEND,        USER IS SUSPENDED                IS10066X29880000
               CANCEL,         USER IS CANCELLED (SUSPENDED)    IS10066X29890000
               PSWD-VIO,       # OF PW VIOLATIONS SINCE LAST ACC S10066X29900000
               PWP-VIO,        # OF PWP VIOLATIONS SINCE LAST "IS10147AX29910000
               EXPIRE,         EXPIRARION DATE                  IS10066X29920000
               ACTIVE,         ACTIVE DATE                      IS10066X29930000
               LSTALGN=A,      LIST ALIGNMENT                   IS10066X29940000
               ENTLEN=8,       ENTRY LENGTH.                    IS10066X29950000
               CRERTNA=YES,    CREATE ROUTINE ADDRESSES.        IS10066X29960000
               CRECNTA=YES,    CREATE COUNT FIELD AFTER NAMES.  IS10066X29970000
               CNTLEN=4,       COUNT FIELD LENGTH.              IS10066X29980000
               RTNPFX=DAP      ROUTINE NAMES PREFIX.            IS10066 29990000
*BS10088
*BS10088                                                        IS10066 30000000
*BS10088 FIELDS LIST FOR ACFSVC WHEN LOGON IS USED              IS10066 30010000
*BS10088                                                        IS10066 30020000
*BS10088 ACFSVCLF CRFLST PSWD-TOD,   PASSWORD CHANGE DATE/TIME IS10066X 30030000
*BS10088       LSTALGN=A,      LIST ALIGNMENT                  IS10066X 30040000
*BS10088       ENTLEN=8,       ENTRY LENGTH.                   IS10066X 30050000
*BS10088       CRERTNA=YES,    CREATE ROUTINE ADDRESSES.       IS10066X 30060000
*BS10088       CRECNTA=YES,    CREATE COUNT FIELD AFTER NAMES. IS10066X 30070000
*BS10088       CNTLEN=4,       COUNT FIELD LENGTH.             IS10066X 30080000
*BS10088       RTNPFX=DAP      ROUTINE NAMES PREFIX.            IS10066 30090000
*                                                               IS10066 30100000
**  FIELDS LIST FOR RACROUTE EXTRACT - RACF                     IS10066 30110000
**                                                                      30120000
**  THE ORDER OF THE OUTPUT IS THE SAME AS THE ORDER OF THE     IS10066 30130000
**  FIELDS IN THE RACROUTE REQUEST. THERFORE,                   IS10066 30140000
**  1. FIELD CGGRPCT SHOULD BE THE FIRST OF ALL CG... FIELDS.   IS10066 30150000
**  2. FIELD CGGRPNM SHOULD BE THE SECOND OF ALL CG... FIELDS.  IS10066 30160000
**  THE DATA RETRIEVED FROM THESE FIELDS IS USED TO ANALYZE     IS10066 30170000
**  THE OTHER CG... FIELDS.                                     IS10066 30180000
**                                                              IS10066 30190000
*                                                               IS10066 30200000
RACRXFLD CRFLST PASSWORD,      PASSWORD                         IS10066X30210000
               PASSDATE,       PASSWORD DATE                    IS10066X30220000
               PHRASE,         PASSWORD PHRASE                 IS10147AX30230000
               PHRDATE,        PASSWORD DATE                   IS10147AX30240000
               PASSINT,        PASSWORD INTERVAL                IS10066X30250000
               PASSASIS,       PASSWORD UPPER / ASIS            IS10107X30260000
               REVOKEDT,       REVOKE DATE                      IS10066X30270000
               RESUMEDT,       RESUME DATE                      IS10066X30280000
               FLAG4,          REVOKED FLAG.                    IS10066X30290000
               CGGRPCT,        NUMBER OF GROUP CONNECTIONS.     IS10066X30300000
               CGGRPNM,        GROUP NAMES                      IS10066X30310000
               CGFLAG4,        REVOKED CONNECTIONS.             IS10066X30320000
               CGREVKDT,       CONNECTION REVOKE DATES          IS10066X30330000
               CGRESMDT,       CONNECTION RESUME DATES          IS10066X30340000
               LSTALGN=A,      LIST ALIGNMENT.                  IS10066X30350000
               ENTLEN=8,       ENTRY LENGTH.                    IS10066X30360000
               CRECNTB=YES,    CREATE COUNT AT THE BEGINNING.   IS10066X30370000
               CNTLEN=4,       COUNT LENGTH.                    IS10066X30380000
               CRERTNA=YES,    CREATE ROUTINE ADDRESSES.        IS10066X30390000
               RTNPFX=DXP      ROUTINE NAMES PREFIX.            IS10066 30400000
*                                                               IS10066 30410000
**  FIELDS LIST FOR RACROUTE EXTRACT - ACF2                     IS10066 30420000
*                                                               IS10066 30430000
ACFRXFLD CRFLST PASSWORD,                                       IS10066X30440000
               LSTALGN=A,      LIST ALIGNMENT.                  IS10066X30450000
               ENTLEN=8,       ENTRY LENGTH.                    IS10066X30460000
               CRECNTB=YES,    CREATE COUNT AT THE BEGINNING.   IS10066X30470000
               CNTLEN=4,       COUNT LENGTH.                    IS10066X30480000
               CRERTNA=YES,    CREATE ROUTINE ADDRESSES.        IS10066X30490000
               RTNPFX=DXP      ROUTINE NAMES PREFIX.            IS10066 30500000
*CFRXFLP CRFLST PWPHRASE,      PASSWORD PHRASE                IS10147AX 30510000
ACFRXFLP CRFLST   PHRASE,      PASSWORD PHRASE                 IS10147AX30520000
               LSTALGN=A,      LIST ALIGNMENT.                  IS10066X30530000
               ENTLEN=8,       ENTRY LENGTH.                    IS10066X30540000
               CRECNTB=YES,    CREATE COUNT AT THE BEGINNING.   IS10066X30550000
               CNTLEN=4,       COUNT LENGTH.                    IS10066X30560000
               CRERTNA=YES,    CREATE ROUTINE ADDRESSES.        IS10066X30570000
               RTNPFX=DXP      ROUTINE NAMES PREFIX.            IS10066 30580000
*                                                               IL10066 30590000
**  RACROUTE LIST FOR - USED FOR ADDRESSABILITY REASONS.        IL10066 30600000
*                                                               IL10066 30610000
ACEECREL RACROUTE REQUEST=VERIFY,                               IS10066X30620000
               ENVIR=CREATE,           CREATE AN ACEE           IS10066X30630000
               STAT=NO,                NO STATISTICS            IS10066X30640000
               USERID=USERALL,         USERID                   IS10066X30650000
               PASSWRD=PASSALL,        PASSWORD                 IS10066X30660000
               WORKA=RAREA,            RACROUTE WORK AREA       IS10066X30670000
               ACEE=ACEEADDR,          AREA FOR ACEE ADDRESS.   IS10066X30680000
               MF=L                                             IS10066 30690000
*                                                               IS10066 30700000
ACEECREM RACROUTE REQUEST=VERIFY,                              IS10147AX30710000
               ENVIR=CREATE,           CREATE AN ACEE          IS10147AX30720000
               STAT=NO,                NO STATISTICS           IS10147AX30730000
               USERID=USERALL,         USERID                  IS10147AX30740000
               PHRASE=PASSALL,         PASSWORD PHRASE         IS10147AX30750000
               WORKA=RAREA,            RACROUTE WORK AREA      IS10147AX30760000
               ACEE=ACEEADDR,          AREA FOR ACEE ADDRESS.  IS10147AX30770000
               RELEASE=7730,           MINIMUM RELEASE REQUIREDIS10147AX30780000
               MF=L                                            IS10147A 30790000
*                                                               IS10066 30800000
ACEEDELL RACROUTE REQUEST=VERIFY,                               IS10066X30810000
               ENVIR=DELETE,           DELETE AN ACEE           IS10066X30820000
               STAT=NO,                NO STATISTICS            IS10066X30830000
               LOG=ASIS,               NO LOG                   IS10066X30840000
               RELEASE=1.8,                                     IS10066X30850000
               WORKA=RAREA,            RACROUTE WORK AREA       IS10066X30860000
               ACEE=ACEEADDR,          ADDRESS OF ACEE TO DELETE S10066X30870000
               MF=L                                             IS10066 30880000
*                                                               IS10066 30890000
EXTRACTL RACROUTE REQUEST=EXTRACT,TYPE=EXTRACT,                 IS10066X30900000
               CLASS='USER',           EXTRACT A USER PROFILE   IS10066X30910000
               RELEASE=1.8,            RELEASE NUMBER           IS10066X30920000
               ENTITY=USERID,          REQUESTED UID            IS10066X30930000
               WORKA=RAREA,            WORKAREA                 IS10066X30940000
               MF=L                                             IS10066 30950000
*BS10104 REMOVING THIS MACRO LIST BECAUSE NOT NEEDED.
*EXTRACTP RACROUTE REQUEST=EXTRACT,TYPE=EXTRACT,               IS10066X 30960000
*BS10104        CLASS='USER',           EXTRACT A USER PROFILE IS10066X 30970000
*BS10104        RELEASE=1.8,            RELEASE NUMBER         IS10066X 30980000
*BS10104        ENTITY=USERID,          REQUESTED UID          IS10066X 30990000
*BS10104        WORKA=RAREA,            WORKAREA               IS10066X 31000000
*BS10104        MF=L                                           IS10066  31010000
*ACF2    SEGMENT='PWPHRASE',     ...FROM SEGMENT PWPHRASE IS10147AX     31020000
*                                                               IS10066 31030000
ENCRYPTL RACROUTE REQUEST=EXTRACT,TYPE=ENCRYPT,                 IS10066X31040000
               ENCRYPT=(PASSALL,INST), ENCRYPTION KEY           IS10066X31050000
               ENTITY=USERID,          DATA TO ENCRYPT          IS10066X31060000
               WORKA=RAREA,            WORKAREA                 IS10066X31070000
               MF=L                                             IS10066 31080000
*                                                                       31090000
*---------------------------------------------------------------*       31100000
*        WORKAREA                                                       31110000
*---------------------------------------------------------------*       31120000
AMODE    DS    A               ENTRY AMODE                              31130000
DBGLEVEL DS    X                                                        31140000
RSSTYPE  DS    CL4                                          WS2460      31150000
RCFLWCS  DC    X'0'               RACF LOWER CASE FLAG          WS2557  31160000
ACCVTADR DS    A                   -> ACF2 ACCVT.               IS10066 31170000
*                                                                       31180000
USERALGN DS    0F                                           WS2460      31190000
         DS    XL3                                          WS2460      31200000
USERALL  DS    0XL9                                                     31210000
USERL    DS    XL1                                                      31220000
USERID   DS    CL8                                                      31230000
*                                                                       31240000
PASSALGN DS    0F                                           WS2460      31250000
         DS    XL3                                          WS2460      31260000
*IS10147APASSALL DS 0XL9                                                31270000
PASSALL  DS    0XL101                                          IS10147A 31280000
PASSL    DS    XL1                                                      31290000
*IS10147APASSWORD DS   CL8                                              31300000
PASSWORD DS    CL100              PASSWORD AREA                IS10147A 31310000
*                                 (USED TO BE CL8 BUT NEEDED   IS10147A 31320000
*                                 100 CHARACTERS TO HANDLE     IS10147A 31330000
*                                 PASSWORD PHRASE)             IS10147A 31340000
PRNTPSWD DC    CL8'********'      FOR PRINTING IN DIAG         IS10183  31300000
DMYPSWD  DC    XL4'FFFFFFFF'      DUMMY PASSWORD               IS10147A 31350000
PSWDPHRL EQU   9                  MIN LEN OF PASSWORD PHRASE   IS10147A 31360000
PSWPHFLG DS    C                  PASSWORD OR PASSWORD PHRASE  IS10147A 31370000
PSWD     EQU   C'P'               PASSWORD FLAG                IS10147A 31380000
PSWDPHRS EQU   C'F'               PASSWORD PHRASE FLAG         IS10147A 31390000
*                                                                       31400000
*IS10147ARSSPSWD DS CL8                                          WS2460 31410000
         DS    0F                                              IS10147A 31420000
RSSPSWD  DS    CL100                                    WS2460 IS10147A 31430000
RSSPSWDL DS    F                  PASSWORD (PHRASE) LENGTH     IS10147A 31440000
*                                                                       31450000
*BS2558 RAREA    DS    XL512                                            31460000
*                                                                       31470000
SVCMSG   DS    CL128              ACF2 MSG WHEN ERROR           IS0041  31480000
ACEEADDR DS    A                                                IS10066 31490000
PACKD    DS    D                  PACKED DEC FOR CONVERSION     IS0041  31500000
CHARRC   DS    CL8                CHAR RC FOR MSG               IS0041  31510000
XTRADDR  DC    A(0)                -> EXTRACT OUTPUT AREA.      IS10066 31520000
XTRADDRE DC    A(0)                -> END OF EXTRACT AREA.      IS10066 31530000
*                                                                       31540000
TODAYDAY DS    A                   TODAY DATE. (0CYYDDDF)       IS10066 31550000
*                                                                       31560000
WRSST    DS    X                  RSS TYPE IND.                 WS10051 31570000
WRACFI   EQU   C'R'               RACF TYPE IND.                WS10051 31580000
WACF2I   EQU   C'A'               ACF2 TYPE IND.                WS10051 31590000
WTSSI    EQU   C'T'               TSS  TYPE IND.                WS10051 31600000
WPALG    DS    XL1                KDFAES IND FROM RCVTPALG      WS10051 31610000
PRMALET  DC    F'0'               PARMS ALET                    WS10051 31640000
SAFCALET DC    F'0'               SAF RC ALET                   WS10051 31650000
RCFCALET DC    F'0'               RACF RC ALET                  WS10051 31660000
RCFSALET DC    F'0'               RACF RS ALET                  WS10051 31670000
SPWSAFRC DC    F'0'               SAF RC FOR IRRSPW00           WS10051 31680000
SPWRCFRC DC    F'0'               RACF RC FOR IRRSPW00          WS10051 31690000
SPWRCFRS DC    F'0'               RACF REASON CODE FOR IRRSPW00 WS10051 31700000
SPWNUMP  DC    F'15'              IRRSPW00 PARMS NUMBER         WS10051 31710000
SPWFNCTN DC    XL2'0001'          IRRSPW00 FUNCTION CODE        WS10051 31720000
SPWUSERL DC    F'0'               IRRSPW00 USERID LENGTH        WS10051 31730000
SPWUSER  DC    CL8' '             IRRSPW00 USERID               WS10051 31740000
SPWPASSL DC    F'0'               IRRSPW00 PASSWORD LENGTH      WS10051 31750000
*IS10147ASPWPASS DC CL8' '        IRRSPW00 PASSWORD             WS10051 31760000
SPWPASS  DC    CL100' '           IRRSPW00 PASSWORD    WS10051 IS10147A 31770000
SPWFNCPL DC    XL4'0'             IRRSPW00 FUNCTION PARM-LIST   WS10051
SPWADDR  DC    A(0)               IRRSPW00 FUNCTION PARM-LIST   WS10051 31800000
WAVPSNM  DC    CL8' '             CURRENT MODULE 2 B SET BY     WS10051 31810000
*IS10147ATEMPPSWD DC CL8' '       ENCRYPTED PSWD FOR DIAGS      WS10051 31820000
TEMPPSWD DC    CL100' '           ENCRYPTED PSWD FOR DIAGS     IS10147A 31830000
*                                 CSVQUERY                      WS10051 31840000
IRRSPW00 DC    CL8'IRRSPW00'      MODULE NAME TO BE LOADED      WS10051 31850000
         ACALT DSECT=NO                                         IS0041  31870000
*                                                               IS10066 31880000
**   FIELDS SET ACCORDING TO EXTRACT OUTPUT.                    IS10066 31890000
**   SEE EQUATES BELOW FOR FLAGS MEANING.                       IS10066 31900000
*                                                               IS10066 31910000
XTCFUFLG DS    0F                  RACF USER FLAGS              IS10066 31920000
XTDFLTGR DS    CL8                 DEFAULT GROUP NAME.          IS10066 31930000
*                                                               IS10066 31940000
XTPSDTFL CREPSDTF DSECT=NO,PREFIX=XT PASSWORD EXPIRATION FIELDS. S10066 31950000
XTPASSMX DS    X                   MIXED-CASE PASSWORD.         IS10107 31960000
*                                                               IS10066 31970000
XTGRP#   DS    A                   GROUPS NUMBER.               IS10066 31980000
XTDFLTG# DS    A                   DEFAULT GROUP NUMBER         IS10066 31990000
XTURVKFL DS    X                   REVOKED FLAG (FROM EXTRACT)  IS10066 32000000
XTGRVKFL DS    X                   GROUP REVOKED FLAG (FROM EXTRACT) 66 32010000
*                                                               IS10066 32020000
XTRVDATF DS    X                   REVOKE DATE FLAGS.           IS10066 32030000
XTRSDATF DS    X                   RESUME DATE FLAGS.           IS10066 32040000
XTGVDATF DS    X                   GROUP REVOKE DATE FLAGS.     IS10066 32050000
XTGSDATF DS    X                   GROUP RESUME DATA FLAGS.     IS10066 32060000
*                                                               IS10066 32070000
XTCFUFLL EQU   *-XTCFUFLG          USER FLAGS LENGTH.           IS10066 32080000
*                                                               IS10066 32090000
**   FIELDS SET ACCORDING TO ACF2 SVC OUTPUT.                   IS10066 32100000
**   SEE EQUATES BELOW FOR FLAGS MEANING.                       IS10066 32110000
*                                                               IS10066 32120000
ACF2UFLG DS    0F                  RACF USER FLAGS              IS10066 32130000
*                                                               IS10066 32140000
ACPSDTFL CREPSDTF DSECT=NO,PREFIX=AC PASSWORD EXPIRATION FIELDS. S10066 32150000
*                                                               IS10066 32160000
ACPXTRFL DS    X                   PSWD-XTR FLAG:               IS10066 32170000
ACPXTRFA EQU   X'FF'               - PASSWORD EXTRACT ALLOWED.  IS10066 32180000
*                                                               IS10066 32190000
ACSUSCNF DS    X                   SUSPEND/CANCEL FLAG:         IS10066 32200000
ACSUSCAN EQU   X'80'               - SUSPENDED / CANCELLED.     IS10066 32210000
*                                                               IS10066 32220000
ACEXDATF DS    X                   EXPIRE DATE FLAGS.           IS10066 32230000
ACACDATF DS    X                   ACTIVE DATE FLAGS.           IS10066 32240000
ACMXDOVF DS    X                   MAXDAYS=0 OVERIDE FLAG:      IS10066 32250000
ACMXDOVR EQU   X'80'               - MAXDAYS=0 OVERIDES GLOBAL. IS10066 32260000
ACPSVIO# DS    H                   # OF PASSWORD VIOLATIONS / DAY. 0066 32270000
*                                                               IS10066 32280000
ACF2UFLL EQU   *-ACF2UFLG          USER FLAGS LENGTH.           IS10066 32290000
*                                                               IS10066 32300000
**   END OF FLAGS AREA                                          IS10066 32310000
*                                                               IS10066 32320000
*IS10147ASAR12 DS A                                             IS10066 32330000
SAR9     DS    A                                               IS10147A 32340000
SAR14    DS    A                                                IS10066 32350000
         ACNTRY DSECT=NO           ACNTRY PARAMETER LIST AREA  IS10147A 32360000
ACNTBL   DS    0F                  REQUIRED PWPHRASE FLD NAMES IS10147A 32370000
         DC    CL8'PWP-EXP'        PWP WAS FORCED TO EXPIRE    IS10147A 32380000
         DC    CL8'PWP-TOD'        LAST SUCCESSFUL PWP CHANGE  IS10147A 32390000
ACNTBLE  EQU   *                   END OF ACNTBL               IS10147A 32400000
ACNTBL#  EQU   (ACNTBLE-ACNTBL)/8  NUMBER OF ACNTBL ENTRIES    IS10147A 32410000
TMPXTRFL DS    X                   TEMP PXTRFL (PWP-XTR) FLAG  IS10147A 32420000
ACTION   DS    CL8                 RACROUTE ACTION FOR DEBUG    IS10066 32430000
WA       DS    D                   WORK AREA FOR CONVERSIONS.   IS10066 32440000
H2CWORK1 DS    CL5                                              IS10066 32450000
WORK02   DS    CL13                                             IS10066 32460000
H2COUT   DS    CL9                                              IS10066 32470000
*                                                               IS10066 32480000
XTSNAPHD DC    AL1(XTSNAPHL)                                    IS10066 32490000
         DC    C'EXTRACT OUTPUT - '                             IS10066 32500000
XTSNAPHN DC    CL8' '                                           IS10066 32510000
         DC    C'PROCESSING FAILED'                             IS10066 32520000
XTSNAPHL EQU   *-XTSNAPHD-1                                     IS10066 32530000
*                                                                       32540000
ACSNAPHD DC    AL1(ACSNAPHL)                                    IS10066 32550000
         DC    C'ACF2 SVC OUTPUT - '                            IS10066 32560000
ACSNAPHN DC    CL8' '                                           IS10066 32570000
         DC    C'PROCESSING FAILED'                             IS10066 32580000
ACSNAPHL EQU   *-ACSNAPHD-1                                     IS10066 32590000
*                                                                       32600000
RCVTSNPH DC    AL1(RCVTSNHL)                                            32610000
         DC    C'** RACF CVT ** (ADDR='                                 32620000
RCVTSNPA DC    CL8' '                                                   32630000
         DC    C')'                                                     32640000
RCVTSNHL EQU   *-RCVTSNPH-1                                             32650000
         DS    0D                                                       32660000
AREBUF   DS    XL256               ACF SVC RETURN AREA.         IS10066 32670000
RAREA    DS    XL512               USED BY CTSADBG AND CTSMSG1  IS10066 32680000
DBGAREA  DS    XL2048                                           IS10066 32690000
IRRSPWA  DS    XL1024             WORK AREA FOR IRRSPW00 CALL   WS10051 32700000
*                                                                       32710000
*---------------------------------------------------------------*       32720000
*        EQUATES                                                        32730000
*---------------------------------------------------------------*       32740000
*                                                               IS10066 32750000
**   EQUATE FOR REVOKED FLAGS.                                  IS10066 32760000
*                                                               IS10066 32770000
RVFRVKD  EQU   X'80'               REVOKED.                     IS10066 32780000
*                                                               IS10066 32790000
**   EQUATES FOR DATE FLAGS.                                    IS10066 32800000
*                                                               IS10066 32810000
DATBTDAY EQU   X'80'               < TODAY.                     IS10066 32820000
DATETDAY EQU   X'40'               = TODAY.                     IS10066 32830000
DATATDAY EQU   X'20'               > TODAY.                     IS10066 32840000
*                                                                       32850000
*---------------------------------------------------------------*       32860000
*        INTERNAL DSECTS                                                32870000
*---------------------------------------------------------------*       32880000
PRM      DSECT           INPUT PARAMETERS BLOCK.                        32890000
PRMUSER  DS    A         USER WHOSE PASSWORD SHOULD BE CHECKED          32900000
PRMPASS  DS    A         THE PASSWORD TO CHECK                          32910000
PRMHOW   DS    A         HOW TO VERIFY (LOGIN/EXTRACT ENCRYPTED) WS2460 32920000
PRMTYPE  DS    A         RSS TYPE                                WS2460 32930000
PRMDBG   DS    A         DEBUG LEVEL                                    32940000
PRMCOUT  DS    A         SAF RETURN CODE                                32950000
PRMCRC   DS    A         ESM RETURN CODE                                32960000
PRMCRS   DS    A         ESM REASON CODE                                32970000
PRMDOUT  DS    A         SAF RETURN CODE                                32980000
PRMDRC   DS    A         ESM RETURN CODE                                32990000
PRMDRS   DS    A         ESM REASON CODE                                33000000
*                                                                       33010000
PSDATFLD CREPSDTF DSECT=YES,PREFIX=PD                           IS10066 33020000
*                                                               IS10066 33030000
DXPARMS  DSECT                     DOXTRACT PARMS:              IS10066 33040000
DXPFLDSA DS    A                   -> FIELDS LIST.              IS10066 33050000
DXPRTNSA DS    A                   -> FIELDS PROCESS ROUTINES LIST.0066 33060000
DXPFLDS# DS    A                   -> NUMBER OF FIELDS.         IS10066 33070000
*                                                               IS10066 33080000
DAPARMS  DSECT                     DOACFSVC PARMS:              IS10066 33090000
DAPFLDSA DS    A                   -> FIELDS LIST.              IS10066 33100000
DAPRTNSA DS    A                   -> FIELDS PROCESS ROUTINES LIST.0066 33110000
DAPFLDS# DS    A                   -> NUMBER OF FIELDS.         IS10066 33120000
*---------------------------------------------------------------*       33130000
*        RACROUTE EXTRACT OUTPUT DATA MAPPING.                          33140000
*---------------------------------------------------------------*       33150000
XTPARM   DSECT                     PARAMETER MAPPING                    33160000
XTPLEN   DS    A                   PARAMETER LENGTH                     33170000
XTPPARM  DS    0C                  PARAMETER DATA.                      33180000
XTPARML  EQU   *-XTPARM                                                 33190000
*                                                                       33200000
XTREPEAT DSECT                     PARAMETER GROUP MAPPING              33210000
XTRLEN   DS    A                   GROUP LENGTH.                        33220000
XTRPARM  DS    0XL(XTPARML)        PARAMETER DATA, MAPPED BY RAPARM.    33230000
*                                                                       33240000
*---------------------------------------------------------------*       33250000
*        CONTROL BLOCKS MAPPING                                         33260000
*---------------------------------------------------------------*       33270000
         PRINT GEN                                                      33280000
CVT      CVT   DSECT=YES,PREFIX=YES,LIST=YES                            33290000
*                                                                       33300000
         ICHSAFP ,                                                      33310000
*                                                                       33320000
         ICHPRCVT ,                                                     33330000
*                                                                       33340000
         ACARE DSECT=YES,TYPE=ARE                               IS0041  33350000
*                                                                       33360000
         ACCVT ,                                                IS0041  33370000
*                                                                       33380000
         IHAACEE ,                                              IS0041  33390000
*                                                                       33400000
         IRRPRXTW ,                RACROUTE RESULT AREA MAPPING WS2460  33410000
*
         END                                                            33430000
