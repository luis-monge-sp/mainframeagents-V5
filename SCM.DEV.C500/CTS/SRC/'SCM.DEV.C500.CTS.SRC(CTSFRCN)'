         TITLE 'LIST GROUP->USER CONNECT INFO FROM RACF DATA BASE'      00010000
*                                                                       00020000
****************************************************************        00030000
****                                                        ****        00040000
****     CONTROL-SA  RELEASE 1.3.0                          ****        00050000
****                                                        ****        00060000
****     LICENCED MATERIAL - NEW DIMENSION SOFTWARE LTD.    ****        00070000
****                                                        ****        00080000
****************************************************************        00090000
*                                                                       00100000
****************************************************************        00110000
*                                                              *        00120000
* TITLE            : CTSFRCN                                   *        00130000
*                                                              *        00140000
* FILE NAME        : CTSFRCN                                   *        00150000
*                                                              *        00160000
* AUTHOR           : ALEX SHVARTSMAN                           *        00170000
*                                                              *        00180000
* CREATION DATE    : 21/04/94                                  *        00190000
*                                                              *        00200000
* DESCRIPTION      : LIST GROUP-> USER CONNECT INFO            *        00210000
*                    FOR A REQUESTED GROUP                     *        00220000
*                                                              *        00230000
* ASSUMPTIONS AND                                              *        00240000
*   CONSIDERATIONS : PROGRAM WHICH CALL TO MUST BE AUTHORIZED  *        00250000
*                                                              *        00260000
****************************************************************        00270000
****************************************************************        00280000
* MOD.ID   WHO      WHEN     DESCRIPTION                       *        00290000
* -------- -------- -------- --------------------------------- *        00300000
*                                                              *        00310000
* AS0602    ALEX    06/02/95 CHANGE FIELD NAME REVOKE_STATUS   *        00320000
*                                         TO   REVOKED         *        00330000
* PS0095    AS      03/06/97 CALL TO CTSADTE INSTEAD TO CTSFDTE*        00340000
* PS0402    AS      20/12/99 RACF DATABASE CORRUPTION HANDLING *        00340100
* BS10008   AVNERL  17/03/08 OVERLAY IN HEAP BY MVCL           *        00340200
* SAS2IBMN  NURITY  27/02/17 SOME CONNECTIONS ARE NOT MOVED    *        00340300
*                            TO THE OUTPUT AREA.               *        00340400
* SAS2IBMA  AVNERL  28/02/17 FIX BS10008                       *        00340500
* IS10186  AVNERL   21/01/24 RECOMP WITH CTSFXPR               *        00340600
* IS10188  AVNERL   06/10/24 MOVE OUR MODULES ABOVE 16M LINE   *        00340701
****************************************************************        00340800
****************************************************************        00340900
*                                                                       00341000
****************************************************************        00341100
*        PARAMETER LIST DSECT                                           00341200
****************************************************************        00341300
*                                                                       00341400
PARMLIST DSECT                                                          00341500
AOPTION  DS    A                       ADDR OPTION CODE (LOCATE/NEXT)   00341600
AENTYP   DS    A                       ADDR.ENTRY TYPE = 'GROUP'        00342000
AENTRY   DS    A                       ADDR ENTRY NAME                  00343000
AFGEN    DS    A                       ADDR. GENERIC FLAG = 0           00344000
AOUT     DS    A                       ADDR OUTPUT LINE                 00345000
ADEBUG   DS    A                       ADDR. DEBUG LEVEL                00346000
ARCFRET  DS    A                       ADDR RACF RETURN CODE            00347000
AREASON  DS    A                       ADDR RACF REASON CODE            00348000
ASEP     DS    A                       SEPARATOR                        00349000
AMAXCNT  DS    A                       MAX CONNECT NUMBER       BS10008 00349100
*                                                                       00350000
****************************************************************        00360000
*        INITIALIZE                                                     00370000
****************************************************************        00380000
*                                                                       00390000
CTSFRCN  CSECT                                                          00400000
CTSFRCN  AMODE 31                                                       00410000
*IS10188 CTSFRCN  RMODE 24       (FOR CTSADBG)                          00420001
CTSFRCN  RMODE ANY                                              IS10188 00421001
         BEGIN *,R12,R11                                                00430000
         CTSEQUR                                                        00440000
         CTSLEVEL                                                       00450000
         LR    R10,R1                                                   00460000
         USING PARMLIST,R10            ADDRESABILITY PARAMETERS         00470000
*                                                                       00480000
*        SET DEBUG LEVEL                                                00490000
*                                                                       00500000
         L     R2,ADEBUG               R2 -> DEBUG LEVEL (4 BYTES)      00510000
         XC    DEBUGL,DEBUGL           STORE DEBUG LEVEL                00520000
         XC    DEBUG,DEBUG             STORE DEBUG LEVEL                00530000
         ICM   R2,15,0(R2)             DEBUG LEVEL                      00540000
         BNP   NODEBUG                 SKIP DEBUG LVL IF MINUS          00550000
         STC   R2,DEBUGL               STORE DEBUG LEVEL (1 BYTE)       00560000
         ST    R2,DEBUG                                                 00570000
NODEBUG  DS    0H                                                       00580000
         CTSADBG 'ENTERING',LEVEL=(DEBUGL,3,4,5,6,7)                    00590000
*                                                                       00600000
****************************************************************        00610000
*        PREPARE FOR EXTRACTOR CALL                                     00620000
****************************************************************        00630000
*                                                                       00631000
         L     R2,AOUT                                                  00632000
         ST    R2,AAREA                ADDRESS OUTPUT AREA              00633000
         NI    AAREA,X'7F'             CLEAR 0 - BYTE(C-CONVENTIONS)    00634000
*                                                                       00635000
         L     R2,AENTRY                                                00636000
         MVC   ENTRY12(8),0(R2)        MOVE ENTRY NAME                  00637000
         TR    ENTRY12(8),TAB          CONVERT TO UPPERCASE             00638000
****************************************************************        00639000
*    CALCULATE REAL LENGTH OF ENTRY NAME                                00640000
****************************************************************        00650000
         LA    R1,ENTRY12+8            MAX ENTRY NAME ADDR              00660000
         TRT   ENTRY12(8),BLANKT1                                       00670000
         S     R1,=A(ENTRY12)                                           00680000
         LTR   R6,R1                   LENGTH = 0 ?                     00690000
         BNZ   LLENNZ                  NO,SKIP                          00700000
LLENZ    DS    0H                      ENTRY NAME LEN=0 SCAN DB         00710000
         MVI   ENTRY11,1               INITIAL LENGTH=1                 00720000
         XC    ENTRY12,ENTRY12         CLEAR ENTRY NAME                 00730000
         B     LCPP                                                     00740000
LLENNZ   DS    0H                                                       00750000
         STC   R6,ENTRY11              ENTRY NAME LENGTH                00760000
LCPP     DS    0H                                                       00770000
         L     R2,AOPTION              OPTION CODE / LOCATE / NEXTC /   00780000
         MVC   OPTCDE(8),0(R2)         MOVE OPTION CODE                 00790000
         TR    OPTCDE(8),TAB           CONVERT OPTION TO UPPERCASE      00800000
*                                                                       00810000
*-------------------------------------------------------------------    00820000
*   MOVE  PARAMETERS TO TEST ROUTINE                                    00830000
*-------------------------------------------------------------------    00840000
*                                                                       00850000
         L     R6,TSTGRP                                                00860000
         USING TESTGRP,R6                                               00870000
         MVC   ENTRYP(4),=A(ENTRY2)    ENTRY PARAMETER ADDR             00880000
         MVC   SLCTINFO(4),=A(SGRP)    TEST PARAMETER LIST              00890000
         MVC   DEBUGT(1),DEBUG+3       DEBUG LEVEL                      00900000
         L     R6,OUTP                                                  00910000
         USING OUTPGP,R6                                                00920000
         MVC   MOVEINFO(4),=A(SGRP)    TEST PARAMETER LIST              00930000
         MVC   DBGLT1(1),DEBUG+3       DEBUG LEVEL                      00940000
*BS10008 STARTS                                                 BS10008 00941000
         L     R6,AAREA                -> OUTPUT AREA           BS10008 00942000
         ST    R6,MOVEAREA             KEEP IT 4 ROUTINE USING  BS10008 00943000
         L     R6,AMAXCNT              =  MAX COUNT NUMBER      BS10008 00944000
         LA    R6,0(,R6)               CLEAR HIGH-ORDER BIT    SAS2IBMN 00944100
         ST    R6,MOVEMAXC             KEEP IT 4 ROUTINE USING  BS10008 00945000
*BS10008 ENDS                                                   BS10008 00949400
         DROP  R6                                                       00950000
*                                                                       00960000
         SR    R6,R6                                                    00970000
         IC    R6,ENTRY11                                               00980000
         CTSADBG 'OPTION=_ ENTRY NAME=#/_',                            X00990000
               (OPTCDE,8,?R6,ENTRY12,?R6),LEVEL=(DEBUGL,5,6,7)          01000000
*                                                                       01010000
         CLC   OPTCDE(6),=CL6'LOCATE'  OPTION 'LOCATE' ?                01020000
         BE    LCNNLOC                 Y,SKIP                           01030000
LCNNXT   DS    0H                                                       01040000
         CTSFAGR NEXTC,RC=RETCODE,MF=(E,GETGPF)                         01050000
         B     RETURN                                                   01060000
LCNNLOC  DS    0H                                                       01070000
         CTSFAGR LOCATE,RC=RETCODE,MF=(E,GETGPF)                        01080000
*********************************************************************   01090000
RETURN   DS    0H                                                       01100000
         L     R2,AENTRY                                                01110000
         MVC   0(8,R2),=CL8' '                                          01120000
         SR    R6,R6                                                    01130000
         IC    R6,ENTRY11              LENGTH OF ENTRY NAME             01140000
         BCTR  R6,0                                                     01150000
         EX    R6,MVCENTRY             RETURN CURRENT ENTRY NAME        01160000
* --------------------     1  - RACF RETURN CODE                        01170000
* --------------------     2  - RACF REASON CODE                        01180000
* --------------------     3  - EXTRACTOR RETURN CODE                   01190000
         L     R4,ARCFRET                                               01200000
         MVC   0(4,R4),RETCODE                                          01210000
         L     R4,AREASON                                               01220000
         MVC   0(4,R4),RETCODE+4                                        01230000
         L     R15,RETCODE+8                                            01240000
         CTSADBG 'EXITING WITH RC=~',(?R15),                           101250000
               LEVEL=(DEBUGL,3,4,5,6,7)                                 01260000
         BRTRN (15)                                                     01270000
* -------------------------------------------------------               01280000
         LTORG                                                          01290000
* -------------------------------------------------------               01300000
*     TRANSLATE TABLE   ( GROUP PROFILE )                               01310000
* -------------------------------------------------------               01320000
*                                      AUTHORITY                        01330000
TRTAU    DC    AL1(1),X'80'                                             01340000
         DC    AL1(4),CL4'JOIN'                                         01350000
         DC    AL1(1),X'40'                                             01360000
         DC    AL1(7),CL7'CONNECT'                                      01370000
         DC    AL1(1),X'20'                                             01380000
         DC    AL1(6),CL6'CREATE'                                       01390000
         DC    AL1(1),X'10'                                             01400000
         DC    AL1(3),CL3'USE'                                          01410000
         DC    AL1(0)                                                   01420000
* -------------------------------------------------------               01430000
*     TRANSLATE TABLE  ( USER PROFILE )                                 01440000
* -------------------------------------------------------               01450000
*                                                                       01460000
*                                      ADSP                             01470000
*                                      SPECIAL                          01480000
*                                      OPERATIONS                       01490000
*                                      REVOKED                          01500000
*                                      GRPACC                           01510000
*                                      AUDITOR                          01520000
G1       DC    AL1(1),X'80'                                             01530000
         DC    AL1(1),CL1'Y'                                            01540000
         DC    AL1(1),X'00'                                             01550000
         DC    AL1(1),CL1'N'                                            01560000
         DC    AL1(0)                                                   01570000
* -------------------------------------------------------               01580000
*                                      UACC                             01590000
TUACC2   DC    AL1(1),X'80'                                             01600000
         DC    AL1(5),CL5'ALTER'                                        01610000
         DC    AL1(1),X'40'                                             01620000
         DC    AL1(7),CL7'CONTROL'                                      01630000
         DC    AL1(1),X'20'                                             01640000
         DC    AL1(6),CL6'UPDATE'                                       01650000
         DC    AL1(1),X'10'                                             01660000
         DC    AL1(4),CL4'READ'                                         01670000
         DC    AL1(1),X'08'                                             01680000
         DC    AL1(7),CL7'EXECUTE'                                      01690000
         DC    AL1(1),X'01'                                             01700000
         DC    AL1(4),CL4'NONE'                                         01710000
         DC    AL1(0)                                                   01720000
*                                                                       01730000
AAREA    DS   F                        ADDRESS OUTPUT AREA              01740000
DEBUG    DS   F                        DEBUG LEVEL                      01750000
DEBUGL   DS   CL1                      DEBUG LEVEL                      01760000
*                                                                       01770000
ENTRY1   DS   0H                       ENTRY NAME ( GROUP )             01780000
ENTRY11  DS   AL1                                                       01790000
ENTRY12  DS   CL256                                              PS0402 01800000
* PS0402 ENTRY12  DS   CL10                                             01810000
*                                                                       01820000
ENTRY2   DS   0H                       ENTRY NAME ( USER )              01830000
ENTRY21  DS   AL1                                                       01840000
ENTRY22  DS   CL256                                              PS0402 01850000
* PS0402 ENTRY22  DS   CL10                                             01860000
*                                                                       01870000
MVCENTRY MVC  0(0,R2),ENTRY12          MOVE ENTRY NAME                  01880000
OPTCDE   DS   CL8                      OPCODE=LOCATE/NEXTC              01890000
OUTP     DC   A(OUTPGP)                EXTERNAL OUTPUT ROUTINE          01900000
TSTGRP   DC   A(TESTGRP)               TEST ROUTINE FOR GROUP PROFILE   01910000
CTSFRXT  DC   V(CTSFRXT)               EXTRACTOR NAME ( LNKEDT )        01920000
RETCODE  DS   3F                                                        01930000
* --------------------     1  - RACF RETURN CODE                        01940000
* --------------------     2  - RACF REASON CODE                        01950000
* --------------------     3  - EXTRACTOR RETURN CODE                   01960000
*                                                                       01970000
**********************************************************              01980000
*     RACF'S ACCESS TABLES                                              01990000
**********************************************************              02000000
GETGPF   CTSFAGR LOCATE,MF=L,                                          102010000
               TYPE='GRP',OUTEP=OUTP,OUTAREA=AAREA,TEST=TSTGRP,        202020000
               ENTRY=ENTRY1,RC=RETCODE,DELAY=GETUSR,                   302030000
               EOE=NO,GETPRG=CTSFRXT,FORMAT=INTERNAL,DEBUG=DEBUG,      402040000
               (TXTL='GROUP',REPEAT=YES),                              *02050000
               (ACLCNT,E,X,TXTL='ACLCNT',IGNORE=YES),                  *02060000
               (USERID,L,C,TXTL='USERID',EOL=NO),                      *02070000
               (DFLTGRP,E,C,TXTL='DFLTGRP',DELAY=YES,REPEAT=YES),      *02080000
               (CGAUTHOR,E,C,TXTL='OWNER',DELAY=YES,TST=SGRP,          *02090000
               REPEAT=YES),                                            *02100000
               (CGUACC,E,X,TXTL='UACC',TRN=TUACC2,DELAY=YES,           *02110000
               TST=SGRP,REPEAT=YES),                                   *02120000
               (CGFLAG1,E,X,TXTL='ADSP',TRN=G1,DELAY=YES,              *02130000
               TST=SGRP,REPEAT=YES),                                   *02131000
               (CGFLAG2,E,X,TXTL='SPECIAL',TRN=G1,DELAY=YES,           *02131100
               TST=SGRP,REPEAT=YES),                                   *02131200
               (CGFLAG3,E,X,TXTL='OPERATIONS',TRN=G1,DELAY=YES,        *02131300
               TST=SGRP,REPEAT=YES),                                   *02131400
               (CGFLAG5,E,X,TXTL='GRPACC',TRN=G1,DELAY=YES,            *02131500
               TST=SGRP,REPEAT=YES),                                   *02131600
               (CGGRPAUD,E,X,TXTL='AUDITOR',TRN=G1,DELAY=YES,          *02131700
               TST=SGRP,REPEAT=YES),                                   *02131800
               (CGREVKDT,E,C,TXTL='REVOKE_DATE',DELAY=YES,             *02131900
               TST=SGRP,REPEAT=YES),                                   *02132000
               (CGRESMDT,E,C,TXTL='RESUME_DATE',DELAY=YES,             *02132100
               TST=SGRP,REPEAT=YES),                                   *02132200
               (CGFLAG4,E,X,TXTL='REVOKED',TRN=G1,DELAY=YES,           *02132300
               TST=SGRP,REPEAT=YES),                                   *02132400
               (CGAUTHDA,E,C,TXTL='INFO.CREATE_DATE',                  *02132500
               DELAY=YES,TST=SGRP,REPEAT=YES),                         *02132600
               (USERACS,L,X,TXTL='AUTHORITY',TRN=TRTAU,EOL=NO,NL=YES)   02132700
*                                                                       02132800
GETUSR   CTSFAGR LOCATE,MF=L,TYPE='USR',ENTRY=ENTRY2,DELAY=YES,        *02132900
               WKAREA=USERINFO                                          02133000
*******************************************************************     02134000
*    RACF RETURN WORK AREA                                              02135000
*******************************************************************     02136000
USERINFO DS    0F                                                       02137000
RETALEN  DC    F'280'                  LENGTH OF AREA                   02137100
RETRBA   DC    XL6'00'                 RBA                              02137200
RETFLGS  DC    X'00'                   GENERIC FLAG                     02137300
RETRES1  DC    X'00'                   RESERVED                         02137400
RETDDSC  DC    F'0'                    DUPLICATE DATASET NAME COUNT     02137500
RETRES2  DC    XL8'00'                 RESERVED                         02137600
USERDATA DS    0CL256                                                   02137700
UDL      DS    AL4                     DATA LENGTH                      02137800
UDD      DS    CL252                   DATA                             02137900
*                                                                       02138000
*                                                                       02138100
* -------------------------------------------------------               02138200
*     TEST FOR GROUP INFO SELECTING                                     02138300
* -------------------------------------------------------               02138400
SGRP     ICHETEST FIELD=CGGRPNM,COND=EQ,FLDATA=(8,ENTRY12),RELEASE=1.9  02138500
* -------------------------------------------------------               02138600
BLANKT1  DC    256AL1(00)                                               02138700
         ORG   BLANKT1+X'40'                                            02138800
         DC    X'FF'                                                    02138900
         ORG   ,                                                        02139000
*                                                                       02140000
TAB      DC    256AL1(*-TAB)           TRANSLATE TABLE TO UPPERCASE     02150000
         ORG   TAB                                                      02160000
         DC    40C' '                                                   02170000
         ORG   TAB+C'A'-X'40'                                           02180000
         DC    C'ABCDEFGHI'                                             02190000
         ORG   TAB+C'J'-X'40'                                           02200000
         DC    C'JKLMNOPQR'                                             02210000
         ORG   TAB+C'S'-X'40'                                           02220000
         DC    C'STUVWXYZ'                                              02230000
         ORG   ,                                                        02240000
*                                                                       02250000
         DROP  ,                                                        02260000
*********************************************************************   02270000
*                                                                   *   02280000
* EXTRACTOR EXIT ROUTINE  ( FOR GROUP PROFILE )                     *   02290000
*                                                                   *   02290100
*********************************************************************   02290200
*                                                                   *   02290300
* INPUT PARAMETERS :                                                *   02290400
* ------------------                                                *   02290500
*                                                                   *   02290600
*  1) TYPE OF CALL                                                  *   02290700
*        START  -  BEFORE REACORD READ FROM RACF DATABASE           *   02290800
*        ENTRY  -  AFTER  REECORD READ FROM RACF DATABASE           *   02290900
*        ELEMN  -  ELEMENTARY DATA FIELD                            *   02291000
*        LIST   -  LIST DATA FIELD                                  *   02291100
*        END    -  BEFORE RETURN FROM EXTRACTOR                     *   02291200
*                                                                   *   02291300
*  SEE PARMM DESCT BELOW FOR OPCODE  DEPENDENT PARAMETERS LIST      *   02291400
*                                                                   *   02291500
* RETURN CODE ( R15 ) :                                             *   02291600
* ---------------------                                             *   02291700
*                                                                   *   02291800
*        TYPE OF ENTRY POINT                                        *   02291900
*        ENTRY  -  0 - CONTINUE, 4 - NEXT RECORD , 8 - END          *   02292000
*        ELEMN  -  0 - CONTINUE, 4 - NOT PUT AND CONTINUE ,8-END    *   02292100
*        LIST   -  0 - CONTINUE, 4 - NOT PUT AND CONTINUE           *   02292200
*                                                                   *   02292300
*********************************************************************   02292400
TESTGRP  BEGIN                                                          02292500
*--------------------------------------------------------------------   02292600
*     ADDRESSABILITY MAIN PARAMETERS                                    02292700
*--------------------------------------------------------------------   02292800
         USING PARMM,R1                                                 02292900
         L     R2,XPROPCD                                               02293000
         CLI   0(R2),XPRSTRT          START  -  BEFORE READ RECORD FROM 02294000
         BE    LSTARTG                          RACF DATA BASE          02295000
         CLI   0(R2),XPRENTY          ENTRY  -  AFTER  READ RECORD FROM 02296000
         BE    LENTRYG                          RACF DATA BASE          02297000
         CLI   0(R2),XPRELMN          ELEMN  -  ELEMENTARY DATA         02298000
         BE    LELEMNG                                                  02299000
         CLI   0(R2),XPRLIST          LIST   -  LIST DATA               02300000
         BE    LLISTG                                                   02310000
         CLI   0(R2),XPREND           END    -  BEFORE RETURN FROM      02320000
         BE    LENDG                            EXTRACTOR               02330000
         B     RET0G                                                    02340000
*                                                                       02350000
********************************************************************    02360000
*        START                                                          02370000
********************************************************************    02380000
*                                                                       02390000
LSTARTG  DS    0H                                                       02400000
         B     RET0G                                                    02410000
*                                                                       02420000
********************************************************************    02430000
*        ENTRY                                                          02440000
********************************************************************    02450000
*                                                                       02460000
LENTRYG  DS    0H                                                       02470000
         L     R3,XPRENTRY             ENTRY NAME ADDR                  02480000
         L     R5,0(R3)                ENTRY NAME LENGTH                02490000
*                                                                       02500000
         CTSADBG 'ENTRY=#/_',(?R5,4(R3),?R5),                          X02510000
               LEVEL=(DEBUGT,5,6,7)                                     02520000
*                                                                       02530000
         B     RET0G                   PUT TO OUTPUT AREA               02540000
*                                                                       02550000
********************************************************************    02560000
*        ELEMNTRY FIELD                                                 02570000
********************************************************************    02580000
*                                                                       02590000
LELEMNG  DS    0H                                                       02600000
         L     R3,XPRFNME              ADDR FIELD NAME                  02610000
         L     R4,XPRFADRE             ADDR FIELD VALUE                 02620000
         L     R5,0(R4)                FIELD LENGTH                     02630000
         CTSADBG 'ELEMN FIELD=_ VALUE=#/_/$',                          *02640000
               (0(R3),8,?R5,4(R4),?R5,4(R4),?R5),                      *02650000
               LEVEL=(DEBUGT,5,6,7)                                     02660000
         CLC   =CL8'ACLCNT',0(R3)      NUMBER OF CONNECTIONS            02670000
         BE    LACLCNT                 Y,SKIP                           02680000
********************************************************************    02690000
*        DELAY FIELDS                                                   02691000
********************************************************************    02692000
         L     R8,SLCTINFO             TEST PARAMETER LIST              02693000
         CLI   1(R8),X'00'             INFO FOUND ?                     02694000
         BNE   RET4G                   NO, DON'T PUT DATA               02695000
         CLC   =CL8'CGREVKDT',0(R3)    REVOKE DATE                      02696000
         BE    LREV                                                     02697000
         CLC   =CL8'CGRESMDT',0(R3)    RESUME DATE                      02698000
         BE    LRES                                                     02699000
         CLC   =CL8'CGFLAG4',0(R3)     REVOKE FLAG                      02699100
         BE    LFLG4                                                    02699200
         CLC   =CL8'CGAUTHDA',0(R3)    CREATE DATA                      02699300
         BE    LAUTH                                                    02699400
         B     RET0G                   PUT TO OUTPUT AREA               02699500
*------------------------------------------------------------           02699600
*     CREATE DATE                                                       02699700
*------------------------------------------------------------           02699800
LAUTH    DS    0H                                                       02699900
         CLC   0(4,R4),=F'3'           LENGTH VALID ?                   02700000
         BNE   RET4G                   N, DON'T PUT                     02701000
         ST    R4,RDT4                                                  02702000
         CALL  CTSADTE,(RDT4)          CREATE DATE                      02703000
         B     RET0G                                                    02704000
*------------------------------------------------------------           02705000
*     REVOKE DATE                                                       02706000
*------------------------------------------------------------           02707000
LREV     DS    0H                                                       02708000
         XC    REVDT,REVDT                                              02709000
         CLC   0(4,R4),=F'3'           LENGTH VALID ?                   02709100
         BNE   RET4G                   N, DON'T PUT                     02709200
         MVC   REVDT(3),4(R4)          SAVE REVOKE DATE                 02709300
         ST    R4,RDT4                                                  02709400
         CALL  CTSADTE,(RDT4)          REVOKE DATE                      02709500
         B     RET0G                   PUT DATA TO OUTPUT AREA          02709600
*------------------------------------------------------------           02709700
*     REVOKE FLAG                                                       02709800
*------------------------------------------------------------           02709900
LFLG4    DS    0H                                                       02710000
         L     R5,REVDT                |REVOKE DATE                     02710100
         LTR   R5,R5                   |   WAS NOT OBTAINED             02710200
         BZ    RET0G                   |     RETURN REVOKE FLAG         02710300
*                                                                       02710400
         MVI   4(R4),X'00'             |OBTAINED REVOKE DATE.           02710500
         B     RET0G                                                    02710600
*                                      |   USER NO REVOKED !            02710700
*------------------------------------------------------------           02710800
*     RESUME DATE                                                       02710900
*------------------------------------------------------------           02711000
LRES     DS    0H                                                       02711100
         CLC   0(4,R4),=F'3'           LENGTH VALID ?                   02711200
         BNE   RET4G                   N, DON'T PUT                     02711300
         ST    R4,RDT4                                                  02711400
         CALL  CTSADTE,(RDT4)          RESUME DATE                      02711500
         B     RET0G                                                    02711600
LACLCNT  DS    0H                                                       02711700
         MVC   ACLCNT(4),4(R4)         CONNECTION NUMBER                02711800
         MVC   CURRCNT(4),=F'0'        CLEAR CONNECT COUNTER            02711900
         B     RET0G                                                    02712000
*                                                                       02713000
********************************************************************    02714000
*        LIST FIELD                                                     02715000
********************************************************************    02716000
*                                                                       02717000
LLISTG   DS    0H                                                       02718000
         L     R3,XPRFNML                                               02719000
         L     R4,XPRFADRL             FIELD ADDR                       02720000
         L     R5,0(R4)                FIELD LENGTH                     02730000
         CTSADBG 'LIST FIELD=_ VALUE=#/_/$',                           *02740000
               (0(R3),8,?R5,4(R4),?R5,4(R4),?R5),                      *02750000
               LEVEL=(DEBUGT,5,6,7)                                     02760000
         CLC   =CL8'USERID',0(R3)      USERID FIELD ?                   02770000
         BE    LUSERID                 YES, GOTO 'USR' PROFILE PROCESS  02780000
         B     RET0G                   PUT INFO TO OUTPUT AREA          02790000
LUSERID  DS    0H                      USERID FIELD                     02800000
*                                                                       02810000
         L     R5,CURRCNT              GET CURRENT CONNECT COUNTER      02820000
         LA    R5,1(R5)                CONNECT COUNTER += 1             02830000
         ST    R5,CURRCNT              STORE CONNECT COUNTER            02840000
*                                                                       02850000
         L     R5,XPRT4                ADDR DELAY ICHEINTY              02860000
         L     R6,0(R5)                                                 02870000
*                                                                       02880000
         CTSADBG 'DELAY ICHEINTY=~/~',(?R5,?R6),                       *02890000
               LEVEL=(DEBUGT,5,6,7)                                     02900000
         LTR   R6,R6                                                    02910000
         BZ    RET0G                   PUT INFO TO OUTPUT AREA          02920000
*                                                                       02930000
         L     R8,ENTRYP                                                02940000
         MVC   1(8,R8),4(R4)           MOVE USERID -> ENTRY NAME        02941000
         LR    R1,R8                                                    02941100
         LA    R1,1(R1)                BRANCH OVER THE LENGTH           02941200
         LA    R1,8(R1)                MAX ENTRY NAME ADDR              02941300
         TRT   1(8,R8),BLANKT2                                          02941400
         L     R8,ENTRYP                                                02941500
         LR    R9,R8                                                    02941600
         LA    R8,1(R8)                BRANCH OVER THE LENGTH           02941700
         SR    R1,R8                                                    02941800
         LR    R8,R1                                                    02941900
         STC   R8,0(R9)                STORE REAL LENGTH                02942000
*                                                                       02942100
         CTSADBG 'ENTRY NAME=#/_',(?R8,1(R9),?R8),                     *02942200
               LEVEL=(DEBUGT,5,6,7)                                     02942300
*                                                                       02942400
         ICHEINTY MF=(E,(R6))          INVOKE DELAY ACCESS              02942500
         L     R8,56(R6)               RSN.RC                           02942600
         L     R9,52(R6)               RC                               02942700
         L     R10,60(R6)              RETURN AREA ADDR(MUST BE 0)      02942800
*                                      BECAUSE IN DELAY PROCESSING      02942900
*                                      MUST USE STATIC RETURN AREA      02943000
*                                                                       02943100
         CTSADBG 'DELAY ICHEINTY RACF RC=~ REASON=~ RET AREA ADDR=~',  *02943200
               (?R9,?R8,?R10),                                         *02943300
               LEVEL=(DEBUGT,5,6,7)                                     02943400
*                                                                       02943500
         LTR   R9,R9                   DELAY ACCESS SUCCESSFULL         02943600
         BZ    RET0G                   PUT INFO TO OUTPUT AREA          02943700
         L     R8,SLCTINFO             TEST PARAMETER LIST              02943800
         MVI   1(R8),1                 INFO NOT FOUND                   02943900
         B     RET0G                   RETURN                           02944000
*                                                                       02945000
* ---------------------------------------------------------             02946000
LENDG    DS    0H                                                       02947000
         B     RET0G                                                    02948000
RET0G    DS    0H                                                       02949000
         SR    R15,R15                                                  02950000
         B     RETTG                                                    02960000
RET4G    DS    0H                                                       02970000
         LA    R15,4                                                    02980000
         B     RETTG                                                    02990000
RET8G    DS    0H                                                       03000000
         LA    R15,8                                                    03010000
         B     RETTG                                                    03020000
RETTG    DS    0H                                                       03030000
         BRTRN (15)                                                     03040000
********************************************************************    03050000
*       W O R K  A R E A  A N D   C O N S T A N T S                     03060000
********************************************************************    03070000
*                                                                       03080000
BLANKT2  DC    256AL1(00)                                               03090000
         ORG   BLANKT2+X'40'                                            03100000
         DC    X'FF'                                                    03110000
         ORG   ,                                                        03120000
*                                                                       03130000
DEBUGT   DS    CL1                     DEBUG LEVEL                      03140000
*                                                                       03150000
ENTRYP   DS    F                       ENTRY PARAMETER ADDR             03160000
SLCTINFO DS    F                       TEST PARAMETER LIST              03170000
ACLCNT   DS    F                       CONNECTION NUMBER                03180000
CURRCNT  DS    F                       CURRENT CONNECT NUMBER           03190000
RDT4     DS    F                       WORK VAR                         03200000
REVDT    DS    F                       WORK VAR                         03210000
* -------------------------------------------------------               03220000
         LTORG                                                          03230000
         DROP  ,                                                        03240000
*-----------------------------------------------------------------      03250000
*   OUTPUT ROUTINE FOR GATHERING CONNECT INFORMATION                    03260000
*   CALLED BY LOADED EXTRACTOR                                          03270000
*-----------------------------------------------------------------      03280000
OUTPGP   BEGIN                                                          03290000
* -------------------------------------ENTRY 'WRITE'                    03300000
*        L     R8,MOVEINFO             TEST PARAMETER LIST              03310000
*        CLI   1(R8),X'00'             INFO FOUND ?                     03320000
*        BNE   OUTPGPE                                                  03330000
         LR    R11,R1                                                   03340000
         L     R6,4(R11)                                                03350000
         L     R6,0(R6)                ADDRESS AREA                     03360000
         MVC   LRECL(4),4(R6)          USE LENGTH                       03370000
*                                                                       03380000
         LR    R7,R6                   ADDRESS AREA                     03390000
         A     R7,LRECL                                                 03400000
         LA    R7,8(R7)                LENGTH + PREFIX LENGTH           03410000
         CTSADBG TYPE=SNAP,ID=1,HDR='**  CONNECT INFO   **',           103420000
               ADDR=(0(R6),0(R7)),LEVEL=(DBGLT1,5,6,7)                  03430000
*                                                                       03440000
         L     R7,TG                   ADDRESS TEST GROUP EXIT ROUTINE  03450000
         USING TESTGRP,R7                                               03460000
         L     R5,CURRCNT              GET CURRENT CONNECT COUNTER      03470000
         DROP  R7                                                       03480000
         SR    R4,R4                                                    03490000
         MVC   MAXREC(4),0(R6)         MAX LENGTH                       03500000
         L     R10,MAXREC                                               03510000
         LA    R10,8(R10)              MAX LEN & PREFIX LENGTH (8)      03520000
         ST    R10,MAXREC                                               03530000
*                                                                       03540000
         CTSADBG 'CONNECT N=# MAX.LENGTH+PREFIX(8)=#',(?R5,MAXREC),    103550000
               LEVEL=(DBGLT1,5,6,7)                                     03560000
*                                                                       03570000
         M     R4,MAXREC                                                03580000
         LR    R8,R6                   ADDRESS AREA                     03590000
         AR    R8,R5                   ADDRESS FOR MVCL                 03600000
         L     R9,MAXREC               AREA LENGTH                      03610000
         L     R7,MAXREC               AREA LENGTH                      03620000
*                                                                       03630000
         CTSADBG 'MOVE CONNECT INFO FROM ADDR=~ ---->TO ADDR=~ LEN=#', 103640000
               (?R6,?R8,?R7),                                          203650000
               LEVEL=(DBGLT1,5,6,7)                                     03660000
*BS10008 STARTS                                                         03661000
         L     R5,MOVEMAXC             =  MAX CONNECT NUMBER    BS10008 03663100
         CTSADBG 'MAX CONNECT NUM IS:/#/',                             *03663200
               (?R5),                                                  *03663300
               LEVEL=(DBGLT1,5,6,7)                                     03663400
         L     R5,MOVEAREA             -> OUTPUT AREA           BS10008 03664000
         CTSADBG 'OUTPUT AREA ADDR IS:/~/ DATA IS:/_/ ',               *03668000
               (?R5,0(R5),40),                                         *03669000
               LEVEL=(DBGLT1,5,6,7)                                     03669100
* BEFORE THIS FIX, THE FOLLOWING MVCL HAD OVERLAID THE HEAP AREA        03669200
* OF SAS/C. IN OTHER WORDS, IT HAD BEEN A S0C4 SITUATION AS WE          03669300
* HAD COPIED DATA TO AN AREA WE HADN'T ALLOCATED.                       03669400
* THIS FIX VERIFIES THAT COPIED DATA IS INSIDE THE ALLOCATED AREA.      03669500
         XR    R4,R4                   CLR FOR MULTIPLY         BS10008 03669600
*SAS2IBMA L     R5,0(R5)               = MAX_LEN                BS10008 03669700
         L     R5,MAXREC               = MAX_LEN               SAS2IBMA 03669800
         L     R15,MOVEMAXC            -> MAX COUNT NUMBER      BS10008 03669900
         LA    R15,1(R15)              + 1 USED BY MALLOC      SAS2IBMA 03670000
*SAS2IBMA LA    R15,4(R15)             + 4 USED BY MALLOC       BS10008 03670100
         CTSADBG 'CALC INPUT: R5=#  R6=~  R7=#  R8=~  R15=#',  SAS2IBMA*03670200
               (?R5,?R6,?R7,?R8,?R15),                         SAS2IBMA*03670300
               LEVEL=(DBGLT1,5,6,7)                            SAS2IBMA 03670400
         MR    R4,R15                  (MAX CNT + 4) * MAX_LEN  BS10008 03670500
         AR    R5,R6                   -> END OF ALLOCATED AREA BS10008 03670600
* CHANGE FROM R1 TO R2 IN BELOW 3 STATEMENTS                   SAS2IBMA 03670700
         LR    R2,R8                   -> TARGET OF MVCL        BS10008 03670800
         AR    R2,R7                   -> END OF TARGET AREA    BS10008 03670900
         CTSADBG 'COMP VALS : R2=~ R5=~',                      SAS2IBMA*03671000
               (?R2,?R5),                                      SAS2IBMA*03671100
               LEVEL=(DBGLT1,5,6,7)                            SAS2IBMA 03671200
         CR    R2,R5                   MVCL WITHIN ALLOCATED?   BS10008 03671300
*SAS2IBMA BL    MVCLOK                 MVCL IS OK               BS10008 03671400
         BNH   MVCLOK                  MVCL IS OK              SAS2IBMA 03671500
         L     R8,MOVEINFO             TEST PARAMETER LIST      BS10008 03671600
         MVI   1(R8),1                 SET SIGN AS IF MOVED     BS10008 03671700
         CTSADBG 'TO+LEN > FROM+MAXLEN ==> MVCL IS SKIPPED',           103671800
               LEVEL=(DBGLT1,5,6,7)                                     03671900
         BRTRN 0                       RETURN TO CALLER         BS10008 03672000
MVCLOK   DS    0H                                               BS10008 03672100
*BS10008 ENDS                                                           03673000
         MVCL  R8,R6                   KEEP CURRENT CONNECT INFO        03680000
         L     R8,MOVEINFO             TEST PARAMETER LIST              03690000
         MVI   1(R8),1                 SIGN : INFO MOVED !              03700000
OUTPGPE  DS    0H                                                       03710000
         BRTRN 0                                                        03720000
         LTORG                                                          03730000
LRECL    DS    F                       USE LENGTH                       03740000
MAXREC   DS    F                       MAX LENGTH                       03750000
DBGLT1   DS    CL1                     DEBUG LEVEL                      03760000
MOVEINFO DS    F                       TEST PARAMETER LIST              03770000
MOVEAREA DS    A                       OUTPUT AREA ADDRESS      BS10008 03771000
MOVEMAXC DS    A                       MAX COUNT NUMBER ADDR    BS10008 03772000
TG       DC    A(TESTGRP)                                               03780000
*                                                                       03790000
********************************************************************    03800000
*    MAIN PARAMETERS LIST FOR TEST ROUTINES                             03810000
*******************************************************************     03820000
PARMM    DSECT                                                          03830000
         COPY  CTSFXPR                                                  03840000
******************************************************************      03850000
*       RETURN AREA FROM RACF                                           03860000
******************************************************************      03870000
RETAREA  DSECT                                                          03880000
         COPY  CTSFXPF                                                  03890000
         END                                                            03900000
