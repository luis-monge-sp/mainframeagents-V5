         TITLE 'CONTROL-SA ICHPWX01 EXIT FOR ONLINE INTERCEPTOR'        00010000
*                                                                       00020000
*********************************************************************** 00030000
****                                                               **** 00040000
****       CONTRL-SA RELEASE 3.0.0                                 **** 00050000
****                                                               **** 00060000
****       LICENCED MATERIAL - NEW DIMENSION SOFTWARE LTD.         **** 00070000
****                                                               **** 00080000
*********************************************************************** 00090000
*                                                                       00100000
*********************************************************************** 00110000
*                                                                     * 00120000
* MODULE NAME : CTSFPWX                                               * 00130000
*                                                                     * 00140000
* DESCRIPTION : CONTROL-SA ICHPWX01 EXIT ROUTINE                      * 00150000
*                                                                     * 00160000
* FUNCTION:                                                           * 00170000
*                                                                     * 00180000
*    ICHPWX01 IS RACF NEW PASSWORD EXIT WHICH CONTROL-SA USES FOR     * 00190000
*    PASSWORD SYNCRONIZTION SUPPORT.                                  * 00200000
*    THE EXIT INTERCEPTS PASSWORD CHANGES THAT WERE GENERATED BY      * 00210000
*    THE RACF COMMANDS 'ALTUSER' AND 'PASSWORD' AND NOTIFIES OF THE   * 00220000
*    EVENT TO CONTROL-SA ONLINE INTERCEPTOR SERVER VIA CROSS MEMORY   * 00230000
*    SERVICES.                                                        * 00240000
*                                                                     * 00250000
* ATTRIBUTES  : THE EXIT MODULE SHOULD BE LINK-EDITED WITH RMODE 24   * 00260000
*               AND AMODE 31 , REUSABLE AND REENTRABLE .              * 00270000
*                                                                     * 00280000
* ENVIRONMENT : THE EXIT RECEIVES CONTROL IN PROBLEM STATE AND PSW    * 00290000
*               KEY 8 WHEN INVOKED BY 'ALTUSER' AND 'PASSWORD'        * 00300000
*               COMMANDS.                                             * 00310000
*               WHEN INVOKED BY RACINIT , IT RECEIVES CONTROL IN      * 00320000
*               SUPERVISOR STATE, PSW KEY 0.                          * 00330000
*                                                                     * 00340000
* RESTRICTIONS : NONE                                                 * 00350000
*                                                                     * 00360000
* DEPENDENCIES : NONE                                                 * 00370000
*                                                                     * 00380000
* REGISTER USAGE :  R0  - TEMPORARY WORK REGISTER                     * 00390000
*                   R1  - TEMPORARY WORK REGISTER                     * 00400000
*                   R2  - TEMPORARY WORK REGISTER                     * 00410000
*                   R3  -> NEW PASSWORD                               * 00420000
*                   R4  -> USERID                                     * 00430000
*                   R5  -  LENGTH REGISTER                            * 00440000
*                   R6  -  NOT USED                                   * 00450000
*                   R7  -  NOT USED                                   * 00460000
*                   R8  -> EVT                                        * 00470000
*                   R9  -> RQC                                        * 00480000
*                   R10 -> MODULE PREFIX AREA                         * 00490000
*                   R11 -> PARAMETER LIST                             * 00500000
*                   R12 -> PROGRAM BASE                               * 00510000
*                   R13 -> DYNAMIC WORK AREA (SVAE AREA)              * 00520000
*                   R14 -  RETURN ADDRESS                             * 00530000
*                   R15 -  RETURN CODE                                * 00540000
*                                                                     * 00550000
* INPUT :                                                             * 00560000
*                                                                     * 00570000
*    REGISTER 1 POINTS TO A RACF PASSWORD EXIT PARAMETER LIST WHICH   * 00580000
*    IS MAPPED BY THE PWXPL CONTROL BLOCK (ICHPWXP MARCO)             * 00590000
*                                                                     * 00600000
* OUTPUT:                                                             * 00610000
*                                                                     * 00620000
*    THIS EXIT ALWAYS RETURNS A RETURN CODE OF 0 .                    * 00630000
*                                                                     * 00640000
* ICHPWX01 RETURN CODES ARE :                                         * 00650000
*                                                                     * 00660000
*    0 - AUTHORIZED THE NEW PASSWORD. CONTINUE WITH PROCESSING        * 00670000
*    4 - THE NEW PASSWORD REQUEST IS NOT ACCEPTED AND IS TO BE FAILED * 00680000
*    8 - THE INTERVAL VALUE CHANGE IS NOT ACCEPTED AND IS TOP BE      * 00690000
*        FAILED .                                                     * 00700000
*   12 - THE NEW PASSWORD REQUEST IS NOT ACCEPTED AND IS TO BE FAILED * 00710000
*        THIS IS THE SAME AS RETURN CODE 4, BUT THE ERROR MESSAGES    * 00720000
*        THAT ARE ISSUED BY 'ALTUSER' AND 'PASSWORD' COMMNADS         * 00730000
*        WILL BE  SUPPRESSED                                          * 00740000
*   16 - THE INTERVAL VALUE CHANGE IS NOT ACCEPTED AND IS TO BE       * 00750000
*        FAILED .                                                     * 00760000
*        THIS IS THE SAME AS RETURN CODE 8, BUT THE ERROR MESSAGES    * 00770000
*        THAT ARE ISSUED BY 'ALTUSER' AND 'PASSWORD' COMMNADS         * 00780000
*        WILL BE  SUPPRESSED                                          * 00790000
*                                                                     * 00800000
* CHANGE ACTIVITY :                                                   * 00810000
*                                                                     * 00820000
*    24/10/94 DC CREATED                                              * 00830000
*                                                                     * 00840000
*********************************************************************** 00850000
*--------------------- CTS V 1.3.0 ----------------------------*        00851000
* *CTS1  07.06.95 DC USE X'FFFFFFFF' TO INDICATE NO PREVIOUS   *        00852000
*                    EXIT IN EXPPREV FIELD                     *        00853000
*--------------------- CTS V 2.1.0 ----------------------------*        00853100
* PS0244 25.02.98 DC LONG RQC SUPPORT                          *        00853200
*--------------------- CTS V 3.0.1-----------------------------*        00853300
* WS2345 25.02.99 GS INTERCEPT ALTUSER COMMANDS                *        00853400
* WS2372 03.07.00 YB INDICATE CALLED BY ALTUSER                *        00853500
*--------------------- CTS V 3.2.01 ---------------------------*        00853600
* WS2555  12.01.06 EM NOTIFY WHEN NO FREE RQC IS LEFT IN CHAIN.*        00853700
* IS10006 10.07.07 AL ADD RC TO CTS210E.                       *        00853800
* IS10012 25.09.07 AL ADD PGMNAME PARM TO MSG CTS213.          *        00853900
*--------------------- CTS V 4.0.00 ---------------------------*        00854000
* SAS2IBMN NURITY   12/12/16 RESOLVE USING WARNING.            *        00854100
*    "      "       17/12/16 RMODE CHANGED FROM 24 TO ANY.     *        00854201
****************************************************************        00854301
*                                                                       00855000
CTSFPWX  CSECT ,                                                        00856000
CTSFPWX  AMODE 31                                                       00857000
*SAS2IBMN CTSFPWX  RMODE 24                                             00858001
CTSFPWX  RMODE ANY                                             SAS2IBMN 00858101
*                                                                       00859000
*--------------------------------------------------------------*        00860000
*        REGISTERS USAGE                                       *        00870000
*--------------------------------------------------------------*        00880000
*                                                                       00890000
R0       EQU   0                                                        00900000
R1       EQU   1                                                        00910000
R2       EQU   2                                                        00920000
R3       EQU   3                                                        00930000
R4       EQU   4                                                        00940000
R5       EQU   5                                                        00950000
R6       EQU   6                                                        00960000
R7       EQU   7                                                        00970000
R8       EQU   8                                                        00980000
R9       EQU   9                                                        00990000
R10      EQU   10                                                       01000000
R11      EQU   11                                                       01010000
R12      EQU   12                                                       01020000
R13      EQU   13                                                       01030000
R14      EQU   14                                                       01040000
R15      EQU   15                                                       01050000
*                                                                       01060000
****************************************************************        01070000
*        PROLOG CODE                                           *        01080000
****************************************************************        01090000
*                                                                       01100000
         SAVE  (14,12),,CTSFPWX-&SYSDATE-&SYSTIME                       01110000
         LR    R12,R15                                                  01120000
         USING CTSFPWX,R12                                              01130000
         CTSLEVEL ,                                                     01140000
         LR    R11,R1                                                   01150000
         USING PWXPL,R11                                                01160000
*                                                                       01170000
****************************************************************        01180000
*        CHECK MODULE HEADER                                            01190000
****************************************************************        01200000
*                                                                       01210000
         LR    R10,R12                                                  01220000
         S     R10,=A(EXPLEN)          R10 -> EXIT PREFIX               01230000
         USING EXP,R10                                                  01240000
         CLC   =CL4'CSAX',EXPID        ARE WE OK ?                      01250000
         BE    CHKZOMBI                NO - WHAT THE ???                01260000
         WTO   'CTSFPWX: EXIT OVERLAYED. NO MODULE HEADER'              01270000
         B     QUIT                                                     01280000
*                                                                       01290000
****************************************************************        01300000
*        IF EXIT IS DISABLED, CONTINUE WITH NEXT ONE                    01310000
****************************************************************        01320000
*                                                                       01330000
CHKZOMBI DS    0H                                                       01340000
         TM    EXPFLAGS,EXPZOMBI       WAS EXIT DISABLED ?              01350000
         BO    NEXTEXIT                YES, SIMPLY DO NOTHING           01360000
*                                                                       01370000
****************************************************************        01380000
*        VERIFY CALLERS, NEWPW AND USERID                               01390000
****************************************************************        01400000
*                                                                       01410000
*        IGNORE IF CALLER = RACINIT                                     01420000
* DO NOT IGNORE IF CALLER = ALTUSER             WS2345                  01430000
*                                                                       01440000
         ICM   R1,15,PWXCALLR          WAS CALLER PASSED ?              01450000
         BZ    NOCALLER                NO, ISSUE WARNING MESSAGE        01460000
         CLI   0(R1),PWXRINIT          CALLED BY RACINIT ?              01470000
         BE    NEXTEXIT                YES, THEN IGNORE THE CALL        01480000
         XR    R6,R6                   ZERO R6                WS2372    01481000
         CLI   0(R1),PWXALTUS          CALLED BY ALTUSER ?    WS2372    01490000
         BNE   NOTALU                  NO - SKIP THIS         WS2372    01490100
         LA    R6,1                    INDICATE ALTUSER       WS2372    01490300
NOTALU   DS    0H                                             WS2372    01490400
*WS2345  CLI   0(R1),PWXALTUS          CALLED BY ALTUSER ?              01491000
*WS2345  BE    NEXTEXIT                YES, THEN IGNORE THE CALL        01500000
*                                                                       01510000
*        IGNORE IF NO USERID                                            01520000
*                                                                       01530000
         ICM   R3,15,PWXUSRID          WAS A NEW USER PASSED ?          01540000
         BZ    NOUID                   NO, ISSUE WARNING MESSAGE        01550000
         CLI   0(R3),0                 WAS NEW USER PASSED ?            01560000
         BE    NOUID                   NO, ISSUE WARNING MESSAGE        01570000
*                                                                       01580000
*        IGNORE IF NO NEW PASSWORD                                      01590000
*                                                                       01600000
         ICM   R4,15,PWXNEWPW          WAS NEW PASSWORD PASSED ?        01610000
         BZ    NONPAS                  NO, ISSUE WARNING MESSAGE        01620000
         CLI   0(R4),0                 WAS NEW PASSWORD PASSED ?        01630000
         BE    NONPAS                  NO, ISSUE WARNING MESSAGE        01640000
*                                                                       01650000
*        PASSED FILTERING                                               01660000
*                                                                       01670000
         B     START                                                    01680000
*                                                                       01690000
****************************************************************        01700000
*        PARAMETERS ERROR                                               01710000
****************************************************************        01720000
*                                                                       01730000
NOCALLER DS    0H                                                       01740000
         WTO   'CTSFPWX: PARAMETERS ERROR - NO CALLER'                  01750000
         B     NEXTEXIT                                                 01760000
NOUID    DS    0H                                                       01770000
         WTO   'CTSFPWX: PARAMETERS ERROR - NO USERID'                  01780000
         B     NEXTEXIT                                                 01790000
NONPAS   DS    0H                                                       01800000
*                                                                       01810000
*  THIS IS NOT AN ERROR. IT HAPPENS WHEN YOU ISSUE                      01820000
*  'PASSWORD INTERVAL(XXX)' COMMAND'                                    01830000
*                                                                       01840000
*        WTO   'CTSFPWX: PARAMETERS ERROR - NO NEW PASSWORD'            01850000
*                                                                       01860000
         B     NEXTEXIT                                                 01870000
*                                                                       01880000
****************************************************************        01890000
*        INCREASE MODULE USE COUNT                                      01900000
****************************************************************        01910000
*                                                                       01920000
* NOTE: SINCE WE HANDLE ONLY PASSWORD COMMANDS                          01930000
*       WE ARE ALWAYS PROBLEM STATE, KEY 8 WHEN WE REACH HERE           01940000
*                                                                       01950000
****************************************************************        01960000
*                                                                       01970000
START    DS    0H                                                       01980000
         MODESET MODE=SUP,KEY=ZERO                                      01990000
INCUSECT DS    0H                      INCREASE MODULE USE COUNT        02000000
         L     R1,EXPUSECT             INCREASE MODULE USE COUNT        02010000
         LA    R0,1(R1)                INCREASE MODULE USE COUNT        02020000
         CS    R1,R0,EXPUSECT          INCREASE MODULE USE COUNT        02030000
         BNZ   INCUSECT                INCREASE MODULE USE COUNT        02040000
         MODESET MODE=PROB,KEY=NZERO                                    02050000
*                                                                       02060000
****************************************************************        02070000
*        OBTAIN WORKAREA                                       *        02080000
****************************************************************        02090000
*                                                                       02100000
GETWORK  DS    0H                                                       02110000
         GETMAIN RC,LV=WORKLEN                                          02120000
         LTR   R15,R15                                                  02130000
         BZ    CHAINSA                                                  02140000
         WTO   'CTSFPWX: GETMAIN FAILED ERROR'                          02150000
         B     RETURN                                                   02160000
CHAINSA  DS    0H                                                       02170000
         ST    R1,8(R13)               CHAIN                            02180000
         ST    R13,4(R1)               SAVE AREAS                       02190000
         LR    R13,R1                  ESTABLISH WORK AREA              02200000
         USING WORKAREA,R13               ADDRESSABILITY                02210000
*                                                                       02220000
****************************************************************        02230000
*        CREATE RECOVERY ENVIRONMENT                                    02240000
****************************************************************        02250000
*                                                                       02260000
         ST    R10,ADDREXP             SAVE EXP FOR ABEND RETRY         02270000
         XC    ABNDCODE,ABNDCODE       CLEAR ABEND CODE                 02280000
         MVC   WRKESTAE,LSTESTAE                                        02290000
         ESTAE ABNDEXIT,PARAM=WORKAREA,TERM=YES,MF=(E,WRKESTAE)         02300000
*                                                                       02310000
****************************************************************        02320000
*        BUILD RQC AND EVT                                     *        02330000
****************************************************************        02340000
*                                                              *        02350000
* 'RQC' IS THE 'REQUEST CONTROL BLOCK' WHICH IS USED BY THE PC *        02360000
* ROUTINES TO PASS INFORMATION TO THE CONTROL-SA ONLINE        *        02370000
* INTERCEPTOR .                                                *        02380000
*                                                              *        02390000
* 'EVT' IS THE 'EVENT CONTROL BLOCK' WHICH IS IMBEDED IN THE   *        02400000
* REQUEST BLOCK FOR 'NOTIFY REQUESTS' . IT DESCRIBES THE       *        02410000
* EVENT THAT OCCURED INCLUDING THE ENTITY (USER, GROUP ETC...) *        02420000
* AND THE EVENT ACTION TYPE (ADD, DELETED, MODIFY, PASSWORD    *        02430000
* CHANGED, ETC...) .                                           *        02440000
*                                                              *        02450000
* THE FOLLOWING CODE FORMATS THESE CONTROL BLOCKS AND FILL THEM*        02460000
* WITH THE RELEVANT INFO SO THEY CAN BE PASSED ON TO THE PC    *        02470000
* ROUTINES AND BE TRANSFERED TO THE ONLINE INTERCEPTOR SERVER. *        02480000
*                                                              *        02490000
****************************************************************        02500000
*                                                                       02510000
*        INITIALIZE RQC                                                 02520000
*                                                                       02530000
*PS0244  XC    RQCAREA,RQCAREA        CLEAR LOCAL RQC AREA              02540100
         LA    R0,RQCAREA              CLEAR THE AREA           PS0244  02540200
         LA    R1,RQCLEN               SET LENGTH               PS0244  02540300
         XR    R15,R15                 PADD WITH X'00'          PS0244  02540400
         MVCL  R0,R14                  CLEAR                    PS0244  02541000
         LA    R9,RQCAREA             R9 -> LOCAL RQC AREA              02550000
         USING RQC,R9                 MAP RQC                           02560000
*PS0244  MVI   RQCTYPE,RQCTNOT        RQC TYPE = NOTIFY                 02570000
         MVI   RQCTYPE,RQCTNOTX       RQC TYPE = NOTIFY         PS0244  02571000
         TIME  DEC                    GET TIME                          02580000
         STM   R0,R1,RQCTSTMP         TIMESTAMP RQC                     02590000
*                                                                       02600000
*        INITIALIZE EVT                                                 02610000
*                                                                       02620000
         LA    R8,RQCEVT              R8 -> EVT                         02630000
         USING EVT,R8                 MAP EVT                           02640000
         MVC   EVTEVT,=CL4'EVT '      SET EYECATHCER                    02650000
         MVC   EVTFLAG,=A(EVTFULL)    SET FLAG - LOADED WITH DATA       02660000
         TIME  BIN                                                      02670000
         ST    R0,EVTTIME             EVENT TIME STAMP                  02680000
         ST    R1,EVTDATE             EVENT TIME STAMP                  02690000
         MVI   EVTTYPE,EVTTUSER       TYPE = USER                       02700000
         MVI   EVTACT,EVTAPSWD        ACTION = PASSWORD CHANGE          02710000
*                                                                       02720000
*        ORIGINATOR USERID                                              02730000
*                                                                       02740000
         L     R1,PSATOLD-PSA         R1 -> CURRENT TCB                 02750000
         ICM   R1,15,TCBSENV-TCB(R1)  R1 -> TASK ACEE                   02760000
         BNZ   COPYOUID               HAVE IT, COPY TO EVT              02770000
         L     R1,PSAAOLD-PSA         R1 -> CURRENT ASCB                02780000
         L     R1,ASCBASXB-ASCB(R1)   R1 -> ASXB                        02790000
         ICM   R1,15,ASXBSENV-ASXB(R1) R1 -> ADDRESS SPACE ACEE         02800000
         BZ    SKIPOUID               NO, FAIL TO FIND AN ACEE          02810000
COPYOUID DS    0H                                                       02820000
         MVC   EVTOUID,ACEEUSRI-ACEE(R1) COPY UID FROM ACEE             02830000
SKIPOUID DS    0H                                                       02840000
*                                                                       02850000
*        COPY ORIGINATOR JOBNAME                                        02860000
*                                                                       02870000
         L     R1,PSAAOLD-PSA          R1 -> ASCB                       02880000
         ICM   R15,15,ASCBJBNI-ASCB(R1) JOBNAME EXISTS ?                02890000
         BNZ   COPYOJBN                YES, THEN COPY IT                02900000
         ICM   R15,15,ASCBJBNS-ASCB(R1) STCNAME EXISTS ?                02910000
         BZ    SKIPOJBN                NO, NOTHING CAN BE COPIED        02920000
COPYOJBN DS    0H                                                       02930000
         MVC   EVTOJBN,0(R15)          COPY JOBNAME/STCNAME             02940000
SKIPOJBN DS    0H                                                       02950000
*                                                                       02960000
*        COPY ORIGINATOR PROGNAME (JOBSTEP TCB, OLDEST RB)              02970000
*                                                                       02980000
         L     R1,PSATOLD-PSA          R1 -> CURRENT TCB                02990000
         ICM   R15,15,TCBJSTCB-TCB(R1) R15 -> JOBSTEP TCB               03000000
         BZ    PROGRB                  NO, SAY WITH CURRENT TCB         03010000
         LR    R1,R15                  R1 -> JOB STEP TCB               03020000
PROGRB   DS    0H                                                       03030000
         L     R15,TCBRBP-TCB(,R1)     R15 -> NEWEST RB FOR TCB         03040000
         USING RBBASIC,R15             MAP RB                           03050000
LOOPPROG DS    0H                                                       03060000
         XR    R14,R14                 CLEAR TO BE SURE                 03070000
         ICM   R14,7,RBLINKB           R14 -> PREVIOUS RB IN CHAIN      03080000
         BZ    SKIPPROG                NO, DEAD END                     03090000
         CR    R1,R14                  IS RB THE OLDEST ?               03100000
         BE    COPYPROG                YES, COPY PROGNAME               03110000
         LR    R15,R14                 KEEP LOOKING FOR OLDEST RB       03120000
         B     LOOPPROG                                                 03130000
COPYPROG DS    0H                                                       03140000
         XR    R1,R1                   CLEAR R1                         03150000
         ICM   R1,7,RBCDE1             R1  -> CDE                       03160000
         MVC   EVTOPROG,CDNAME-CDENTRY(R1) COPY PROGNAME FROM CDE       03170000
         LTR   R6,R6                  IS ALTUSER IND. TURNED ON WS2372  03171000
         BZ    SKIPALU                NO - SKIP IT              WS2372  03172000
         MVC   EVTOPROG,=C'ALTUSER '  YES - MOVE INDICATION     WS2372  03174000
SKIPALU  DS    0H                                               WS2372  03175000
SKIPPROG DS    0H                                                       03180000
         DROP  R15                                                      03190000
*                                                                       03200000
*        COPY USERID                                                    03210000
*                                                                       03220000
         MVC   EVTUSER,=CL8' '                                          03230000
         XR    R5,R5                   PREPARE FOR 'IC'                 03240000
         IC    R5,0(R3)                R5 = LENGTH OF USER ID           03250000
         BCTR  R5,0                    ADJUST USERID LENGTH FOR 'EX'    03260000
         MVC   EVTUSER(*-*),1(R3)      DUMMY CODE FOR 'EX'              03270000
         EX    R5,*-6                  COPY THE USERID TO EVT           03280000
*                                                                       03290000
*        COPY NEW PASSWORD                                              03300000
*                                                                       03310000
         MVC   EVTGROUP,=CL8' '                                         03320000
         XR    R5,R5                   PREPARE FOR 'IC'                 03330000
         IC    R5,0(R4)                R5 = NEW PASSWORD LENGTH         03340000
         BCTR  R5,0                    ADJUST FOR 'EX'                  03350000
         MVC   EVTGROUP(*-*),1(R4)     DUMMY CODE FOR 'EX'              03360000
         EX    R5,*-6                  COPY PASSWORD                    03370000
*WS2555  DROP  R8                                                WS2555 03380000
*                                                                       03390000
****************************************************************        03400000
*        NOTIFY SERVER VIA PC ROUTINE                                   03410000
****************************************************************        03420000
*                                                                       03430000
         MVC   SSNAME,EXPSSNAM                                          03440000
         MVC   JOBNAME,EXPJOBNM                                         03450000
         CALL  CTSAPCC,(FUJIFLAG,SSNAME,JOBNAME,(R9),PCCWORK),         X03460000
               MF=(E,CALLAREA)                                          03470000
         LTR   R15,R15                                                  03480000
         BZ    CLEANUP                                                  03490000
         CVD   R15,PACKD               CONVERT RC TO EBCDIC     IS10006 03491000
         UNPK  CHARRC,PACKD            CONVERT RC TO EBCDIC     IS10006 03491100
         OI    CHARRC+7,X'F0'          CONVERT RC TO EBCDIC     IS10006 03491200
*                                                                       03491300
         CH    R15,=H'8'               FREE CHAIN EXISTS ?       WS2555 03492000
         BE    NOFRCHN                 NO, FREE CHAIN RUN OUT    WS2555 03493000
*                                                                       03494000
         CH    R15,=H'160'                                              03500000
         BH    ERRPCC                                                   03510000
*IS10006 CTSMSG1 CODE=CTS210E,ROUT=WTO,RAREA=WTOAREA                    03520000
         CTSMSG1 CODE=CTS210E,ROUT=WTO,RAREA=WTOAREA,          IS10006 X03521000
               PLANT=(4,CHARRC+4)                              IS10006  03522000
         B     CLEANUP                                                  03530000
*                                                                       03531000
NOFRCHN  DS    0H                                                WS2555 03532000
         MVC   PGMNAME,=CL7'CTSFPWX'                            IS10012 03532100
         CTSMSG1 CODE=CTS213I,ROUT=WTO,RAREA=WTOAREA,            WS2555X03533000
               PLANT=(7,PGMNAME,8,EVTUSER)                      IS10012 03533100
*IS10012       PLANT=(8,EVTUSER)                                 WS2555 03533200
         DROP  R8                                                WS2555 03533600
         B     CLEANUP                                           WS2555 03534000
*                                                                       03540000
ERRPCC   DS    0H                                                       03550000
*IS10006 CVD   R15,PACKD               CONVERT RC TO EBCDIC             03560000
*IS10006 UNPK  CHARRC,PACKD            CONVERT RC TO EBCDIC             03570000
*IS10006 OI    CHARRC+7,X'F0'          CONVERT RC TO EBCDIC             03580000
         CTSMSG1 CODE=CTS211E,ROUT=WTO,RAREA=WTOAREA,                  X03590000
               PLANT=(4,CHARRC+4)                                       03600000
*                                                                       03610000
****************************************************************        03620000
*        ISSUE ABEND MESSGAE                                   *        03630000
****************************************************************        03640000
*                                                                       03650000
CLEANUP  DS    0H                                                       03660000
         ICM   R2,15,ABNDCODE          R2 -> ABEND CODE WORD            03670000
         BZ    NOABEND                 ZERO, NO ABEND OCCURED           03680000
         MVI   ABNDTYPE,C'U'           ASSUME USER ABNED                03690000
         N     R2,=XL4'00000FFF'       ISOLATE USER ABEND CODE          03700000
         BNZ   ABENDMSG                HAVE IT, ISSUE THE MESSAGE       03710000
         L     R2,ABNDCODE             TRY AGAIN FOR SYSTEM ABNED       03720000
         SRL   R2,12                   ISOLATE SYSTEM ABEND CODE        03730000
         MVI   ABNDTYPE,C'S'           SET SYSTEM ABEND TYPE            03740000
ABENDMSG DS    0H                                                       03750000
         ST    R2,ABNDBIN              SAVE ISOLATED ABEND CODE         03760000
         UNPK  ABNDCHAR(9),ABNDBIN(5)  CONVERT ABEND CODE TO ZONED      03770000
         TR    ABNDCHAR(8),HEX2CHAR    CONEVRT TO CHARACTERS            03780000
         MVC   ABNDCHAR+4(1),ABNDTYPE  SET ABEND TYPE CHARACTER         03790000
         CTSMSG1 CODE=CTS212S,ROUT=WTO,RAREA=WTOAREA,                  X03800000
               PLANT=(4,ABNDCHAR+4)                                     03810000
NOABEND  DS    0H                                                       03820000
*                                                                       03830000
****************************************************************        03840000
*        CLEAR RECOVERY ENVIRONMENT                            *        03850000
****************************************************************        03860000
*                                                                       03870000
         ESTAE 0                                                        03880000
*                                                                       03890000
****************************************************************        03900000
*        RELEASE WORKAREA STORAGE                              *        03910000
****************************************************************        03920000
*                                                                       03930000
         DROP  R13                                                      03940000
         LR    R1,R13                  ADDRESS FOR FREEMAIN             03950000
         L     R13,4(R13)              RESTORE CALLERS SAVE AREA        03960000
         LA    R0,WORKLEN                                               03970000
         FREEMAIN RC,LV=(R0),A=(R1)                                     03980000
         LTR   R15,R15                                                  03990000
         BZ    RETURN                                                   04000000
         WTO   'CTSFPWX: FREEMAIN FAILED ERROR'                         04010000
*                                                                       04020000
****************************************************************        04030000
*        FINISHED                                              *        04040000
****************************************************************        04050000
*                                                                       04060000
RETURN   DS    0H                                                       04070000
*                                                                       04080000
*        DECREASE EXIT USE COUNT                                        04090000
*                                                                       04100000
*                                                                       04110000
         MODESET MODE=SUP,KEY=ZERO                                      04120000
DECUSECT DS    0H                      DECREASE MODULE USE COUNT        04130000
         L     R0,EXPUSECT             DECREASE MODULE USE COUNT        04140000
         LR    R1,R0                   DECREASE MODULE USE COUNT        04150000
         BCTR  R1,0                    DECREASE MODULE USE COUNT        04160000
         CS    R0,R1,EXPUSECT          DECREASE MODULE USE COUNT        04170000
         BNZ   DECUSECT                DECREASE MODULE USE COUNT        04180000
         MODESET MODE=PROB,KEY=NZERO                                    04190000
*                                                                       04200000
****************************************************************        04210000
*        BRANCH TO NEXT EXIT IF EXISTS                         *        04220000
****************************************************************        04230000
*                                                                       04240000
NEXTEXIT DS    0H                                                       04250000
         ICM   R15,15,EXPPREV          R15 -> NEXT EXIT                 04260000
         BZ    QUIT                    NO EXIT - RETURN TO CALLER       04270000
         C     R15,=XL4'FFFFFFFF'      NO PREVIOUS ?            *CTS1   04280000
         BE    QUIT                    NO EXIT - RETURN         *CTS1   04290000
         DROP  R10                                                      04300000
         L     R14,R12(R13,0)                                           04310000
         LM    R0,R12,20(R13)                                           04320000
         BSM   R0,R15                                                   04330000
*                                                                       04340000
****************************************************************        04350000
*        TERMINATE TO CALLER                                   *        04360000
****************************************************************        04370000
*                                                                       04380000
QUIT     DS    0H                                                       04390000
         SR    R15,R15             LOAD RETURN CODE                     04400000
         RETURN (14,12),T,RC=(15)  RESTORE REGISTERS AND RETURN         04410000
*                                                                       04420000
****************************************************************        04430000
*        CONSTANTS                                             *        04440000
****************************************************************        04450000
*                                                                       04460000
         DS    0D                                                       04470000
FUJIFLAG DC    AL1(128)                                                 04480000
*                                                                       04490000
LSTESTAE ESTAE MF=L                                                     04500000
LENESTAE EQU   *-LSTESTAE                                               04510000
*                                                                       04510100
HEX2CHAR DC    256AL1(*-HEX2CHAR)                                       04520000
         ORG   HEX2CHAR+X'FA'                                           04530000
         DC    CL6'ABCDEF'                                              04540000
         ORG   ,                                                        04550000
*                                                                       04560000
         LTORG ,                                                        04570000
         DROP  ,                                                        04580000
*                                                                       04590000
****************************************************************        04600000
*        ABEND RECOVERY ROUTINE                                *        04610000
****************************************************************        04620000
*                                                                       04630000
ABNDEXIT DS    0H                                                       04640000
         USING ABNDEXIT,R15            ABEND EXIT ADDRESSABILITY        04650000
         L     R12,=A(CTSFPWX)         RESTORE LMOD BASE REG            04660000
         DROP  R15                                             SAS2IBMN 04661000
         USING CTSFPWX,R12             RESTORE ITS ADDRESSABILITY       04670000
*SAS2IBMN DROP  R15                     USE LMOD ADDRESSABILITY         04680000
         C     R0,=F'12'               SDWA PROVIDED ?                  04690000
         BE    NOSDWA                  NO, CAN NOT RETRY                04700000
         USING SDWA,R1                 MAP SDWA                         04710000
         L     R13,SDWAPARM            RESTORE WORKAREA REGISTER        04720000
         USING WORKAREA,R13            MAP WORKAREA                     04730000
         MVC   ABNDCODE,SDWAABCC       SET ABEND CODE                   04740000
         TM    SDWAERRD,SDWACLUP       RETRY ALLOWED ?                  04750000
         BNZ   NORETRY                 NO, CAN NOT RETRY                04760000
*                                                                       04770000
RETRY    DS    0H                                                       04780000
         ST    R12,SDWASR12            SET BASE REGISTER FOR RETRY      04790000
         ST    R13,SDWASR13            SET WORKAREA REGISTER FOR RETRY  04800000
         MVC   SDWASR10,ADDREXP                                         04810000
         SETRP RETREGS=YES,RC=4,RETADDR=CLEANUP,                       X04820000
               FRESDWA=YES,DUMP=YES                                     04830000
         BR    R14                                                      04840000
*                                                                       04850000
NOSDWA   DS    0H                                                       04860000
         LR    R13,R2                   NO SDWA, PARM IN R2             04870000
         ST    R1,ABNDCODE              SAVE ABEND CODE                 04880000
         XR    R1,R1                    CLEAR                           04890000
NORETRY  DS    0H                                                       04900000
         XR    R15,R15                  INDICATE NO RETRY               04910000
         BR    R14                      RETURN TO RTM                   04920000
         LTORG                                                          04930000
         DROP                                                           04940000
*                                                                       04950000
****************************************************************        04960000
*        DYNAMIC WORK AREA DSECT                               *        04970000
****************************************************************        04980000
*                                                                       04990000
WORKAREA DSECT                                                          05000000
SAVEAREA DS    18F                     SAVE AREA TO CALL OTHERS         05010000
CALLAREA CALL  ,(,,,,),MF=L            EXECUTE FORM CALL AREA           05020000
PCCWORK  DS    XL512                   WORK AREA FOR CTSAPCC ROUTINE    05030000
RQCAREA  DS    CL(RQCLEN)              AREA FOR RQC                     05040000
PACKD    DS    D                       RETURN CODE CONVERSION           05050000
CHARRC   DS    CL8                     RETURN CODE CONVERSION           05060000
WTOAREA  DS    XL384                   CTSMSG1 WTO WORK AREA            05070000
ABNDCODE DS    XL4                     ABCODE SAVED BY ESTAE ROUTINE    05080000
ABNDBIN  DS    XL5                     ISOLATED ABEND CODE + PAD BYTE   05090000
ABNDTYPE DS    CL1                     ABEND TYPE (S/U)                 05100000
ABNDCHAR DS    CL9                     CHARCTER ABEND CODE FOR CTSMSG   05110000
WRKESTAE DS    CL(LENESTAE)            EXECUTE FORM FOR ESTAE           05120000
ADDREXP  DS    A                       SAVE EXP ADDR FOR ABEND RETRY    05130000
SSNAME   DS    CL4                     SSNAME FROM EXP                  05140000
JOBNAME  DS    CL8                     JOBNAME FROM EXP                 05150000
RESERVED DS    16X                     RESERVED AREA                    05160000
PGMNAME  DS    CL7                     PROGRAM NAME FOR MSG     IS10012 05161000
WORKLEN  EQU   *-WORKAREA                                               05170000
*                                                                       05180000
****************************************************************        05190000
*        CONTROL-SA/IOA CONTROL BLOCKS                         *        05200000
****************************************************************        05210000
*                                                                       05220000
RQC      DSECT                                                          05230000
         COPY  CTSRQC                  XMS REQUEST ELEMENT              05240000
EVT      DSECT                                                          05250000
         COPY  CTSEVT                  EVENT CONTROL BLOCK              05260000
EXP      DSECT                                                          05270000
         COPY  CTSAEXP                  MODULE PREFIX                   05280000
*                                                                       05290000
****************************************************************        05300000
*        SYSTEM CONTROL BLOCKS                                 *        05310000
****************************************************************        05320000
*                                                                       05330000
         ICHPWXP                                                        05340000
         IHASDWA                                                        05350000
         IHAPSA                                                         05360000
         CVT   DSECT=YES                                                05370000
         IHAASCB                                                        05380000
         IHAASXB                                                        05390000
         IHAACEE                                                        05400000
         IKJTCB                                                         05410000
         IHARB                                                          05420000
         IHACDE                                                         05430000
         END                                                            05440000
