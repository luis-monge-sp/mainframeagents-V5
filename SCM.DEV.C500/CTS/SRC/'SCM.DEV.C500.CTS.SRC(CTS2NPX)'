         TITLE 'CONTROL-SA ACFNPXIT EXIT FOR ONLINE INTERCEPTOR'        00010000
*                                                                       00020000
*********************************************************************** 00030000
****                                                               **** 00040000
****       CONTRL-SA RELEASE 2.1.0                                 **** 00050000
****                                                               **** 00060000
****       LICENSED MATERIAL - EAGLEEYE CONTROL SOFTWARE LTD.      **** 00070000
****                                                               **** 00080000
*********************************************************************** 00090000
*                                                                       00100000
*********************************************************************** 00100100
*                                                                     * 00100200
* MODULE NAME : CTS2NPX                                               * 00100300
*                                                                     * 00100400
* DESCRIPTION : SA-AGENT ACF2 NEW PASSWORD EXIT (NEWPXIT)             * 00100500
*                                                                     * 00100600
* FUNCTION:                                                           * 00100700
*                                                                     * 00100800
*    NEWPXIT IS ACF2 NEW PASSWORD EXIT WHICH SA-AGENT USES FOR        * 00100900
*    PASSWORD SYNCRONIZTION SUPPORT.                                  * 00101000
*    THE EXIT INTERCEPTS PASSWORD CHANGES AND NOTIFIES SA-AGENT       * 00101100
*    ONLINE INTERCEPTOR SERVER VIA CROSS MEMORY SERVICES OF THE EVENT.* 00101200
*                                                                     * 00101300
* ATTRIBUTES  : THE EXIT MODULE SHOULD BE LINK-EDITED WITH RMODE ANY  * 00101400
*               AND AMODE 31 , REUSABLE AND REENTRABLE .              * 00101500
*                                                                     * 00101600
* ENVIRONMENT : THE EXIT RECEIVES CONTROL IN SUPERVISOR STATE ,       * 00101700
*               KEY 0 .                                               * 00101800
*                                                                     * 00101900
* RESTRICTIONS : NONE                                                 * 00102000
*                                                                     * 00102100
* DEPENDENCIES : THE CODE USES THE DEFINITION IN MEMEBR CTSADEFS FOR  * 00102200
*                TO CALL THE ONLINE INTERCEPTOR SERVER, THEREFORE     * 00102300
*                THIS EXIT SHOULD BE RE-INSTALLED AFTER A CHANGE      * 00102400
*                IN THE CTSDEFS MEMEBR .                              * 00102500
*                                                                     * 00102600
* REGISTER USAGE :  R0  -  TEMPORARY WORK REGISTER                    * 00102700
*                   R1  -  TEMPORARY WORK REGISTER                    * 00102800
*                   R2  -  TEMPORARY WORK REGISTER                    * 00102900
*                   R3  -> ACVALD/ACALT PARAM BLOCK                   * 00103000
*                   R4  -> NEW PASSWORD                               * 00103100
*BS2442             R5  -> CTS210E MESSAGES COUNTER                   * 00103200
*                   R6  -  NOT USED                                   * 00103300
*                   R7  -  NOT USED                                   * 00103400
*                   R8  -> EVT                                        * 00103500
*                   R9  -> RQC                                        * 00103600
*                   R10 -> EXP AREA                                   * 00103700
*                   R11 -> PARAMETER LIST                             * 00103800
*                   R12 -> PROGRAM BASE                               * 00103900
*                   R13 -> DYNAMIC WORK AREA (SVAE AREA)              * 00104000
*                   R14 -  RETURN ADDRESS                             * 00104100
*                   R15 -  RETURN CODE                                * 00104200
*                                                                     * 00104300
* INPUT :                                                             * 00104400
*                                                                     * 00104500
*    REGISTER 1 POINTS TO A NEWPXIT PARAMETER LIST                    * 00104600
*                                                                     * 00104700
*        +0 - ADDR OF ACVALD OR ACALT PARM BLOCK                      * 00104800
*             (INSPECT 1ST BYTE FOR FUNCTION CODE                     * 00104900
*              AN 01 FOR ACVALD AND 02 FOR ACALT)                     * 00105000
*        +4 - ADDR OF 8-CHAR. NEW PASSWORD                            * 00105100
*        +8 - ADDR OF LOGONID RECORD.                                 * 00105200
*                                                                     * 00105300
* OUTPUT:                                                             * 00105400
*                                                                     * 00105500
*    THIS EXIT ALWAYS RETURNS A RETURN CODE OF 0 .                    * 00105600
*                                                                     * 00105700
* NEWPXIT RETURN CODES ARE :                                          * 00105800
*                                                                     * 00105900
*        0 - CONTINUE, PASSWORD IS VALID                              * 00106000
*        4 - ERROR, MESSAGE RETURNED IN SVCA                          * 00106100
*            PARM BLOCK (ACVALD OR ACALT).                            * 00106200
*        8 - ERROR, USE STANDARD ACF2 MESSAGE                         * 00106300
*                                                                     * 00106400
* CHANGE ACTIVITY :                                                   * 00106500
*                                                                     * 00106600
*    16/07/97         DC CREATED                                      * 00106700
*    08/12/00 BS2442  AS LOOP PROTECTION MECHANISM                    * 00106800
*    10/07/07 IS10006 AL ADD RC TO CTS210E                            * 00106900
*    08/04/08 IS10012 AL NOTIFY WHEN NO FREE RQC IS LEFT IN CHAIN     * 00107000
*                                                                     * 00107100
*********************************************************************** 00107300
* SAS2IBMN NURITY   17/12/16 RMODE CHANGED FROM 24 TO ANY.            * 00107401
*********************************************************************** 00107601
*                                                                       00107701
CTS2NPX  CSECT ,                                                        00107801
CTS2NPX  AMODE 31                                                       00107901
*SAS2IBMN CTS2NPX  RMODE 24                                             00108001
CTS2NPX  RMODE ANY                                             SAS2IBMN 00108101
*                                                                       00108201
*--------------------------------------------------------------*        00108301
*        REGISTERS USAGE                                       *        00108401
*--------------------------------------------------------------*        00108501
*                                                                       00108601
R0       EQU   0                                                        00108701
R1       EQU   1                                                        00109000
R2       EQU   2                                                        00110000
R3       EQU   3                                                        00120000
R4       EQU   4                                                        00130000
R5       EQU   5                                                        00140000
R6       EQU   6                                                        00150000
R7       EQU   7                                                        00160000
R8       EQU   8                                                        00170000
R9       EQU   9                                                        00180000
R10      EQU   10                                                       00190000
R11      EQU   11                                                       00200000
R12      EQU   12                                                       00210000
R13      EQU   13                                                       00220000
R14      EQU   14                                                       00230000
R15      EQU   15                                                       00240000
*                                                                       00250000
****************************************************************        00260000
*        PROLOG CODE                                           *        00270000
****************************************************************        00280000
*                                                                       00290000
         SAVE  (14,12),,CTS2NPX-&SYSDATE-&SYSTIME                       00300000
         LR    R12,R15                                                  00310000
         USING CTS2NPX,R12                                              00320000
         CTSLEVEL ,                                                     00330000
         SR    R5,R5                   RESET CTS210E MSG COUNTER BS2442 00340000
         LR    R11,R1                  R11 -> PARAMETERS LIST           00350000
         USING PRMNPXIT,R11            ADDRESSABILITY                   00360000
*                                                                       00370000
****************************************************************        00380000
*        CHECK MODULE HEADER                                            00390000
****************************************************************        00400000
*                                                                       00410000
         LR    R10,R12                                                  00420000
         S     R10,=A(EXPLEN)          R10 -> EXIT PREFIX               00430000
         USING EXP,R10                                                  00440000
         CLC   =CL4'CSAX',EXPID        ARE WE OK ?                      00450000
         BE    CHKZOMBI                NO - WHAT THE ???                00460000
         WTO   'CTS2NPX: EXIT OVERLAYED. NO MODULE HEADER'              00470000
         B     QUIT                                                     00480000
*                                                                       00490000
****************************************************************        00500000
*        IF EXIT IS DISABLED, CONTINUE WITH NEXT ONE                    00510000
****************************************************************        00520000
*                                                                       00530000
CHKZOMBI DS    0H                                                       00540000
         TM    EXPFLAGS,EXPZOMBI       WAS EXIT DISABLED ?              00550000
         BO    NEXTEXIT                YES, SIMPLY DO NOTHING           00560000
*                                                                       00570000
****************************************************************        00580000
*        VERIFY CALLERS, NEWPW AND USERID                               00590000
****************************************************************        00600000
*                                                                       00610000
         L     R3,PBLK                 R3 -> PARAMETERS BLOCK           00620000
         CLI   0(R3),X'02'             ACALT AND ACVALD REQ ?           00630000
         BH    NEXTEXIT                NO, LEAVE                        00640000
*                                                                       00650000
****************************************************************        00660000
*        INCREASE MODULE USE COUNT                                      00670000
****************************************************************        00680000
INCUSECT DS    0H                      INCREASE MODULE USE COUNT        00690000
         L     R1,EXPUSECT             INCREASE MODULE USE COUNT        00700000
         LA    R0,1(R1)                INCREASE MODULE USE COUNT        00710000
         CS    R1,R0,EXPUSECT          INCREASE MODULE USE COUNT        00720000
         BNZ   INCUSECT                INCREASE MODULE USE COUNT        00730000
*                                                                       00740000
****************************************************************        00750000
*        OBTAIN WORKAREA                                       *        00760000
****************************************************************        00770000
*                                                                       00780000
GETWORK  DS    0H                                                       00790000
         GETMAIN RC,LV=WORKLEN                                          00800000
         LTR   R15,R15                                                  00810000
         BZ    CHAINSA                                                  00820000
         WTO   'CTS2NPX: GETMAIN FAILED ERROR'                          00830000
         B     RETURN                                                   00840000
CHAINSA  DS    0H                                                       00850000
         ST    R1,8(R13)               CHAIN                            00860000
         ST    R13,4(R1)               SAVE AREAS                       00870000
         LR    R13,R1                  ESTABLISH WORK AREA              00880000
         USING WORKAREA,R13               ADDRESSABILITY                00890000
*                                                                       00900000
****************************************************************        00910000
*        CREATE RECOVERY ENVIRONMENT                                    00920000
****************************************************************        00930000
*                                                                       00940000
         ST    R10,ADDREXP             SAVE EXP FOR ABEND RETRY         00950000
         XC    ABNDCODE,ABNDCODE       CLEAR ABEND CODE                 00960000
         MVC   WRKESTAE,LSTESTAE                                        00970000
         ESTAE ABNDEXIT,PARAM=WORKAREA,TERM=YES,MF=(E,WRKESTAE)         00980000
*                                                                       00990000
****************************************************************        01000000
*        BUILD RQC AND EVT                                     *        01010000
****************************************************************        01020000
*                                                              *        01030000
* 'RQC' IS THE 'REQUEST CONTROL BLOCK' WHICH IS USED BY THE PC *        01040000
* ROUTINES TO PASS INFORMATION TO THE CONTROL-SA ONLINE        *        01050000
* INTERCEPTOR .                                                *        01060000
*                                                              *        01070000
* 'EVT' IS THE 'EVENT CONTROL BLOCK' WHICH IS IMBEDED IN THE   *        01080000
* REQUEST BLOCK FOR 'NOTIFY REQUESTS' . IT DESCRIBES THE       *        01090000
* EVENT THAT OCCURED INCLUDING THE ENTITY (USER, GROUP ETC...) *        01100000
* AND THE EVENT ACTION TYPE (ADD, DELETED, MODIFY, PASSWORD    *        01110000
* CHANGED, ETC...) .                                           *        01120000
*                                                              *        01130000
* THE FOLLOWING CODE FORMATS THESE CONTROL BLOCKS AND FILL THEM*        01140000
* WITH THE RELEVANT INFO SO THEY CAN BE PASSED ON TO THE PC    *        01150000
* ROUTINES AND BE TRANSFERED TO THE ONLINE INTERCEPTOR SERVER. *        01160000
*                                                              *        01170000
****************************************************************        01180000
*                                                                       01190000
*        INITIALIZE RQC                                                 01200000
*                                                                       01210000
*PS0244  XC    RQCAREA,RQCAREA         CLEAR LOCAL RQC AREA             01220000
         LA    R0,RQCAREA              CLEAR THE AREA           PS0244  01230000
         LA    R1,RQCLEN               SET LENGTH               PS0244  01240000
         XR    R15,R15                 PADD WITH X'00'          PS0244  01250000
         MVCL  R0,R14                  CLEAR                    PS0244  01260000
         LA    R9,RQCAREA              R9 -> LOACL RQC AREA             01270000
         USING RQC,R9                  MAP IT                           01280000
*PS0244  MVI   RQCTYPE,RQCTNOT         REQUEST TYPE IS 'NOTIFY'         01290000
         MVI   RQCTYPE,RQCTNOTX        REQUEST TYPE IS 'NOTIFY' PS0244  01300000
*                                                                       01310000
*        INITIALIZE EVT                                                 01320000
*                                                                       01330000
         LA    R8,RQCEVT               R8 -> EVT                        01340000
         USING EVT,R8                  MAP EVENT BLOCK                  01350000
         MVC   EVTEVT,=CL4'EVT '       SETUP EYE CATCHER                01360000
         MVC   EVTFLAG,=A(EVTFULL)     EVT IS LOADED WITH DATA          01370000
         MVC   EVTTIME,RQCTSTMP        SET EVENT TIME                   01380000
         MVC   EVTDATE,RQCTSTMP+4      SET EVENT DATA                   01390000
         L     R4,PNEWP                R4 -> NEW PASSWORD               01400000
         CLI   0(R3),X'01'             ACVALD REQ ?                     01410000
         BE    SETVALD                 YES, HANDLE IT                   01420000
*                                                                       01430000
*        SET EVENT DETAILS  (ACALT)                                     01440000
*                                                                       01450000
         MVI   EVTTYPE,EVTTUSER        EVENT TYPE = USER                01460000
         MVI   EVTACT,EVTAPSWD         ACTION = PASSWORD CHANGE         01470000
         MVC   EVTGROUP,0(R4)          PASSWORD                         01480000
         MVC   EVTUSER,ACALID-ACALT(R3) LOGONID                         01490000
         B     SETORG                                                   01500000
*                                                                       01510000
*        SET EVENT DETAILS  (ACVALD)                                    01520000
*                                                                       01530000
SETVALD  DS    0H                                                       01540000
         MVI   EVTTYPE,EVTTUSER        EVENT TYPE = USER                01550000
         MVI   EVTACT,EVTAPSWD         ACTION = PASSWORD CHANGE         01560000
         MVC   EVTGROUP,0(R4)          NEW PASSWORD                     01570000
         CLI   0(R4),C' '              NEW PASSWORD NULL ?              01580000
         BNH   SETVLID                 NO, USE IT                       01590000
* BS2419 MVC   EVTGROUP,ACVPSWD-ACVALD(R3) TAKE PASSWORD FROM ACVALD    01600000
* BS2419       TAKE PASSWORD FROM ACVALD                                01610000
         MVC   EVTGROUP,ACVNPSWD-ACVALD(R3)                      BS2419 01620000
SETVLID  DS    0H                                                       01630000
         MVC   EVTUSER,ACVLID-ACVALD(R3) COPY LOGONID FROM ACVALD       01640000
         B     SETORG                                                   01650000
*                                                                       01660000
*        SET ORIGINATOR DETAILS FROM LID RECORD                         01670000
*                                                                       01680000
SETORG   DS    0H                                                       01690000
         L     R1,PSAAOLD-PSA            R1 -> ASCB                     01700000
         ICM   R15,15,ASCBJBNI-ASCB(R1)  JOBNAME EXISTS ?               01710000
         BNZ   COPYOJBN                  YES, THEN COPY IT              01720000
         ICM   R15,15,ASCBJBNS-ASCB(R1)  STCNAME EXISTS ?               01730000
         BZ    SKIPOJBN                  NO, NOTHING CAN BE COPIED      01740000
COPYOJBN DS    0H                                                       01750000
         MVC   EVTOJBN,0(R15)            COPY JOBNAME/STCNAME           01760000
SKIPOJBN DS    0H                                                       01770000
*                                                                       01780000
         L     R1,PLID                   R1 -> LID RECORD               01790000
         MVC   EVTOUID,LIDLID-LIDREC(R1)                                01800000
*                                                                       01810000
*IS10012 DROP  R8                                                       01820000
*                                                                       01830000
****************************************************************        01840000
*        NOTIFY SERVER VIA PC ROUTINE                                   01850000
****************************************************************        01860000
*                                                                       01870000
         MVC   SSNAME,EXPSSNAM                                          01880000
         MVC   JOBNAME,EXPJOBNM                                         01890000
         CALL  CTSAPCC,(FUJIFLAG,SSNAME,JOBNAME,(R9),PCCWORK),         X01900000
               MF=(E,CALLAREA)                                          01910000
         LTR   R15,R15                                                  01920000
         BZ    CLEANUP                                                  01930000
         CVD   R15,PACKD               CONVERT RC TO EBCDIC     IS10006 01931000
         UNPK  CHARRC,PACKD            CONVERT RC TO EBCDIC     IS10006 01932000
         OI    CHARRC+7,X'F0'          CONVERT RC TO EBCDIC     IS10006 01933000
*                                                                       01933100
         CH    R15,=H'8'               FREE CHAIN EXISTS ?      IS10012 01934000
         BE    NOFRCHN                 NO, FREE CHAIN RUN OUT   IS10012 01935000
*                                                                       01936000
         CH    R15,=H'160'                                              01940000
         BH    ERRPCC                                                   01950000
         LTR   R5,R5                   CHECK CTS210E CNTR        BS2442 01951000
         BZ    SEND210E                                          BS2442 01952000
         WTO   'CTS2NPX: CTS210E COUNTER > 1. QUIT'              BS2442 01953000
         BNZ   SETZOMBI                LOOP ?, EXIT              BS2442 01953100
SEND210E DS    0H                                                BS2442 01953200
         CTSMSG1 CODE=CTS210E,ROUT=WTO,RAREA=WTOAREA,                  *01953300
               PLANT=(4,CHARRC+4)                               IS10006 01953400
         LA    R5,1(R5)                CTS210E CNTR+1            BS2442 01953500
         B     CLEANUP                                                  01953600
*                                                                       01953700
NOFRCHN  DS    0H                                               IS10012 01953800
         MVC   PGMNAME,=CL7'CTS2NPX'                            IS10012 01953900
         CTSMSG1 CODE=CTS213I,ROUT=WTO,RAREA=WTOAREA,           IS10012X01954000
               PLANT=(7,PGMNAME,8,EVTUSER)                      IS10012 01954100
         DROP  R8                                               IS10012 01954600
         B     CLEANUP                                          IS10012 01954700
*                                                                       01954800
ERRPCC   DS    0H                                                       01954900
*IS10006 CVD   R15,PACKD               CONVERT RC TO EBCDIC             01955000
*IS10006 UNPK  CHARRC,PACKD            CONVERT RC TO EBCDIC             01955100
*IS10006 OI    CHARRC+7,X'F0'          CONVERT RC TO EBCDIC             01955200
         CTSMSG1 CODE=CTS211E,ROUT=WTO,RAREA=WTOAREA,                  X01955300
               PLANT=(4,CHARRC+4)                                       01956000
*                                                                       01957000
****************************************************************        01958000
*        ISSUE ABEND MESSGAE                                   *        01959000
****************************************************************        01960000
*                                                                       01970000
CLEANUP  DS    0H                                                       01980000
         ICM   R2,15,ABNDCODE          R2 -> ABEND CODE WORD            01990000
         BZ    NOABEND                 ZERO, NO ABEND OCCURED           02000000
         MVI   ABNDTYPE,C'U'           ASSUME USER ABNED                02010000
         N     R2,=XL4'00000FFF'       ISOLATE USER ABEND CODE          02020000
         BNZ   ABENDMSG                HAVE IT, ISSUE THE MESSAGE       02030000
         L     R2,ABNDCODE             TRY AGAIN FOR SYSTEM ABNED       02040000
         SRL   R2,12                   ISOLATE SYSTEM ABEND CODE        02050000
         MVI   ABNDTYPE,C'S'           SET SYSTEM ABEND TYPE            02060000
ABENDMSG DS    0H                                                       02070000
         ST    R2,ABNDBIN              SAVE ISOLATED ABEND CODE         02080000
         UNPK  ABNDCHAR(9),ABNDBIN(5)  CONVERT ABEND CODE TO ZONED      02090000
         TR    ABNDCHAR(8),HEX2CHAR    CONEVRT TO CHARACTERS            02100000
         MVC   ABNDCHAR+4(1),ABNDTYPE  SET ABEND TYPE CHARACTER         02110000
         CTSMSG1 CODE=CTS212S,ROUT=WTO,RAREA=WTOAREA,                  X02120000
               PLANT=(4,ABNDCHAR+4)                                     02130000
NOABEND  DS    0H                                                       02140000
*                                                                       02150000
****************************************************************        02160000
*        CLEAR RECOVERY ENVIRONMENT                            *        02170000
****************************************************************        02180000
*                                                                       02190000
         ESTAE 0                                                        02200000
*                                                                       02210000
****************************************************************        02220000
*        RELEASE WORKAREA STORAGE                              *        02230000
****************************************************************        02240000
*                                                                       02250000
         DROP  R13                                                      02260000
         LR    R1,R13                  ADDRESS FOR FREEMAIN             02270000
         L     R13,4(R13)              RESTORE CALLERS SAVE AREA        02280000
         LA    R0,WORKLEN                                               02290000
         FREEMAIN RC,LV=(R0),A=(R1)                                     02300000
         LTR   R15,R15                                                  02310000
         BZ    RETURN                                                   02320000
         WTO   'CTS2NPX: FREEMAIN FAILED ERROR'                         02330000
*                                                                       02340000
****************************************************************        02350000
*        FINISHED                                              *        02360000
****************************************************************        02370000
*                                                                       02380000
RETURN   DS    0H                                                       02390000
*                                                                       02400000
*        DECREASE EXIT USE COUNT                                        02410000
*                                                                       02420000
DECUSECT DS    0H                      DECREASE MODULE USE COUNT        02430000
         L     R0,EXPUSECT             DECREASE MODULE USE COUNT        02440000
         LR    R1,R0                   DECREASE MODULE USE COUNT        02450000
         BCTR  R1,0                    DECREASE MODULE USE COUNT        02460000
         CS    R0,R1,EXPUSECT          DECREASE MODULE USE COUNT        02470000
         BNZ   DECUSECT                DECREASE MODULE USE COUNT        02480000
*                                                                       02490000
****************************************************************        02500000
*        BRANCH TO NEXT EXIT IF EXISTS                         *        02510000
****************************************************************        02520000
*                                                                       02530000
NEXTEXIT DS    0H                                                       02540000
         ICM   R15,15,EXPPREV          R15 -> NEXT EXIT                 02550000
         BZ    QUIT                    NO EXIT - RETURN TO CALLER       02560000
         C     R15,=XL4'FFFFFFFF'      NO PREVIOUS ?            *CTS1   02570000
         BE    QUIT                    NO EXIT - RETURN         *CTS1   02580000
         CR    R15,R12                 CALL ITSELF ? LOOP ?      BS2442 02590000
         BE    NEXTNOK                 EXIT                      BS2442 02600000
         BL    NEXTEXOK                R15 < R12, OK             BS2442 02610000
         ICM   R10,B'1111',EXPMODLN    GET MODULE LENGTH         BS2442 02620000
         AR    R10,R12                 END ADDR OF EXIT          BS2442 02630000
         CR    R15,R10                 CHECK THE ADDR            BS2442 02640000
         BNH   NEXTNOK                 CALL INSIDE THE EXIT      BS2442 02650000
NEXTEXOK DS    0H                                                       02660000
         DROP  R10                                                      02670000
         L     R14,R12(R13,0)                                           02680000
         LM    R0,R12,20(R13)                                           02690000
         BSM   R0,R15                                                   02700000
NEXTNOK  DS    0H                                                BS2442 02710000
         WTO   'CTS2NPX: SELFCALL REJECTED'                      BS2442 02720000
         B     QUIT                                                     02730000
*                                                                       02740000
****************************************************************        02750000
* BS2442. SET ZOMBI AND QUIT                                   *        02760000
****************************************************************        02770000
*                                                                       02780000
SETZOMBI DS    0H                                                BS2442 02790000
         WTO   'CTS2NPX: AUTO DISABLED'                          BS2442 02790100
         LR    R10,R12                                           BS2442 02790200
         S     R10,=A(EXPLEN)          R10 -> EXIT PREFIX        BS2442 02790300
         USING EXP,R10                                           BS2442 02790400
         OI    EXPFLAGS,EXPZOMBI       DISABLE EXIT              BS2442 02790500
         B     QUIT                                              BS2442 02790600
         DROP  R10                                               BS2442 02790700
*                                                                       02790800
****************************************************************        02790900
*        TERMINATE TO CALLER                                   *        02791000
****************************************************************        02792000
*                                                                       02793000
QUIT     DS    0H                                                       02794000
         SR    R15,R15             LOAD RETURN CODE                     02795000
         RETURN (14,12),T,RC=(15)  RESTORE REGISTERS AND RETURN         02796000
*                                                                       02797000
****************************************************************        02798000
*        CONSTANTS                                             *        02799000
****************************************************************        02800000
*                                                                       02810000
         DS    0D                                                       02820000
FUJIFLAG DC    AL1(128)                                                 02830000
*                                                                       02840000
LSTESTAE ESTAE MF=L                                                     02850000
LENESTAE EQU   *-LSTESTAE                                               02860000
HEX2CHAR DC    256AL1(*-HEX2CHAR)                                       02870000
         ORG   HEX2CHAR+X'FA'                                           02880000
         DC    CL6'ABCDEF'                                              02890000
         ORG   ,                                                        02900000
         LTORG ,                                                        02920000
         DROP  ,                                                        02930000
*                                                                       02940000
****************************************************************        02950000
*        ABEND RECOVERY ROUTINE                                *        02960000
****************************************************************        02970000
*                                                                       02980000
ABNDEXIT DS    0H                                                       02990000
         USING ABNDEXIT,R15            ABEND EXIT ADDRESSABILITY        03000000
         L     R12,=A(CTS2NPX)         RESTORE LMOD BASE REG            03010000
         DROP  R15                     USE LMOD ADDRESSABILITY          03020000
         USING CTS2NPX,R12             RESTORE ITS ADDRESSABILITY       03030000
         C     R0,=F'12'               SDWA PROVIDED ?                  03040000
         BE    NOSDWA                  NO, CAN NOT RETRY                03050000
         USING SDWA,R1                 MAP SDWA                         03060000
         L     R13,SDWAPARM            RESTORE WORKAREA REGISTER        03070000
         USING WORKAREA,R13            MAP WORKAREA                     03080000
         MVC   ABNDCODE,SDWAABCC       SET ABEND CODE                   03090000
         TM    SDWAERRD,SDWACLUP       RETRY ALLOWED ?                  03100000
         BNZ   NORETRY                 NO, CAN NOT RETRY                03110000
*                                                                       03120000
RETRY    DS    0H                                                       03130000
         ST    R12,SDWASR12            SET BASE REGISTER FOR RETRY      03140000
         ST    R13,SDWASR13            SET WORKAREA REGISTER FOR RETRY  03150000
         MVC   SDWASR10,ADDREXP                                         03160000
         SETRP RETREGS=YES,RC=4,RETADDR=CLEANUP,                       X03170000
               FRESDWA=YES,DUMP=YES                                     03180000
         BR    R14                                                      03190000
*                                                                       03200000
NOSDWA   DS    0H                                                       03210000
         LR    R13,R2                   NO SDWA, PARM IN R2             03220000
         ST    R1,ABNDCODE              SAVE ABEND CODE                 03230000
         XR    R1,R1                    CLEAR                           03240000
NORETRY  DS    0H                                                       03250000
         XR    R15,R15                  INDICATE NO RETRY               03260000
         BR    R14                      RETURN TO RTM                   03270000
         LTORG                                                          03280000
         DROP                                                           03290000
*                                                                       03300000
****************************************************************        03310000
*        DYNAMIC WORK AREA DSECT                               *        03320000
****************************************************************        03330000
*                                                                       03340000
WORKAREA DSECT                                                          03350000
SAVEAREA DS    18F                     SAVE AREA TO CALL OTHERS         03360000
CALLAREA CALL  ,(,,,,),MF=L            EXECUTE FORM CALL AREA           03370000
PCCWORK  DS    XL512                   WORK AREA FOR CTSAPCC ROUTINE    03380000
RQCAREA  DS    CL(RQCLEN)           @  AREA FOR RQC                     03390000
PACKD    DS    D                       RETURN CODE CONVERSION           03400000
CHARRC   DS    CL8                     RETURN CODE CONVERSION           03410000
WTOAREA  DS    XL384                   CTSMSG1 WTO WORK AREA            03420000
ABNDCODE DS    XL4                     ABCODE SAVED BY ESTAE ROUTINE    03430000
ABNDBIN  DS    XL5                     ISOLATED ABEND CODE + PAD BYTE   03440000
ABNDTYPE DS    CL1                     ABEND TYPE (S/U)                 03450000
ABNDCHAR DS    CL9                     CHARCTER ABEND CODE FOR CTSMSG   03460000
WRKESTAE DS    CL(LENESTAE)            EXECUTE FORM FOR ESTAE           03470000
ADDREXP  DS    A                       SAVE EXP ADDR FOR ABEND RETRY    03480000
SSNAME   DS    CL4                     SSNAME FROM EXP                  03490000
JOBNAME  DS    CL8                     JOBNAME FROM EXP                 03500000
RESERVED DS    16X                     RESERVED AREA                    03510000
PGMNAME  DS    CL7                     PROGRAM NAME FOR MSG     IS10012 03511000
WORKLEN  EQU   *-WORKAREA                                               03520000
*                                                                       03530000
****************************************************************        03540000
*        CONTROL-SA/IOA CONTROL BLOCKS                         *        03550000
****************************************************************        03560000
*                                                                       03570000
RQC      DSECT                                                          03580000
         COPY  CTSRQC                  XMS REQUEST ELEMENT              03590000
EVT      DSECT                                                          03600000
         COPY  CTSEVT                  EVENT CONTROL BLOCK              03610000
EXP      DSECT                                                          03620000
         COPY  CTSAEXP                  MODULE PREFIX                   03630000
*                                                                       03640000
****************************************************************        03650000
*        ACF2 DSECTS                                           *        03660000
****************************************************************        03670000
*                                                                       03680000
PRMNPXIT DSECT                                                          03690000
PBLK     DS    A            ACVALD/ACALT PARAMETERS BLOCK               03700000
PNEWP    DS    A            NEW PASSWORD                                03710000
PLID     DS    A            LOGONID RECORD                              03720000
*                                                                       03730000
         ACVALD                                                         03740000
         ACALT                                                          03750000
         LIDREC                                                         03760000
         ACCVT ,                                                        03770000
*                                                                       03780000
****************************************************************        03790000
*        SYSTEM CONTROL BLOCKS                                 *        03800000
****************************************************************        03810000
*                                                                       03820000
         IHASDWA                                                        03830000
         IHAPSA                                                         03840000
         CVT   DSECT=YES                                                03850000
         IHAASCB                                                        03860000
         IHAASXB                                                        03870000
         IHAACEE                                                        03880000
         IKJTCB                                                         03890000
         IHARB                                                          03900000
         IHACDE                                                         03910000
         END                                                            03920000
