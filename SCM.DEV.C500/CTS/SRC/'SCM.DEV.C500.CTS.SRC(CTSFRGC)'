         TITLE 'LIST USER->GROUP CONNECT INFO FROM RACF DATA BASE'      00010000
****************************************************************        00020000
****                                                        ****        00030000
****     CONTROL-SA  RELEASE 1.3.0                          ****        00040000
****                                                        ****        00050000
****     LICENCED MATERIAL - NEW DIMENSION SOFTWARE LTD.    ****        00060000
****                                                        ****        00070000
****************************************************************        00080000
*                                                                       00090000
****************************************************************        00100000
*                                                              *        00110000
* TITLE            : CTSFRGC                                   *        00120000
*                                                              *        00130000
* FILE NAME        : CTSFRGC                                   *        00140000
*                                                              *        00150000
* AUTHOR           : ALEX SHVARTSMAN                           *        00160000
*                                                              *        00170000
* CREATION DATE    : 05/05/94                                  *        00180000
*                                                              *        00190000
* DESCRIPTION      : LIST CONNECT INFORMATION                  *        00200000
*                    OF A CERTAIN USER                         *        00210000
*                                                              *        00220000
* ASSUMPTIONS AND                                              *        00230000
*   CONSIDERATIONS : PROGRAM WHICH CALL TO MUST BE AUTHORIZED  *        00240000
*                                                              *        00250000
****************************************************************        00260000
*                                                                       00270000
****************************************************************        00280000
* MOD.ID   WHO      WHEN     DESCRIPTION                       *        00290000
* -------- -------- -------- --------------------------------- *        00300000
*                                                              *        00310000
* AS0602    ALEX    06/02/95 CHANGE FIELD NAME REVOKE_STATUS   *        00320000
*                                         TO   REVOKED         *        00330000
* PS0095    AS      03/06/97 CALL TO CTSADTE INSTEAD TO CTSFDTE*        00340000
* PS0402    AS      20/12/99 RACF DATABASE CORRUPTION HANDLING *        00350000
* WS2427    SK      23/01/02 RACF UNIVERSAL GROUP SUPPORT      *        00351000
* BS10008   AVNERL  17/03/08 OVERLAY IN HEAP BY MVCL           *        00351100
* BS10056   AVNERL  28/05/17 DO LIKE IS10142 IN CTSFRCN        *        00351200
* IS10186   AVNERL  21/01/24 RECOMP WITH CTSFXPR               *        00351300
* IS10188  AVNERL   06/10/24 MOVE OUR MODULES ABOVE 16M LINE   *        00351401
****************************************************************        00352000
*                                                                       00353000
****************************************************************        00354000
*        PARAMETER LIST DSECT                                           00355000
****************************************************************        00356000
*                                                                       00357000
PARMLIST DSECT                                                          00358000
AOPTION  DS    A                       ADDR OPTION CODE(LOCATE/NEXT)    00359000
AENTYP   DS    A                       ADDR.ENTRY TYPE = 'USER'         00360000
AENTRY   DS    A                       ADDR ENTRY NAME                  00370000
AFGEN    DS    A                       ADDR. GENERIC FLAG = 0           00380000
AOUT     DS    A                       ADDR OUTPUT LINE                 00390000
ADEBUG   DS    A                       DEBUG LEVEL                      00400000
ARCFRET  DS    A                       ADDR RACF RETURN CODE            00410000
AREASON  DS    A                       ADDR RACF REASON CODE            00420000
ASEP     DS    A                       SEPARATOR                        00430000
AMAXCNT  DS    A                       MAX CONNECT NUMBER       BS10008 00431000
*                                                                       00440000
****************************************************************        00450000
*        INITIALIZE                                                     00460000
****************************************************************        00470000
*                                                                       00470100
CTSFRGC  CSECT                                                          00470200
CTSFRGC  AMODE 31                                                       00470300
*IS10188 CTSFRGC  RMODE 24       (FOR CTSADBG)                          00470401
CTSFRGC  RMODE ANY                                             IS10188  00470501
         BEGIN *,R12,R11                                                00470601
         CTSEQUR                                                        00470701
         CTSLEVEL                                                       00470801
         LR    R10,R1                                                   00470901
         USING PARMLIST,R10            ADDRESABILITY PARAMETERS         00471001
*                                                                       00471101
*        SET DEBUG LEVEL                                                00472000
*                                                                       00473000
         L     R2,ADEBUG               R2 -> DEBUG LEVEL (4 BYTES)      00474000
         XC    DEBUGL,DEBUGL           STORE DEBUG LEVEL                00475000
         XC    DEBUG,DEBUG             STORE DEBUG LEVEL                00476000
         ICM   R2,15,0(R2)             DEBUG LEVEL                      00477000
         BNP   NODEBUG                 SKIP DEBUG LVL IF MINUS          00478000
         STC   R2,DEBUGL               STORE DEBUG LEVEL (1 BYTE)       00479000
         ST    R2,DEBUG                                                 00480000
NODEBUG  DS    0H                                                       00490000
         CTSADBG 'ENTERING',LEVEL=(DEBUGL,3,4,5,6,7)                    00500000
*                                                                       00510000
****************************************************************        00520000
*        PREPARE FOR EXTRACTOR CALL                                     00530000
****************************************************************        00540000
*                                                                       00550000
         L     R2,AOUT                                                  00560000
         ST    R2,AAREA                ADDRESS OUTPUT AREA              00570000
         NI    AAREA,X'7F'             CLEAR 0 - BYTE(C-CONVENTIONS)    00580000
*                                                                       00590000
         L     R2,AENTRY                                                00600000
         MVC   ENTRY12(8),0(R2)                                         00610000
         TR    ENTRY12(8),TAB          CONVERT TO UPPERCASE             00620000
****************************************************************        00630000
*    CALCULATE REAL LENGTH OF ENTRY NAME                                00640000
****************************************************************        00650000
         LA    R1,ENTRY12+8            MAX ENTRY NAME ADDR              00660000
         TRT   ENTRY12(8),BLANKT1                                       00670000
         S     R1,=A(ENTRY12)                                           00680000
         LTR   R6,R1                   LENGTH = 0 ?                     00690000
         BNZ   LLENNZ                  NO,SKIP                          00700000
LLENZ    DS    0H                      ENTRY NAME LEN=0 SCAN DB         00710000
         MVI   ENTRY11,1               INITIAL LENGTH=1                 00720000
         XC    ENTRY12,ENTRY12         CLEAR ENTRY NAME                 00730000
         B     LGPP                                                     00740000
LLENNZ   DS    0H                                                       00750000
         STC   R6,ENTRY11              STORE REAL ENTRY NAME LENGTH     00760000
LGPP     DS    0H                                                       00770000
         L     R2,AOPTION              OPTION CODE / LOCATE / NEXTC /   00780000
         MVC   OPTCDE(8),0(R2)                                          00790000
         TR    OPTCDE(8),TAB           CONVERT OPTION TO UPPERCASE      00800000
*                                                                       00810000
         L     R6,TSTUSR                                                00820000
*                                                                       00830000
*-------------------------------------------------------------------    00840000
*   MOVE  PARAMETERS TO TEST ROUTINE                                    00850000
*-------------------------------------------------------------------    00860000
*                                                                       00870000
         USING TESTUSR,R6                                               00880000
         MVC   ENTRYP(4),=A(ENTRY2)    ENTRY PARAMETER ADDR             00890000
         MVC   SLCTINFO(4),=A(SUSR)    TEST PARAMETER LIST              00900000
         MVC   DEBUGT(1),DEBUG+3       DEBUG LEVEL                      00910000
         L     R6,OUTP                                                  00920000
         USING OUTPGP,R6                                                00930000
         MVC   MOVEINFO(4),=A(SUSR)    TEST PARAMETER LIST              00940000
         MVC   DBGLT1(1),DEBUG+3       DEBUG LEVEL                      00950000
*BS10008 STARTS                                                 BS10008 00951000
         L     R6,AAREA                -> OUTPUT AREA           BS10008 00952000
         ST    R6,MOVEAREA             KEEP IT 4 ROUTINE USING  BS10008 00953000
         L     R6,AMAXCNT              =  MAX COUNT NUMBER      BS10008 00953100
         LA    R6,0(,R6)               CLEAR HIGH-ORDER BIT     BS10056 00953200
         ST    R6,MOVEMAXC             KEEP IT 4 ROUTINE USING  BS10008 00953300
*BS10008 ENDS                                                   BS10008 00957000
         DROP  R6                                                       00960000
*                                                                       00970000
         SR    R6,R6                                                    00980000
         IC    R6,ENTRY11                                               00990000
         CTSADBG 'OPTION=_ ENTRY NAME=#/_',                            X01000000
               (OPTCDE,8,?R6,ENTRY12,?R6),LEVEL=(DEBUGL,5,6,7)          01010000
*                                                                       01020000
         CLC   OPTCDE(6),=CL6'LOCATE'                                   01030000
         BE    LGCLOC                                                   01040000
LGCNEXT  DS    0H                                                       01050000
         CTSFAGR NEXTC,RC=RETCODE,MF=(E,GETUPF)                         01060000
         B     RETURN                                                   01070000
LGCLOC   DS    0H                                                       01080000
         CTSFAGR LOCATE,RC=RETCODE,MF=(E,GETUPF)                        01090000
*********************************************************************   01100000
RETURN   DS    0H                                                       01110000
         L     R2,AENTRY                                                01120000
         MVC   0(8,R2),=CL8' '                                          01130000
         SR    R6,R6                                                    01140000
         IC    R6,ENTRY11              LENGTH OF ENTRY NAME             01150000
         BCTR  R6,0                                                     01160000
         EX    R6,MVCENTRY             MOVE ENTRY NAME                  01170000
* --------------------     1  - RACF RETURN CODE                        01180000
* --------------------     2  - RACF REASON CODE                        01190000
* --------------------     3  - EXTRACTOR RETURN CODE                   01200000
         L     R4,ARCFRET                                               01210000
         MVC   0(4,R4),RETCODE                                          01220000
         L     R4,AREASON                                               01230000
         MVC   0(4,R4),RETCODE+4                                        01240000
         L     R15,RETCODE+8                                            01250000
         CTSADBG 'EXITING WITH RC=~',(?R15),                           101260000
               LEVEL=(DEBUGL,3,4,5,6,7)                                 01270000
         BRTRN (15)                                                     01280000
* -------------------------------------------------------               01290000
         LTORG                                                          01300000
* -------------------------------------------------------               01310000
*     TRANSLATE TABLE  ( USER PROFILE )                                 01320000
* -------------------------------------------------------               01330000
*                                                                       01340000
*                                      ADSP                             01350000
*                                      SPECIAL                          01360000
*                                      OPERATIONS                       01370000
*                                      REVOKED                          01380000
*                                      GRPACC                           01390000
*                                      AUDITOR                          01400000
G1       DC    AL1(1),X'80'                                             01410000
         DC    AL1(1),CL1'Y'                                            01420000
         DC    AL1(1),X'00'                                             01430000
         DC    AL1(1),CL1'N'                                            01440000
         DC    AL1(0)                                                   01450000
* -------------------------------------------------------               01460000
*                                      UACC                             01470000
TUACC    DC    AL1(1),X'80'                                             01480000
         DC    AL1(5),CL5'ALTER'                                        01490000
         DC    AL1(1),X'40'                                             01500000
         DC    AL1(7),CL7'CONTROL'                                      01510000
         DC    AL1(1),X'20'                                             01520000
         DC    AL1(6),CL6'UPDATE'                                       01530000
         DC    AL1(1),X'10'                                             01540000
         DC    AL1(4),CL4'READ'                                         01550000
         DC    AL1(1),X'08'                                             01560000
         DC    AL1(7),CL7'EXECUTE'                                      01570000
         DC    AL1(1),X'01'                                             01580000
         DC    AL1(4),CL4'NONE'                                         01590000
         DC    AL1(0)                                                   01600000
* -------------------------------------------------------               01610000
*     TRANSLATE TABLE  ( GROUP PROFILE )                                01620000
* -------------------------------------------------------               01630000
*                                      AUTHORITY                        01640000
TRTAU    DC    AL1(1),X'80'                                             01650000
         DC    AL1(4),CL4'JOIN'                                         01660000
         DC    AL1(1),X'40'                                             01670000
         DC    AL1(7),CL7'CONNECT'                                      01680000
         DC    AL1(1),X'20'                                             01690000
         DC    AL1(6),CL6'CREATE'                                       01700000
         DC    AL1(1),X'10'                                             01710000
         DC    AL1(3),CL3'USE'                                          01720000
         DC    AL1(0)                                                   01730000
* -------------------------------------------------------               01740000
AAREA    DS   F                        ADDRESS OUTPUT AREA              01750000
DEBUG    DS   F                        DEBUG LEVEL                      01760000
DEBUGL   DS   CL1                      DEBUG LEVEL                      01770000
*                                                                       01780000
ENTRY1   DS   0H                       ENTRY NAME                       01790000
ENTRY11  DS   AL1                                                       01800000
ENTRY12  DS   CL256                                              PS0402 01810000
* PS0402 ENTRY12  DS   CL10                                             01820000
*                                                                       01830000
ENTRY2   DS   0H                       ENTRY NAME                       01840000
ENTRY21  DS   AL1                                                       01850000
ENTRY22  DS   CL256                                              PS0402 01860000
* PS0402 ENTRY22  DS   CL10                                             01870000
*                                                                       01880000
OPTCDE   DS   CL8                      OPCODE=LOCATE/NEXTC              01890000
OUTP     DC   A(OUTPGP)                EXTERNAL OUTPUT ROUTINE          01900000
TSTUSR   DC   A(TESTUSR)               TEST ROUTINE FOR USER PROFILE    01910000
CTSFRXT  DC   V(CTSFRXT)               EXTRACTOR NAME ( LNKEDT )        01920000
RETCODE  DS   3F                                                        01930000
* --------------------     1  - RACF RETURN CODE                        01940000
* --------------------     2  - RACF REASON CODE                        01950000
* --------------------     3  - EXTRACTOR RETURN CODE                   01960000
*                                                                       01970000
**********************************************************              01980000
*     RACF'S ACCESS TABLES                                              01990000
**********************************************************              02000000
GETUPF   CTSFAGR NEXTC,MF=L,                                           102010000
               TYPE='USR',OUTEP=OUTP,OUTAREA=AAREA,                    202020000
               ENTRY=ENTRY1,RC=RETCODE,TEST=TSTUSR,DELAY=GETGRP,       302030000
               EOE=NO,GETPRG=CTSFRXT,FORMAT=INTERNAL,DEBUG=DEBUG,      402040000
               (TXTL='USERID',REPEAT=YES),                             *02050000
               (CGGRPCT,E,X,TXTL='CGGRPCT',IGNORE=YES),                *02060000
               (DFLTGRP,E,C,TXTL='DFLTGRP',REPEAT=YES),                *02070000
               (CGGRPNM,L,C,TXTL='GROUP',EOL=NO),                      *02080000
               (USERACS,E,X,TXTL='AUTHORITY',TRN=TRTAU,                *02090000
               DELAY=YES,TST=SUSR,REPEAT=YES),                         *02100000
               (CGAUTHOR,L,C,TXTL='OWNER',EOL=NO),                     *02110000
               (CGUACC,L,X,TXTL='UACC',TRN=TUACC,EOL=NO),              *02120000
               (CGFLAG1,L,X,TXTL='ADSP',TRN=G1,EOL=NO),                *02130000
               (CGFLAG2,L,X,TXTL='SPECIAL',TRN=G1,EOL=NO),             *02140000
               (CGFLAG3,L,X,TXTL='OPERATIONS',TRN=G1,EOL=NO),          *02150000
               (CGFLAG5,L,X,TXTL='GRPACC',TRN=G1,EOL=NO),              *02160000
               (CGGRPAUD,L,X,TXTL='AUDITOR',TRN=G1,EOL=NO),            *02170000
               (CGREVKDT,L,C,TXTL='REVOKE_DATE',EOL=NO),               *02180000
               (CGRESMDT,L,C,TXTL='RESUME_DATE',EOL=NO),               *02190000
               (CGFLAG4,L,X,TXTL='REVOKED',TRN=G1,EOL=NO),             *02200000
               (CGAUTHDA,L,C,TXTL='INFO.CREATE_DATE',EOL=NO,NL=YES)     02210000
*                                                                       02220000
GETGRP   CTSFAGR LOCATE,MF=L,TYPE='GRP',ENTRY=ENTRY2,DELAY=YES,        *02230000
               WKAREA=GRPINFO                                           02240000
*                                                                       02250000
* -------------------------------------------------------               02260000
*     TEST FOR USER INFO SELECTING                                      02270000
* -------------------------------------------------------               02280000
SUSR     ICHETEST FIELD=USERID,COND=EQ,FLDATA=(8,ENTRY12),RELEASE=1.9   02290000
*******************************************************************     02300000
*    RACF RETURN WORK AREA                                              02310000
*******************************************************************     02320000
GRPINFO  DS    0F                                                       02330000
RETALEN  DC    F'280'                  LENGTH OF AREA                   02340000
RETRBA   DC    XL6'00'                 RBA                              02350000
RETFLGS  DC    X'00'                   GENERIC FLAG                     02360000
RETRES1  DC    X'00'                   RESERVED                         02370000
RETDDSC  DC    F'0'                    DUPLICATE DATASET NAME COUNT     02380000
RETRES2  DC    XL8'00'                 RESERVED                         02390000
USERDATA DS    0CL256                                                   02400000
UDL      DS    AL4                     DATA LENGTH                      02410000
UDD      DS    CL252                   DATA                             02420000
*                                                                       02430000
MVCENTRY MVC   0(0,R2),ENTRY12         MOVE ENTRY NAME                  02440000
*                                                                       02441000
BLANKT1  DC    256AL1(00)                                               02442000
         ORG   BLANKT1+X'40'                                            02443000
         DC    X'FF'                                                    02444000
         ORG   ,                                                        02445000
*                                                                       02446000
TAB      DC    256AL1(*-TAB)           TRANSLATE TABLE TO UPPERCASE     02447000
         ORG   TAB                                                      02448000
         DC    40C' '                                                   02449000
         ORG   TAB+C'A'-X'40'                                           02450000
         DC    C'ABCDEFGHI'                                             02460000
         ORG   TAB+C'J'-X'40'                                           02470000
         DC    C'JKLMNOPQR'                                             02480000
         ORG   TAB+C'S'-X'40'                                           02490000
         DC    C'STUVWXYZ'                                              02500000
         ORG   ,                                                        02510000
*                                                                       02520000
         DROP  ,                                                        02530000
*********************************************************************   02540000
*                                                                   *   02550000
* EXTRACTOR EXIT ROUTINE  ( FOR GROUP PROFILE )                     *   02560000
*                                                                   *   02570000
*********************************************************************   02580000
*                                                                   *   02590000
* INPUT PARAMETERS :                                                *   02600000
* ------------------                                                *   02610000
*                                                                   *   02610100
*  1) TYPE OF CALL                                                  *   02610200
*        START  -  BEFORE REACORD READ FROM RACF DATABASE           *   02610300
*        ENTRY  -  AFTER  REECORD READ FROM RACF DATABASE           *   02610400
*        ELEMN  -  ELEMENTARY DATA FIELD                            *   02610500
*        LIST   -  LIST DATA FIELD                                  *   02610600
*        END    -  BEFORE RETURN FROM EXTRACTOR                     *   02610700
*                                                                   *   02610800
*  SEE PARMM DESCT BELOW FOR OPCODE  DEPENDENT PARAMETERS LIST      *   02610900
*                                                                   *   02611000
* RETURN CODE ( R15 ) :                                             *   02611100
* ---------------------                                             *   02611200
*                                                                   *   02611300
*        TYPE OF ENTRY POINT                                        *   02611400
*        ENTRY  -  0 - CONTINUE, 4 - NEXT RECORD , 8 - END          *   02611500
*        ELEMN  -  0 - CONTINUE, 4 - NOT PUT AND CONTINUE ,8-END    *   02611600
*        LIST   -  0 - CONTINUE, 4 - NOT PUT AND CONTINUE           *   02611700
*                                                                   *   02611800
*********************************************************************   02611900
TESTUSR  BEGIN                                                          02612000
*--------------------------------------------------------------------   02612100
*     ADDRESSABILITY MAIN PARAMETERS                                    02612200
*--------------------------------------------------------------------   02612300
         USING PARMM,R1                                                 02612400
         L     R2,XPROPCD                                               02612500
         CLI   0(R2),XPRSTRT          START  -  BEFORE READ RECORD FROM 02612600
         BE    LSTARTU                          RACF DATA BASE          02612700
         CLI   0(R2),XPRENTY          ENTRY  -  AFTER  READ RECORD FROM 02612800
         BE    LENTRYU                          RACF DATA BASE          02612900
         CLI   0(R2),XPRELMN          ELEMN  -  ELEMENTARY DATA         02613000
         BE    LELEMNU                                                  02614000
         CLI   0(R2),XPRLIST          LIST   -  LIST DATA               02615000
         BE    LLISTU                                                   02616000
         CLI   0(R2),XPREND           END    -  BEFORE RETURN FROM      02617000
         BE    LENDU                            EXTRACTOR               02618000
         B     RET0U                                                    02619000
*                                                                       02620000
********************************************************************    02630000
*        START                                                          02640000
********************************************************************    02650000
*                                                                       02660000
LSTARTU  DS    0H                                                       02670000
         B     RET0U                                                    02680000
*                                                                       02690000
********************************************************************    02700000
*        ENTRY                                                          02710000
********************************************************************    02720000
*                                                                       02730000
LENTRYU  DS    0H                                                       02740000
         L     R3,XPRENTRY             ENTRY NAME ADDR                  02750000
         L     R5,0(R3)                ENTRY NAME LEN                   02760000
*                                                                       02770000
         CTSADBG 'ENTRY=#/_',(?R5,4(R3),?R5),                          X02780000
               LEVEL=(DEBUGT,5,6,7)                                     02790000
*                                                                       02800000
         B     RET0U                   PUT TO OUTPUT AREA               02810000
*                                                                       02820000
********************************************************************    02830000
*        ELEMNTRY FIELD                                                 02840000
********************************************************************    02850000
*                                                                       02860000
LELEMNU  DS    0H                                                       02870000
         L     R3,XPRFNME              ADDR FIELD NAME                  02880000
         L     R4,XPRFADRE             ADDR FIELD VALUE                 02890000
         L     R5,0(R4)                                                 02900000
         CTSADBG 'ELEMN FIELD=_ VALUE=#/_/$',                          *02910000
               (0(R3),8,?R5,4(R4),?R5,4(R4),?R5),                      *02911000
               LEVEL=(DEBUGT,5,6,7)                                     02912000
*WS2427        LEVEL=(DEBUGT,5)                                         02913000
*WS2427  CLC   =CL8'CGGRPCT',0(R3)     CONNECT COUNT FIELD ?            02914000
         CLC   =CL7'CGGRPCT',0(R3)     CONNECT COUNT FIELD ?            02915000
         BE    LCGGRPCT                Y, TREATMENT IT                  02916000
*                                                                       02917000
*WS2427  CLC   =CL8'USERACS',0(R3)     ACCESS FIELD ?                   02918000
         CLC   =CL7'USERACS',0(R3)     ACCESS FIELD ?                   02919000
         BE    LUSRACS                 Y, TREATMENT IT                  02920000
         B     RET0U                   PUT DATA TO OUTPUT AREA          02930000
********************************************************************    02940000
*        DELAY FIELDS                                                   02950000
********************************************************************    02960000
LUSRACS  DS    0H                                                       02970000
         L     R8,SLCTINFO             TEST SUSR PARAMETER LIST         02980000
         CLI   1(R8),X'00'             USER FOUND ?                     02990000
         BNE   RET4U                   IF USER NOT FOUND NOT PUT DATA   03000000
         B     RET0U                                                    03010000
LCGGRPCT DS    0H                                                       03020000
         MVC   CGGRPCT(4),4(R4)        CONNECTION NUMBER                03021000
         MVC   CURRCNT(4),=F'0'        CLEAR INTERNAL CONNECT COUNTER   03022000
         B     RET4U                   DONT'T PUT TO OUTPUT AREA        03023000
*                                                                       03024000
********************************************************************    03025000
*        LIST FIELD                                                     03026000
********************************************************************    03027000
*                                                                       03028000
LLISTU   DS    0H                                                       03029000
         L     R3,XPRFNML              ADDR FIELD NAME                  03030000
         L     R4,XPRFADRL             FIELD ADDR                       03040000
         L     R5,0(R4)                FIELD LEN                        03050000
*                                                                       03060000
         CTSADBG 'LIST FIELD=_ VALUE=#/_/$',                           *03070000
               (0(R3),8,?R5,4(R4),?R5,4(R4),?R5),                      *03080000
               LEVEL=(DEBUGT,5,6,7)                                     03090000
*                                                                       03100000
         CLC   =CL8'CGGRPNM',0(R3)     GROUP NAME                       03110000
         BE    LCGGRPNM                                                 03120000
         CLC   =CL8'CGREVKDT',0(R3)    REVOKE DATE                      03130000
         BE    LREV                                                     03140000
         CLC   =CL8'CGRESMDT',0(R3)    RESUME DATE                      03150000
         BE    LRES                                                     03160000
         CLC   =CL8'CGFLAG4',0(R3)       REVOKE FLAG                    03170000
         BE    LFLG4                                                    03180000
         CLC   =CL8'CGAUTHDA',0(R3)    CREATE DATE                      03190000
         BE    LAUTH                                                    03200000
         B     RET0U                   PUT DATA                         03210000
*------------------------------------------------------------           03220000
*     CREATE DATE                                                       03230000
*------------------------------------------------------------           03240000
LAUTH    DS    0H                                                       03250000
         CLC   0(4,R4),=F'3'           LENGTH VALID ?                   03260000
         BNE   RET4U                   N, DON'T PUT DATA                03270000
         ST    R4,RDT4                                                  03280000
         CALL  CTSADTE,(RDT4)          CREATE DATE                      03290000
         B     RET0U                   PUT DATA TO OUTPUT AREA          03300000
*------------------------------------------------------------           03310000
*     REVOKE DATE                                                       03320000
*------------------------------------------------------------           03330000
LREV     DS    0H                                                       03340000
         XC    REVDT,REVDT                                              03350000
         CLC   0(4,R4),=F'3'           LENGTH VALID ?                   03360000
         BNE   RET4U                   N, DON'T PUT DATA                03370000
         MVC   REVDT(3),4(R4)          SAVE REVOKE DATE                 03380000
         ST    R4,RDT4                                                  03390000
         CALL  CTSADTE,(RDT4)          REVOKE DATE                      03400000
         B     RET0U                   PUT DATA TO OUTPUT AREA          03410000
*------------------------------------------------------------           03420000
*     REVOKE FLAG                                                       03430000
*------------------------------------------------------------           03440000
LFLG4    DS    0H                                                       03450000
         L     R5,REVDT                |REVOKE DATE                     03460000
         LTR   R5,R5                   |   WAS NOT OBTAINED             03470000
         BZ    RET0U                   |     RETURN REVOKE FLAG         03480000
*                                                                       03490000
         MVI   4(R4),X'00'             |OBTAINED REVOKE DATE.           03500000
         B     RET0U                                                    03510000
*                                      |   USER NO REVOKED !            03520000
*------------------------------------------------------------           03530000
*     RESUME DATE                                                       03540000
*------------------------------------------------------------           03550000
*                                                                       03560000
LRES     DS    0H                                                       03570000
         CLC   0(4,R4),=F'3'           LENGTH VALID ?                   03580000
         BNE   RET4U                   N,DON'T PUT DATA                 03590000
         ST    R4,RDT4                                                  03600000
         CALL  CTSADTE,(RDT4)          RESUME DATE                      03610000
         B     RET0U                   PUT DATA TO OUTPUT AREA          03620000
*                                      |   USER NO REVOKED !            03630000
*------------------------------------------------------------           03640000
*     GROUP NAME                                                        03650000
*------------------------------------------------------------           03660000
*                                                                       03670000
LCGGRPNM DS    0H                      GROUP NAME FIELD                 03680000
         L     R5,CURRCNT              LOAD CURRENT CONNECT COUNTER     03690000
         LA    R5,1(R5)                CONNECT COUNTER += 1             03700000
         ST    R5,CURRCNT              STORE CONNECT COUNTER            03710000
*                                                                       03711000
         L     R5,XPRT4                ADDR DELAY ICHEINTY              03712000
         L     R6,0(R5)                                                 03713000
*                                                                       03714000
         CTSADBG 'DELAY ICHEINTY=~/~',(?R5,?R6),                       *03715000
               LEVEL=(DEBUGT,5,6,7)                                     03716000
         LTR   R6,R6                                                    03717000
         BZ    RET0U                   PUT INFO TO OUTPUT AREA          03718000
*                                                                       03719000
         L     R8,ENTRYP                                                03720000
         MVC   1(8,R8),4(R4)           MOVE GROUP -> ENTRY NAME         03730000
         LR    R1,R8                                                    03740000
         LA    R1,1(R1)                BRANCH OVER THE LENGTH           03750000
         LA    R1,8(R1)                MAX ENTRY NAME ADDR              03760000
         TRT   1(8,R8),BLANKT2                                          03770000
         L     R8,ENTRYP                                                03771000
         LR    R9,R8                                                    03771100
         LA    R8,1(R8)                BRANCH OVER THE LENGTH           03771200
         SR    R1,R8                                                    03771300
         LR    R8,R1                                                    03771400
         STC   R8,0(R9)                STORE REAL LENGTH                03771500
*                                                                       03771600
         CTSADBG 'ENTRY NAME=#/_',(?R8,1(R9),?R8),                     *03771700
               LEVEL=(DEBUGT,5,6,7)                                     03771800
*                                                                       03771900
         ICHEINTY MF=(E,(R6))          INVOKE DELAY ACCESS              03772000
         L     R8,56(R6)               RSN.RC                           03772100
         L     R9,52(R6)               RC                               03772200
         L     R10,60(R6)              RETURN AREA ADDR(MUST BE 0)      03772300
*                                      BECAUSE IN DELAY PROCESSING      03772400
*                                      MUST USE STATIC RETURN AREA      03772500
*                                                                       03772600
         CTSADBG 'DELAY ICHEINTY RACF RC=~ REASON=~ RET AREA ADDR=~',  *03772700
               (?R9,?R8,?R10),                                         *03772800
               LEVEL=(DEBUGT,5,6,7)                                     03772900
*                                                                       03773000
         LTR   R9,R9                   DELAY ACCESS SUCCESSFULL         03773100
         BZ    RET0U                   PUT INFO TO OUTPUT AREA          03773200
         L     R8,SLCTINFO             TEST PARAMETER LIST              03773300
         MVI   1(R8),1                 INFO NOT FOUND                   03773400
         B     RET0U                   RETURN                           03773500
* ---------------------------------------------------------             03773600
LENDU    DS    0H                                                       03773700
         B     RET0U                                                    03773800
RET0U    DS    0H                                                       03773900
         SR    R15,R15                                                  03774000
         B     RETTU                                                    03775000
RET4U    DS    0H                                                       03776000
         LA    R15,4                                                    03777000
         B     RETTU                                                    03778000
RET8U    DS    0H                                                       03779000
         LA    R15,8                                                    03780000
         B     RETTU                                                    03790000
RETTU    DS    0H                                                       03800000
         BRTRN (15)                                                     03810000
********************************************************************    03820000
*       W O R K  A R E A  A N D   C O N S T A N T S                     03830000
********************************************************************    03840000
RDT4     DS    F                                                        03850000
REVDT    DS    F                                                        03860000
DEBUGT   DS    CL1                     DEBUG LEVEL                      03870000
CGGRPCT  DS    F                       CONNECTION NUMBER                03880000
CURRCNT  DS    F                       CURRENT CONNECT NUMBER           03890000
ENTRYP   DS    F                       ENTRY PARAMETER ADDR             03900000
SLCTINFO DS    F                       TEST PARAMETER LIST              03910000
*                                                                       03920000
BLANKT2  DC    256AL1(00)                                               03930000
         ORG   BLANKT2+X'40'                                            03940000
         DC    X'FF'                                                    03950000
         ORG   ,                                                        03960000
*                                                                       03970000
         LTORG                                                          03980000
         DROP  ,                                                        03990000
*                                                                       04000000
*-----------------------------------------------------------------      04010000
*   OUTPUT ROUTINE FOR GATHERING CONNECT INFORMATION                    04020000
*   CALLED BY SECOND EXTRACTOR                                          04030000
*-----------------------------------------------------------------      04040000
OUTPGP   BEGIN                                                          04050000
* -------------------------------------ENTRY WRITE                      04060000
         LR    R11,R1                                                   04070000
         L     R6,4(R11)                                                04080000
         L     R6,0(R6)                ADDRESS AREA                     04090000
         MVC   LRECL(4),4(R6)          USE LEN                          04100000
         LR    R7,R6                                                    04110000
         A     R7,LRECL                                                 04120000
         LA    R7,8(R7)                LENGTH + PREFIX LENGTH           04130000
*                                                                       04140000
         CTSADBG TYPE=SNAP,ID=1,HDR='**   CONNECT INFO    **',         104150000
               ADDR=(0(R6),0(R7)),                                     204160000
               LEVEL=(DBGLT1,5,6,7)                                     04170000
*                                                                       04180000
         L     R7,TG                   ADDR TEST GROUP ROUTINE          04190000
         USING TESTUSR,R7                                               04200000
         L     R5,CURRCNT              LOAD CURRENT CONNECT COUNTER     04210000
         DROP  R7                                                       04220000
         SR    R4,R4                                                    04230000
         MVC   MAXREC(4),0(R6)         MAX LENGTH                       04240000
         L     R10,MAXREC                                               04250000
         LA    R10,8(R10)             MAX LEN _ PREFIX LENGTH (8)       04260000
         ST    R10,MAXREC                                               04270000
*                                                                       04280000
         CTSADBG 'CONNECT N=# MAX.LENGTH+PREFIX(8)=#',(?R5,MAXREC),    104290000
               LEVEL=(DBGLT1,5,6,7)                                     04300000
*                                                                       04310000
         M     R4,MAXREC                                                04320000
         LR    R8,R6                  ADDRESS AREA                      04330000
         AR    R8,R5                  ADDRESS FOR MVCL                  04340000
         L     R9,MAXREC                                                04350000
         L     R7,MAXREC                                                04360000
*                                                                       04370000
         CTSADBG 'MOVE CONNECT INFO FROM ADDR=~ ---->TO ADDR=~ LEN=#', 104380000
               (?R6,?R8,?R7),                                          204390000
               LEVEL=(DBGLT1,5,6,7)                                     04400000
*BS10008 STARTS                                                         04400100
         L     R5,MOVEMAXC             =  MAX CONNECT NUMBER    BS10008 04402100
         CTSADBG 'MAX CONNECT NUM IS:/#/',                             *04402400
               (?R5),                                                  *04402500
               LEVEL=(DBGLT1,5,6,7)                                     04402600
         L     R5,MOVEAREA             -> OUTPUT AREA           BS10008 04402700
         CTSADBG 'OUTPUT AREA ADDR IS:/~/ DATA IS:/_/ ',               *04403100
               (?R5,0(R5),40),                                         *04403200
               LEVEL=(DBGLT1,5,6,7)                                     04403300
* BEFORE THIS FIX, THE FOLLOWING MVCL HAD OVERLAID THE HEAP AREA        04403400
* OF SAS/C. IN OTHER WORDS, IT HAD BEEN A S0C4 SITUATION AS WE          04403500
* HAD COPIED DATA TO AN AREA WE HADN'T ALLOCATED.                       04403600
* THIS FIX VERIFIES THAT COPIED DATA IS INSIDE THE ALLOCATED AREA.      04403700
         XR    R4,R4                   CLR FOR MULTIPLY         BS10008 04403800
*BS10056 L     R5,0(R5)                = MAX_LEN                BS10008 04403900
         L     R5,MAXREC               = MAX_LEN INCLUDING PRFX BS10056 04404000
         L     R15,MOVEMAXC            =  MAX COUNT NUMBER      BS10008 04404200
         LA    R15,1(R15)              + 1 USED BY MALLOC       BS10056 04404300
*BS10056 LA    R15,4(R15)              + 4 USED BY MALLOC       BS10008 04404400
         CTSADBG 'CALC INPUT: R5=#  R6=~  R7=#  R8=~  R15=#',   BS10056*04404500
               (?R5,?R6,?R7,?R8,?R15),                          BS10056*04404600
               LEVEL=(DBGLT1,5,6,7)                             BS10056 04404700
         MR    R4,R15                  (MAX CNT + 4) * MAX_LEN  BS10008 04404800
         AR    R5,R6                   -> END OF ALLOCATED AREA BS10008 04404900
* CHANGE FROM R1 TO R2 IN BELOW 2 STATEMENTS                    BS10056 04405000
         LR    R2,R8                   -> TARGET OF MVCL        BS10008 04405100
         AR    R2,R7                   -> END OF TARGET AREA    BS10008 04405200
         CTSADBG 'COMP VALS : R2=~ R5=~',                       BS10056*04405300
               (?R2,?R5),                                       BS10056*04405400
               LEVEL=(DBGLT1,5,6,7)                             BS10056 04405500
         CR    R2,R5                   MVCL WITHIN ALLOCATED?   BS10008 04405600
*BS10056 CR    R1,R5                   MVCL WITHIN ALLOCATED?   BS10008 04405700
         BNH   MVCLOK                  MVCL IS OK               BS10056 04405800
*BS10056 BL    MVCLOK                  MVCL IS OK               BS10008 04405900
         L     R8,MOVEINFO             TEST PARAMETER LIST      BS10008 04406400
         MVI   1(R8),1                 SET SIGN AS IF MOVED     BS10008 04406500
         CTSADBG 'TO+LEN > FROM+MAXLEN ==> MVCL IS SKIPPED',           104406600
               LEVEL=(DBGLT1,5,6,7)                                     04406700
         BRTRN 0                       RETURN TO CALLER         BS10008 04407000
MVCLOK   DS    0H                                               BS10008 04414000
*BS10008 ENDS                                                           04415000
         MVCL  R8,R6                   MOVE OUTPUT AREA TO CONNECT      04420000
         L     R8,MOVEINFO             TEST PARAMETER LIST              04430000
         MVI   1(R8),1                 SIGN : INFO MOVED !              04440000
         BRTRN 0                                                        04450000
         LTORG                                                          04460000
LRECL    DS    F                       USE LENGTH                       04470000
MAXREC   DS    F                       MAX LENGTH                       04480000
DBGLT1   DS    CL1                     DEBUG LEVEL                      04490000
MOVEINFO DS    F                       TEST PARAMETER LIST              04500000
MOVEAREA DS    A                       OUTPUT AREA ADDRESS      BS10008 04503000
MOVEMAXC DS    F                       MAX COUNT NUMBER ADDR    BS10008 04504000
TG       DC    A(TESTUSR)                                               04510000
         DROP  ,                                                        04520000
********************************************************************    04530000
*    MAIN PARAMETERS LIST FOR TEST ROUTINES                             04540000
*******************************************************************     04550000
PARMM    DSECT                                                          04560000
         COPY  CTSFXPR                                                  04570000
******************************************************************      04580000
*       RETURN AREA FROM RACF                                           04590000
******************************************************************      04600000
RETAREA  DSECT                                                          04610000
         COPY  CTSFXPF                                                  04620000
         END                                                            04630000
