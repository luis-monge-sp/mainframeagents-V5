         TITLE 'HANDLE REVOKE REASON CUSTOM FIELD DATA'                 00010000
****************************************************************        00020000
****                                                        ****        00030000
****     CONTROL-SA  RELEASE 3.3.1                          ****        00040000
****                                                        ****        00050000
****     LICENCED MATERIAL -                                ****        00060000
****                                                        ****        00070000
****************************************************************        00080000
*                                                                       00090000
****************************************************************        00100000
*                                                              *        00110000
* TITLE            : CTSFRVR                                   *        00120000
*                                                              *        00130000
* FILE NAME        : CTSFRVR                                   *        00140000
*                                                              *        00150000
* AUTHOR           : NURIT YAHALOM                             *        00160000
*                                                              *        00170000
* CREATION DATE    : 09/09/13                                  *        00180000
*                                                              *        00190000
* DESCRIPTION      : HANDLE REVOKE REASON CUSTOM FIELD DATA    *        00200000
*                    FOR A USER:                               *        00201000
*                    - FOR REVOKE, SET THE CUSTOM FIELD DATA   *        00210000
*                      WITH THE REQUESTED REVOKE REASON.       *        00211000
*                    - FOR RESUME, REMOVE THE CUSTOM FIELD     *        00212000
*                      DATA.                                   *        00213000
*                                                              *        00215400
* OUTPUT           : PUPDTYPE - TYPE OF UPDATE DONE TO THE     *        00215500
*                               USER RECORD (SET / DEL / ' '). *        00215600
*                  : PRVRSET  - REVOKE REASON, WHEN UPDATE     *        00215800
*                               TYPE IS 'SET'.                 *        00216000
*                                                              *        00216100
* RETURN CODES     : 0 - OK.                                   *        00216200
*                  : 4 - ERROR IN PARAMETERS.                  *        00216300
*                  : 8 - RACF CALL FAILED OR RACF RETURNED     *        00216400
*                        UNACCEPTABLE DATA.                    *        00216500
*                                                              *        00216600
* ASSUMPTIONS AND                                              *        00216700
*   CONSIDERATIONS : CALLER MUST BE AUTHORIZED                 *        00216800
*                                                              *        00216900
****************************************************************        00217000
****************************************************************        00217100
* MOD.ID   WHO      WHEN     DESCRIPTION                       *        00217200
* -------- -------- -------- --------------------------------- *        00217300
* IS10100  NURITY   08/09/13 INITIAL VERSION.                  *        00218000
* SAS2IBMN NURITY   12/12/16 REMOVE PATCH=NO FOM CTSLEVEL      *        00219000
* IS10188  AVNERL   06/10/24 MOVE OUR MODULES ABOVE 16M LINE   *        00220000
****************************************************************        00230000
*                                                                       00240000
CTSFRVR  CSECT                                                          00250000
CTSFRVR  AMODE 31                                                       00260000
*IS10188 CTSFRVR  RMODE 24       (FOR CTSADBG)                          00270000
CTSFRVR  RMODE ANY                                             IS10188  00271000
         BEGIN *                                                        00280000
*SAS2IBMN CTSLEVEL PATCH=NO                                             00290000
         CTSLEVEL                                              SAS2IBMN 00291000
         LR    R10,R1                                                   00300000
         USING PARMS,R10           ADDRESABILITY PARAMETERS             00310000
         L     R12,=A(VARS)        R12 -> VARIABLES AREA.               00311000
         USING VARS,R12                                                 00312000
*                                                                       00320000
**   SET DEBUG LEVEL                                                    00330000
*                                                                       00340000
         L     R2,PDEBUG           R2 -> DEBUG LEVEL (4 BYTES)          00350000
         XC    DEBUGL,DEBUGL                                            00360000
         XC    DEBUG,DEBUG                                              00370000
         ICM   R2,B'1111',0(R2)    R2 = DEBUG LEVEL                     00380000
         BNP   NODEBUG             INVALID DEBUG LEVEL.                 00390000
         STC   R2,DEBUGL           SAVE DEBUG LEVEL (1 BYTE).           00400000
         ST    R2,DEBUG            SAVE DEBUG LEVEL (4 BYTES).          00410000
NODEBUG  DS    0H                                                       00420000
         CTSADBG 'ENTERING',LEVEL=(DEBUGL,1,2,3,4,5,6),                X00430000
               RAREA=RAREA,DBGAREA=DBGAREA                              00440000
*                                                                       00500000
**   GET USERID NAME.                                                   00510000
*                                                                       00520000
         L     R3,PUSERID                                               00530000
         LA    R1,255(,R3)         R1 -> LAST CHAR,                     00540000
         TRT   0(255,R3),CNULLTAB  LOOK FOR END OF NAME.                00550000
         SR    R1,R3               R1 = NAME LENGTH.                    00560000
         BNP   NOUSERID            NO NAME SUPPLIED.                    00570000
         STC   R1,USERLEN          SAVE NAME LENGTH.                    00580000
         AHI   R1,-1               FOR EX.                              00590000
         EX    R1,MVCENTNM                                              00600000
         B     *+L'*+L'MVCENTNM                                         00610000
MVCENTNM MVC   USERNAM(0),0(R3)                                         00620000
*                                                                       00620100
**   GET REVOKE REASON CUSTOM FIELD NAME.                               00620200
*                                                                       00620300
         MVC   CFNAME(8),BLANKS                                         00620400
         L     R3,PCFNAME                                               00620500
         LA    R1,8(,R3)           R1 -> AFTER CFNAME.                  00620600
         TRT   0(8,R3),CNULLTAB    LOOK FOR END OF NAME.                00620700
         SR    R1,R3               R1 = NAME LENGTH.                    00620800
         BNP   NOCFNAME            NO NAME SUPPLIED.                    00620900
         ST    R1,CFNAMELN         SAVE CFNAME LENGTH.                  00621000
         AHI   R1,-1               FOR EX.                              00621100
         EX    R1,MVCCFNAM                                              00621200
         B     *+L'*+L'MVCENTNM                                         00621300
MVCCFNAM MVC   CFNAME(0),0(R3)                                          00621400
         EX    R1,UCCFNAME                                              00621500
         B     *+L'*+L'UCCFNAME                                         00621600
UCCFNAME TR    CFNAME(0),UCASETAB                                       00621700
*                                                                       00621900
**   UPDATE ICHETEST WITH THE ACTUAL CFNAME LENGTH.                     00622000
*                                                                       00622100
         L     R4,CFNAMELN         R4 = CFNAME LENGTH.                  00622200
         ICHETEST FLDATA=((R4),CFNAME),MF=(E,TCSKEYEQ)                  00622300
         ICHETEST FLDATA=((R4),CFNAME),MF=(E,TCSKEYNE)                  00622600
*                                                                       00622800
**   GET ACTION                                                         00622900
*                                                                       00623000
         MVI   ACTIONIN,C' '       INIT INPUT ACTION.                   00623100
         L     R3,PACTION                                               00623200
         CHI   R3,0                ACTION PROVIDED ?                    00623300
         BE    INVACT              ..NO - ERROR.                        00623400
         LHI   R1,0                                                     00623500
         IC    R1,0(,R3)           R1 = ACTION.                         00623600
         OILL  R1,X'0040'          "TRANSLATE" TO UPPERCASE...          00624000
         STC   R1,ACTIONIN         ...AND SAVE.                         00624100
*                                                                       00624200
         MVI   ACTYPEIN,C' '       INIT INPUT ACTION TYPE.              00624300
         L     R3,PACTTYPE                                              00625000
         CHI   R3,0                ACTION TYPE PROVIDED ?               00625100
         BE    INVACTYP            ..NO - ERROR.                        00625200
         LHI   R1,0                                                     00626000
         IC    R1,0(,R3)           R1 = ACTION TYPE.                    00627000
         OILL  R1,X'0040'          "TRANSLATE" TO UPPERCASE.            00628000
         STC   R1,ACTYPEIN         ...AND SAVE.                         00629000
*                                                                       00629100
         MVI   RVKRSNIN,C' '       INIT INPUT REVOKE REASON.            00629200
         L     R3,PRVKRSN                                               00629300
         CHI   R3,0                REVOKE REASON PROVIDED?              00629400
         BE    CHKOUTP             ..NO - VERIFY ACTION.                00629500
         LHI   R1,0                                                     00629600
         IC    R1,0(,R3)           R1 = ACTION TYPE.                    00629700
         OILL  R1,X'0040'          "TRANSLATE" TO UPPERCASE.            00629800
         STC   R1,RVKRSNIN         ...AND SAVE.                         00629900
*                                                                       00630000
CHKOUTP  DS    0H                                                       00630100
         L     R3,PUPDTYPE                                              00630200
         CHI   R3,0                -> TO OUTPUT UPDATE TYPE PROVIDED ?  00630300
         BE    NOOUTPRM            ..NO - ERROR.                        00630400
         MVI   0(R3),#UPNO         INIT OUTPUT UPDATE TYPE.             00630500
*                                                                       00630600
         L     R3,PRVRSET                                               00630700
         CHI   R3,0                -> TO OUTPUT REVOKE REASON PROVIDED? 00630800
         BE    NOOUTPRM            ..NO - ERROR.                        00630900
         MVI   0(R3),#EVRVRS       INIT OUTPUT REVOKE REASON.           00631000
*                                                                       00632000
**   VERIFY ACTION.                                                     00640000
*                                                                       00650000
         LHI   R15,0                                                    00660100
         IC    R15,USERLEN         R15 = USERID LENGTH (FOR DEBUG)      00660200
         LHI   R2,0                                                     00660300
         L     R2,CFNAMELN         R2 = CFNAME LENGTH (FOR DEBUG).      00660400
         CTSADBG 'INPUT PARMS: USERID=_  CFNAME=_  ACTION=_/_/_',      X00661000
               (USERNAM,?R15,CFNAME,?R2,                               X00662000
               ACTIONIN,1,ACTYPEIN,1,RVKRSNIN,1),                      X00663000
               LEVEL=(DEBUGL,1,2,3,4,5,6),                             X00664000
               RAREA=RAREA,DBGAREA=DBGAREA                              00664100
*                                                                       00665000
         CLI   ACTIONIN,#ACTUPD    UPDATE ?                             00670000
         BE    GOUPDATE                                                 00680000
         CLI   ACTIONIN,#ACTREV    REVOKE ?                             00681000
         BE    GOREVOKE                                                 00690100
         B     INVACT                                                   00690200
*                                                                       00690300
**   PROCESS UPDATE ACTION                                              00690400
*                                                                       00690500
GOUPDATE DS    0H                                                       00690600
         MVC   ACTION,#UPDATE                                           00690700
         CLI   ACTYPEIN,#ACTYPRV   REVOKE ?                             00690800
         BE    GOUPCHKR                                                 00691300
         CLI   ACTYPEIN,#ACTYPRS   RESUME ?                             00691400
         BE    DORESUME                                                 00691600
         B     INVACTYP                                                 00691700
GOUPCHKR DS    0H                                                       00691800
         CLI   RVKRSNIN,C' '       REVOKE REASON PROVIDED ?             00692000
         BH    SETRVKRS            ..YES - SET REVOKE REACON.           00692100
         B     NORVKRSN            ..NO - ERROR.                        00692200
*                                                                       00692300
**   PROCESS REVOKE ACTION                                              00692400
*                                                                       00692500
GOREVOKE DS    0H                                                       00692600
         MVC   ACTION,#REVOKE                                           00692700
         CLI   ACTYPEIN,#ACTYPRV   REVOKE ?                             00692900
         BNE   INVACTYP            ..NO - ERROR.                        00693000
         CLI   RVKRSNIN,C' '       REVOKE REASON PROVIDED ?             00693200
         BH    SETRVKRS            ..YES - SET REVOKE REASON.           00693300
         B     GOCHKDTE            ..NO - CHECK IF REVOKE REASON IS     00693400
*                                         'DATE'.                       00693500
*---------------------------------------------------------------------- 00693600
**                                                                      00693700
**   CHECK IF USER REVOKED BECAUSE OF REVOKE DATE.                      00693800
**   - RETRIVE REVOKE REASON, REVOKE DATE AND RESUME DATE.              00693900
**   - IF REVOKE REASON EXISTS, NOTHING TO DO (ALREADY REVOKED).        00694000
**   - IF NO REVOKE REASON:                                             00694100
**     IF REVOKE DATE AND RESUME DATE INDICATE THAT THE                 00694200
**     USER IS REVOKED BECAUSE OF REVOKE DATE, SET REVOKE REASON.       00694300
**                                                                      00694400
*---------------------------------------------------------------------- 00694500
GOCHKDTE DS    0H                                                       00694600
*                                                                       00694700
**   GET TODAY DATE                                                     00694800
*                                                                       00694900
         TIME  DEC                                                      00695000
         STCM  R1,B'0111',TODAY    SAVE TODAY DATE.                     00695100
*                                                                       00695200
**   RETRIEVE REVOKE REASON, REVOKE DATE AND RESUME DATE.               00695300
*                                                                       00695400
         XC    WA1+4(X'18'),WA1+4  CLEAR WORK AREA PREFIX.              00695500
         XC    WA2+4(X'18'),WA2+4  CLEAR WORK AREA PREFIX.              00695600
*                                                                       00695700
         ICHEINTY CHAIN=ICHNLOC2,                                      X00695800
               OPTIONS=(NOEXEC),                                       X00695900
               RELEASE=1.8,                                            X00696000
               MF=(E,ICHNLOC1)                                          00696100
*                                                                       00696200
         ICHEINTY LOCATE,MF=(E,ICHNLOC1)                                00696300
*                                                                       00696400
         STM   R15,R0,RETCODES                                          00696500
         CTSADBG 'ICHEINTY LOCATE: RC = # / #  (RC1=#/#  RC2=#/#)',    X00696600
               (RETCRACF,RESCRACF,                                     X00696700
               ICHNLOC1+52,ICHNLOC1+56,                                X00696800
               ICHNLOC2+52,ICHNLOC2+56),                               X00696900
               LEVEL=(DEBUGL,1,2,3,4,5,6),                             X00697000
               RAREA=RAREA,DBGAREA=DBGAREA                              00697100
*                                                                       00697200
         CHI   R15,0               LOCATE OK ?                          00697300
         BNE   ICHNLCER            ..NO - ERROR.                        00697400
*                                                                       00697500
**   ANALYZE RETURNED DATA IN WA1 (REVOKE REASON VALUE).                00697600
*                                                                       00697700
UWA1     USING RETAREA,WA1                                              00697800
         L     R4,UWA1.RETADLEN    R4 = RETURNED DATA LENGTH.           00698600
         CHI   R4,0                ANYTHING RETURNED ?                  00698700
         BE    ICHNLCER            ..NO - ERROR.                        00698800
*                                                                       00698900
         LR    R2,R4                                                    00699000
         AHI   R2,RETADATA-RETAREA R2 = RETURNED LENGTH + PREFIX.       00699100
         AHI   R2,-1                                                    00699200
         CTSADBG TYPE=SNAP,ID=1,HDR='ICHEINTY LOCATE 1 RETURNED DATA', X00699300
               ADDR=(WA1,WA1(R2)),                                     X00699400
               LEVEL=(DEBUGL,1,2,3,4,5,6),                             X00699500
               RAREA=RAREA,DBGAREA=DBGAREA                              00699600
*                                                                       00699700
         LA    R4,UWA1.RETADATA(R4) R4 -> END OF DATA.                  00699800
         LA    R5,UWA1.RETADATA    R5 -> RETURNED DATA.                 00699900
         USING RETPARM,R5                                               00700000
*  CHECK REVOKE REASON                                                  00700100
         L     R1,RETPLEN          R1 = REVOKE REASON LENGTH.           00700200
         CHI   R1,1                REVOKE REASON EXISTS ?               00700300
         BNE   CHKWA2              ..NO - CHECK REVOKE/RESUME DATES.    00700400
         CLI   RETPDATA,#EVRVRS$   REVOKE REASON = '?' (UNKNOWN) ?      00700500
         BNE   RETRC0              ..NO - NOTHING TO DO.                00700600
         DROP  R5                                                       00700700
         DROP  UWA1                                                     00700800
*                                                                       00700900
**   ANALYZE RETURNED DATA IN WA2 (REVOKE DATE AND RESUME DATE).        00701000
*                                                                       00701100
CHKWA2   DS    0H                                                       00701200
UWA2     USING RETAREA,WA2                                              00701300
         L     R4,UWA2.RETADLEN    R4 = RETURNED DATA LENGTH.           00701900
         CHI   R4,0                ANYTHING RETURNED ?                  00702000
         BE    ICHNLCER            ..NO ERROR.                          00702100
*                                                                       00702200
         LR    R2,R4                                                    00702300
         AHI   R2,RETADATA-RETAREA R2 = RETURNED LENGTH + PREFIX.       00702400
         AHI   R2,-1                                                    00702500
         CTSADBG TYPE=SNAP,ID=1,HDR='ICHEINTY LOCATE 2 RETURNED DATA', X00702600
               ADDR=(WA2,WA2(R2)),                                     X00702700
               LEVEL=(DEBUGL,1,2,3,4,5,6),                             X00702800
               RAREA=RAREA,DBGAREA=DBGAREA                              00702900
         LA    R4,UWA2.RETADATA(R4) R4 -> END OF DATA.                  00703000
         LA    R5,UWA2.RETADATA    R5 -> RETURNED DATA.                 00703100
         USING RETPARM,R5                                               00703200
*  TAKE REVOKE DATE                                                     00703300
         L     R1,RETPLEN          R1 = REVOKE DATE LENGTH.             00703700
         CHI   R1,0                REVOKE DATE EXISTS ?                 00703800
         BE    RETRC0              ..NO - NOT REVOKED BECASUE OF DATE.  00703900
         MVC   REVOKEDT(3),RETPDATA                                     00704000
         OI    REVOKEDT+2,X'0F'                                         00704100
*  TAKE RESUME DATE                                                     00704200
         LA    R5,RETPDATA(R1)     R5 -> NEXT PARAMETER.                00704300
         CR    R5,R4               END OF DATA ?                        00704400
         BNL   LCDATAER                                                 00704500
         MVC   RESUMEDT,NODATE                                          00704600
         L     R1,RETPLEN          R1 = REVOKE DATE LENGTH.             00704700
         CHI   R1,0                RESUME REASON EXISTS ?               00704800
         BE    ISRVKDT             ..NO - CHECK IF 'DATE' REVOKED.      00704900
         MVC   RESUMEDT(3),RETPDATA                                     00705000
         OI    RESUMEDT+2,X'0F'                                         00705100
         DROP  R5                                                       00705200
         DROP  UWA2                                                     00705300
*                                                                       00705400
**   CHECK IF REVOKED BECAUSE OF DATE                                   00705500
*                                                                       00705600
ISRVKDT  DS    0H                                                       00705700
         CTSADBG 'REVOKE DATE=$   RESUME DATE=$   TODAY=$',            X00705800
               (REVOKEDT,3,RESUMEDT,3,TODAY,3),                        X00705900
               LEVEL=(DEBUGL,1,2,3,4,5,6),                             X00706000
               RAREA=RAREA,DBGAREA=DBGAREA                              00706100
         CLC   REVOKEDT,TODAY      REVOKE DATE > TODAY ?                00706200
         BH    RETRC0              ..YES - NOT A 'DATE' REVOKE.         00706300
         CLC   RESUMEDT,REVOKEDT   RESUME DATE =< REVOKE DATE ?         00706400
         BNH   RVKTYPDT            ..YES - REVOKED BECAUE OF DATE.      00706500
         CLC   RESUMEDT,TODAY      RESUME DATE =< TODAY ?               00706600
         BNH   RETRC0              ..YES - NOT A 'DATE' REVOKE.         00706700
RVKTYPDT DS    0H                                                       00706800
         MVI   RVKRSNIN,#EVRVRSD   SET REASON = 'DATE'.                 00706900
*                                                                       00707000
*---------------------------------------------------------------------- 00707100
**                                                                      00707200
**   UPDATE USER PROFILE, SET REVOKE REASON.                            00707300
**                                                                      00707400
**   - IF THE USER PROFILE CONTAINS A REVOKE REASON, CHANGE IS          00707500
**     TO THE NEW REVOKE REASON.                                        00707600
**   - OF THE USER PROFILE DOES NOT CONTAIN A REVOKE REASON,            00707700
**     ADD IT.                                                          00707800
**                                                                      00707900
*---------------------------------------------------------------------- 00708000
SETRVKRS DS    0H                                                       00708100
         MVC   CFVALUE(1),RVKRSNIN SET REVOKE REASON.                   00708200
*                                                                       00708300
**   CREATE THE CSCDATA COMBINED FIELD (TYPE + NAME + VALUE)            00708400
*                                                                       00708500
         LA    R4,CFDATA           R4 -> PLACE FOR TYPE.                00708600
         LHI   R1,CFTYPEL                                               00708700
         ST    R1,0(,R4)                                                00708800
         MVC   4(CFTYPEL,R4),CFTYPE                                     00708900
*                                                                       00709000
         LA    R4,CFTYPEL+4(,R4)   R4 -> PLACE FOR CFNAME               00709100
         L     R1,CFNAMELN                                              00709200
         ST    R1,0(,R4)                                                00709300
         AHI   R1,-1                                                    00709400
         EX    R1,MVCFN2CD                                              00709500
         B     *+L'*+L'MVCFN2CD                                         00709600
MVCFN2CD MVC   4(0,R4),CFNAME                                           00709700
*                                                                       00709800
         LA    R4,4+1(R1,R4)       R4 -> PLACE FOR VALUE.               00709900
         LHI   R1,CFVALUEL                                              00710000
         ST    R1,0(,R4)                                                00710100
         MVC   4(CFVALUEL,R4),CFVALUE                                   00710200
*                                                                       00710300
**   UPDATE ICHEACTN WITH THE ACTUAL FIELD NAME.                        00710400
*                                                                       00710500
         LA    R4,CFVALUEL+4(,R4)                                       00710600
         LA    R1,CFDATA                                                00710700
         SR    R4,R1               R4 = CSDATA LENGTH                   00710800
         ICHEACTN FLDATA=((R4),CFDATA),TESTS=TCSKEYNE,                 X00710900
               MF=(E,ADCSCDAT)     TESTS MUST BE SPECIFIED IN ORDER     00711000
*                                  FOR THE MACRO TO PUT THE FLDATA      00711100
*                                  CORRECTLY.                           00711200
*                                                                       00711300
**   PUT THE REVOKE REASON IN THE USER PROFILE.                         00711400
*                                                                       00711500
         ICHEINTY ALTER,MF=(E,ICHNALT1)                                 00711600
*                                                                       00711700
         STM   R15,R0,RETCODES                                          00711800
         CTSADBG 'ICHEINTY ALTER: RC = # / #   (RC1=#/#  RC2=#/#)',    X00711900
               (RETCRACF,RESCRACF,                                     X00712000
               ICHNALT1+52,ICHNALT1+56,                                X00712100
               ICHNALT2+52,ICHNALT2+56),                               X00712200
               LEVEL=(DEBUGL,1,2,3,4,5,6),                             X00712300
               RAREA=RAREA,DBGAREA=DBGAREA                              00712400
*                                                                       00712900
         CHI   R15,0                                                    00713000
         BNE   ICHNALER                                                 00713100
*                                                                       00713200
**   UPDATE SUCCESSFUL, RETURN UPDATE TYPE AND REVOKE REASON            00713300
*                                                                       00713400
         L     R3,PUPDTYPE                                              00713500
         MVI   0(R3),#UPSET        RETURN UPDATE TYPE = DEL.            00713600
         L     R3,PRVRSET                                               00713700
         MVC   0(1,R3),CFVALUE     RETURN REVOKE REASON.                00713800
         B     RETRC0                                                   00713900
*                                                                       00714000
*---------------------------------------------------------------------- 00714100
**                                                                      00714200
**   RESUME - DELETE THE REVOKE REASON CFIELD FROM USER PROFILE.        00714300
**                                                                      00714400
*---------------------------------------------------------------------- 00714500
DORESUME DS    0H                                                       00714600
*                                                                       00714700
**   CHECK IF THE USER HAS A REVOKE REASON.                             00714800
*                                                                       00714900
         ICHEINTY CHAIN=*-*,                                           X00715000
               OPTIONS=(NOEXEC),                                       X00715100
               RELEASE=1.8,                                            X00715200
               MF=(E,ICHNLOC1)                                          00715300
*                                                                       00715400
         XC    WA1+4(X'18'),WA1+4  CLEAR WORK AREA PREFIX.              00715500
         ICHEINTY LOCATE,MF=(E,ICHNLOC1)                                00716200
*                                                                       00716300
         STM   R15,R0,RETCODES                                          00716400
         CTSADBG 'ICHEINTY LOCATE: RC = # / #  (RC1=#/#)',             X00716500
               (RETCRACF,RESCRACF,                                     X00716600
               ICHNLOC1+52,ICHNLOC1+56),                               X00716700
               LEVEL=(DEBUGL,1,2,3,4,5,6),                             X00716900
               RAREA=RAREA,DBGAREA=DBGAREA                              00717000
*                                                                       00717100
         CHI   R15,0               LOCATE OK ?                          00717200
         BNE   ICHNLCER            ..NO - ERROR.                        00717300
*                                                                       00717600
UWA1     USING RETAREA,WA1                                              00717700
         L     R4,UWA1.RETADLEN    R4 = RETURNED LENGTH.                00717800
         CHI   R4,0                ANYTHING RETURNED ?                  00717900
         BE    ICHNLCER            ..NO - ERROR.                        00718000
*                                                                       00718100
         LR    R2,R4                                                    00718200
         AHI   R2,RETADATA-RETAREA R2 = RETURNED LENGTH + PREFIX.       00718300
         AHI   R2,-1                                                    00718400
         CTSADBG TYPE=SNAP,ID=1,HDR='ICHEINTY LOCATE 1 RETURNED DATA', X00718500
               ADDR=(WA1,WA1(R2)),                                     X00718600
               LEVEL=(DEBUGL,1,2,3,4,5,6),                             X00718700
               RAREA=RAREA,DBGAREA=DBGAREA                              00718800
*                                                                       00718900
         LA    R4,UWA1.RETADATA(R4) R4 -> END OF DATA.                  00719000
         LA    R5,UWA1.RETADATA    R5 -> START OF RETURNED DATA.        00719100
         USING RETPARM,R5                                               00719200
         L     R1,RETPLEN          R1 = REVOKE REASON LENGTH.           00719400
         CHI   R1,0                REVOKE REASON EXISTS ?               00719500
         BE    RETRC0              ..NO - NOTHING TO DO.                00719600
         DROP  R5                                                       00719700
         DROP  UWA1                                                     00719800
*                                                                       00720000
**   REVOKE REASON EXISTS - DELETE IT.                                  00720100
*                                                                       00720200
         ICHEINTY ALTER,MF=(E,ICHNDEL1)                                 00720900
*                                                                       00721000
         STM   R15,R0,RETCODES                                          00721100
         CTSADBG 'ICHEINTY DELETE: RC = # / #  (RC1=#/#)',             X00721200
               (RETCRACF,RESCRACF,                                     X00721300
               ICHNDEL1+52,ICHNDEL1+56),                               X00721400
               LEVEL=(DEBUGL,1,2,3,4,5,6),                             X00721500
               RAREA=RAREA,DBGAREA=DBGAREA                              00721600
*                                                                       00721700
         CHI   R15,0                                                    00721800
         BNE   ICHNDLER                                                 00721900
*                                                                       00722000
**   DELETE SUCCESSFUL, RETURN UPDATE TYPE                              00722100
*                                                                       00722200
         L     R3,PUPDTYPE                                              00722300
         MVI   0(R3),#UPDEL        RETURN UPDATE TYPE = DEL.            00722400
         B     RETRC0                                                   00722500
*                                                                       00723000
*---------------------------------------------------------------------- 00730000
**                                                                      01321000
**  TERMINAION                                                          01321100
**                                                                      01321200
**   ISSUE DEBUG MESSAGES FOR INTERNAL ERRORS, SET A RETURN CODE        01321300
**   AND RETURN TO THE CALLER.                                          01321400
**                                                                      01321500
*---------------------------------------------------------------------- 01321600
NOUSERID DS    0H                  NO USERID - NOTHING TO DO.           01322000
         L     R1,=A(ERRNOUID)                                          01322100
         BAL   R14,ERRORRTN                                             01322200
         B     RETURN                                                   01322300
NOCFNAME DS    0H                  NO USERID - NOTHING TO DO.           01322700
         L     R1,=A(ERRNOCFN)                                          01322800
         BAL   R14,ERRORRTN                                             01322900
         B     RETURN                                                   01323000
INVACT   DS    0H                  ACTION IS MISSING OR INVALID.        01323400
         L     R1,=A(ERRINVAC)                                          01323500
         BAL   R14,ERRORRTN                                             01323600
         B     RETURN                                                   01323700
INVACTYP DS    0H                  ACTION TYPE IS MISSING OR INVALID.   01324100
         L     R1,=A(ERRINVAT)                                          01324200
         BAL   R14,ERRORRTN                                             01324300
         B     RETURN                                                   01324400
NORVKRSN DS    0H                  MISSING REVOKE REASON.               01324900
         L     R1,=A(ERRNORVR)                                          01325000
         BAL   R14,ERRORRTN                                             01325100
         B     RETURN                                                   01325200
NOOUTPRM DS    0H                  NO OUTPUT PARMS.                     01325600
         L     R1,=A(ERRNOUTP)                                          01325700
         BAL   R14,ERRORRTN                                             01325800
         B     RETURN                                                   01325900
ICHNLCER DS    0H                  ICHEINTY LOCATE FAILED.              01326400
         L     R1,=A(ERRLOCFL)                                          01326500
         BAL   R14,ERRORRTN                                             01326600
         B     RETURN                                                   01326700
LCDATAER DS    0H                  LODATE DATA ERROR.                   01327400
         L     R1,=A(ERRLOCDE)                                          01327500
         BAL   R14,ERRORRTN                                             01327600
         B     RETURN                                                   01327700
ICHNDLER DS    0H                  ICHEINTY ALTER 'DELETE' FAILED.      01329700
         L     R1,=A(ERRDELFL)                                          01329800
         BAL   R14,ERRORRTN                                             01329900
         B     RETURN                                                   01330000
ICHNALER DS    0H                  ICHEINTY ALTER FAILED.               01330800
         L     R1,=A(ERRALTFL)                                          01330900
         BAL   R14,ERRORRTN                                             01331000
         B     RETURN                                                   01331100
*                                                                       01331900
*                                                                       01332000
**   SET RETURN CODES AND RETURN                                        01332100
*                                                                       01332200
RETRC0   DS    0H                  OK.                                  01332300
         LHI   R15,0                                                    01332400
         L     R3,PUPDTYPE                                              01332500
         L     R4,PRVRSET                                               01332600
         CTSADBG 'UPDATE DETAILS = _ ($) / _ ($)',                     X01332700
               (0(R3),1,0(R3),1,0(R4),1,0(R4),1),                      X01332800
               LEVEL=(DEBUGL,3,4,5,6,7),                               X01332900
               RAREA=RAREA,DBGAREA=DBGAREA                              01333000
         B     RETURN                                                   01333100
*                                                                       01333200
**   OUT                                                                01334000
*                                                                       01340000
RETURN   DS    0H                                                       01350000
         L     R3,PUPDTYPE                                              01351000
         L     R3,PRVRSET                                               01352000
         CTSADBG 'EXITING WITH RC=#',(?R15),                           X01360000
               LEVEL=(DEBUGL,3,4,5,6,7),                               X01370000
               RAREA=RAREA,DBGAREA=DBGAREA                              01371000
         BRTRN (15)                                                     01380000
         LTORG ,                                                        01381000
         DROP  ,                                                        01382000
*                                                                       01390000
*---------------------------------------------------------------------- 01401000
**                                                                      01404000
**   ISSUE DEBUG MESSAGES FOR INTERNAL ERRORS, SET A RETURN CODE        01405000
**   AND RETURN TO THE CALLER.                                          01406000
**                                                                      01407000
*---------------------------------------------------------------------- 01408000
ERRORRTN DS    0H                                                       01408100
         USING VARS,R12                                                 01408200
         STM   R14,R11,ERRSA                                            01408300
         BALR  R11,0                                                    01408400
         USING *,R11                                                    01408500
         BR    R1                                                       01408600
*                                                                       01408700
ERRNOUID DS    0H                  NO USERID - NOTHING TO DO.           01409000
         CTSADBG 'USERID IS MISSING',                                  X01409100
               RAREA=RAREA,DBGAREA=DBGAREA                              01409200
         B     ERRRC4                                                   01409300
ERRNOCFN DS    0H                  NO USERID - NOTHING TO DO.           01409400
         CTSADBG 'CUSTOM FIELD NAME IS MISSING',                       X01409500
               RAREA=RAREA,DBGAREA=DBGAREA                              01409600
         B     ERRRC4                                                   01409700
ERRINVAC DS    0H                  ACTION IS MISSING OR INVALID.        01409800
         CTSADBG 'ACTION (_) IS MISSING OR INCORRECT',(ACTIONIN,1),    X01409900
               RAREA=RAREA,DBGAREA=DBGAREA                              01410000
         B     ERRRC4                                                   01411000
ERRINVAT DS    0H                  ACTION TYPE IS MISSING OR INVALID.   01412000
         CTSADBG '"_" - ACTION TYPE (_) IS MISSING OR INCORRECT',      X01413000
               (ACTION,8,ACTYPEIN,1),                                  X01414000
               RAREA=RAREA,DBGAREA=DBGAREA                              01415000
         B     ERRRC4                                                   01416000
ERRNORVR DS    0H                  MISSING REVOKE REASON.               01417000
         CTSADBG '"_" - REVOKE REASON IS MISSING.',(ACTION,8),         X01418000
               RAREA=RAREA,DBGAREA=DBGAREA                              01419000
         B     ERRRC4                                                   01419100
ERRNOUTP DS    0H                  NO OUYPUT PARAMETERS.                01419200
         CTSADBG 'OUTPUT TYPE OR OUTPUT REVOKE REASON PARAMETER IS MISSX01419300
               ING',                                                   X01419400
               RAREA=RAREA,DBGAREA=DBGAREA                              01419500
         B     ERRRC4                                                   01419600
ERRLOCFL DS    0H                  ICHEINTY LOCATE FAILED.              01419700
         LHI   R2,0                                                     01419800
         IC    R2,USERLEN                                               01419900
         CTSADBG 'ICHEINTY LOCATE FAILED: RC=#/#  USER=_',             X01420000
               (RETCRACF,RESCRACF,USERNAM,?R2),                        X01421000
               RAREA=RAREA,DBGAREA=DBGAREA                              01422000
         B     ERRRC8                                                   01423000
ERRLOCDE DS    0H                  LODATE DATA ERROR.                   01424000
         LHI   R2,0                                                     01425000
         IC    R2,USERLEN                                               01426000
         CTSADBG 'ICHEINTY LOCATE DATA ERROR: USER=_',                 X01427000
               (USERNAM,?R2),                                          X01428000
               RAREA=RAREA,DBGAREA=DBGAREA                              01429000
         L     R2,RETADLEN-RETAREA+WA1                                  01429100
         AHI   R2,RETADATA-RETAREA R2 = RETURNED LENGTH (+ PREFIX).     01429200
         AHI   R2,-1                                                    01429300
         CTSADBG TYPE=SNAP,ID=1,HDR='ICHEINTY LOCATE RETURNED DATA 1', X01429400
               ADDR=(WA1,WA1(R2)),                                     X01429500
               RAREA=RAREA,DBGAREA=DBGAREA                              01429600
*                                                                       01429700
         L     R2,RETADLEN-RETAREA+WA2                                  01429800
         AHI   R2,RETADATA-RETAREA R2 = RETURNED LENGTH (+ PREFIX).     01429900
         AHI   R2,-1                                                    01430000
         CTSADBG TYPE=SNAP,ID=1,HDR='ICHEINTY LOCATE RETURNED DATA 2', X01431000
               ADDR=(WA2,WA2(R2)),                                     X01432000
               RAREA=RAREA,DBGAREA=DBGAREA                              01433000
         B     ERRRC8                                                   01434000
ERRDELFL DS    0H                  ICHEINTY ALTER 'DELETE' FAILED.      01435000
         LHI   R2,0                                                     01436000
         IC    R2,USERLEN                                               01437000
         L     R4,CFNAMELN                                              01438000
         CTSADBG 'ICHEINTY DELETE FAILED: RC=#/#  USER=_  CFNAME=#/_', X01439000
               (RETCRACF,RESCRACF,USERNAM,?R2,?R4,CFNAME,?R4),         X01439100
               RAREA=RAREA,DBGAREA=DBGAREA                              01439200
         B     ERRRC8                                                   01439300
ERRALTFL DS    0H                  ICJEINTY ALTER FAILED.               01439400
         LHI   R2,0                                                     01439500
         IC    R2,USERLEN                                               01439600
         LA    R15,CFDATAL                                              01439700
         CTSADBG 'ICHEINTY ALTER FAILED: RC=#/#  USER=_  DATA=$',      X01439800
               (RETCRACF,RESCRACF,USERNAM,?R2,CFDATA,?R15),            X01439900
               RAREA=RAREA,DBGAREA=DBGAREA                              01440000
         B     ERRRC8                                                   01441000
ERRRC4   DS    0H                  PARAMETERS ERROR.                    01442000
         LHI   R15,4                                                    01443000
         B     ERRRET                                                   01444000
ERRRC8   DS    0H                                                       01445000
         LHI   R15,8               RACF RELATED ERROR,                  01446000
         B     ERRRET                                                   01447000
ERRRET   DS    0H                                                       01447100
         L     R14,ERRSA           RESTORE REGISTERS...                 01447200
         LM    R0,R11,ERRSA+8        ...EXCEPT R15.                     01447300
         BR    R14                                                      01447400
         LTORG ,                                                        01448000
         DROP  ,                                                        01449000
*                                                                       01450000
**   VARIABLES.                                                         01460000
*                                                                       01470000
VARS     DS    0D                  VARIABLES.                           01881000
*                                                                       01883000
ERRSA    DS    14F                 SAVE AREA FOR ERRORRTN               01884000
*                                                                       01885000
BLANKS   DC    CL8' '                                                   01890000
*                                                                       01900000
ACTION   DS    CL8                 RECEIVED ACTION:                     01950000
#UPDATE  DC    CL8'UPDATE'         ..UPDATE.                            01951000
#REVOKE  DC    CL8'REVOKE'         ..REVOKE.                            01952000
*                                                                       01960000
ACTIONIN DS    C                   INPUT ACTION.                        01961000
ACTYPEIN DS    C                   INPUT ACTION TYPE.                   01961100
RVKRSNIN DS    C                   INPUT REVOKE REASON.                 01962000
*                                                                       01963000
AOUTAREA DS    A                   ADDRESS OUTPUT AREA                  01970000
DEBUG    DS    F                   DEBUG LEVEL                          01980000
DEBUGL   DS    CL1                 DEBUG LEVEL                          01990000
*                                                                       02000000
USER     DS    0H                  ENTRY NAME:                          02010000
USERLEN  DC    AL1(1)              .. USER NAME LENGTH.                 02020000
USERNAM  DC    XL256'00'           .. USER NAME.                        02030000
*                                                                       02060000
NODATE   DC    X'00000F'           NO DATE VALUE.                       02060100
REVOKEDT DS    XL3                 REVOKE DATE (YYDDDF)                 02061000
RESUMEDT DS    XL3                 RESUME DATE (YYDDDF)                 02062000
TODAY    DS    XL3                 TODAY (YYDDDF)                       02062100
*                                                                       02063000
RETCODES DS    0F                  RETURN CODES AREA:                   02070000
RETCRACF DS    F                   ..RACF RETURN CODE                   02080000
RESCRACF DS    F                   ..RACF REASON CODE                   02090000
*                                                                       02110000
CNULLTAB DC    256AL1(00)                                               02170000
         ORG   CNULLTAB                                                 02180000
         DC    65X'01'             FIND FIRST CONRTOL CHAR.             02190000
         ORG   ,                                                        02200000
*                                                                       02210000
UCASETAB DC    256AL1(*-UCASETAB)                                       02220000
         ORG   UCASETAB+X'81'                                           02230000
         DC    C'ABCDEFGHI'                                             02240000
         ORG   UCASETAB+X'91'                                           02250000
         DC    C'JKLMNOPQR'                                             02260000
         ORG   UCASETAB+X'A2'                                           02270000
         DC    C'STUVWXYZ'                                              02280000
         ORG   ,                                                        02290000
*                                                                       02291000
**   ICHEINTY FIELDS.                                                   02291100
*                                                                       02291200
CFDATA   DS    0H,CL(4+CFTYPEL+4+CFNAMEL+4+CFVALUEL)                    02291400
CFDATAL  EQU   *-CFDATA                                                 02291500
*                                                                       02291600
CFTYPE   DC    X'01'               FIELD TYPE = CHAR.                   02291700
CFTYPEL  EQU   *-CFTYPE                                                 02291800
*                                                                       02291900
CFNAME   DC    CL8' '              FIELD NAME.                          02292100
CFNAMEL  EQU   *-CFNAME                                                 02292200
CFNAMELN DC    A(CFNAMEL)                                               02292300
*                                                                       02292400
CFVALUE  DC    C' '                FIELD VALUE.                         02292500
CFVALUEL EQU   *-CFVALUE                                                02292600
*                                                                       02292700
LCRVKDT  ICHEACTN FIELD=(REVOKEDT)                                      02297000
LCRSMDT  ICHEACTN FIELD=(RESUMEDT)                                      02297100
LCCSVALU ICHEACTN FIELD=(CSVALUE),TESTS=(TCSKEYEQ)                      02298000
*                                                                       02298100
ADCSCDAT ICHEACTN FIELD=(CSCDATA),FLDATA=(CFDATAL,CFDATA),             X02298200
               TESTS=(TCSKEYNE),MF=L                                    02298300
ALCSVALU ICHEACTN FIELD=(CSVALUE),FLDATA=(CFVALUEL,CFVALUE),           X02299000
               TESTS=(TCSKEYEQ)                                         02299100
ALCSDEL  ICHEACTN FIELD=(CSCDATA),FLDATA='DEL',                        X02299200
               TESTS=(TCSKEYEQ)                                         02299300
TCSKEYEQ ICHETEST FIELD=(CSKEY),FLDATA=(CFNAMEL,CFNAME),COND=EQ,       X02299400
               MF=L                                                     02299500
TCSKEYNE ICHETEST FIELD=(CSKEY),FLDATA=(CFNAMEL,CFNAME),COND=NE,       X02299600
               MF=L                                                     02299700
*                                                                       02299800
**   ICHEINTY ALTER - SET / ADD                                         02299900
*                                                                       02300000
         DS    0F                                                       02301600
ICHNALT1 ICHEINTY ALTER,TYPE='USR',                                    X02301700
               CHAIN=ICHNALT2,                                         X02301800
               ENTRY=USER,                                             X02301900
               ACTIONS=ALCSVALU,                                       X02302000
               SEGMENT=CSDATA,                                         X02302100
               GENERIC=NO,                                             X02302200
               FLDACC=NO,                                              X02302300
               RELEASE=1.8,                                            X02302400
               MF=L                                                     02302500
*                                                                       02302600
         DS    0F                                                       02302700
ICHNALT2 ICHEINTY ALTER,TYPE='USR',                                    X02302800
               ENTRY=USER,                                             X02302900
               ACTIONS=ADCSCDAT,                                       X02303000
               SEGMENT=CSDATA,                                         X02303100
               GENERIC=NO,                                             X02303200
               FLDACC=NO,                                              X02303300
               RELEASE=1.8,                                            X02303400
               MF=L                                                     02303500
*                                                                       02303600
**   ICHEINTY ALTER - DELETE                                            02303700
*                                                                       02303800
         DS    0F                                                       02303900
ICHNDEL1 ICHEINTY ALTER,TYPE='USR',                                    X02304000
               ENTRY=USER,                                             X02304200
               ACTIONS=ALCSDEL,                                        X02304300
               SEGMENT=CSDATA,                                         X02304400
               GENERIC=NO,                                             X02304500
               FLDACC=NO,                                              X02304600
               RELEASE=1.8,                                            X02304700
               MF=L                                                     02304800
*                                                                       02304900
*                                                                       02305000
**   ICHEINTY LOCATE                                                    02305100
*                                                                       02305200
         DS    0F                                                       02305300
ICHNLOC1 ICHEINTY LOCATE,TYPE='USR',                                   X02305400
               ENTRY=USER,                                             X02305500
               ACTIONS=(LCCSVALU),                                     X02305600
               WKAREA=WA1,                                             X02305700
               SEGMENT=CSDATA,                                         X02305800
               CHAIN=ICHNLOC2,                                         X02305900
               GENERIC=NO,                                             X02306000
               FLDACC=NO,                                              X02306100
               RELEASE=1.8,                                            X02306200
               MF=L                                                     02306300
         DS    0F                                                       02306400
ICHNLOC2 ICHEINTY LOCATE,TYPE='USR',                                   X02306500
               ENTRY=USER,                                             X02306600
               ACTIONS=(LCRVKDT,LCRSMDT),                              X02306700
               WKAREA=WA2,                                             X02307000
               GENERIC=NO,                                             X02309000
               FLDACC=NO,                                              X02310000
               RELEASE=1.8,                                            X02320000
               MF=L                                                     02330000
*                                                                       02461000
WA1      DC    F'50'               ICHEINTY LOCATE 1 WORKAREA           02462000
         DC    50X'00'                                                  02462200
WA2      DC    F'50'               ICHEINTY LOCATE 1 WORKAREA           02462300
         DC    50X'00'                                                  02462500
*                                                                       02462600
RAREA    DS    0F,XL512               USED BY CTSADBG AND CTSMSG1       02463000
DBGAREA  DS    XL2048                                                   02464000
         DROP  ,                                                        02470000
********************************************************************    02640000
*        PARAMETER LIST MAPPING                                         02650000
********************************************************************    02660000
PARMS    DSECT                                                          02670000
PUSERID  DS    A                   -> USER ID (CL256)                   02690000
PACTION  DS    A                   -> ACTION (CL1):                     02691000
#ACTUPD  EQU   EVTAUPD             ..UPDATE.                            02692000
#ACTREV  EQU   EVTAREV             ..REVOKE.                            02693000
PACTTYPE DS    A                   -> ACTION TYPE (CL1)                 02700000
#ACTYPRV EQU   #EVTUPTV            ..REVOKE.                            02710000
#ACTYPRS EQU   #EVTUPTS            ..RESUME.                            02720000
PRVKRSN  DS    A                   -> REVOKE REASON (CL1)               02721000
PCFNAME  DS    A                   -> CUSTOM FIELD NAME (CL8)           02722000
PDEBUG   DS    A                   -> DEBUG LEVEL (F)                   02730000
PUPDTYPE DS    A                   -> UPDATE DONE ON USER RECORD:       02731000
#UPNO    EQU   C' '                ..NOTHING.                           02732000
#UPSET   EQU   C'S'                ..SET.                               02733000
#UPDEL   EQU   C'D'                ..DELETE                             02734000
PRVRSET  DS    A                   -> REVOKE REASON SET FOR USER.       02735000
*                                                                       02740000
******************************************************************      02750000
*        RETURN AREA FROM RACF                                          02760000
******************************************************************      02770000
RETAREA  DSECT                                                          02771000
RETALEN  DS    F                   MAXIMUM LENGTH OF AREA               02772000
RETARBA  DS    XL6                 RBA RETURN AREA                      02773000
RETAFLGS DS    XL1                 FLAG                                 02774000
RETARES1 DS    XL1                 RESERVED                             02775000
RETADDSC DS    F                   DUPLICATE DATASET NAME COUNT         02776000
RETARES2 DS    XL8                 RESERVED                             02777000
RETADLEN DS    XL4                 RETURNED DATA LENGTH.                02778000
RETADATA DS    0X                  RETURNED DATA.                       02779000
*                                                                       02779100
RETPARM  DSECT                                                          02779200
RETPLEN  DS    XL4                 PARAMETER LENGTH.                    02779300
RETPDATA DS    0X                  PARAMETER DATA.                      02779400
*                                                                       02779500
********************************************************************    02780000
*        EXTRENAL DSECTS                                                02790000
********************************************************************    02800000
         CTSEQUR                                                        02810000
*                                                                       02820000
EVT      DSECT                                                          02820100
         COPY  CTSEVT                                                   02821000
*                                                                       02822000
         IHAPSA LIST=NO                                                 02830000
*                                                                       02840000
         CVT   DSECT=YES,LIST=NO                                        02850000
*                                                                       02860000
         ICHPRCVT ,                                                     02870000
*                                                                       02880000
         END                                                            02890000
